# Redis 数据类型应用

## 案例---最受欢迎的文章

选出最受欢迎文章，需要支持对文章进行评分。

（1）使用Hash存储文章

使用 `HASH` 类型存储文章信息。其中：key 是文章 ID；field 是文章的属性 key；value 是属性对应值。

操作：

- 存储文章信息 - 使用 `HSET` 或 `HMGET` 命令
- 查询文章信息 - 使用 `HGETALL` 命令
- 添加投票 - 使用 `HINCRBY` 命令

（2）使用 `ZSET` 针对不同维度集合排序

使用 `ZSET` 类型分别存储按照时间排序和按照评分排序的文章 ID 集合。时间和评分各自维护一个 zset

操作：

- 添加记录 - 使用 `ZADD` 命令
- 添加分数 - 使用 `ZINCRBY` 命令
- 取出多篇文章 - 使用 `ZREVRANGE` 命令

（3）为了防止重复投票，使用 `SET` 类型记录每篇文章 ID 对应的投票集合。

操作：

- 添加投票者 - 使用 `SADD` 命令
- 设置有效期 - 使用 `EXPIRE` 命令

（4）假设 user:115423 给 article:100408 投票，分别需要高更新评分排序集合以及投票集合。

当需要对一篇文章投票时，程序需要用 ZSCORE 命令检查记录文章发布时间的有序集合，判断文章的发布时间是否超过投票有效期（比如：一星期）。

## JWT 鉴权

使用 Hash ，hash-key：Token，sub-key：具体的Token值，value：过期那一天的时间戳。

### 1 登录

#### 1.1 颁发 Token

登录时，根据自己的业务进行必要的账号验证。验证通过后，颁发Token。这里从Redis中取，可以避免多处登录时出现互斥的情况，后续开发可以实现单点登录等其他功能。如果要实现多端只能同时保持一个客户端登录，则可以直接生成新的Token，让缓存中Redis失效，强迫其他端的Token失效。

这里，我将用户的userId和userName存入了Token中。方便后面的横向鉴权。

在生成Token时，首先想到Token的有效期。一般设置Token有效期为30天。

#### 1.2 有效期

但如何实现Token在特定时间后过期呢？

这里就借助于Redis实现了。可以将颁发的Token存入Redis缓存，并将过期时间设置为我们所需要的时间。  

在颁发Token时，先检查Redis中是否存在有效的Token，有则直接颁发，并延长Token有效期。

在鉴权时，当Redis里的Token失效时，我们即可判断用户当前Token 过期了。

我这里用户的userName是唯一的，可根据自己的业务更换其他的key。

### 2 鉴权

* 判断 Token 是否有效（解析）

* 判断 Token 是否过期（Redis）

* 鉴权，取出 Token 中存放的 UserID，判断是否有权限
