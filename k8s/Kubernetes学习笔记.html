

<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<!-- Basic Page Needs -->
<meta charset="utf-8" />
<title>绿色记忆:Kubernetes学习笔记</title>

<meta name="author" content="" />

<!-- Mobile Specific Metas -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="icon" type="image/png" href="https://blog.gmem.cc/wp-content/uploads/2014/09/Gmem.ico" />


<!-- This site is optimized with the Yoast WordPress SEO plugin v1.6.1 - https://yoast.com/wordpress/plugins/seo/ -->
<link rel="canonical" href="https://blog.gmem.cc/kubernetes-study-note" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Kubernetes学习笔记" />
<meta property="og:description" content="简介 什么是K8S Kubernates（发音 / kubə&#039;neitis /，简称K8S）是一个容器编排工具，使用它可以自动化容器的部署、扩容、管理。使用K8S可以将应用程序封装为容易管理、发现的逻辑单元。使用K8S你可以打造完全以容器为中心的开发环境。 K8S的特性包括： 自动装箱：根据容器的资源需求和其他约束条件，自动部署容器到合适的位置，与此同时，不影响可用性。K8S可以混合管理关键负载、非关键负载并尽可能的有效利用资源 自我修复：当容器宕掉后自动重启它，当节点宕掉后重新调度容器。关闭不能正确响应自定义健康检查的容器，在容器准备好提供服务之前，不将他们暴露给客户端 水平扩容：手工（UI、命令行）或自动（根据CPU负载）进行自动的扩容/缩容 服务发现/负载均衡：不需要修改应用程序来使用第三方的服务发现机制，K8S为容器提供专有IP，同时为一组容器（类似Swarm中的Service）提供单一的DNS名称，应用程序可以基于DNS名称发现服务。K8S还内置的负载均衡支持 无缝滚动更新/回滚：支持逐步的将更新应用到程序或配置，与此同时监控程序的健康状况，避免同时杀死程序的所有实例。如果出现问题，K8S能够自动回滚更新 密码和配置管理：部署、更新应用程序的密码、配置信息时，不需要重新构建镜像，不需要在配置信息中暴露密码信息 存储编排：自动从本地磁盘、公有云、网络存储系统挂载存储系统 资源监控、访问并处理日志、调试应用、提供认证和授权功能…… K8S提供了PaaS的简单性、IaaS的灵活性，支持在各基础设施提供商之间迁移。 尽管K8S提供了部署、扩容、负载均衡、日志、监控等服务，但是它并不是传统的PaaS平台： 它不限制能支持的应用程序类型，不限制编程语言、SDK。只要应用能在容器中运行，就可以在K8S下运行  不内置中间件（例如消息总线）、数据处理框架（例如Spark）、数据库、或者存储系统 不提供服务市场来下载服务 允许用户选择日志、监控、报警系统 同时，很多PaaS平台可以运行在K8S之上，例如OpenShift、Deis，你可以在K8S上部署自己的PaaS平台，集成自己喜欢的CI环境，或者仅仅是部署容器镜像。 什么是云原生 [...]" />
<meta property="og:url" content="https://blog.gmem.cc/kubernetes-study-note" />
<meta property="og:site_name" content="绿色记忆" />
<meta property="article:tag" content="Docker" />
<meta property="article:tag" content="K8S" />
<meta property="article:section" content="PaaS" />
<meta property="article:published_time" content="2016-06-11T10:12:08+08:00" />
<meta property="article:modified_time" content="2021-08-24T16:42:36+08:00" />
<meta property="og:updated_time" content="2021-08-24T16:42:36+08:00" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-1.png" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-2.png" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/kube-arch-3.png" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/pre-ccm-arch.png" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/post-ccm-arch-1024x443.png" />
<meta property="og:image" content="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-master-ha.png" />
<!-- / Yoast WordPress SEO plugin. -->

<link rel="alternate" type="application/rss+xml" title="绿色记忆 &raquo; Feed" href="https://blog.gmem.cc/feed" />
<link rel="alternate" type="application/rss+xml" title="绿色记忆 &raquo; Comments Feed" href="https://blog.gmem.cc/comments/feed" />
<link rel="alternate" type="application/rss+xml" title="绿色记忆 &raquo; Kubernetes学习笔记 Comments Feed" href="https://blog.gmem.cc/kubernetes-study-note/feed" />
<link rel='stylesheet' id='bs_bootstrap-css'  href='https://blog.gmem.cc/wp-content/plugins/bootstrap-shortcodes/css/bootstrap.css?ver=3.9.14' type='text/css' media='all' />
<link rel='stylesheet' id='bs_shortcodes-css'  href='https://blog.gmem.cc/wp-content/plugins/bootstrap-shortcodes/css/shortcodes.css?ver=3.9.14' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-css'  href='https://blog.gmem.cc/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=2.7.0' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-gmem-github-css'  href='https://blog.gmem.cc/wp-content/uploads/crayon-syntax-highlighter/themes/gmem-github/gmem-github.css?ver=2.7.0' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-none-css'  href='https://blog.gmem.cc/wp-content/plugins/crayon-syntax-highlighter/themes/none/none.css?ver=2.7.0' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-consolas-css'  href='https://blog.gmem.cc/wp-content/plugins/crayon-syntax-highlighter/fonts/consolas.css?ver=2.7.0' type='text/css' media='all' />
<link rel='stylesheet' id='open_social_css-css'  href='https://blog.gmem.cc/wp-content/plugins/open-social/images/os.css?ver=3.9.14' type='text/css' media='all' />
<link rel='stylesheet' id='videojs-plugin-css'  href='https://blog.gmem.cc/wp-content/plugins/videojs-html5-video-player-for-wordpress/plugin-styles.css?ver=3.9.14' type='text/css' media='all' />
<link rel='stylesheet' id='videojs-css'  href='https://blog.gmem.cc/wp-content/plugins/videojs-html5-video-player-for-wordpress/videojs/video-js.css?ver=3.9.14' type='text/css' media='all' />
<link rel='stylesheet' id='style-name-css'  href='https://blog.gmem.cc/wp-content/themes/infinitygrid/style.css?ver=3.9.14' type='text/css' media='all' />
<script type='text/javascript' src='https://blog.gmem.cc/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/plugins/bootstrap-shortcodes/js/bootstrap.js?ver=3.9.14'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/plugins/bootstrap-shortcodes/js/init.js?ver=3.9.14'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"2.7.0","is_admin":"0","ajaxurl":"https:\/\/blog.gmem.cc\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=2.7.0'></script>
<script type='text/javascript' src='https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js?ver=3.9.14'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blog.gmem.cc/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://blog.gmem.cc/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.14" />
<link rel='shortlink' href='https://blog.gmem.cc/?p=16626' />

	<style type='text/css'>
		.vjs-default-skin { color: #ccc }
		.vjs-default-skin .vjs-play-progress, .vjs-default-skin .vjs-volume-level { background-color: #007766 }
		.vjs-default-skin .vjs-control-bar, .vjs-default-skin .vjs-big-play-button { background: rgba(0,0,0,0.7) }
		.vjs-default-skin .vjs-slider { background: rgba(0,0,0,0.2333333333333333) }
	</style>
		
		<script type="text/javascript">
			if(typeof videojs != "undefined") {
				videojs.options.flash.swf = "https://blog.gmem.cc/wp-content/plugins/videojs-html5-video-player-for-wordpress/videojs/video-js.swf";
			}
			document.createElement("video");document.createElement("audio");document.createElement("track");
		</script>
			<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style type="text/css" class="options-output">h1{font-family:Alice;font-weight:400;font-style:normal;font-size:26px;line-height:40px;color:#757575;}h2{font-family:Alice;font-weight:400;font-style:normal;font-size:22px;line-height:40px;color:#757575;}h3{font-family:Alice;font-weight:400;font-style:normal;font-size:18px;line-height:30px;color:#757575;}h4{font-family:Alice;font-weight:400;font-style:normal;font-size:18px;line-height:30px;color:#757575;}h5{font-family:Alice;font-weight:400;font-style:normal;font-size:16px;line-height:30px;color:#757575;}h6{font-family:Alice;font-weight:400;font-style:normal;font-size:14px;line-height:30px;color:#757575;}h1 a, h2 a, h3 a, h4 a, h5 a, h6 a{color:#585858;}h1 a:hover, h2 a:hover, h3 a:hover, h4 a:hover, h5 a:hover, h6 a:hover{color:#007766;}body, p{font-family:Alice;font-weight:400;font-style:normal;font-size:14px;line-height:22px;color:#333333;}.sf-menu-primary a{font-family:Alice;font-weight:400;font-style:normal;font-size:22px;line-height:22px;color:#757575;}article a, p a, .sidebar a{color:#757575;}article a:hover, p a:hover, .sidebar a:hover{color:#007766;}accent a{color:#007766;}accent a:hover{color:#007766;}.sf-menu-primary a{color:#757575;}.sf-menu-primary a:hover, .sf-menu-primary .current-menu-item a{color:#007766;}.sf-menu-primary ul li a, ul.sf-menu-primary ul li.current-menu-item a{color:#c8c8c8;}.sf-menu-primary ul li a:hover, ul.sf-menu-primary ul li.current-menu-item a:hover{color:#efefef;}html{background-color:#efefef;}</style><link rel="stylesheet" id="options-google-fonts"  href="https://blog.gmem.cc/wp-content/themes/infinitygrid/css/google-fonts.css" type="text/css" media="all" />
<script type="text/javascript" src="https://blog.gmem.cc/wp-content/themes/infinitygrid/js/gmem.js"></script>
<link rel="stylesheet" href="https://blog.gmem.cc/wp-content/themes/infinitygrid/style-override.css" type="text/css" media="all">
<link rel="stylesheet" href="https://blog.gmem.cc/wp-content/themes/infinitygrid/iconfont/iconfont.css" type="text/css" media="all">
</head>
<body class="single single-post postid-16626 single-format-standard">

<div id="mobile-header">
  <nav id="sidr" role="mobile">
   <h3>Menu</h3><div class="responsive-trig uptop" id="simple-close" href="#sidr"></div>

    <div class="menu-primary-menu-container"><ul id="menu-primary-menu" class="cbp-spmenu"><li id="menu-item-828" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-828"><a href="/">Home</a></li>
<li id="menu-item-10" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-10"><a href="https://blog.gmem.cc/category/work">Work</a>
<ul class="sub-menu">
	<li id="menu-item-12814" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-12814"><a href="https://blog.gmem.cc/category/work/cloud">Cloud</a>
	<ul class="sub-menu">
		<li id="menu-item-12815" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-12815"><a href="https://blog.gmem.cc/category/work/cloud/virtualization">Virtualization</a></li>
		<li id="menu-item-13589" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-13589"><a href="https://blog.gmem.cc/category/work/cloud/iaas">IaaS</a></li>
		<li id="menu-item-17288" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-17288"><a href="https://blog.gmem.cc/category/work/cloud/paas">PaaS</a></li>
	</ul>
</li>
	<li id="menu-item-15" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-15"><a href="https://blog.gmem.cc/category/work/java">Java</a></li>
	<li id="menu-item-17631" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-17631"><a href="https://blog.gmem.cc/category/work/go">Go</a></li>
	<li id="menu-item-11" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11"><a href="https://blog.gmem.cc/category/work/c">C</a></li>
	<li id="menu-item-12" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-12"><a href="https://blog.gmem.cc/category/work/cpp">C++</a></li>
	<li id="menu-item-16" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://blog.gmem.cc/category/work/web/javascript">JavaScript</a></li>
	<li id="menu-item-18" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-18"><a href="https://blog.gmem.cc/category/work/web/php">PHP</a></li>
	<li id="menu-item-4035" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4035"><a href="https://blog.gmem.cc/category/work/python">Python</a></li>
	<li id="menu-item-4470" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4470"><a href="https://blog.gmem.cc/category/work/architecture">Architecture</a></li>
	<li id="menu-item-4469" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4469"><a>Others</a>
	<ul class="sub-menu">
		<li id="menu-item-36239" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-36239"><a href="https://blog.gmem.cc/category/work/assembly">Assembly</a></li>
		<li id="menu-item-11732" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11732"><a href="https://blog.gmem.cc/category/work/ruby">Ruby</a></li>
		<li id="menu-item-17" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-17"><a href="https://blog.gmem.cc/category/work/perl">Perl</a></li>
		<li id="menu-item-18695" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-18695"><a href="https://blog.gmem.cc/category/work/lua">Lua</a></li>
		<li id="menu-item-27601" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-27601"><a href="https://blog.gmem.cc/category/work/rust">Rust</a></li>
		<li id="menu-item-6568" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6568"><a href="https://blog.gmem.cc/category/work/xml">XML</a></li>
		<li id="menu-item-5044" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-5044"><a href="https://blog.gmem.cc/category/work/network">Network</a></li>
		<li id="menu-item-11557" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11557"><a href="https://blog.gmem.cc/category/work/iot">IoT</a></li>
		<li id="menu-item-3886" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3886"><a href="https://blog.gmem.cc/category/work/gis">GIS</a></li>
		<li id="menu-item-38209" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-38209"><a href="https://blog.gmem.cc/category/work/algorithm">Algorithm</a></li>
		<li id="menu-item-26435" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-26435"><a href="https://blog.gmem.cc/category/work/ai">AI</a></li>
		<li id="menu-item-16806" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16806"><a href="https://blog.gmem.cc/category/work/math">Math</a></li>
		<li id="menu-item-10858" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-10858"><a href="https://blog.gmem.cc/category/work/re">RE</a></li>
		<li id="menu-item-3786" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3786"><a href="https://blog.gmem.cc/category/work/graphic">Graphic</a></li>
	</ul>
</li>
	<li id="menu-item-2364" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-2364"><a href="https://blog.gmem.cc/category/work/os">OS</a>
	<ul class="sub-menu">
		<li id="menu-item-698" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-698"><a href="https://blog.gmem.cc/category/work/os/linux">Linux</a></li>
		<li id="menu-item-2363" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2363"><a href="https://blog.gmem.cc/category/work/os/windows">Windows</a></li>
		<li id="menu-item-10775" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-10775"><a href="https://blog.gmem.cc/category/work/os/mac-os-x">Mac OS X</a></li>
	</ul>
</li>
	<li id="menu-item-16477" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16477"><a href="https://blog.gmem.cc/category/work/bigdata">BigData</a></li>
	<li id="menu-item-1610" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-1610"><a href="https://blog.gmem.cc/category/work/database">Database</a>
	<ul class="sub-menu">
		<li id="menu-item-4533" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4533"><a href="https://blog.gmem.cc/category/work/database/mysql">MySQL</a></li>
		<li id="menu-item-4534" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4534"><a href="https://blog.gmem.cc/category/work/database/oracle">Oracle</a></li>
	</ul>
</li>
	<li id="menu-item-4471" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-4471"><a href="https://blog.gmem.cc/category/work/mobile">Mobile</a>
	<ul class="sub-menu">
		<li id="menu-item-4472" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4472"><a href="https://blog.gmem.cc/category/work/mobile/android">Android</a></li>
		<li id="menu-item-4473" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4473"><a href="https://blog.gmem.cc/category/work/mobile/ios">IOS</a></li>
	</ul>
</li>
	<li id="menu-item-12742" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-12742"><a href="https://blog.gmem.cc/category/work/web">Web</a>
	<ul class="sub-menu">
		<li id="menu-item-14" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-14"><a href="https://blog.gmem.cc/category/work/web/html">HTML</a></li>
		<li id="menu-item-13" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-13"><a href="https://blog.gmem.cc/category/work/web/css">CSS</a></li>
	</ul>
</li>
</ul>
</li>
<li id="menu-item-3563" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-3563"><a href="https://blog.gmem.cc/category/life">Life</a>
<ul class="sub-menu">
	<li id="menu-item-3564" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3564"><a href="https://blog.gmem.cc/category/life/cooking">Cooking</a></li>
	<li id="menu-item-3565" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3565"><a href="https://blog.gmem.cc/category/life/travel">Travel</a></li>
	<li id="menu-item-4028" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4028"><a href="https://blog.gmem.cc/category/life/gardening">Gardening</a></li>
</ul>
</li>
<li id="menu-item-20" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-20"><a href="https://blog.gmem.cc/category/gallery">Gallery</a></li>
<li id="menu-item-796" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-796"><a href="https://blog.gmem.cc/category/video">Video</a></li>
<li id="menu-item-586" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-586"><a href="https://blog.gmem.cc/category/music">Music</a></li>
<li id="menu-item-9" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9"><a href="https://blog.gmem.cc/category/essay">Essay</a></li>
</ul></div>  </nav>
</div>

<div class="entire-site-wrap">
<div class="site-margin">
<div class="site-wrap-shadow">
<header class="header-wrap">
    <div class="container">
        <div class="row">

<div class="col-md-3">
    <div class="logo">
                    <a href="https://blog.gmem.cc" title="https://blog.gmem.cc">
                <img src="https://blog.gmem.cc/wp-content/uploads/2014/09/logo.png " data-at2x="https://blog.gmem.cc/wp-content/uploads/2014/09/logo@2x.png"/>
            </a>
            </div><!--end logo-->
</div>

<div class="col-md-9 rel">
        <div class="responsive-trig" id="simple-menu" href="#sidr"></div>
        <nav class="menuwrap" role="main">
            <div class="menu-primary-menu-container"><ul id="menu-primary-menu-1" class="sf-menu-primary"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-828"><a href="/">Home</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-10"><a href="https://blog.gmem.cc/category/work">Work</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-12814"><a href="https://blog.gmem.cc/category/work/cloud">Cloud</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-12815"><a href="https://blog.gmem.cc/category/work/cloud/virtualization">Virtualization</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-13589"><a href="https://blog.gmem.cc/category/work/cloud/iaas">IaaS</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-17288"><a href="https://blog.gmem.cc/category/work/cloud/paas">PaaS</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-15"><a href="https://blog.gmem.cc/category/work/java">Java</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-17631"><a href="https://blog.gmem.cc/category/work/go">Go</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11"><a href="https://blog.gmem.cc/category/work/c">C</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-12"><a href="https://blog.gmem.cc/category/work/cpp">C++</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://blog.gmem.cc/category/work/web/javascript">JavaScript</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-18"><a href="https://blog.gmem.cc/category/work/web/php">PHP</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4035"><a href="https://blog.gmem.cc/category/work/python">Python</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4470"><a href="https://blog.gmem.cc/category/work/architecture">Architecture</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4469"><a>Others</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-36239"><a href="https://blog.gmem.cc/category/work/assembly">Assembly</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11732"><a href="https://blog.gmem.cc/category/work/ruby">Ruby</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-17"><a href="https://blog.gmem.cc/category/work/perl">Perl</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-18695"><a href="https://blog.gmem.cc/category/work/lua">Lua</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-27601"><a href="https://blog.gmem.cc/category/work/rust">Rust</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6568"><a href="https://blog.gmem.cc/category/work/xml">XML</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-5044"><a href="https://blog.gmem.cc/category/work/network">Network</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11557"><a href="https://blog.gmem.cc/category/work/iot">IoT</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3886"><a href="https://blog.gmem.cc/category/work/gis">GIS</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-38209"><a href="https://blog.gmem.cc/category/work/algorithm">Algorithm</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-26435"><a href="https://blog.gmem.cc/category/work/ai">AI</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16806"><a href="https://blog.gmem.cc/category/work/math">Math</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-10858"><a href="https://blog.gmem.cc/category/work/re">RE</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3786"><a href="https://blog.gmem.cc/category/work/graphic">Graphic</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-2364"><a href="https://blog.gmem.cc/category/work/os">OS</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-698"><a href="https://blog.gmem.cc/category/work/os/linux">Linux</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2363"><a href="https://blog.gmem.cc/category/work/os/windows">Windows</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-10775"><a href="https://blog.gmem.cc/category/work/os/mac-os-x">Mac OS X</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16477"><a href="https://blog.gmem.cc/category/work/bigdata">BigData</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-1610"><a href="https://blog.gmem.cc/category/work/database">Database</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4533"><a href="https://blog.gmem.cc/category/work/database/mysql">MySQL</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4534"><a href="https://blog.gmem.cc/category/work/database/oracle">Oracle</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-4471"><a href="https://blog.gmem.cc/category/work/mobile">Mobile</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4472"><a href="https://blog.gmem.cc/category/work/mobile/android">Android</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4473"><a href="https://blog.gmem.cc/category/work/mobile/ios">IOS</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-12742"><a href="https://blog.gmem.cc/category/work/web">Web</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-14"><a href="https://blog.gmem.cc/category/work/web/html">HTML</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-13"><a href="https://blog.gmem.cc/category/work/web/css">CSS</a></li>
	</ul>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-3563"><a href="https://blog.gmem.cc/category/life">Life</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3564"><a href="https://blog.gmem.cc/category/life/cooking">Cooking</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3565"><a href="https://blog.gmem.cc/category/life/travel">Travel</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-4028"><a href="https://blog.gmem.cc/category/life/gardening">Gardening</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-20"><a href="https://blog.gmem.cc/category/gallery">Gallery</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-796"><a href="https://blog.gmem.cc/category/video">Video</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-586"><a href="https://blog.gmem.cc/category/music">Music</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9"><a href="https://blog.gmem.cc/category/essay">Essay</a></li>
</ul></div>        </nav><!--end navbar primary-->
</div>



        </div><!--end row-->
    </div><!--end container-->
</header><!-- end of menu and logo section -->


<!--slider for pages area-->
<section class="section-wrap">
    <div class="container">
        <div class="row">              

<div class="col-md-9">  



<h1 class="nomargin lh-40">Kubernetes学习笔记</h1>



</div><!--end 9 col-->

<div class="col-md-3">
    <form method="get" id="searchForm" action="https://blog.gmem.cc/kubernetes-study-note/">
        <div class="search-wrapper">
        <div class="search-icon"></div>
        <input type="text" maxlength="30" name="s" id="s" class="search_input"  autocomplete="off"/>
        <input type="submit" id="searchSubmit"  />
        </div>
</form>
</div><!--end 3col-->

        </div><!--end row-->
    </div><!--end container-->
</div><!--section-->

<section class="section-wrap nopads">
    <div class="container">
        <div class="row">              
            <div class="col-md-12">
                <div class="hrrule"></div>
            </div>
        </div>
    </div>
</section>

<section class="section-wrap">
    <div class="container">
        <div class="row">


<div class="col-md-1 bumpnorm">
<div class="stickysidebar">

    <div class="datewrap centertext bumpmini">
            <span class="entrylg">11</span>
            <br>
            <span class="entrysm">Jun</span>     
            <br>
            <span class="entrysm">2016</span>     
    </div>

<div class="datewrap centertext linetop">
    <div class="post-markdown"><a href="#" data-post_id="16626">
					<span class="qtip markdown"></span>
				</a></div></div>

   
    <div class="datewrap centertext linetop">
        <div class="post-like"><a href="#" data-post_id="16626">
					<span  title=""class="qtip like"></span>
				</a></div>    </div>


</div><!--affix-->
</div><!--end col span-->

<div class="col-md-8 bumpnorm">
<article class="singlewrap colored">
<div class="singlewrap">
<div id="post-16626" class="post-16626 post type-post status-publish format-standard hentry category-paas tag-docker tag-k8s">

        <h3 class="notop">Kubernetes学习笔记</h3>




       




</div><!--id wrapper-->
</div><!--end single wrap-->

<div class="singlewrap bumpnorm linetopbtm accent">
        <div class="row">
                <div class="col-xs-9">
                    <div class="cellblock text-left">By <a href="https://blog.gmem.cc/author/wangzhen" title="Posts by Alex" rel="author">Alex</a></div>
                    <div class="cellblock text-left">/ in <a href="https://blog.gmem.cc/category/work/cloud/paas" title="View all posts in PaaS" rel="category tag">PaaS</a></div>
                    
                                            <div class="cellblock text-left">    
                               / tags <a href="https://blog.gmem.cc/tag/docker" rel="tag">Docker</a>, <a href="https://blog.gmem.cc/tag/k8s" rel="tag">K8S</a>                        </div>
                                    </div>    
            <div class="col-xs-3">      
            <div class="cellblockright text-right"><a href="#reply-title">0 Comments</a>
            </div>
            </div>
        </div><!--end wrap-->
</div><!--end row-->
<script type="text/javascript" src="https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.scrollTo.min.js"></script>
<script type="text/javascript" src="https://blog.gmem.cc/wp-content/themes/infinitygrid/js/arrive.min.js"></script>
<div class="singlewrap" id="content-wrapper">
<style>
@media (min-width: 1440px) {
  .container {
    width: 1300px;
  }
}
</style>
<script type="text/javascript" src="https://blog.gmem.cc/wp-content/themes/infinitygrid/js/page-single-before-content.js"></script>
<div class="wri_content_clear_both"><div class="blog_h1"><span class="graybg">简介</span></div>
<div class="blog_h2"><span class="graybg">什么是K8S</span></div>
<p>Kubernates（发音 / kubə'neitis /，简称K8S）是一个容器编排工具，使用它可以自动化容器的部署、扩容、管理。使用K8S可以将应用程序封装为容易管理、发现的逻辑单元。使用K8S你可以打造完全以容器为中心的开发环境。</p>
<p>K8S的特性包括：</p>
<ol>
<li>自动装箱：根据容器的资源需求和其他约束条件，自动部署容器到合适的位置，与此同时，不影响可用性。K8S可以混合管理关键负载、非关键负载并尽可能的有效利用资源</li>
<li>自我修复：当容器宕掉后自动重启它，当节点宕掉后重新调度容器。关闭不能正确响应自定义健康检查的容器，在容器准备好提供服务之前，不将他们暴露给客户端</li>
<li>水平扩容：手工（UI、命令行）或自动（根据CPU负载）进行自动的扩容/缩容</li>
<li>服务发现/负载均衡：不需要修改应用程序来使用第三方的服务发现机制，K8S为容器提供专有IP，同时为一组容器（类似Swarm中的Service）提供单一的DNS名称，应用程序可以基于DNS名称发现服务。K8S还内置的负载均衡支持</li>
<li>无缝滚动更新/回滚：支持逐步的将更新应用到程序或配置，与此同时监控程序的健康状况，避免同时杀死程序的所有实例。如果出现问题，K8S能够自动回滚更新</li>
<li>密码和配置管理：部署、更新应用程序的密码、配置信息时，不需要重新构建镜像，不需要在配置信息中暴露密码信息</li>
<li>存储编排：自动从本地磁盘、公有云、网络存储系统挂载存储系统</li>
<li>资源监控、访问并处理日志、调试应用、提供认证和授权功能……</li>
</ol>
<p>K8S提供了PaaS的简单性、IaaS的灵活性，支持在各基础设施提供商之间迁移。</p>
<p>尽管K8S提供了部署、扩容、负载均衡、日志、监控等服务，但是它并不是传统的PaaS平台：</p>
<ol>
<li>它不限制能支持的应用程序类型，不限制编程语言、SDK。只要应用能在容器中运行，就可以在K8S下运行</li>
<li> 不内置中间件（例如消息总线）、数据处理框架（例如Spark）、数据库、或者存储系统</li>
<li>不提供服务市场来下载服务</li>
<li>允许用户选择日志、监控、报警系统</li>
</ol>
<p>同时，很多PaaS平台可以运行在K8S之上，例如OpenShift、Deis，你可以在K8S上部署自己的PaaS平台，集成自己喜欢的CI环境，或者仅仅是部署容器镜像。</p>
<div class="blog_h2"><span class="graybg">什么是云原生</span></div>
<p>以Kubernetes为核心的技术生态圈，已经成为构建云原生架构的基石。</p>
<p>云原生架构没有权威的定义，但是基于这种架构的应用具有一系列的模式：</p>
<ol>
<li>代码库：每个可部署的应用程序，都有<span style="background-color: #c0c0c0;">独立的代码库</span>，可以在不同环境部署多个实例</li>
<li>明确的依赖：应用程序的依赖应该基于适当的工具（例如Maven、Bazel）明确的声明，<span style="background-color: #c0c0c0;">不对部署环境有任何依赖</span></li>
<li>配置注入：和发布环境（dev/stage/pdt）变化的<span style="background-color: #c0c0c0;">配置信息</span>，应该以操作系统级的环境变量<span style="background-color: #c0c0c0;">注入</span></li>
<li>后端服务：数据库、消息代理应视为附加资源，并在所有环境中同等看待</li>
<li>编译、发布、运行：构建一个可部署的<span style="background-color: #c0c0c0;">应用程序并将它与配置绑定</span>，根据这个组件/配置的组合来启动一个或者多个进程，这<span style="background-color: #c0c0c0;">两个阶段是严格分离</span>的</li>
<li>进程：应用程序运行一个或多个无状态进程，不共享任何东西 —— <span style="background-color: #c0c0c0;">任何状态存储于后端服务</span></li>
<li>端口绑定：应用程序是独立的，并通过<span style="background-color: #c0c0c0;">端口绑定（包括HTTP）导出任何服务</span></li>
<li>并发：并发通常通过<span style="background-color: #c0c0c0;">水平扩展</span>应用程序进程来实现</li>
<li>可任意处置：通过<span style="background-color: #c0c0c0;">迅速启动和优雅的终止进程</span>，可以最大程度上的实现鲁棒性。这些方面允许<span style="background-color: #c0c0c0;">快速弹性缩放、部署更改和从崩溃中恢复</span></li>
<li>开发/生产平等：通过保持开发、预发布和生产环境<span style="background-color: #c0c0c0;">尽可能的一致来实现持续交付和部署</span></li>
<li>日志：不管理<span style="background-color: #c0c0c0;">日志文件，将日志视为事件流</span>，允许执行环境通过<span style="background-color: #c0c0c0;">集中式服务收集、聚合、索引和分析事件</span></li>
<li>管理任务：管理性的任务，例如数据库迁移，应该在应用程序运行的<span style="background-color: #c0c0c0;">那个环境下，一次性的执行</span></li>
</ol>
<p>关键字：环境解耦、无状态、微服务。</p>
<div class="blog_h2"><span class="graybg">微服务架构选型</span></div>
<div class="blog_h3"><span class="graybg">K8S VS Spring Cloud</span></div>
<p>两者之间存在高度的功能重叠，例如服务发现、负载均衡。</p>
<div class="blog_h3"><span class="graybg">K8S VS Swarm</span></div>
<p>Swarm的功能比K8S要弱的多，可以实现简单的负载均衡、HA等特性，小规模部署可以使用。</p>
<div class="blog_h2"><span class="graybg">架构图</span></div>
<div class="blog_h3"><span class="graybg">整体架构</span></div>
<p><a href="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-1.png"><img class="aligncenter  wp-image-21073" src="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-1.png" alt="k8s-arch-1" width="823" height="474" /></a></p>
<div class="blog_h3"><span class="graybg">Master架构</span></div>
<p><a href="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-2.png"><img class="aligncenter  wp-image-21077" src="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-arch-2.png" alt="k8s-arch-2" width="828" height="433" /></a></p>
<div class="blog_h3"><span class="graybg">Node架构</span></div>
<p><a href="https://blog.gmem.cc/wp-content/uploads/2016/06/kube-arch-3.png"><img class="aligncenter  wp-image-21079" src="https://blog.gmem.cc/wp-content/uploads/2016/06/kube-arch-3.png" alt="kube-arch-3" width="823" height="457" /></a></p>
<p>&nbsp;</p>
<div class="blog_h2"><span class="graybg">网络架构</span></div>
<p>K8S网络包括CNI、Service网络、Ingress、DNS这几个方面的内容：</p>
<ol>
<li>CNI负责Pod到Pod的网络连接</li>
<li>Service网络负责Pod到Service的连接</li>
<li>Ingress负责外部到集群的访问</li>
<li>DNS负责解析集群内部域名</li>
</ol>
<p>取决于具体实现，节点可能可以直接访问CNI、Service的IP地址。</p>
<p>Pod<span style="background-color: #c0c0c0;">到集群外部的访问，基于SNAT实现</span>。</p>
<p>Pod在节点内部的连接，经典方案是veth pair + bridge，也就是说多个Pod会连接到同一个网桥上，实现互联。</p>
<p>Pod在节点之间的连接，经典方案是bridge、overlay，Calico等插件则基于虚拟路由。</p>
<p>Kubernetes容器网络由Kubenet或CNI插件负责，前者未来会被废弃。</p>
<div class="blog_h3"><span class="graybg">Kubenet</span></div>
<p>Kubenet是K8S早期的原生网络驱动，提供简单的单机容器网络。需要用Kubelet参数
			<span id="crayon-634f9a69b9c78352671881" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">plugin</span><span class="crayon-o">=</span><span class="crayon-v">kubenet</span></span></span>启用。</p>
<p>Kubenet本身不实现跨节点网络连接、网络策略，它通常和云提供商一起使用来实现路由规则配置、跨主机通信。Kubenet也用到一些CNI的功能，例如它基于CNI bridge插件创建<span style="background-color: #c0c0c0;">名为cbr0的Linux Bridge，为每个容器创建一对veth pair并连接到cbr0网桥</span>。</p>
<p>Kubenet在CNI插件的基础上拓展了很多功能：</p>
<ol>
<li>基于host-local IP地址管理插件，为Pod分配IP地址并定期释放分配而未使用的IP</li>
<li>设置sysctl的net.bridge.bridge-nf-call-iptables=1</li>
<li>为Pod的IP设置SNAT（MASQUERADE），以允许Pod 访问外部网络</li>
<li>开启Linux Bridge的hairpin、混杂模式，允许Pod访问自己所在的Service IP</li>
<li>HostPort管理、设置端口映射</li>
<li>带宽控制。可以通过kubernetes.io/ingress-bandwith、kubernetes.io/egress-bandwith来配置Pod网络带宽限制</li>
</ol>
<p>Kubenet会使用bridge、lo、host-local等几个CNI插件，默认在/opt/cni/bin中搜索这些插件的二进制文件。你可以通过--network-plugin-dir参数定制搜索位置。此外Kubenet来回去/etc/cni/net.d中搜索CNI配置文件。</p>
<p>支持通过Kubelet参数--network-plugin-mtu<span style="background-color: #c0c0c0;">定制MTU，支持限制带宽</span>。这两个特性是Kubenet<span style="background-color: #c0c0c0;">不能被CNI完全代替</span>的原因。</p>
<div class="blog_h3"><span class="graybg">CNI</span></div>
<p>CNI是容器网络的标准，试图通过一段JSON来描述容器网络配置。CNI是K8S和底层网络插件之间的抽象层。</p>
<p>CNI包含以下接口：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9c88784519389" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c88784519389-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9c88784519389-37">37</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9c88784519389-1"><span class="crayon-r">type</span><span class="crayon-h"> </span><span class="crayon-e">CNI</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">AddNetworkList</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">types</span><span class="crayon-sy">.</span><span class="crayon-v">Result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CheckNetworkList</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-4"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">DelNetworkList</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-5"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">GetNetworkListCachedResult</span><span class="crayon-sy">(</span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">types</span><span class="crayon-sy">.</span><span class="crayon-v">Result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">GetNetworkListCachedConfig</span><span class="crayon-sy">(</span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">AddNetwork</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">types</span><span class="crayon-sy">.</span><span class="crayon-v">Result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CheckNetwork</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-10"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">DelNetwork</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">error</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-11"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">GetNetworkCachedResult</span><span class="crayon-sy">(</span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">types</span><span class="crayon-sy">.</span><span class="crayon-v">Result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">GetNetworkCachedConfig</span><span class="crayon-sy">(</span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">rt *</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">RuntimeConf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ValidateNetworkList</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfigList</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ValidateNetwork</span><span class="crayon-sy">(</span><span class="crayon-e">ctx </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">Context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">net *</span><span class="crayon-v">NetworkConfig</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">error</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-16"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-18"><span class="crayon-r">type</span><span class="crayon-h"> </span><span class="crayon-e">RuntimeConf</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ContainerID </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">NetNS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">IfName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Args</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// A dictionary of capability-specific data passed by the runtime</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// to plugins as top-level keys in the 'runtimeConfig' dictionary</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// of the plugin's stdin data.&nbsp;&nbsp;libcni will ensure that only keys</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// in this map which match the capabilities of the plugin are passed</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// to the plugin</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CapabilityArgs</span><span class="crayon-h"> </span><span class="crayon-e">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-t">interface</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-29">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// DEPRECATED. Will be removed in a future release.</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CacheDir </span><span class="crayon-t">string</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-32"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-33">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-34"><span class="crayon-r">type</span><span class="crayon-h"> </span><span class="crayon-e">NetworkConfig</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e ">Network *</span><span class="crayon-v">types</span><span class="crayon-sy">.</span><span class="crayon-e">NetConf</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c88784519389-36"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Bytes</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span></div><div class="crayon-line" id="crayon-634f9a69b9c88784519389-37"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0109 seconds] -->

<p>AddNetwork负责在创建容器时，进行网络接口的配置；DelNetwork则在删除容器时，清理掉网络接口。参数NetworkConfig是网络配置信息，RuntimeConf则是容器运行时传入的网络命名空间信息。</p>
<p>CNI配置编写在如下形式的JSON文件中：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9c8e277822306" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JSON</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9c8e277822306-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9c8e277822306-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-1"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"mynet"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 使用bridge CNI插件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">type</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"bridge"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">bridge</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"cni0"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">ipam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 基于host-local插件进行IP地址管理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">type</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"host-local"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">subnet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"10.0.0.0/16"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">routes</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-s">"dst"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"0.0.0.0/0"</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69b9c8e277822306-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9c8e277822306-14"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<p>上述配置文件，默认需要存在/etc/cni/net.d目录下，并且命名为*.conf，对应的插件二进制文件默认需要存放在/opt/cni/bin下。 </p>
<p>在K8S中启用基于CNI的网络插件，需要配置Kubelet参数
			<span id="crayon-634f9a69b9c93033606918" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">plugin</span><span class="crayon-o">=</span><span class="crayon-v">cni</span></span></span>。CNI配置文件位置通过参数
			<span id="crayon-634f9a69b9c97912946535" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">cni</span><span class="crayon-o">-</span><span class="crayon-v">conf</span><span class="crayon-o">-</span><span class="crayon-v">dir</span></span></span>配置，如果目录中存在多个配置文件则仅仅取第一个。CNI插件二进制文件位置通过
			<span id="crayon-634f9a69b9c9b598431116" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">cni</span><span class="crayon-o">-</span><span class="crayon-v">bin</span><span class="crayon-o">-</span><span class="crayon-v">dir</span></span></span>配置。</p>
<div class="blog_h1"><span class="graybg">K8S对象</span></div>
<p>K8S对象是指运行在K8S系统中的持久化实体，K8S使用这些实体来表示你的应用集群的状态。例如：</p>
<ol>
<li>哪些容器化应用程序在执行，在何处（Node）执行</li>
<li>上述应用程序可用的资源情况</li>
<li>和应用程序行为有关的策略，例如重启策略、升级策略、容错策略</li>
</ol>
<p>通过创建一系列对象，你可以告诉K8S，你的集群的负载是什么样的，所谓集群的期望状态（desired state）。</p>
<p>要创建/修改/删除K8S对象，可以调用Kubernetes API。提供命令行kubectl可以间接的调用此API，你也可以在程序中调用这些API，目前支持Go语言。</p>
<p>K8S对象包括：</p>
<ol>
<li>Pod、Service、Volume、Namespace等基本对象</li>
<li>ReplicaSet、Deployment、StatefulSet、DaemonSet、Job等高级对象，这些高级对象在上述基本对象之上构建，并且提供了额外功能、便利化功能</li>
</ol>
<p>本章不会一一解释这些不同类型的对象。</p>
<div class="blog_h2"><span class="graybg">规格和状态</span></div>
<p>任何K8S对象都有两个内嵌的字段：规格、状态。前者由你提供，声明对象期望状态（所谓对象的期望状态即集群的期望状态）。后者则表示某一时刻对象的实际状态，此状态由K8S更新，K8S控制平面会积极的管理对象的状态，使其尽可能满足规格。</p>
<p>例如，Kubernetes Deployment是描述运行在集群中的一个应用程序的K8S对象。你创建一个Deployment时，可能在规格中声明你需要3个应用程序的Replica。K8S会读取规格并启动3个应用实例，如果一段时间后宕掉1个实例，则K8S会检测到Spec和Status之间的不同，进而启动一个新的实例代替宕掉的那个。</p>
<div class="blog_h2"><span class="graybg">对象规格</span></div>
<p>调用K8S API创建对象时，你需要提供一个JSON格式的规格说明，其中包含期望状态和一些基本信息（例如应用的名称）。</p>
<p>通过kubectl创建对象时，你需要提供一个YML文件，kubectl会自动将其转换为JSON格式。</p>
<p>下面是对象规格（YML）的一个示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ca0981211596" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">nginx-deployment.yaml</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca0981211596-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9ca0981211596-37">37</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-1"><span class="crayon-c"># 如果K8S版本小于1.8则使用 apps/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-2"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1beta2</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-4"><span class="crayon-c"># 对象类型</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-5"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-6">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-7"><span class="crayon-c"># 对象元数据，唯一的识别对象，字段包括name、UID、namespace</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-8"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 名字通常由客户端提供，每一个对象类型内部，名字不得重复。在资源URL中名字用于引用对象，例如/api/v1/pods/some-name</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 名字应该仅仅包含小写字母、数字、-、.这几类字符</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># UID由K8S自动生成，全局唯一</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># namespace 指定对象所属的名字空间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-15"><span class="crayon-c"># 对象规格</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-16"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 标签选择器</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: nginx</span><span class="">:1.7.9</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 端口名称，可以被Service引用</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: web</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca0981211596-36"><span class="crayon-c"># 标签</span></div><div class="crayon-line" id="crayon-634f9a69b9ca0981211596-37"><span class="crayon-s ">labels</span><span class="">: ...</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<p>基于上述规格创建对象的命令示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ca5891146677" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ca5891146677-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ca5891146677-1"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">blog</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-e">.yaml</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">record</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h2"><span class="graybg">名字空间</span></div>
<p>K8S支持在一个物理集群上，创建多个虚拟集群，这些虚拟集群称为名字空间。名字空间为资源名称限定了作用域，同一名字空间内部名字不能重复，但是跨越名字空间则不受限制。</p>
<p>可以考虑使用名字空间的场景：</p>
<ol>
<li>当跨越多个团队/项目的人员共享一套集群时，可以考虑使用名字空间机制。如果使用集群的人员仅仅在数十个级别，不需要使用名字空间</li>
<li>希望利用K8S的资源配额机制，在名字空间之间划分集群资源</li>
<li>在未来版本的K8S中，同一名字空间中的对象将具有一致的默认范围控制策略</li>
</ol>
<p>如果两个资源仅仅有些许的不同，例如应用的两个版本，则不需要利用名字空间隔离。考虑使用标签（Label）来在名字空间内部区分这些资源。</p>
<p>大部分K8S资源（Pod、Service、Replication Controller...）都位于名字空间中。但是名字空间本身（也是资源）则不位于任何名字空间中。事件（Event）则可能位于、也可能不位于名字空间中，取决于事件的源对象。</p>
<div class="blog_h3"><span class="graybg">查看名字空间</span></div>
<p>执行下面的命令可以查看集群中现有的名字空间：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ca9745018598" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ca9745018598-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca9745018598-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ca9745018598-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ca9745018598-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ca9745018598-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ca9745018598-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">namespaces</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca9745018598-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATUS&nbsp;&nbsp;&nbsp;&nbsp;AGE</span></div><div class="crayon-line" id="crayon-634f9a69b9ca9745018598-3"><span class="crayon-c"># default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Active&nbsp;&nbsp;&nbsp;&nbsp;1d</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ca9745018598-4"><span class="crayon-c"># kube-system&nbsp;&nbsp; Active&nbsp;&nbsp;&nbsp;&nbsp;1d</span></div><div class="crayon-line" id="crayon-634f9a69b9ca9745018598-5"><span class="crayon-c"># kube-public&nbsp;&nbsp; Active&nbsp;&nbsp;&nbsp;&nbsp;1d </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>上述命令输出了3个名字空间：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">名字空间</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>默认名字空间，没有显式指定名字空间的对象位于此空间</td>
</tr>
<tr>
<td>kube-system</td>
<td>由K8S系统创建的对象</td>
</tr>
<tr>
<td>kube-public</td>
<td>自动创建、可以被任何用户（包括未进行身份验证的）访问的名字空间。此名字空间基本上是保留供集群使用的，因为某些资源需要公开的、跨越整个集群的访问</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">指定名字空间</span></div>
<p>要在单个命令请求中，指定名字空间，可以：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cae363689540" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cae363689540-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cae363689540-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cae363689540-1"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">ns</span><span class="crayon-o">-</span><span class="crayon-e">dev </span><span class="crayon-e">run </span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-e">nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cae363689540-2"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">ns</span><span class="crayon-o">-</span><span class="crayon-e">dev </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>要永久的为某个上下文切换默认名字空间，可以：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cb2216851610" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cb2216851610-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cb2216851610-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cb2216851610-1"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-i">context</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-v">current</span><span class="crayon-o">-</span><span class="crayon-v">context</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">ns</span><span class="crayon-o">-</span><span class="crayon-e">pdt</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cb2216851610-2"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">namespace</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c"># 验证设置</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<div class="blog_h3"><span class="graybg">名字空间和DNS </span></div>
<p>当你创建一个服务时，相应的DNS条目自动创建。此条目的默认格式是：
			<span id="crayon-634f9a69b9cb6747533972" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-v">svc</span><span class="crayon-sy">.</span><span class="crayon-v">cluster</span><span class="crayon-sy">.</span><span class="crayon-v">local</span></span></span>。如果容器仅仅使用来引用服务，则解析到当前名字空间。这种特性可以方便的在多个名字空间（开发、测试、生产）中使用完全相同的配置信息。如果需要跨名字空间引用服务，则必须使用FQDN。</p>
<div class="blog_h2"><span class="graybg">标签和选择器</span></div>
<p>所谓标签（Label）就是用户自定义的、关联到对象的键值对，这些标签和K8S的核心系统没有意义。你可以使用标签来管理、选择对象的子集。</p>
<p>你可以在创建对象的时候设置标签，也可以后续添加、修改标签。对于单个对象来说，标签的键必须是唯一的。</p>
<p>K8S会对标签进行索引/反向索引，以便对标签进行高效的查询、监控，在UI、CLI中对输出进行分组、排序。</p>
<div class="blog_h3"><span class="graybg">动机</span></div>
<p>标签提供一种松散耦合的风格，让用户自由的映射他们的组织结构到K8S对象，而不需要客户端记住这些映射关系。</p>
<p>服务部署、批处理流水线，常常都是多维的实体（多分区/部署、多个发行条线、多层、每层多个微服务）。对这些实体进行管理，常需要横切性的操作——打破严格的层次性封装，这些层次可能由基础设施死板的规定。</p>
<p>样例标签集：</p>
<ol>
<li>区分发行条线：{ "release" : "stable", "release" : "canary" }</li>
<li>区分运行环境：{ "environment" : "dev", "environment" : "qa", "environment" : "production" }</li>
<li>区分架构层次：{ "tier" : "frontend", "tier" : "backend", "tier" : "cache" }</li>
<li>区分分区： { "partition" : "customerA", "partition" : "customerB" }</li>
<li>区分Track： { "track" : "daily", "track" : "weekly" }</li>
</ol>
<div class="blog_h3"><span class="graybg">标签格式</span></div>
<p>标签的键，可以由两段组成：可选的前缀和名称，它们用 / 分隔：</p>
<ol>
<li>名称部分必须63-字符，支持大小写字母、数字、下划线、短横线、点号</li>
<li>前缀如果存在，则必须是DNS子域名 —— 一系列以点号分隔的DNS标签，最后加上一个  / </li>
<li>如果前缀被省略，则暗示标签是用户私有的</li>
<li>前缀 kubernetes.io/ 为K8S核心组件保留</li>
</ol>
<div class="blog_h3"><span class="graybg">标签选择器</span></div>
<p>一系列对象常常具有相同的标签。利用标签选择器，客户端可以识别一组对象。标签选择器是K8S提供的核心分组原语。</p>
<p>目前K8S API提供两种标签选择器：</p>
<ol>
<li>equality-based。操作符=、==（和=同义）、!=。示例：environment = production,tier != frontend</li>
<li>set-based。操作符in、notin、exists。示例：environment in (production, qa),tier notin (frontend, backend)</li>
</ol>
<p>如果有多个选择器需要匹配，则使用逗号（作用类似于&amp;&amp;）分隔。</p>
<p>NULL选择器匹配空集，空白选择器则匹配集合中所有对象。</p>
<div class="blog_h3"><span class="graybg">标签相关API</span></div>
<p>LIST、WATCH之类的操作可以指定标签选择器，以过滤对象。</p>
<p>基于CLI的例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cbb401265585" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cbb401265585-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cbb401265585-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cbb401265585-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cbb401265585-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">environment</span><span class="crayon-o">=</span><span class="crayon-v">production</span><span class="crayon-sy">,</span><span class="crayon-v">tier</span><span class="crayon-o">=</span><span class="crayon-e">frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cbb401265585-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-s">'environment in (production),tier in (frontend)'</span></div><div class="crayon-line" id="crayon-634f9a69b9cbb401265585-3"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-s">'environment,environment notin (frontend)'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<p>某些K8S对象（Service、复制控制器）使用标签选择器指定关联的对象（例如Pod）。例如，作为服务目标的Pods是通过标签选择器指定的。replicationcontroller需要管理的pod生产，也是通过标签指定的。对象配置片断示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cc0855471499" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cc0855471499-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc0855471499-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cc0855471499-1"><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc0855471499-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: redis</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>ReplicaSet、Deployment、DaemonSet、Job等对象，支持set-based风格的标签选择器，来指定其需求：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cc4937492984" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cc4937492984-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc4937492984-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cc4937492984-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc4937492984-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9cc4937492984-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc4937492984-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cc4937492984-1"><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc4937492984-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cc4937492984-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: redis</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc4937492984-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cc4937492984-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-s ">key</span><span class="">: tier</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">operator</span><span class="">: In</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">values</span><span class="">: [cache]</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc4937492984-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-s ">key</span><span class="">: environment</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">operator</span><span class="">: NotIn</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">values</span><span class="">: [dev]</span><span class="crayon-o">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<div class="blog_h2"><span class="graybg">注解 </span></div>
<p>除了标签以外，你还可以使用注解（Annotations）来为K8S对象附加非识别性（non-identifying）元数据。客户端可以通过API获得这些元数据。</p>
<p>注意注解和标签不一样，后者可以用来识别、选择对象，前者则不能。此外注解的值大小没有限制。</p>
<p>注解也是键值对形式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cc8392594921" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cc8392594921-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc8392594921-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cc8392594921-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cc8392594921-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cc8392594921-1"><span class="crayon-s">"annotations"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc8392594921-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"key1"</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"value1"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9cc8392594921-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"key2"</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"value2"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cc8392594921-4"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<div class="blog_h1"><span class="graybg">节点</span></div>
<p>节点是K8S中的Worker机器，之前被叫做minion。节点可以是物理机器，也可以是VM。节点上运行着一些服务，运行Pod需要这些服务，这些服务被Master组件管理。运行在节点上的服务包括Docker、kubelet、kube-proxy等。</p>
<p>节点应该是x86_64（amd64）架构的Linux系统。其它架构或系统有可能支持K8S。</p>
<div class="blog_h2"><span class="graybg">节点状态</span></div>
<p>以下几类信息用于描述节点的状态：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">字段类别</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>Addresses</td>
<td>
<p>这些字段的用法取决于你使用的云服务，或者裸金属的配置：</p>
<p>HostName：由节点的内核报告，可以由kubelet的--hostname-override参数覆盖<br />ExternalIP：可以被集群外部访问的节点IP<br />InternalIP：仅仅能在集群内部访问的节点IP</p>
</td>
</tr>
<tr>
<td>Condition</td>
<td>
<p>这些字段描述运行中节点的状态信息：</p>
<p>OutOfDisk：如果为True则意味着节点上没有足够空间供新Pod使用<br />Ready：如果为True则意味着节点状态健康，准备好接受Pods。如果为False则意味着节点不监控并且不接受Pods。如果为Unknown则意味着节点控制器已经40s没有听到节点的心跳了<br />MemoryPressure：如果为True则节点内存方面存在压力<br />DiskPressure：如果True则节点磁盘方面存在压力，也就是说磁盘空间不足<br />NetworkUnavailable：如果为True则意味着节点的网络配置不正确</p>
<p>节点的状态以JSON形式表示，例如：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ccc321563670" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ccc321563670-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ccc321563670-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ccc321563670-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ccc321563670-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ccc321563670-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ccc321563670-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ccc321563670-1"><span class="crayon-s">"conditions"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ccc321563670-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9ccc321563670-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"kind"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"Ready"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ccc321563670-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"status"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"True"</span></div><div class="crayon-line" id="crayon-634f9a69b9ccc321563670-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ccc321563670-6"><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>如果节点的Ready状态为False/Unknown，并且持续时间大于pod-eviction-timeout（默认5分钟），则kube-controller-manager会接收到一个argument，该节点上所有Pods将被节点控制器调度以删除 </p>
<p>某些情况下节点不可达，APIServer无法与其上运行的kubelet通信。这样Pods删除信息无法传递到被分区（partitioned，网络被隔离的）节点，因而知道网络通信恢复前，其上的Pods会继续运行</p>
<p>在1.5-版本中，节点控制器会强制的从APIServer中删除不可达Pods，1.5+版本后只有在确认这些Pods已经从集群中停止运行后才进行删除。这些运行在不可达节点上的Pod的状态可能为Terminating或者Unknown</p>
<p>某些情况下，K8S无法在基础设施层推断节点是否永久的离开了集群，管理员可能需要手工进行节点移除</p>
<p>移除节点将导致其上的所有Pod对象从APIServer上删除</p>
<p>&nbsp;</p>
<p>从1.8开始K8S引入了一个Alpha特性，可以自动创建代表Condition的taints。要启用此特性，为APIServer、控制器管理器、调度器提供参数：</p>
<p style="padding-left: 60px;"><em>--feature-gates=...,TaintNodesByCondition=true</em></p>
<p>当TaintNodesByCondition启用后，调度器会忽略节点的Conditions，代之以查看节点的taints、Pod的toleration。你可以选择旧有的调度模型，或者使用新的更加灵活的调度模型：</p>
<ol>
<li>没有tolerations（容忍）的Pod基于旧模型调度</li>
<li>能够容忍特定节点taints（污染）的Pod，则可以在污染节点上调度</li>
</ol>
</td>
</tr>
<tr>
<td>Capacity</td>
<td>描述节点上可用的资源，包括CPU、内存、最多可以在其上调度的Pod数量 </td>
</tr>
<tr>
<td>Info</td>
<td>一般性信息，例如内核版本、K8S版本（kubelet/kube-proxy）、Docker版本</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">节点管理</span></div>
<p>与Node/Service不同，节点不是K8S创建的，它常常由外部云服务（例如Google Compute Engine）创建，或者存在于你的物理机/虚拟机池子中。K8S中创建一个节点，仅仅是创建代表此节点的对象。在创建节点对象后，K8S会验证其有效性，例如下面的节点配置信息：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cd2561312206" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cd2561312206-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd2561312206-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cd2561312206-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd2561312206-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9cd2561312206-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd2561312206-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9cd2561312206-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd2561312206-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9cd2561312206-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd2561312206-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cd2561312206-1"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd2561312206-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"kind"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"Node"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9cd2561312206-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"apiVersion"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"v1"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd2561312206-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"metadata"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9cd2561312206-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"10.240.79.157"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd2561312206-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"labels"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9cd2561312206-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"my-first-k8s-node"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd2561312206-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9cd2561312206-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd2561312206-10"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>执行创建后，K8S会基于metadata.name字段来检查节点的健康状态。如果节点是有效的（所有必须的服务在其上运行）则它有资格运行Pod，否则它会被任何集群活动排除在外，知道它变为有效状态。 </p>
<p>除非显式删除，K8S会一致维护你创建的节点对象，并且周期性的检查其健康状态。</p>
<p>目前和节点接口交互的组件有三个：节点控制器、Kubelet、Kubectl。</p>
<div class="blog_h2"><span class="graybg">节点控制器</span></div>
<p>节点控制器属于K8S管理组件，可以管理节点的方方面面：</p>
<ol>
<li>当节点注册时，给节点分配一个CIDR块（如果CIDR分配打开）</li>
<li>在内部维护一个最新的节点列表。在云环境下，节点控制器会调用云提供商的接口，判断不健康节点的VM是否仍然可用，如果答案是否则则节点控制器从子集的节点列表中删除不健康节点</li>
<li>监控节点的健康状态。当节点不可达（节点由于某种原因不再响应心跳，例如宕机，默认40s）时，更新NodeStatus的NodeReady状态为ConditionUnknown。如果节点持续处于不可达状态（默认5m），则优雅的清除（Terminate）节点上所有Pods。控制器每隔--node-monitor-period秒检查节点状态</li>
<li>从1.6开始，节点控制器还负责清除运行在具有NoExecute taints节点上的Pods（如果Pod不容忍NoExecutes）</li>
</ol>
<p>从1.4开始，K8S更新了节点控制器的逻辑，当Master节点本身网络出现问题导致大量节点不可达的场景被优化处理。在决定清除一个Pods时，节点控制器会查看集群中所有节点的状态。</p>
<p>大部分情况下，节点控制器限制了节点清除的速度。参数--node-eviction-rate默认为0.1，也就是每10秒最多从单个节点清除一个Pod。</p>
<p>当给定可用性区域（availability zone，集群可能跨越云服务的多个可用性区域，例如北美、亚太）中节点变得不健康时，节点清除行为会有改变。 节点控制器会计算可用性区域中不健康（NodeReady=ConditionUnknown or ConditionFalse）节点的百分比：</p>
<ol>
<li>如果此比值不小于--unhealthy-zone-threshold（默认0.55）则清除速率降低。降低到--secondary-node-eviction-rate（默认0.01）</li>
<li>如果集群规模较小（小于--large-cluster-size-threshold，默认50）则清除行为停止</li>
</ol>
<p>之所以按可用性区域来决定上述行为，是因为某些区域可能和Master之间形成网络分区，另外一些这和Master之间保持连通。</p>
<p>跨越可用性区域分布节点的关键原因是，当整个区域不可用时，工作负载可以迁移到健康的区域中。</p>
<div class="blog_h2"><span class="graybg">节点自动注册</span></div>
<p>当为Kubelet提供参数--register-node=true（默认）时，Kubelet会尝试自动的到API服务器上注册自己。自动注册相关的参数：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 35%; text-align: center;">参数</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>--kubeconfig</td>
<td>用于包含自己的身份验证信息的文件路径</td>
</tr>
<tr>
<td>--cloud-provider</td>
<td>指定云服务提供商信息，用于读取关于节点本身的元数据</td>
</tr>
<tr>
<td>--register-node</td>
<td>自动注册自己</td>
</tr>
<tr>
<td>--register-with-taints</td>
<td>使用指定的taints注册自己，多个taints用逗号分隔：=:,=:</td>
</tr>
<tr>
<td>--node-ip</td>
<td>节点的IP地址</td>
</tr>
<tr>
<td>--node-labels</td>
<td>注册时附加到节点对象的标签集</td>
</tr>
<tr>
<td>--node-status-update-frequency</td>
<td>节点向Master提交自身状态的间隔</td>
</tr>
</tbody>
</table>
<p>当前，Kubelet有权创建/修改任何节点资源，但是通常它仅应该修改自己的。</p>
<div class="blog_h2"><span class="graybg">手工节点管理</span></div>
<p>作为集群管理员，你可以随时创建、修改节点对象。你可以设置kubelet标记--register-node=false，仅仅允许手工的管理。</p>
<p>你可以管理节点的资源，例如设置标签、标记其为unschedulable：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cd8826795596" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cd8826795596-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cd8826795596-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cd8826795596-1"><span class="crayon-c"># 设置节点为unschedulable</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cd8826795596-2"><span class="crayon-e">kubectl </span><span class="crayon-i">cordon</span><span class="crayon-h"> </span><span class="crayon-v">$NODENAME</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>标记节点为unschedulable可以禁止新的Pods被分配到节点上，但是对节点上现有的Pod则没有影响。</p>
<p>注意DaemonSet控制器创建的Pod跳过了K8S的调度器，因而unschedulable标记为其无意义。</p>
<div class="blog_h2"><span class="graybg">节点容量</span></div>
<p>节点的容量（Capacity，CPU数量、内存量）属于节点对象属性的一部分。通常节点自我注册时会提供容量信息。如果你手工的注册节点，则必须提供容量信息。</p>
<p>K8S调度器会确保节点拥有足够的资源来运行分配给它的所有Pods，它会检查请求在节点上启动的容器（仅限kubelet启动的）所需总资源不大于节点的容量。</p>
<p>你可以显式的为非Pod进程保留节点资源：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cdc188614740" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9cdc188614740-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cdc188614740-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-1"><span class="crayon-c"># 作为占位符的Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-3"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: resource-reserver</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: sleep-forever</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: gcr.io/google_containers/pause</span><span class="">:0.8.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 请求保留的资源数量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cdc188614740-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">cpu</span><span class="">: 100m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cdc188614740-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">memory</span><span class="">: 100Mi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h2"><span class="graybg">节点通信</span></div>
<p>本节讨论Master（准确的说是APIServer）和K8S集群之间的通信。 </p>
<div class="blog_h3"><span class="graybg">集群 → Master</span></div>
<p>集群到Master的通信路径，总是在APIServer处终结，因为其它的Master组件均不暴露远程接口。</p>
<p>在典型配置上，API服务器基于HTTPS协议监听443端口，并且启用1-N种客户端验证、授权机制。</p>
<p>节点应该被预先分配集群的根证书，以便能够使用有效的客户端证书链接到APIServer。</p>
<p>利用服务账户（Service Account），Pod可以和APIServer安全的通信，根据服务账户的配置，K8S会自动把根证书、不记名令牌（bearer token ）注入到Pod中。所有名字空间中的K8S服务都配备了一个虚拟IP，通过kube-proxy重定向到APIServer上的HTTPS端点。</p>
<p>Master组件和APIServer基于非安全端口通信，此端口通常仅仅暴露在Master机器的localhost接口上。</p>
<div class="blog_h3"><span class="graybg">Master → 集群</span></div>
<p>从Master（APIServer）到集群的通信路径主要包括两条：</p>
<ol>
<li>从APIServer到运行在各节点上的kubelet进程。这些通信路径用于：
<ol>
<li>抓取Pod的日志</li>
<li>Attach到（利用kubectl）到运行中的Pod</li>
<li>提供Kubelet的端口转发功能</li>
</ol>
</li>
<li>从APIServer到任何节点/Pod/Service，基于APIServer的代理功能</li>
</ol>
<p>对于第1类通信路径，APIServer默认不会校验kubelet的服务器端证书，因而存在中间人攻击的可能性。使用--kubelet-certificate-authority标记可以为APIServer提供一个根证书，用于验证kubelet的服务器证书。</p>
<p>对于第2类通信路径，默认使用HTTP连接，不验证身份或加密。</p>
<div class="blog_h1"><span class="graybg">Master组件</span></div>
<p>这类组件构成了K8S集群的控制平面（Plane），负责集群的全局性管理，例如调度、检测/响应集群事件。</p>
<p>Master组件可以运行在集群的任何节点上，你可以创建多Master的集群以获得高可用性。</p>
<p>Master组件主要包括kube-apiserver、kube-controller-manager、kube-scheduler</p>
<div class="blog_h2"><span class="graybg">kube-apiserver</span></div>
<p>暴露K8S的API，作为控制平面的前端。此服务器本身支持水平扩容。</p>
<div class="blog_h2"><span class="graybg">etcd</span></div>
<p>一个分布式的键值存储，K8S集群的信息全部存放在其中。要注意做好etcd的备份。</p>
<div class="blog_h2"><span class="graybg">kube-controller-manager</span></div>
<p>运行控制器。控制器是一系列执行集群常规任务的后台线程，控制器包括：</p>
<ol>
<li>节点控制器：检测节点宕机并予以响应</li>
<li>复制控制器：为系统中每个复制控制器对象维护正确数量的Pod</li>
<li>端点控制器：产生端点对象</li>
<li>服务账号/令牌控制器：为新的名字空间创建默认账户、API访问令牌</li>
</ol>
<div class="blog_h2"><span class="graybg">cloud-controller-manager</span></div>
<p>运行和云服务提供商交互的控制器，1.6引入的试验特性。CCM和其它Master组件在一起运行，它也可以作为Addon启动（运行在K8S的上层）。</p>
<p>CCM的设计初衷是，让云服务商相关的代码和K8S核心解耦，相互独立演进。不使用CCM时的K8S集群架构如下：</p>
<p><img class="aligncenter  wp-image-17295" src="https://blog.gmem.cc/wp-content/uploads/2016/06/pre-ccm-arch.png" alt="pre-ccm-arch" width="787" height="322" /></p>
<p>上述架构中，云服务和Kubelet、APIServer、KCM进行交互，实现集成，交互复杂，不符合最少知识原则。</p>
<p>使用CCM后，K8S集群架构变为：</p>
<p><img class="aligncenter size-large wp-image-17297" src="https://blog.gmem.cc/wp-content/uploads/2016/06/post-ccm-arch-1024x443.png" alt="post-ccm-arch" width="710" height="307" /></p>
<p>新的架构中，CCM作为一个Facade，统一负责和云服务的交互。CCM分离了部分KCM的功能，在独立进程中运行它们，分离的原因是这些功能是依赖于具体云服务的：节点控制器、 卷控制器、路由控制器、服务控制器。在1.8版本中CCM运行前述控制器中的：</p>
<ol>
<li>节点控制器：通过从云服务获取运行在集群中的节点信息，来初始化节点对象。添加云服务特定的Zone/Regin标签、云服务特定的节点实例细节，获取节点网络地址和主机名，在节点不可用时调用云服务确认节点是否被删除（如果是则级联删除节点对象）</li>
<li>路由控制器：在云服务中配置路由，确保不同节点中运行的容器能够相互通信，仅用于GCE集群</li>
<li>服务控制器：监听服务的创建/更新/删除事件。它会根据K8S中当前服务的状态来配置云服务的负载均衡器</li>
</ol>
<p>CCM还运行一个PersistentVolumeLabels控制器，用于在PersistentVolumes（GCP/AWS提供）上设置Zone/Regin标签。卷控制器没有作为CCM的一部分是刻意的设计，主要原因是K8S已经在剥离云服务相关的卷逻辑上做了很多工作。</p>
<p>CCM还包含了云服务特定的Kubelet功能。在引入CCM之前，Kubelet负责利用云服务特定的信息（例如IP、Regin/Zone标签、节点实例类型）初始化节点，引入CCM之后这些职责被转移。在新架构中，Kubelet初始化节点时不知晓云服务特定的信息，但是它会给节点添加一个taint，从而将节点标记为不可调度的。直到CCM初始化了云服务特定的信息，taint才被移除，节点可以被调度。</p>
<p>CCM基于Go开发，暴露了一系列的接口（CloudProvider），允许任何云服务实现这些接口</p>
<div class="blog_h3"><span class="graybg">CloudProvider</span></div>
<p>此接口定义在pkg/cloudprovider/cloud.go，包含的功能有：</p>
<ol>
<li>管理第三层（TCP）负载均衡器</li>
<li>管理节点实例（云服务提供的）</li>
<li>管理网络路由</li>
</ol>
<p>不是所有功能都需要实现，取决于K8S组件的标记如何设置。运行K8S也不一定需要此接口的实现，比如在裸金属上运行时。</p>
<div class="blog_h2"><span class="graybg">kube-scheduler</span></div>
<p>监控新创建的、没有分配到Node的Pod，然后选择适当的Node供其运行。</p>
<div class="blog_h2"><span class="graybg">addons</span></div>
<p>加载项是实现了集群特性的Pod和服务，这些Pod可以被Deployments、ReplicationControllers等管理。限定了名字空间的加载项在名字空间kube-system中创建。加载项管理器创建、维护加载项资源。常见加载项如下：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 15%; text-align: center;">加载项</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>DNS</td>
<td>
<p>所有集群都需要此加载项，以提供集群DNS服务。此加载项为K8S服务提供DNS记录</p>
<p>K8S启动的容器自动使用此DNS服务</p>
</td>
</tr>
<tr>
<td>Dashboard</td>
<td>此加载项是一个一般用途的Web客户端，用户可以基于此加载项来管理集群、管理或者针对K8S集群中运行的应用程序</td>
</tr>
<tr>
<td>CRM</td>
<td>容器资源监控（Container Resource Monitoring）在中心数据库中记录容器的度量信息，并提供查看这些信息的UI</td>
</tr>
<tr>
<td>CIL</td>
<td>集群级别日志（Cluster-level Logging）收集容器日志，集中保存，并提供搜索/查询接口</td>
</tr>
</tbody>
</table>
<div class="blog_h1"><span class="graybg">节点组件</span></div>
<p>这些组件可以运行在集群中的任何节点上，它们维护运行中的Pods、提供K8S运行时环境。主要包括kubelet、kube-proxy。</p>
<div class="blog_h2"><span class="graybg">kubelet</span></div>
<p>主要的节点代理程序，监控分配到（通过APIServer或本地配置文件）当前节点的Pod，并且：</p>
<ol>
<li>挂载Pod所需的卷</li>
<li>下载Pod的Secrets</li>
<li>通过Docker或rkt运行Pod的容器</li>
<li>周期性执行任何请求的容器存活探针</li>
<li>将Pod状态反馈到系统的其他部分</li>
<li>将节点状态反馈到系统的其它部分</li>
</ol>
<div class="blog_h2"><span class="graybg">kube-proxy</span></div>
<p>在每个节点上映射K8S的网络服务的代理。提供在宿主机上维护网络规则、执行连接转发，来实现K8S服务抽象。</p>
<p>最早的版本完全在用户空间实现，性能较差。从1.1开始，K8S实现了基于Iptable代理模式的kube-proxy，从1.8开始，添加基于IPVS实现的kube-proxy。</p>
<div class="blog_h2"><span class="graybg">docker/rkt</span></div>
<p>用于运行容器。</p>
<div class="blog_h2"><span class="graybg">supervisord</span></div>
<p>轻量级的监控系统，用于确保kubelet、docker持续运行（宕机重启之）。</p>
<div class="blog_h2"><span class="graybg">fluentd</span></div>
<p>用于配合实现集群级别日志（CIL）。</p>
<div class="blog_h1"><span class="graybg">容器</span></div>
<p>在Pod中引用Docker镜像之前，你必须将其Push到Registry中。</p>
<p>container对象的image属性可以包含Registry前缀和Tag，这个命名规则和Docker是一致的。</p>
<div class="blog_h2"><span class="graybg">镜像更新</span></div>
<p>默认的镜像拉取策略是IfNotPresent，如果镜像已经存在于本地，则Kubelet不会重复抓取。如果希望总是取抓取镜像，可以使用以下三种方法之一：</p>
<ol>
<li>设置imagePullPolicy=Always</li>
<li>使用镜像的:latest标签</li>
<li>启用AlwaysPullImages这一admission controller</li>
</ol>
<p>当不指定镜像tag时，默认即使用:latest，因而会导致每次都抓取最新镜像。:latest是应该尽可能避免使用的。</p>
<div class="blog_h2"><span class="graybg">使用私服</span></div>
<p>Docker将访问私服所需要的密钥信息存放在$HOME/.dockercfg或者$HOME/.docker/config.json文件中。如果在Kubelet的root的$home目录下存在这两个文件K8S会使用之。</p>
<p>可以使用如下Pod能验证私服能否正常访问：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ce5962858285" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ce5962858285-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ce5962858285-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: private-image-test-1</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: uses-private-image</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: $PRIVATE_IMAGE_NAME</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">imagePullPolicy</span><span class="">: Always</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: [ "echo"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"SUCCESS"<span class="crayon-h"> </span><span class="crayon-o">]</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-12"><span class="crayon-c"># 创建Pod对象</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-13">kubectl<span class="crayon-h"> </span>create<span class="crayon-h"> </span>-f<span class="crayon-h"> </span>/tmp/private-image-test-1<span class="crayon-o">.</span>yaml</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ce5962858285-14"><span class="crayon-c"># 查看运行结果， 期望输出SUCCESS</span></div><div class="crayon-line" id="crayon-634f9a69b9ce5962858285-15">kubectl<span class="crayon-h"> </span>logs<span class="crayon-h"> </span>private-image-test-1</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>注意：</p>
<ol>
<li>所有节点必须具有相同的.docker/config.json，否则可能出现Pod仅能在部分节点上运行的情况。例如，如果你使用节点自动扩容，则每个实例模板需要包含.docker/config.json文件或者挂载包含此文件的卷</li>
<li>只要私服的访问密钥被添加到config.json中，则任何Pod都有权访问这些私服中的镜像</li>
</ol>
<div class="blog_h2"><span class="graybg">容器环境</span></div>
<p>K8S的容器环境，为容器提供了很多重要的资源：</p>
<ol>
<li>一个文件系统，由镜像 + 1-N个卷构成</li>
<li>关于容器本身的信息：
<ol>
<li>容器的hostname就是容器所在的Pod的name，此名称可以通过hostname命令/gethostname函数获得</li>
<li>容器所属的Pod name和namespace还可以通过<a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">downward API</a>获得</li>
<li>用户在Pod定义中声明的环境变量，对于容器都是可用的</li>
</ol>
</li>
<li>关于集群中其它对象的信息：
<ol>
<li>容器创建时所有服务的列表，可以通过环境变量得到。例如名为foo的服务对应环境变量如下：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cea935283156" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cea935283156-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cea935283156-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cea935283156-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cea935283156-1"><span class="crayon-c"># 在容器中可以访问环境变量：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cea935283156-2"><span class="crayon-v">FOO_SERVICE_HOST</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-634f9a69b9cea935283156-3"><span class="crayon-v">FOO_SERVICE_PORT</span><span class="crayon-o">=</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

</li>
<li>服务拥有专享的IP地址，容器可以基于DNS名称访问它（如果DNS Addon启用的话）</li>
</ol>
</li>
</ol>
<div class="blog_h2"><span class="graybg">生命周期钩子</span></div>
<p>利用容器生命周期钩子框架，你可以在Kubelet管理的容器启动、关闭时执行特定的代码。可用的钩子（事件）包括：PostStart、PreStop。</p>
<div class="blog_h2"><span class="graybg">容器配置参数</span></div>
<div class="blog_h3"><span class="graybg">command/args</span></div>
<p>如果：</p>
<ol>
<li>既不提供command和args，则使用Docker镜像中定义的默认值</li>
<li>如果仅提供了command，则Docker镜像中的CMD/ENTRYPOINT被忽略</li>
<li>如果仅提供了args，则使用Docker镜像中的ENTRYPOINT + args</li>
<li>如果同时提供了command和args，则Docker镜像中的CMD/ENTRYPOINT被忽略 </li>
</ol>
<div class="blog_h1"><span class="graybg">Pod</span></div>
<div class="blog_h2"><span class="graybg">简介</span></div>
<p>Pod（本义：豆荚，箱子）是K8S对象模型中，最小的部署、复制、扩容单元 —— K8S中单个应用程序实例。</p>
<p>Pod封装了以下内容：</p>
<ol>
<li>应用程序容器</li>
<li>存储资源</li>
<li>唯一的网络IP</li>
<li>管理容器运行方式的选项</li>
</ol>
<p>Pod最常用的容器运行时是Docker，尽管其它容器运行时也被支持。</p>
<p>Pod的两种使用方式：</p>
<ol>
<li>运行单个容器：容器和Pod呈现一对一关系，这是最常见的用法。你可以将Pod看作是容器的简单包装器，K8S管理Pod而不直接管理容器</li>
<li>运行多个容器：Pod封装了由多个较小的、紧耦合的、共享资源的容器相互协作而组成的应用，以及和这些容器相关的存储资源</li>
</ol>
<p>Pod本身只是一套环境，因此容器可以重启，Pod则没有这一概念。</p>
<p>每个Pod对应一个应用程序实例，如果你需要水平扩容，则需要使用多个Pod。这种水平扩容在K8S中一般叫做复制（Replication）。复制的Pod由控制器创建、管理。</p>
<p>如果Pod包含多个容器，则这些容器一般被调度、运行在单个节点上。这些容器可以共享资源、依赖，相互通信，并且协调如何关闭（例如谁先关闭）。容器之间共享的资源主要有：</p>
<ol>
<li>网络：每个Pod具有唯一性的IP地址，Pod中的每个容器共享网络名字空间，包括IP地址和端口。Pod内的容器之间可以通过localhost + 端口相互通信。当与外部实体通信时，这些容器必须协调如何共享网络资源（例如端口）</li>
<li>存储：Pod可以指定一系列的共享存储卷，所有容器可以访问这些卷。如果Pod中部分容器重启，这些卷仍然保持可用</li>
<li>容器之间也可以基于IPC机制进行通信，例如SystemV信号量、POSIX共享内存</li>
</ol>
<p>在基于Docker时，Pod中的容器是共享名字空间、共享卷的Docker容器。</p>
<p>Pod可以和其它物理机器、其它Pod进行网络通信。</p>
<div class="blog_h2"><span class="graybg">Pod创建过程</span></div>
<ol>
<li>用户向API Server发送创建Pod的请求</li>
<li>K8S Scheduler选取一个节点，将Pod分配到节点上</li>
<li>节点上的Kubelet负责Pod的创建：
<ol>
<li>调用CNI实现（dockershim、containerd等）创建Pod内的容器</li>
<li>第一个创建的容器是<span style="background-color: #c0c0c0;">pause</span>，它会允许一个简单的程序，进行永久的阻塞。该容器的<span style="background-color: #c0c0c0;">作用是维持命名空间</span>，因为Linux的命名空间需要其中至少包含一个进程才能存活</li>
<li>其他容器会加入到pause容器所在的命名空间</li>
<li>初始化容器网络接口，由kubenet（即将废弃）获CNI插件负责。CNI会在pause容器内创建eth0接口并分配IP地址</li>
<li>容器和主机的网络协议栈，通过veth pair连接</li>
</ol>
</li>
</ol>
<div class="blog_h2"><span class="graybg">pause容器</span></div>
<p>在Pod中，pause容器是所有其他容器的“父”容器，它：</p>
<ol>
<li>是各容器共享的命名空间的基础</li>
<li>可以启用PID命名空间共享，为每个Pod提供init进程</li>
</ol>
<p>pause容器的逻辑非常简单，它启动后就通过pause()系统调用暂停自己。当子进程变为孤儿进程（父进程提前出错退出）时，它会调用wait()防止僵尸进程的出现。</p>
<p>在1.8版本之前，默认启用PID命名空间共享，也就是说Pod的所有容器共享一个PID命名空间，之后的版本则默认禁用共享，可以配置
			<span id="crayon-634f9a69b9cf1292778565" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">spec</span><span class="crayon-sy">.</span><span class="crayon-v">shareProcessNamespace</span></span></span>强制启用。不共享PID命名空间时，每个容器都有PID 1进程。</p>
<div class="blog_h2"><span class="graybg">使用Pod</span></div>
<p>你很少需要直接创建单个Pod，甚至是单例（不复制）的Pod，这是因为Pod被设计为是短命的、可丢弃的实体。当Pod被（你直接、或控制器）创建时，它被调度到集群中的某个节点。直到进程退出，Pod会一直存在于节点上。如果缺少资源、节点失败，则Pod会被清除、Pod对象也被从APIServer中删除。</p>
<p>Pod本身没有自愈能力，如果Pod被调度到一个失败的节点，或者调度操作本身失败，则Pod会被删除。类似的，当资源不足或者节点维护时，Pod也会被删除。K8S使用控制器这一高层抽象来管理Pod实例。通常你都是通过控制器来间接使用Pod。</p>
<div class="blog_h2"><span class="graybg">控制器</span></div>
<p>控制器能够创建、管理多个Pod，处理复制/回滚，并提供自愈（在集群级别）功能 —— 例如当节点失败时控制器会在其它节点上创建等价的Pod。一般来说，控制器使用你提供的Pod模板来创建Pod。</p>
<p>控制器主要有三类：</p>
<ol>
<li>Job：用于控制那些期望会终结的Pod，在批处理计算场景下用到。Job必须和restartPolicy为OnFailure/Never的Pod联用</li>
<li>ReplicationController, ReplicaSet,Deployment：用于控制不期望终结的Pod，例如Web服务。这些控制器必须和restartPolicy=Always联用</li>
<li>DaemonSet：用于某个机器上仅运行一个实例的Pod，用于提供机器特定的系统服务</li>
</ol>
<p>这三类控制器都包含了对应的Pod模板。</p>
<div class="blog_h2"><span class="graybg">Pod模板</span></div>
<p>Pod模板是包含在其它对象（复制控制器、Jobs、DaemonSets...）中的Pod的规格说明。控制器使用Pod模板来创建实际的Pod，模板示例如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cf6136981992" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cf6136981992-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cf6136981992-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cf6136981992-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cf6136981992-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cf6136981992-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9cf6136981992-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cf6136981992-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cf6136981992-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: myapp-pod</span></div><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cf6136981992-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: myapp</span></div><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cf6136981992-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: myapp-container</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cf6136981992-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line" id="crayon-634f9a69b9cf6136981992-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'echo<span class="crayon-h"> </span>Hello<span class="crayon-h"> </span>Kubernetes<span class="crayon-sy">!</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span>sleep<span class="crayon-h"> </span>3600'<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>Pod模板发生改变不会影响已经创建的Pod。 </p>
<div class="blog_h2"><span class="graybg">Pod的终结</span></div>
<p>当用户请求删除Pod时，K8S首先发送TERM信号给每个容器的主进程，当超过时限（完整宽限期，Full Grace Period）后，则发送KILL信号，之后删除Pod对象。</p>
<p>如果在等待容器进程退出期间Kubelet、Docker守护进程重启，则重启后重新进行完整宽限期内的TERM，以及必要的KILL。</p>
<p>强制删除：这种删除操作会导致Pod对象立即从APIServer中移除，这样它的名字可以立即被重用。实际的Pod会在较短的宽限期内被清除。</p>
<div class="blog_h2"><span class="graybg">Pod容器的特权模式</span></div>
<p>在容器规格的SecurityContext字段中指定privileged标记，则容器进入特权模式。如果容器需要操作网络栈、访问设备，则需要特权模式。</p>
<div class="blog_h2"><span class="graybg">Pod生命周期</span></div>
<p>Pod的status字段是一个PodStatus对象，后者具有一个phase字段。该字段是Pod所处生命周期阶段的概要说明：</p>
<ol>
<li>Pending：Pod已经被K8S系统接受，单是一或多个容器镜像尚未创建。此时Pod尚未调度到节点上，或者镜像尚未下载完毕</li>
<li>Running：Pod已经被调度到某个节点，且所有容器已被创建，至少有一个容器处于运行中/重启中/启动中</li>
<li>Succeeded：Pod的所有容器被正常终结，且不会再重启</li>
<li>Failed：Pod的所有容器被终结，且至少一个被异常终结——要么退出码非0要么被强杀</li>
<li>Unknown：Pod状态未知，通常由于和目标节点的通信中断导致</li>
</ol>
<p>PodStatus具有一个 PodCondition数组，数组的每个元素具有type、status字段。type可选值是PodScheduled、Ready、Initialized、Unschedulable，status字段的可选值是True、False、Unknown。</p>
<p>通常情况下，重复你或者控制器销毁Pod，它不会小时。唯一的例外是，phase值为Succeeded/Failed，并持续一定时间（具体由Master确定），则Pod会因为过期而自动销毁。</p>
<p>如果节点和集群断开，则K8S会把该节点上所有的Pod的phase更新为Failed</p>
<div class="blog_h2"><span class="graybg">容器探针</span></div>
<p>Probe由Kubelet周期性的针对容器调用，以执行健康检查。Kubelet会调用容器实现的Handler，Handler包括三类：</p>
<ol>
<li>ExecAction：在容器内部执行特定的命令，如果命令为0则意味着诊断成功</li>
<li>TCPSocketAction：针对容器的IP/端口进行TCP检查，如果端口打开则诊断成功</li>
<li>HTTPGetAction：针对容器的IP/端口进行HTTP检查，如果响应码为[200,400)之间则诊断成功</li>
</ol>
<p>每个探针的诊断结果可以是Success、Failure、Unknown</p>
<p>Kubelet可以在运行中的容器上执行两个可选探针，并作出反应：</p>
<ol>
<li>livenessProbe：探测容器是否还在运行。如果<span style="background-color: #c0c0c0;">探测失败则杀死容器</span>，并根据其重启策略决定如何反应。如果容器没有提供此探针，则总是返回Success</li>
<li>readinessProbe：探测容器是否能提供服务。如果探测失败，端点控制器会<span style="background-color: #c0c0c0;">从所有匹配Pod的服务的端点中移除Pod的IP地址</span>。在Initial delay之前默认值Failure，如果容器没有提供此探针，则Initial delay之后默认Success。<span style="background-color: #c0c0c0;">仅仅用于在Pod启动初期</span>、延迟的把它加入到服务集群中，不能用于将Pod从服务集群中移除</li>
</ol>
<p>注意，这些探针在Kubelet的网络名字空间中运行。</p>
<p>如果你的容器在出现问题时会自己崩溃，则不需要使用探针，只需要设置好restartPolicy即可。</p>
<div class="blog_h3"><span class="graybg">livenessProbe</span></div>
<p>基于HTTP的探针示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9cfc380107239" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9cfc380107239-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9cfc380107239-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">test</span><span class="">: liveness</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: liveness-http</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- args</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>/server</div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: gcr.io/google_containers/liveness</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 指定探针，在容器级别上指定</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">livenessProbe</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">httpGet</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /healthz</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 8080&nbsp;&nbsp;# 也可以使用命名端口（ContainerPort）</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">httpHeaders</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: X-Custom-Header</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: Awesome</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 第一次探针延迟多久执行</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">initialDelaySeconds</span><span class="">: 15</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 每隔多久执行一次探针</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 5</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 探针执行超时，默认1秒</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">timeoutSeconds</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 被判定为失败后，连续多少次探测没问题，才被重新认为是成功</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">successThreshold</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 连续多少次探测失败，则认为无法恢复，自动重启</span></div><div class="crayon-line" id="crayon-634f9a69b9cfc380107239-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">failureThreshold</span><span class="">: 3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9cfc380107239-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: liveness</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<p>基于命令的探针示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d01767281261" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d01767281261-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d01767281261-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d01767281261-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d01767281261-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d01767281261-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d01767281261-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d01767281261-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d01767281261-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d01767281261-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d01767281261-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d01767281261-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d01767281261-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d01767281261-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: runtime</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d01767281261-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">livenessProbe</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d01767281261-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">exec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d01767281261-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d01767281261-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>cat</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d01767281261-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>/app/liveness</div><div class="crayon-line" id="crayon-634f9a69b9d01767281261-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">initialDelaySeconds</span><span class="">: 5</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d01767281261-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 5</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>要注意：命令的标准输出被收集，并在kubectl describe pod命令中显示为Unhealthy事件的原因，因此<span style="background-color: #c0c0c0;">探针的标准输出应该简洁明了</span>。</p>
<div class="blog_h3"><span class="graybg">readinessProbe</span></div>
<p>某些情况下，容器临时的不适合处理请求，例如其正在启动、正在加载大量数据。此时可以使用readiness探针。readiness探测失败的Pod不会接收到K8S Service转发来的请求。</p>
<p>readinessProbe的配置和livenessProbe没有区别。两个探针可以被同时执行。</p>
<div class="blog_h2"><span class="graybg">重启策略</span></div>
<p>PodSpec包含一个restartPolicy字段，可选值为：</p>
<ol>
<li>Always，默认值，应用到Pod的所有容器</li>
<li>OnFailure</li>
<li>Never</li>
</ol>
<p>重启时如果再次失败，重启延迟呈指数增长（10s，20s，40s）但是最大5分钟。启动成功后，10m后清除重启延迟。</p>
<div class="blog_h2"><span class="graybg">初始化容器</span></div>
<p>在PodSpec的containers字段之后，你可以声明一个初始化容器。这类容器在应用容器之前运行，可能包含应用镜像中没有的实用工具、安装脚本。</p>
<p>初始化容器可以有多个，K8S会按照声明顺序逐个执行它们，<span style="background-color: #c0c0c0;">只有前一个初始化容器成功完成，后面的初始化容器才会被调用</span>。如果某个初始化容器运行失败，K8S会反复重启它，直到成功，除非你设置其restartPolicy=Never。</p>
<div class="blog_h3"><span class="graybg">示例</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d05333673664" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d05333673664-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d05333673664-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d05333673664-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: myapp-pod</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: myapp</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 普通容器</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: myapp-container</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'echo<span class="crayon-h"> </span>The<span class="crayon-h"> </span>app<span class="crayon-h"> </span>is<span class="crayon-h"> </span>running<span class="crayon-sy">!</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span>sleep<span class="crayon-h"> </span>3600'<span class="crayon-o">]</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 初始化容器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">initContainers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: init-myservice</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'until<span class="crayon-h"> </span>nslookup<span class="crayon-h"> </span>myservice<span class="crayon-sy">;</span><span class="crayon-h"> </span>do<span class="crayon-h"> </span>echo<span class="crayon-h"> </span>waiting<span class="crayon-h"> </span>for<span class="crayon-h"> </span>myservice<span class="crayon-sy">;</span><span class="crayon-h"> </span>sleep<span class="crayon-h"> </span>2<span class="crayon-sy">;</span><span class="crayon-h"> </span>done<span class="crayon-sy">;</span>'<span class="crayon-o">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: init-mydb</span></div><div class="crayon-line" id="crayon-634f9a69b9d05333673664-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d05333673664-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'until<span class="crayon-h"> </span>nslookup<span class="crayon-h"> </span>mydb<span class="crayon-sy">;</span><span class="crayon-h"> </span>do<span class="crayon-h"> </span>echo<span class="crayon-h"> </span>waiting<span class="crayon-h"> </span>for<span class="crayon-h"> </span>mydb<span class="crayon-sy">;</span><span class="crayon-h"> </span>sleep<span class="crayon-h"> </span>2<span class="crayon-sy">;</span><span class="crayon-h"> </span>done<span class="crayon-sy">;</span>'<span class="crayon-o">]</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->

<div class="blog_h2"><span class="graybg">Pod预设</span></div>
<p>PodPreset用于在创建Pod时，向Pod注入额外的运行时需求信息。你可以使用标签选择器来指定预设要应用到的Pod。当Pod创建请求出现时，系统中发生以下事件：</p>
<ol>
<li>取得所有可用的PodPreset</li>
<li>检查是否存在某个PodPreset，其标签选择器匹配准备创建的Pod</li>
<li>尝试合并PodPreset中的各种资源到准备创建的Pod中
<ol>
<li>如果出错，触发一个事件说明合并出错。在不注入任何资源的情况下创建Pod</li>
<li>如果成功，标注被修改的PodSpec为已被PodPreset修改 </li>
</ol>
</li>
</ol>
<p>要在集群中使用Pod预设功能，你需要：</p>
<ol>
<li>确保API类型settings.k8s.io/v1alpha1/podpreset启用。可以设置APIServer的--runtime-config选项，包含settings.k8s.io/v1alpha1=true</li>
<li>确保PodPreset这一Admission controller已经启用。可以设置APIServer的--admission-control选项，包含PodPreset</li>
<li>在你需要使用的名字空间中，定义一个PodPreset对象</li>
</ol>
<p>如果你在使用Kubeadm，则修改配置文件/etc/kubernetes/manifests/kube-apiserver.yaml即可。</p>
<div class="blog_h3"><span class="graybg">示例</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d0a119980781" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d0a119980781-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9d0a119980781-33">33</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-1"><span class="crayon-s ">apiVersion</span><span class="">: settings.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-2"><span class="crayon-s ">kind</span><span class="">: PodPreset</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: allow-database</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">role</span><span class="">: frontend</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 支持的Pod配置项是有限的，仅仅支持：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 预设容器的环境变量</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: DB_PORT</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "6379"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: expansion</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: $(REPLACE_ME)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 预设容器的环境变量，从ConfigMap读取变量</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">envFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- configMapRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: etcd-env-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 预设容器的卷挂载</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /cache</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: cache-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /etc/app/config.json</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: secret-volume</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 预设Pod的卷定义</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: cache-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">emptyDir</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: secret-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d0a119980781-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secret</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d0a119980781-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">secretName</span><span class="">: config-details</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0028 seconds] -->

<div class="blog_h2"><span class="graybg">高可用</span></div>
<p>要构建基于K8S的高可用应用，就要明白Pod什么时候会被中断（Disrpution）。</p>
<p>Pod不会凭空消失，除非你或控制器销毁了它们，或者出现不可避免的软硬件错误。这些不可避免的错误被称为非自愿中断（Involuntary Disruptions），例如：</p>
<ol>
<li>作为节点支撑的物理机器，出现硬件错误</li>
<li>集群管理员错误的删除了VM</li>
<li>云服务或者Hypervisor的错误导致VM消失</li>
<li>内核错误</li>
<li>网络分区导致节点从集群分离</li>
<li>节点资源不足导致Pod被清除</li>
</ol>
<p>其它情况则称为自愿中断，中断操作可能由应用程序所有者、集群管理员触发。应用程序所有者的操作包括：</p>
<ol>
<li>删除部署或者其它管理Pod的控制器</li>
<li>更新部署的Pod模板导致重启</li>
<li>直接意外的删除了Pod</li>
</ol>
<p>集群管理员的操作包括：</p>
<ol>
<li>Drain了某个节点，进行硬件维护或软件升级</li>
<li>Drain了某个节点，进行缩容</li>
<li>从节点移除Pod，流下资源供其他人使用</li>
</ol>
<p>缓和非自愿中断造成的影响，手段包括：</p>
<ol>
<li>确保Pod请求了其需要的资源</li>
<li>如果需要HA，启用（无状态/有状态）应用程序复制</li>
<li>如果需要进一步HA，启用跨机柜复制（anti-affinity）甚至跨区域复制（multi-zone cluster）</li>
</ol>
<p>自愿中断发生的频率根据集群用法的不同，有很大差异。对于某些基本的集群，根本不会出现自愿中断。</p>
<p>集群管理员/云服务提供商可能运行额外的服务，进而导致自愿中断。例如，滚动进行节点的软件更新就可能导致这种中断。某些节点自动扩容的实现，可能进行节点的取碎片化，从而导致自愿中断。</p>
<p>K8S提供了中断预算（Disruption Budgets）机制，帮助在频繁的自愿中断的情况下，实现HA。</p>
<div class="blog_h2"><span class="graybg">优先级和抢占</span></div>
<p>这是从1.8引入的特性，目前处于Alpha状态。该特性允许Pod具有优先级，并且能够在无法调度Pod时，从节点驱除低优先级的Pod。</p>
<p>从1.9开始，优先级影响Pod的调度顺序、资源不足时Pod的驱逐顺序。高优先级的Pod更早被调度，低优先级的Pod更早被驱除。</p>
<div class="blog_h3"><span class="graybg">启用特性</span></div>
<p>你需要为APIServer、scheduler、kubelet启用下面的特性开关：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d10099684129" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d10099684129-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d10099684129-1"><span class="crayon-o">--</span><span class="crayon-v">feature</span><span class="crayon-o">-</span><span class="crayon-v">gates</span><span class="crayon-o">=</span><span class="crayon-v">PodPriority</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-sy">,</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>同时在APIServer中启用scheduling.k8s.io/v1alpha1这个API以及Priority这个准许控制器：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d14359308179" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d14359308179-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d14359308179-1"><span class="crayon-o">--</span><span class="crayon-v">runtime</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-o">=</span><span class="crayon-v">scheduling</span><span class="crayon-e">.k8s</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">v1alpha1</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">admission</span><span class="crayon-o">-</span><span class="crayon-v">control</span><span class="crayon-o">=</span><span class="crayon-v">Controller</span><span class="crayon-o">-</span><span class="crayon-v">Foo</span><span class="crayon-sy">,</span><span class="crayon-v">Controller</span><span class="crayon-o">-</span><span class="crayon-v">Bar</span><span class="crayon-sy">,</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">,</span><span class="crayon-v">Priority</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<div class="blog_h3"><span class="graybg">PriorityClass</span></div>
<p>这是一类非名字空间化的对象，定义了一个优先级类的名称，以及一个整数的优先级值。最大取值为10亿，更大的值保留。规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d18542814680" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d18542814680-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d18542814680-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d18542814680-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d18542814680-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d18542814680-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d18542814680-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d18542814680-1"><span class="crayon-s ">apiVersion</span><span class="">: scheduling.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d18542814680-2"><span class="crayon-s ">kind</span><span class="">: PriorityClass</span></div><div class="crayon-line" id="crayon-634f9a69b9d18542814680-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d18542814680-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 名</span></div><div class="crayon-line" id="crayon-634f9a69b9d18542814680-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: high-priority</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d18542814680-6"><span class="crayon-c"># 值</span></div><div class="crayon-line" id="crayon-634f9a69b9d18542814680-7"><span class="crayon-s ">value</span><span class="">: 1000000</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d18542814680-8"><span class="crayon-c"># 是否全局默认值，如果是，则没有定义PriorityClassName属性的Pod，其优先级均为此PriorityClass.value</span></div><div class="crayon-line" id="crayon-634f9a69b9d18542814680-9"><span class="crayon-s ">globalDefault</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d18542814680-10"><span class="crayon-c"># 供用户阅读的描述</span></div><div class="crayon-line" id="crayon-634f9a69b9d18542814680-11"><span class="crayon-s ">description</span><span class="">: "..."</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<div class="blog_h3"><span class="graybg">抢占</span></div>
<p>当Pod被创建后，它会列队等待调度。调度器会选取队列中的一个Pod并尝试调度到某个节点上，如果没有节点能满足Pod的需求，则抢占逻辑被激活：</p>
<ol>
<li>尝试寻找这样的节点：其上具有更低优先级的Pod，并且将这些Pod驱除后，能满足正被调度的Pod的需求</li>
<li>如果找到匹配的节点，则对其上的低优先级Pod执行驱除，并调度当前Pod到节点</li>
</ol>
<div class="blog_h2"><span class="graybg">共享卷</span></div>
<p>同一个Pod内的多个容器，可以通过共享卷（Shared Volume）进行交互。</p>
<p>卷天然是Pod内共享的，因为<span style="background-color: #c0c0c0;">卷只能在Pod级别定义，而后任何一个容器都可以挂载它到自己的某个路径下</span>：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d1c529656687" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d1c529656687-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d1c529656687-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-1"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-2"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: shared-data</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod被调度到某个节点上后，创建一个空目录</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">emptyDir</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: nginx-container</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: shared-data</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /usr/share/nginx/html</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: debian-container</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: debian</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: shared-data</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /pod-data</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ["/bin/sh"]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d1c529656687-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 修改共享卷的内容</span></div><div class="crayon-line" id="crayon-634f9a69b9d1c529656687-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">args</span><span class="">: ["-c"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"echo<span class="crayon-h"> </span>Hello<span class="crayon-h"> </span>from<span class="crayon-h"> </span>the<span class="crayon-h"> </span>debian<span class="crayon-h"> </span>container<span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span>/pod-data/index<span class="crayon-o">.</span>html"<span class="crayon-o">]</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>注意，K8S的共享卷和Docker的--volumes-from不同。</p>
<div class="blog_h2"><span class="graybg">容器组合模式</span></div>
<div class="blog_h3"><span class="graybg">Sidecar</span></div>
<p>跨斗，本指三轮摩托旁边的那个座位。</p>
<p>Sidecar用于辅助主要容器，让其更好的工作。例如Pod中的主容器是Nginx，它提供HTTP服务，Sidecar中运行一个Git，周期性的将最新的代码拉取过来，通过共享文件系统推送给Nginx。</p>
<div class="blog_h3"><span class="graybg">Ambassador</span></div>
<p>使者模式，辅助容器作为一个代理服务器，主容器直接通过localhost（因为Pod内所有容器共享网络名字空间）访问外部的服务。</p>
<p>好处是，主容器可以和开发环境完全一致，因为在开发时常常所有东西都在localhost上。</p>
<div class="blog_h3"><span class="graybg">Adaptor</span></div>
<p>不同容器输出的监控指标信息格式不一致，可以由一个配套的辅助容器对这些格式进行适配。</p>
<div class="blog_h2"><span class="graybg"><a id="label-mgr"></a>标签管理</span></div>
<p>建议统一规划、配置标签：</p>
<ol>
<li>tier，标识应用所属的层次，取值：
<ol>
<li>control-plane：K8S控制平面</li>
<li>infrastructure：提供网络、存储等基础设施</li>
<li>devops：开发、运维相关的工具</li>
<li>middleware：中间件、数据库等</li>
<li>application：业务域应用程序</li>
</ol>
</li>
<li>app，标识应用程序的类别</li>
<li>comp，标识应用程序组件</li>
<li>version，标识应用程序的版本</li>
<li>release，标识Helm Release的名称，或者手工部署的应用程序的实例名</li>
</ol>
<div class="blog_h2"><span class="graybg">hostNetwork</span></div>
<p>将此配置项设置为true，则Pod直接使用宿主机的网络。Pod直接在宿主机的网络接口上监听。</p>
<div class="blog_h2"><span class="graybg">Pod配置</span></div>
<div class="blog_h3"><span class="graybg">环境变量</span></div>
<p>将Pod的Spec/Status字段注入为环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d21732038486" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d21732038486-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d21732038486-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d21732038486-1"><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: NODE_NAME</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: spec.nodeName</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_NAME</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: metadata.name</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_NAMESPACE</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: metadata.namespace</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_IP</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: status.podIP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_SERVICE_ACCOUNT</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d21732038486-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d21732038486-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: spec.serviceAccountName</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<div class="blog_h1"><span class="graybg">分配Pod到节点</span></div>
<p>你可以指定Pod和Node的对应关系，让Pod只能（或优选）在某些节点上运行。具体实现方式有几种，都是基于标签选择器的。</p>
<p>大部分情况下你不需要强制指定对应关系，因为K8S会进行合理的调度。你需要这种细致的控制机制的场景包括：</p>
<ol>
<li>确保Pod在具有SSD的机器上运行</li>
<li>让两个位于不同Service中的、频繁协作的Pod，能在同一个Zone内部运行</li>
</ol>
<div class="blog_h2"><span class="graybg">nodeSelector</span></div>
<p>这是Pod规格的一个字段，规定有资格运行Pod的节点，所具有的标签集。</p>
<p>你需要首先为节点添加标签：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d26995088404" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d26995088404-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d26995088404-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d26995088404-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d26995088404-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d26995088404-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d26995088404-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d26995088404-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d26995088404-1"><span class="crayon-c"># 获取集群的节点列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d26995088404-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span></div><div class="crayon-line" id="crayon-634f9a69b9d26995088404-3"><span class="crayon-c"># 为某个节点添加标签</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d26995088404-4"><span class="crayon-e">kubectl </span><span class="crayon-e">label </span><span class="crayon-e">nodes&nbsp;&nbsp;</span><span class="crayon-v">disktype</span><span class="crayon-o">=</span><span class="crayon-v">ssd</span></div><div class="crayon-line" id="crayon-634f9a69b9d26995088404-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d26995088404-6"><span class="crayon-c"># 显示节点标签</span></div><div class="crayon-line" id="crayon-634f9a69b9d26995088404-7"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">show</span><span class="crayon-o">-</span><span class="crayon-v">labels</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>然后，需要为Pod规格添加一个nodeSelector字段： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d2a326356468" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d2a326356468-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d2a326356468-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d2a326356468-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d2a326356468-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d2a326356468-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">nodeSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d2a326356468-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">disktype</span><span class="">: ssd</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>执行命令：
			<span id="crayon-634f9a69b9d2e773601035" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">get </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">wide</span></span></span>可以看到Pod被分配到的节点。 </p>
<div class="blog_h3"><span class="graybg">内置节点标签</span></div>
<p>截止1.4，K8S内置的节点标签有：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="text-align: center;">节点标签</td>
</tr>
</thead>
<tbody>
<tr>
<td>kubernetes.io/hostname</td>
</tr>
<tr>
<td>failure-domain.beta.kubernetes.io/zone</td>
</tr>
<tr>
<td>failure-domain.beta.kubernetes.io/region</td>
</tr>
<tr>
<td>beta.kubernetes.io/instance-type</td>
</tr>
<tr>
<td>beta.kubernetes.io/os</td>
</tr>
<tr>
<td>beta.kubernetes.io/arch</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">Affinity</span></div>
<p>Beta特性affinity，也可以用于将Pod分配到节点。但是这一特性更加强大：</p>
<ol>
<li>表达能力更强，不是简单的限制于nodeSelector的那种  k == v &amp;&amp; k == v</li>
<li>可以标注为“软规则”而非强制要求，如果调度器无法满足Pod的需求，Pod仍然会被调度</li>
<li>可以基于其它Pod上的标签进行约束，也就是说，可以让一系列的Pod同地协作（ co-located）</li>
</ol>
<p>Affinity分为两种类型：</p>
<ol>
<li>Node affinity：类似于nodeSelector，但是表达能力更强、可以启用软规则（对应上面的第1、2条）</li>
<li>Inter-pod affinity：基于Pod标签而非Node标签进行约束（对应上面第3条）</li>
</ol>
<div class="blog_h3"><span class="graybg">Node affinity</span></div>
<p>包含两种子类型：requiredDuringSchedulingIgnoredDuringExecution（硬限制）、preferredDuringSchedulingIgnoredDuringExecution（软限制）。</p>
<p>“IgnoredDuringExecution“的含义是，如果在Pod调度到Node并运行后，Node的标签发生改变，则Pod会继续运行，nodeSelector的行为也是这样的。未来可能支持后缀“RequiredDuringExecution“，也就说当运行是Node的标签发生改变，导致不满足规则后，Pod会被驱除。</p>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d33318685396" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9d33318685396-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d33318685396-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d33318685396-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">affinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodeAffinity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 硬限制</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 加强版的节点选择器，值为数组。如果数组元素有多个，目标节点只需要匹配其中一个即可</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodeSelectorTerms</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 每个节点选择器可以包含多个表达式，如果表达式有多个，目标节点必须匹配全部表达式</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 必须在AZ（Availability Zone）e2e-az1或者e2e-az2中运行</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: kubernetes.io/e2e-az-name</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 支持的操作符包括 In, NotIn, Exists, DoesNotExist, Gt, Lt</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 其中 NotIn,DoesNotExist 用于实现anti-affinity</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>e2e-az1</div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>e2e-az2</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 软限制</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">preferredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 权重，值越大越需要优先满足</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- weight</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">preference</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 节点选择器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: another-node-label-key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line" id="crayon-634f9a69b9d33318685396-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d33318685396-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>another-node-label-value</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<div class="blog_h3"><span class="graybg">Inter-pod affinity</span></div>
<p>基于已经运行在节点上的Pod，而不是节点本身的标签进行匹配 —— 当前Pod应该/不应该运行在，已经运行了匹配规则R的Pod(s)的X上。其中：</p>
<ol>
<li>R表现为关联了一组名字空间的标签选择器</li>
<li>X是一个拓扑域（Topology Domain），可以是Node、Rack、Zone、Region等等</li>
</ol>
<p>和节点不同，Pod是限定名字空间的，因此它的标签也是有名字空间的。针对Pod的标签选择器必须声明其针对的名字空间。</p>
<p>Inter-pod affinity要求较大的计算量，因此可能拖累调度性能，不建议在大型集群（K+节点）上使用。</p>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d37461386194" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9d37461386194-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d37461386194-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d37461386194-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">affinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod亲和性</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAffinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果Zone（由topologyKey指定）上已经运行了具有标签security=S1的Pod，则当前Pod也必须调度到该Zone</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- labelSelector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: security</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 支持的操作符In, NotIn, Exists, DoesNotExist</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>S1</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topologyKey</span><span class="">: failure-domain.beta.kubernetes.io/zone</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod反亲和性</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAntiAffinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 强制</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 尽可能</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">preferredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果Host（节点）上已经运行了具有标签security=S2的Pod，则当前Pod不得调度到该Host</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- weight</span><span class="">: 100</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAffinityTerm</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labelSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: security</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d37461386194-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>S2</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d37461386194-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topologyKey</span><span class="">: kubernetes.io/hostname</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<p>当需要保证高级对象（ReplicaSets, Statefulsets, Deployments）在同一拓扑域内运行时， podAffinity非常有用。</p>
<p>下面是一个示例，3实例的Redis集群 + 3实例的Nginx前端，每个Redis不在同一节点运行，每个Nginx也不在同一节点运行，每个Nginx必须在本地有个Redis：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d3c718102878" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d3c718102878-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d3c718102878-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-1"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-2"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: redis-cache</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-4"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: store</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod模板</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">affinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 当前节点上不得存在Pod的标签是app=store，也就是说，复制集的每个实例都占据单独的节点</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAntiAffinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- labelSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: app</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>store</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topologyKey</span><span class="">: "kubernetes.io/hostname"</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d3c718102878-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: redis-server</span></div><div class="crayon-line" id="crayon-634f9a69b9d3c718102878-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: redis</span><span class="">:3.2-alpine</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->
<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d40313413165" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d40313413165-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9d40313413165-35">35</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d40313413165-1"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-2"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: web-server</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-4"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: web-store</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">affinity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAntiAffinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 当前节点上不得存在Pod具有标签app=web-store</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 也就是说当前复制集的实例，都不会在同一节点上运行</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- labelSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: app</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>web-store</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topologyKey</span><span class="">: "kubernetes.io/hostname"</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">podAffinity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 当前节点上的某个Pod必须具有app=store标签</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- labelSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: app</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>store</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topologyKey</span><span class="">: "kubernetes.io/hostname"</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d40313413165-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: web-app</span></div><div class="crayon-line" id="crayon-634f9a69b9d40313413165-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: nginx</span><span class="">:1.12-alpine</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->

<div class="blog_h2"><span class="graybg">Taints/Tolerations </span></div>
<p>前文讨论的Node affinity，可以把Node和Pod吸引到一起。Taints则做相反的事情，让Pod拒绝某些Node。</p>
<div class="blog_h3"><span class="graybg">添加Taint</span></div>
<p>使用kubectl可以为节点添加一个Taint，例如：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d45692997731" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d45692997731-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d45692997731-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d45692997731-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d45692997731-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d45692997731-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d45692997731-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d45692997731-1"><span class="crayon-c"># taint的键为key，值为value</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d45692997731-2"><span class="crayon-c"># taint effect为 NoSchedule，意味着Pod不能被调度到该节点，除非它具有匹配的toleration</span></div><div class="crayon-line" id="crayon-634f9a69b9d45692997731-3"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-e">nodes </span><span class="crayon-e">node1 </span><span class="crayon-v">key</span><span class="crayon-o">=</span><span class="crayon-v">value</span><span class="crayon-o">:</span><span class="crayon-v">NoSchedule</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d45692997731-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9d45692997731-5"><span class="crayon-c"># 恢复Master节点的禁止调度</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d45692997731-6"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-e">nodes </span><span class="crayon-e">master </span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">role</span><span class="crayon-e">.kubernetes</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">master</span><span class="crayon-o">=</span><span class="crayon-o">:</span><span class="crayon-v">NoSchedule</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h3"><span class="graybg">删除Taint</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d49904462046" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d49904462046-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d49904462046-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d49904462046-1"><span class="crayon-c"># 删除Taint</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d49904462046-2"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">all </span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">role</span><span class="crayon-e">.kubernetes</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">master</span><span class="crayon-o">-</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">容忍</span></div>
<p>下面的Pod都能容忍上述Taint：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d4d311965423" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d4d311965423-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9d4d311965423-27">27</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-1"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-2"><span class="crayon-c"># 容忍 键、值、效果组合</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-3"><span class="crayon-s ">- key</span><span class="">: "node-role.kubernetes.io/master"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 操作符，不指定默认为Equal</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: "Equal"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "value"</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">effect</span><span class="">: "NoSchedule"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-9"><span class="crayon-c"># 容忍 键、效果组合</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-10"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-11"><span class="crayon-s ">- key</span><span class="">: "node-role.kubernetes.io/master"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: "Exists"</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">effect</span><span class="">: "NoSchedule"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-15"><span class="crayon-c"># 容忍一切</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-16"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-17"><span class="crayon-s ">- operator</span><span class="">: "Exists"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-19"><span class="crayon-c"># 容忍键和一切效果</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-20"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-21"><span class="crayon-s ">- key</span><span class="">: "node-role.kubernetes.io/master"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: "Exists"</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-24"><span class="crayon-c"># 容忍某种效果</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-25"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d4d311965423-26"><span class="crayon-s ">- effect</span><span class="">: NoSchedule</span></div><div class="crayon-line" id="crayon-634f9a69b9d4d311965423-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: Exists</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<div class="blog_h3"><span class="graybg">effect </span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">取值</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>NoSchedule</td>
<td>不能容忍Taint的Pod绝不会调度到节点</td>
</tr>
<tr>
<td>PreferNoSchedule</td>
<td>不能容忍Taint的Pod尽量不被调度到节点</td>
</tr>
<tr>
<td>NoExecute</td>
<td>
<p>如果Pod不能容忍此Effect且正在节点上运行，它会被从节点上被驱除：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d51924286754" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d51924286754-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d51924286754-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d51924286754-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d51924286754-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d51924286754-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d51924286754-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d51924286754-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d51924286754-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d51924286754-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d51924286754-1"><span class="crayon-c"># Pod配置</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d51924286754-2"><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d51924286754-3"><span class="crayon-s ">- key</span><span class="">: "key1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d51924286754-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: "Equal"</span></div><div class="crayon-line" id="crayon-634f9a69b9d51924286754-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "value1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d51924286754-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">effect</span><span class="">: "NoExecute"</span></div><div class="crayon-line" id="crayon-634f9a69b9d51924286754-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果所在节点添加了key1=value1:NoExecute，则1小时后Pod被驱除</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d51924286754-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果1小时内Taint被移除，则Pod不会被驱除</span></div><div class="crayon-line" id="crayon-634f9a69b9d51924286754-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">tolerationSeconds</span><span class="">: 3600</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">应用场景</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">场景</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>专用节点</td>
<td>
<p>如果希望某些节点被特定Pod集专用，你可以为节点添加Taint、并为目标Pod添加匹配的Toleration。这样，目标Pod可以在专用节点上运行
<p>如果要让目标Pod仅能在专用节点，可以配合nodeSelector</p>
</td>
</tr>
<tr>
<td>特殊硬件节点</td>
<td>集群中可能存在一小部分具有特殊硬件（例如GPU）的节点，Taint可以让不需要特殊硬件的Pod和这些节点隔离</td>
</tr>
<tr>
<td>定制化Pod驱除</td>
<td>可以在节点出现问题时，为每个Pod定制驱除策略，这是一个Alpha特性 </td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">基于Taint的驱除</span></div>
<p>使用NoExecute可以导致已经运行在节点上的Pod被驱除，Pod配置tolerationSeconds可以指定驱除的Buffer时间。</p>
<p>从1.6开始，节点控制器会在节点状态变化时，自动添加Taint，包括：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 45%; text-align: center;">Taint</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>node.kubernetes.io/not-ready</td>
<td>节点没有准备好，对应NodeCondition.Ready=False</td>
</tr>
<tr>
<td>node.alpha.kubernetes.io/unreachable</td>
<td>节点控制器无法连接到节点，对应NodeCondition.Ready=Unknown</td>
</tr>
<tr>
<td>node.kubernetes.io/out-of-disk</td>
<td>节点磁盘空间不足</td>
</tr>
<tr>
<td>node.kubernetes.io/memory-pressure</td>
<td>节点面临内存压力</td>
</tr>
<tr>
<td>node.kubernetes.io/disk-pressure</td>
<td>节点面临磁盘压力</td>
</tr>
<tr>
<td>node.kubernetes.io/network-unavailable</td>
<td>节点的网络不可用</td>
</tr>
<tr>
<td>node.cloudprovider.kubernetes.io/uninitialized</td>
<td>当Kubelet通过“外部”云服务启动时，它会设置此Taint，当CCM初始化了节点后，移除此Taint</td>
</tr>
</tbody>
</table>
<div class="blog_h1"><span class="graybg">PDB</span></div>
<p>PDB（PodDisruptionBudget）可以用来构建高可用的应用程序。</p>
<div class="blog_h2"><span class="graybg">自愿/非自愿中断</span></div>
<p>除非被人工或控制器删除，或者出现不可避免的软硬件错误，Pod不会消失。那些不可避免软硬件错误导致的Pod删除，称为非自愿中断（involuntary disruptions ），具体包括：</p>
<ol>
<li>硬件故障</li>
<li>虚拟机故障，例如被误删除</li>
<li>内核崩溃</li>
<li>集群网络分区导致节点丢失</li>
<li>由于资源不足，Pod被kubelet驱除</li>
</ol>
<p>要避免非自愿中断影响应用程序的可用性，可以考虑：</p>
<ol>
<li>合理的配置资源请求</li>
<li>使用Deployment/StatefulSet</li>
</ol>
<p>要避免资源中断影响应用程序的可用性，可以使用PDB。</p>
<div class="blog_h2"><span class="graybg">PDB</span></div>
<p>PDB可以限制复制集中，同时<span style="background-color: #c0c0c0;">由于自愿中断而宕掉</span>的Pod的最大数量。示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d56685437380" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d56685437380-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d56685437380-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d56685437380-1"><span class="crayon-s ">apiVersion</span><span class="">: policy/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-2"><span class="crayon-s ">kind</span><span class="">: PodDisruptionBudget</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: zookeeper</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 最小保证2实例处于运行中，可以指定百分比，例如 25%</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">minAvailable</span><span class="">: 2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 也可以指定最大宕机数量，可以指定百分比，例如 25%</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">maxUnavailable</span><span class="">:1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 控制的目标应用程序</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d56685437380-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d56685437380-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: zookeeper</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h1"><span class="graybg">ConfigMap</span></div>
<p>ConfigMap用于把配置信息和容器的镜像解耦，保证容器化应用程序的可移植性。</p>
<p>ConfigMap中文叫配置字典，下一章的Secrets中文叫保密字典，两者很类似，只是后者的内容是编码存储的。</p>
<div class="blog_h2"><span class="graybg">创建ConfigMap</span></div>
<p>命令格式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d5b514395204" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d5b514395204-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5b514395204-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d5b514395204-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5b514395204-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d5b514395204-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5b514395204-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d5b514395204-1"><span class="crayon-c"># map-name是ConfigMap的名称</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5b514395204-2"><span class="crayon-c"># data-source 目录、文件，或者硬编码的字面值</span></div><div class="crayon-line" id="crayon-634f9a69b9d5b514395204-3"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-v">configmap</span><span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5b514395204-4"><span class="crayon-c"># 在ConfigMap对象中，data-source表现为键值对：</span></div><div class="crayon-line" id="crayon-634f9a69b9d5b514395204-5"><span class="crayon-c"># key：文件名，或者通过命令行提供的key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5b514395204-6"><span class="crayon-c"># value：文件内容，或者通过命令行提供的字面值</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<div class="blog_h3"><span class="graybg">--from-file</span></div>
<p>下面是把目录作为数据源的例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d5f820917677" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d5f820917677-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d5f820917677-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-1">kubectl<span class="crayon-h"> </span>create<span class="crayon-h"> </span>configmap<span class="crayon-h"> </span>game-config<span class="crayon-h"> </span>--from-file=path-to-dir</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-2"><span class="crayon-c"># ls path-to-dir</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-3"><span class="crayon-c"># game.properties</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-4"><span class="crayon-c"># ui.properties</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-6">kubectl<span class="crayon-h"> </span>describe<span class="crayon-h"> </span>configmaps<span class="crayon-h"> </span>game-config</div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-7"><span class="crayon-c"># Name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; game-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-8"><span class="crayon-c"># Namespace:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-9"><span class="crayon-c"># Labels:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-10"><span class="crayon-c"># Annotations:&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-12"><span class="crayon-c"># Data</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-13"><span class="crayon-c"># ====</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d5f820917677-14"><span class="crayon-c"># game.properties:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;158 bytes</span></div><div class="crayon-line" id="crayon-634f9a69b9d5f820917677-15"><span class="crayon-c"># ui.properties:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;83 bytes</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>目录中文件的内容，会读取到ConfigMap的data段中：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d63188885544" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d63188885544-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9d63188885544-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d63188885544-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-2"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 文件名为键，文件内容为值（字符串）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果要自定义键，可以 --from-file==</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-5"><span class="crayon-h">&nbsp;&nbsp;</span>game<span class="crayon-o">.</span><span class="crayon-s ">properties</span><span class="">: |</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>enemies=aliens</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>lives=3</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>enemies<span class="crayon-o">.</span>cheat=true</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>enemies<span class="crayon-o">.</span>cheat<span class="crayon-o">.</span>level=noGoodRotten</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>secret<span class="crayon-o">.</span>code<span class="crayon-o">.</span>passphrase=UUDDLRLRBABAS</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>secret<span class="crayon-o">.</span>code<span class="crayon-o">.</span>allowed=true</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>secret<span class="crayon-o">.</span>code<span class="crayon-o">.</span>lives=30</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-13"><span class="crayon-h">&nbsp;&nbsp;</span>ui<span class="crayon-o">.</span><span class="crayon-s ">properties</span><span class="">: |</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>color<span class="crayon-o">.</span>good=purple</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>color<span class="crayon-o">.</span>bad=yellow</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>allow<span class="crayon-o">.</span>textmode=true</div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>how<span class="crayon-o">.</span>nice<span class="crayon-o">.</span>to<span class="crayon-o">.</span>look=fairlyNice</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-18"><span class="crayon-s ">kind</span><span class="">: ConfigMap</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-19"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: 2016-02-18T18</span><span class="">:52</span><span class="">:05Z</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: game-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resourceVersion</span><span class="">: "516"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d63188885544-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selfLink</span><span class="">: /api/v1/namespaces/default/configmaps/game-config</span></div><div class="crayon-line" id="crayon-634f9a69b9d63188885544-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">uid</span><span class="">: b4952dc3-d670-11e5-8cd0-68f728db1985</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<p>如果将文件作为数据源，可以指定--from-file多次，引用多个文件。</p>
<div class="blog_h3"><span class="graybg">--from-env-file</span></div>
<p>使用该选项可以从Env-File创建ConfigMap，例如文件：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d67659930604" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">game-env-file.properties</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d67659930604-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d67659930604-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d67659930604-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d67659930604-1">enemies=aliens</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d67659930604-2">lives=3</div><div class="crayon-line" id="crayon-634f9a69b9d67659930604-3">allowed="true"</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>可以创建ConfigMap：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d6b580661984" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d6b580661984-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d6b580661984-1"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">configmap </span><span class="crayon-v">game</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-v">game</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-e">.properties</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>结果ConfigMap为：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d6f765334956" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d6f765334956-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d6f765334956-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d6f765334956-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d6f765334956-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d6f765334956-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d6f765334956-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d6f765334956-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d6f765334956-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d6f765334956-2"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d6f765334956-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 注意是一个个键值对，而不是字符串</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d6f765334956-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">allowed</span><span class="">: '"true"'</span></div><div class="crayon-line" id="crayon-634f9a69b9d6f765334956-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">enemies</span><span class="">: aliens</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d6f765334956-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">lives</span><span class="">: "3"</span></div><div class="crayon-line" id="crayon-634f9a69b9d6f765334956-7"><span class="crayon-s ">kind</span><span class="">: ConfigMap</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h3"><span class="graybg">--from-literal</span></div>
<p>使用该选项，直接通过命令行给出ConfigMap的数据：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d73200814514" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d73200814514-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d73200814514-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d73200814514-1"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">configmap </span><span class="crayon-v">special</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d73200814514-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-v">literal</span><span class="crayon-o">=</span><span class="crayon-v">special</span><span class="crayon-e">.how</span><span class="crayon-o">=</span><span class="crayon-v">very</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-v">literal</span><span class="crayon-o">=</span><span class="crayon-v">special</span><span class="crayon-e">.type</span><span class="crayon-o">=</span><span class="crayon-v">charm</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h2"><span class="graybg">使用ConfigMap</span></div>
<div class="blog_h3"><span class="graybg">定义环境变量</span></div>
<p>定义单个环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d77436992605" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d77436992605-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d77436992605-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d77436992605-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: test</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 定义一个环境变量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: SPECIAL_LEVEL_KEY</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">configMapKeyRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 环境变量的值，从名为special-config的ConfigMap中获取，使用其中的special.how的值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d77436992605-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: special-config</span></div><div class="crayon-line" id="crayon-634f9a69b9d77436992605-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">key</span><span class="">: special.how</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>你可以把ConfigMap中的所有键值对导出为Pod的环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d7b700690436" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d7b700690436-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d7b700690436-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d7b700690436-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d7b700690436-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d7b700690436-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d7b700690436-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d7b700690436-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d7b700690436-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d7b700690436-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: test-container</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d7b700690436-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">envFrom</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d7b700690436-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- configMapRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d7b700690436-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: special-config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h3"><span class="graybg">在Pod命令中使用环境变量</span></div>
<p>使用特殊语法
			<span id="crayon-634f9a69b9d7f405286062" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">VAR_NAME</span><span class="crayon-sy">)</span></span></span>，例如：?</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d83089507466" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d83089507466-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d83089507466-1"><span class="crayon-s ">command</span><span class="">: [ "/bin/sh"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"-c"<span class="crayon-o">,</span><span class="crayon-h"> </span>"echo<span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span>SPECIAL<span class="crayon-sy">_</span>LEVEL<span class="crayon-sy">_</span>KEY<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span>SPECIAL<span class="crayon-sy">_</span>TYPE<span class="crayon-sy">_</span>KEY<span class="crayon-sy">)</span>"<span class="crayon-h"> </span><span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">作为卷使用</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d87633336010" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d87633336010-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d87633336010-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d87633336010-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d87633336010-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d87633336010-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d87633336010-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d87633336010-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d87633336010-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d87633336010-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d87633336010-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d87633336010-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d87633336010-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d87633336010-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: test-container</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d87633336010-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d87633336010-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: config-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d87633336010-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /etc/config</span></div><div class="crayon-line" id="crayon-634f9a69b9d87633336010-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d87633336010-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: config-volume</span></div><div class="crayon-line" id="crayon-634f9a69b9d87633336010-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">configMap</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d87633336010-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: special-config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<p>这样，Pod启动后，/etc/config目录下会出现若干文件。这些文件的名字是configMap的键，内容是键对应的值。</p>
<div class="blog_h3"><span class="graybg">映射到卷的特定路径</span></div>
<p>你可以使用path属性指定某个ConfigMap键映射到的文件路径：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d8b699022293" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d8b699022293-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8b699022293-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: config-volume</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /etc/config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: config-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">configMap</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: special-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">items</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># ConfigMap中条目的key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: special.level</span></div><div class="crayon-line" id="crayon-634f9a69b9d8b699022293-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 映射到mountPath下的什么文件，默认为key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8b699022293-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: special.lv</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>special.level的内容会映射到容器路径：/etc/config/special.lv</p>
<div class="blog_h2"><span class="graybg">自动刷新</span></div>
<p>加载为卷的ConfigMap被修改后，K8S会自动的监测到，并更新Pod的卷的内容。<span style="background-color: #c0c0c0;">延迟取决于Kubelet的同步周期</span>。</p>
<p>加载为环境变量的ConfigMap修改后不会刷新到已经运行的Pod。</p>
<div class="blog_h2"><span class="graybg"><a id="configmap-subpath"></a>SubPath</span></div>
<p>挂载ConfigMap时，如果ConfigMap中包含多个配置文件，可以指定每个文件映射到容器的什么路径：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d8f021556231" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d8f021556231-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8f021556231-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d8f021556231-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8f021556231-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d8f021556231-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d8f021556231-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d8f021556231-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d8f021556231-1"><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8f021556231-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 卷名，必须是ConfigMap或者Secret卷</span></div><div class="crayon-line" id="crayon-634f9a69b9d8f021556231-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: dangconf</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8f021556231-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 挂载到容器路径</span></div><div class="crayon-line" id="crayon-634f9a69b9d8f021556231-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /etc/dangdangconfig/digital/api.config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d8f021556231-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># ConfigMap或Secret中的文件名</span></div><div class="crayon-line" id="crayon-634f9a69b9d8f021556231-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">subPath</span><span class="">: api-config.properties</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>SubPath挂载的内容不会随ConfigMap变更，这可能是Kubernetes的Bug。</p>
<div class="blog_h1"><span class="graybg">Secret</span></div>
<p>Secret是一种K8S对象，用于保存敏感信息，例如密码、OAuth令牌、SSH私钥。将这些信息存放在Secret（而不是Pod规格、Docker镜像）中更加安全、灵活。 </p>
<p>你可以在Pod的规格配置中引用Secret。</p>
<div class="blog_h2"><span class="graybg">内置Secret </span></div>
<p>K8S会自动生成一些Secret，其中包含访问API所需的凭证，并自动修改Pod以使用这些Secret。</p>
<div class="blog_h2"><span class="graybg">创建Secret</span></div>
<p>你可以通过kubectl来创建Secret：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d94640225596" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d94640225596-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9d94640225596-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d94640225596-1"><span class="crayon-c"># 创建一个名为db-user-pass的一般性Secret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-2"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">secret </span><span class="crayon-e">generic </span><span class="crayon-v">db</span><span class="crayon-o">-</span><span class="crayon-v">user</span><span class="crayon-o">-</span><span class="crayon-v">pass</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">username</span><span class="crayon-e">.txt</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">password</span><span class="crayon-e">.txt</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-4"><span class="crayon-c"># 创建用作Ingress TLS证书的Secret</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-5"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">secret </span><span class="crayon-e">tls </span><span class="crayon-v">tls</span><span class="crayon-o">-</span><span class="crayon-v">secret</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cert</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">alex</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">/</span><span class="crayon-v">tls</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">key</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">alex</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">/</span><span class="crayon-v">tls</span><span class="crayon-e">.key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-6">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-7"><span class="crayon-c"># 直接提供字面值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-8"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-e">create </span><span class="crayon-e">secret </span><span class="crayon-e">generic </span><span class="crayon-v">chartmuseum</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-v">literal</span><span class="crayon-o">=</span><span class="crayon-v">BASIC_AUTH_USER</span><span class="crayon-o">=</span><span class="crayon-v">alex</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-v">literal</span><span class="crayon-o">=</span><span class="crayon-v">BASIC_AUTH_PASS</span><span class="crayon-o">=</span><span class="crayon-e">alex</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-10"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">secrets</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-11"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-12"><span class="crayon-c"># db-user-pass&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Opaque&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 51s</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-14"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-v">secrets</span><span class="crayon-o">/</span><span class="crayon-v">db</span><span class="crayon-o">-</span><span class="crayon-v">user</span><span class="crayon-o">-</span><span class="crayon-v">pass</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-15"><span class="crayon-c"># ...</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-16"><span class="crayon-c"># Type:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Opaque</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-18"><span class="crayon-c"># Data</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-19"><span class="crayon-c"># ====</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d94640225596-20"><span class="crayon-c"># password.txt:&nbsp;&nbsp;&nbsp;&nbsp;12 bytes</span></div><div class="crayon-line" id="crayon-634f9a69b9d94640225596-21"><span class="crayon-c"># username.txt:&nbsp;&nbsp;&nbsp;&nbsp;5 bytes</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0051 seconds] -->

<p>你也可以手工的指定Secret规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d98680587887" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d98680587887-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d98680587887-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9d98680587887-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d98680587887-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9d98680587887-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d98680587887-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9d98680587887-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d98680587887-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9d98680587887-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9d98680587887-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d98680587887-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d98680587887-2"><span class="crayon-s ">kind</span><span class="">: Secret</span></div><div class="crayon-line" id="crayon-634f9a69b9d98680587887-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d98680587887-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mysecret</span></div><div class="crayon-line" id="crayon-634f9a69b9d98680587887-5"><span class="crayon-s ">type</span><span class="">: Opaque</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d98680587887-6"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9d98680587887-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 每个数据必须Base64处理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d98680587887-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># echo -n "admin" | base64</span></div><div class="crayon-line" id="crayon-634f9a69b9d98680587887-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">username</span><span class="">: YWRtaW4=</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9d98680587887-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">password</span><span class="">: MWYyZDFlMmU2N2Rm</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h2"><span class="graybg">解码Secret</span></div>
<p>使用如下命令可以获得Secret的所有属性，并输出为YML格式： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9d9c065350347" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9d9c065350347-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9d9c065350347-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">secret </span><span class="crayon-v">mysecret</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>然后你可以复制Base格式的数据并解码：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9da0796084203" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9da0796084203-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9da0796084203-1"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"MWYyZDFlMmU2N2Rm"</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">base64</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">decode</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h2"><span class="graybg">使用Secret</span></div>
<div class="blog_h3"><span class="graybg">挂载为文件</span></div>
<p>Secret可以作为数据卷挂载，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9da4024944060" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9da4024944060-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da4024944060-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9da4024944060-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: mypod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: redis</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 把foo卷只读挂载到文件系统路径下</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: foo</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: "/etc/foo"</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 定义一个名为foo的卷，其内容为mysecret这个Secret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: foo</span></div><div class="crayon-line" id="crayon-634f9a69b9da4024944060-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secret</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da4024944060-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: mysecret</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>默认的，Secret中的每个Data的key，都作为mountPath下的一个文件名。你可以定制Data到容器文件系统的映射关系：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9da8541245564" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9da8541245564-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9da8541245564-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9da8541245564-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: mypod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: redis</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: foo</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: "/etc/foo"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: foo</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secret</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: mysecret</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">items</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: username</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 在容器中，访问路径为/etc/foo/my-group/my-username</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: my-group/my-username</span></div><div class="crayon-line" id="crayon-634f9a69b9da8541245564-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 文件模式为0400，这里必须转为十进制</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9da8541245564-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">defaultMode</span><span class="">: 256</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0023 seconds] -->

<p>在容器中读取Data映射文件时，获得的是明文。 </p>
<div class="blog_h3"><span class="graybg">映射环境变量</span></div>
<p>Secret还可以映射为容器的环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dac986516098" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dac986516098-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dac986516098-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dac986516098-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dac986516098-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dac986516098-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dac986516098-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dac986516098-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dac986516098-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dac986516098-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dac986516098-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dac986516098-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dac986516098-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dac986516098-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: mycontainer</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dac986516098-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: redis</span></div><div class="crayon-line" id="crayon-634f9a69b9dac986516098-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dac986516098-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: SECRET_USERNAME</span></div><div class="crayon-line" id="crayon-634f9a69b9dac986516098-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dac986516098-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretKeyRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dac986516098-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mysecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dac986516098-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">key</span><span class="">: username</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<div class="blog_h1"><span class="graybg">ServiceAccount</span></div>
<p>当你通过kubectl访问集群时，APIServer基于特定的用户账号（默认admin）对你进行身份验证。</p>
<p>服务账号（ServiceAccount）为运行在Pod中的进程提供身份（Identity）信息，这样当这些进程联系APIServer时，也能够通过身份验证。对服务账号的授权由<a href="https://kubernetes.io/docs/admin/authorization/#a-quick-note-on-service-accounts">授权插件和策略</a>负责。</p>
<div class="blog_h2"><span class="graybg">自动化</span></div>
<p>三个组件进行协作，完成和SA相关的自动化：</p>
<ol>
<li>服务账户准入控制器（Service account admission controller），是API Server的一部分，当Pod创建或更新时：
<ol>
<li>如果该 pod 没有 ServiceAccount 设置，将其 ServiceAccount 设为 default</li>
<li>如果设置的ServiceAccount不存在则拒绝Pod</li>
<li>如果Pod不包含ImagePullSecrets设置，则将SA中的ImagePullSecrets拷贝进来</li>
<li>将一个用于访问API Server的Token作为卷挂载到Pod</li>
<li>将/var/run/secrets/kubernetes.io/serviceaccount下的VolumeSource添加到每个容器</li>
</ol>
</li>
<li>Token 控制器（Token controller），是controller-manager的一部分，异步方式来：
<ol>
<li>当SA创建后，创建对应的Secret，用于支持API 访问</li>
<li>当SA删除后，删除对应的Token Secret</li>
<li>当Token Secret删除后，在SA中去除对应的数组元素</li>
<li>当通过annotation引用了SA的ServiceAccountToken类型的Secret创建后，自动生成Token并更新Secret字段：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9db1919659370" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9db1919659370-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9db1919659370-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9db1919659370-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9db1919659370-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9db1919659370-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9db1919659370-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9db1919659370-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9db1919659370-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9db1919659370-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9db1919659370-2"><span class="crayon-s ">kind</span><span class="">: Secret</span></div><div class="crayon-line" id="crayon-634f9a69b9db1919659370-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9db1919659370-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: build-robot-secret</span></div><div class="crayon-line" id="crayon-634f9a69b9db1919659370-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9db1919659370-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 提示此Secret为了哪个SA</span></div><div class="crayon-line" id="crayon-634f9a69b9db1919659370-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/service-account<span class="crayon-o">.</span><span class="crayon-s ">name</span><span class="">: build-robot</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9db1919659370-8"><span class="crayon-s ">type</span><span class="">: kubernetes.io/service-account-token</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</li>
</ol>
</li>
<li>服务账户控制器（Service account controller）
<ol>
<li>确保每个命名空间具有default帐户</li>
</ol>
</li>
</ol>
<div class="blog_h3"><span class="graybg">Token管理器</span></div>
<p>你需要通过
			<span id="crayon-634f9a69b9db5349987445" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">service</span><span class="crayon-o">-</span><span class="crayon-v">account</span><span class="crayon-o">-</span><span class="crayon-m">private</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-o">-</span><span class="crayon-v">file</span></span></span>传递一个私钥给controller-manager，用于对SA的Token进行签名。</p>
<p>你需要通过
			<span id="crayon-634f9a69b9db9258725303" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">service</span><span class="crayon-o">-</span><span class="crayon-v">account</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-o">-</span><span class="crayon-v">file</span></span></span>传递一个公钥给kube-api-server，以便API Server对Token进行校验。</p>
<div class="blog_h3"><span class="graybg">Token卷影射</span></div>
<p>v1.12引入的Beta特性。要启用此特性，需要给API Server传递：</p>
<ol>
<li>--service-account-issuer：SA Token颁发者的标识符，颁发者会断言颁发的Token的iss claim中具有此参数的值，字符串或URI，例如kubernetes.default.svc</li>
<li>--service-account-signing-key-file：包含SA Token颁发者私钥的路径，需要打开特性TokenRequest</li>
<li>--service-account-api-audiences：API的标识符</li>
</ol>
<p>Kubelet能够把SA Token影射到Pod中，你需要提供必须的属性，包括audience、有效期：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dbd188810331" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9dbd188810331-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dbd188810331-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- image</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /var/run/secrets/tokens</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: vault-token</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">serviceAccountName</span><span class="">: build-robot</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: vault-token</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">projected</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">sources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- serviceAccountToken</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: vault-token</span></div><div class="crayon-line" id="crayon-634f9a69b9dbd188810331-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">expirationSeconds</span><span class="">: 7200</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dbd188810331-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">audience</span><span class="">: vault</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<p>对于上述配置，Kubelet会代表Pod来请求Token，并存储到对应位置，并且<span style="background-color: #c0c0c0;">在80%有效期过去后，自动刷新Token</span>。应用程序需要自己检测Token已经刷新。</p>
<div class="blog_h2"><span class="graybg">默认账号</span></div>
<p>当你创建Pod时，如果显式提供服务账号，则K8S在相同名字空间内为Pod分配一个默认账号（名为default），并自动设置到spec.serviceAccountName字段。</p>
<p>你可以在Pod内部调用K8S API，基于自动挂载的服务账号凭证（令牌）。从1.6开始，令牌的自动挂载可以禁用：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dc1172689267" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc1172689267-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9dc1172689267-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-2"><span class="crayon-s ">kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-5"><span class="crayon-c"># 在服务账号上禁用</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-6"><span class="crayon-s ">automountServiceAccountToken</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-8"><span class="crayon-o">---</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-10"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-11"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-12"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-14"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">serviceAccountName</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc1172689267-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 针对单个Pod禁用</span></div><div class="crayon-line" id="crayon-634f9a69b9dc1172689267-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">automountServiceAccountToken</span><span class="">: false</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h2"><span class="graybg">使用多账号</span></div>
<p>每个名字空间都有一个名为default的默认服务账号，你可以自己创建新的账号。</p>
<p>执行下面的命令列出所有账号：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dc5828305167" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dc5828305167-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc5828305167-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dc5828305167-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dc5828305167-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">serviceAccounts</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc5828305167-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SECRETS&nbsp;&nbsp;&nbsp;&nbsp;AGE</span></div><div class="crayon-line" id="crayon-634f9a69b9dc5828305167-3"><span class="crayon-c"># default&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1d</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>ServiceAccount的规格很简单，上一节有示例。创建账号后，你可以利用授权插件来<a href="https://kubernetes.io/docs/admin/authorization/#a-quick-note-on-service-accounts">设置账号的权限</a>。 </p>
<p>要让Pod使用非默认账号，配置spec.serviceAccountName字段即可。</p>
<div class="blog_h2"><span class="graybg">手工创建令牌</span></div>
<p>如果禁用了服务账号的自动凭证生成功能，你需要手工的创建令牌。令牌是一个Secret对象：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dc9757558391" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dc9757558391-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc9757558391-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dc9757558391-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc9757558391-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dc9757558391-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dc9757558391-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dc9757558391-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dc9757558391-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc9757558391-2"><span class="crayon-s ">kind</span><span class="">: Secret</span></div><div class="crayon-line" id="crayon-634f9a69b9dc9757558391-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc9757558391-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: build-robot-secret</span></div><div class="crayon-line" id="crayon-634f9a69b9dc9757558391-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dc9757558391-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/service-account<span class="crayon-o">.</span><span class="crayon-s ">name</span><span class="">: build-robot</span></div><div class="crayon-line" id="crayon-634f9a69b9dc9757558391-7"><span class="crayon-s ">type</span><span class="">: kubernetes.io/service-account-token</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<div class="blog_h2"><span class="graybg">ImagePullSecrets</span></div>
<p>ImagePullSecrets是用于访问镜像私服的Secret，假设你<a href="https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod">已经创建好</a>一个名为gmemregsecret的Secret， 则可以使用下面的命令，为服务账号添加ImagePullSecrets：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dcd581950373" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dcd581950373-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dcd581950373-1"><span class="crayon-e">kubectl </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">serviceaccount </span><span class="crayon-st">default</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-s">'{"imagePullSecrets": [{"name": "gmemregsecret"}]}'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h3"><span class="graybg">实例</span></div>
<p>创建docker.gmem.cc的Secret：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dd2494324700" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dd2494324700-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd2494324700-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dd2494324700-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd2494324700-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dd2494324700-1"><span class="crayon-c"># 创建名为gmemregsecret类型为docker-registry的secret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd2494324700-2"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">secret </span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-e">registry </span><span class="crayon-i">gmemregsecret</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69b9dd2494324700-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-v">server</span><span class="crayon-o">=</span><span class="crayon-v">docker</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-v">username</span><span class="crayon-o">=</span><span class="crayon-i">alex</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd2494324700-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-v">password</span><span class="crayon-o">=</span><span class="crayon-v">pswd</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-v">email</span><span class="crayon-o">=</span><span class="crayon-v">k8s</span><span class="crayon-sy">@</span><span class="crayon-v">gmem</span><span class="crayon-e">.cc</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p>查看刚刚创建的Secret：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dd6634218908" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dd6634218908-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dd6634218908-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">secret </span><span class="crayon-v">gmemregsecret</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">output</span><span class="crayon-o">=</span><span class="crayon-v">yaml</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-3"><span class="crayon-c"># apiVersion: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-4"><span class="crayon-c"># data:</span></div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-5"><span class="crayon-c">#&nbsp;&nbsp; .dockerconfigjson: eyJhdXRocyI6eyJkb2NrZXIuZ21lbS5jYzo1MDAwIjp7InVzZXJuYW1lIjoiYWxleCIsInBhc3N3b3JkIjoibGF2ZW5kZXIiLCJlbWFpbCI6Ims4c0BnbWVtLmNjIiwiYXV0aCI6IllXeGxlRHBzWVhabGJtUmxjZz09In19fQ==</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-6"><span class="crayon-c"># kind: Secret</span></div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-7"><span class="crayon-c"># metadata:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-8"><span class="crayon-c">#&nbsp;&nbsp; creationTimestamp: 2018-02-11T14:04:52Z</span></div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-9"><span class="crayon-c">#&nbsp;&nbsp; name: gmemregsecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-10"><span class="crayon-c">#&nbsp;&nbsp; namespace: default</span></div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-11"><span class="crayon-c">#&nbsp;&nbsp; resourceVersion: "1023033"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-12"><span class="crayon-c">#&nbsp;&nbsp;selfLink: /api/v1/namespaces/default/secrets/gmemregsecret</span></div><div class="crayon-line" id="crayon-634f9a69b9dd6634218908-13"><span class="crayon-c">#&nbsp;&nbsp;uid: 87db6e2e-0f34-11e8-92db-deadbeef00a0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dd6634218908-14"><span class="crayon-c"># type: kubernetes.io/dockerconfigjson</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>其中data字段为BASE64编码的密码数据，可以查看一下它的明文：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dda842542953" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dda842542953-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dda842542953-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dda842542953-1"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-v">eyJhdXRocyI6eyJkb2NrZXIuZ21lbS5jYzo1MDAwIjp7InVzZXJuYW1lIjoiYWxleCIsInBhc3N3b3JkIjoibGF2ZW5kZXIiLCJlbWFpbCI6Ims4c0BnbWVtLmNjIiwiYXV0aCI6IllXeGxlRHBzWVhabGJtUmxjZz09In19fQ</span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">base64</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">d</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dda842542953-2"><span class="crayon-c"># {"auths":{"docker.gmem.cc":{"username":"alex","password":"lavender","email":"k8s@gmem.cc","auth":"YWxleDpsYXZlbmRlcg=="}}}alex@Zircon:~$ </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>现在你可以创建使用此Secret来拉取镜像的Pod了：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dde197562419" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dde197562419-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dde197562419-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dde197562419-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: digitalsrv-1</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">tier</span><span class="">: rpc</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: digitalsrv</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: digitalsrv-1</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: docker.gmem.cc/digitalsrv</span><span class="">:1.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dde197562419-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">imagePullSecrets</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dde197562419-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: gmemregsecret</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h3"><span class="graybg">为默认账号分配</span></div>
<p>执行
			<span id="crayon-634f9a69b9de2236415414" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">edit </span><span class="crayon-e">serviceaccounts </span><span class="crayon-st">default</span></span></span>，修改为如下内容：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9de5372276011" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9de5372276011-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9de5372276011-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9de5372276011-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-2"><span class="crayon-s ">kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: 2018-02-12T07</span><span class="">:53</span><span class="">:30Z</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resourceVersion</span><span class="">: "1843"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selfLink</span><span class="">: /api/v1/namespaces/default/serviceaccounts/default</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">uid</span><span class="">: d0e062a3-0fc9-11e8-b942-deadbeef00a0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-10"><span class="crayon-s ">secrets</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-11"><span class="crayon-s ">- name</span><span class="">: default-token-j9zdx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9de5372276011-12"><span class="crayon-s ">imagePullSecrets</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9de5372276011-13"><span class="crayon-s ">- name</span><span class="">: gmemregsecret</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>或者，执行命令：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dea369861796" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dea369861796-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dea369861796-1"><span class="crayon-e">kubectl </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">serviceaccount </span><span class="crayon-st">default</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-s">'{"imagePullSecrets": [{"name": "gmemregsecret"}]}'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h1"><span class="graybg">控制器</span></div>
<div class="blog_h2"><span class="graybg">ReplicaSet</span></div>
<p>下一代复制控制器，与Replication Controller仅仅的不同是对选择器的支持， ReplicaSet支持指定set-based的选择器（来匹配Pod），后者仅支持equality-based的选择器。</p>
<p>尽管ReplicaSet可以被独立使用，但是实际上它主要通过Deployment间接使用，作为编排Pod创建、更新、删除的工具。使用Deployment时你无需关心其自动创建的ReplicaSet对象。</p>
<p>ReplicaSet用于确保，在任何时刻，指定数量的Pod实例同时在集群中运行。示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dee021208561" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9dee021208561-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dee021208561-40">40</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dee021208561-1"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-2"><span class="crayon-s ">kind</span><span class="">: ReplicaSet</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: frontend</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: guestbook</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">tier</span><span class="">: frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 复制实例的数量，默认1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 选择器，用于匹配被控制的Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 只要匹配，即使Pod不是ReplicaSet自己创建的，也被管理 —— 这允许替换ReplicaSet而不影响已存在的Pod的控制</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">tier</span><span class="">: frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-s ">key</span><span class="">: tier</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">operator</span><span class="">: In</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">values</span><span class="">: [frontend]</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># template是spec段唯一强制要求的元素，提供一个Pod模板</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 此Pod模板的结构和Pod对象完全一样，只是没有apiVersion/kind字段</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># ReplicaSet中的Pod模板必须指定标签、以及适当的重启策略</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: guestbook</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">tier</span><span class="">: frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: php-redis</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: gcr.io/google_samples/gb-frontend</span><span class="">:v3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">cpu</span><span class="">: 100m</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">memory</span><span class="">: 100Mi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: GET_HOSTS_FROM</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: dns</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果集群没有配备DNS Addon，则可以从环境变量获取service的主机名</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># value: env</span></div><div class="crayon-line" id="crayon-634f9a69b9dee021208561-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dee021208561-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0037 seconds] -->

<div class="blog_h3"><span class="graybg">删除</span></div>
<p>要删除ReplicaSet及其Pod，可以使用
			<span id="crayon-634f9a69b9df2270274797" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-v">delete</span></span></span>命令。Kubectl会将ReplicaSet缩容为0，并在删除ReplicaSet之前等待其所有Pod的删除，使用REST API或者Go客户端库时，你需要手工缩容、等待Pod删除、并删除ReplicaSet。</p>
<p>要仅删除ReplicaSet，可以使用
			<span id="crayon-634f9a69b9df6240166456" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-v">delete</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cascade</span><span class="crayon-o">=</span><span class="crayon-t">false</span></span></span>命令。 使用REST API/Go客户端库时，简单删除ReplicaSet对象即可。</p>
<p>在删除ReplicaSet之后，你可以创建.spec.selector字段与之一样的新的ReplicaSet，这个新的RS会管理原先的Pod。但是现有Pod不会匹配新RS的Pod 模板，你可以通过滚动更新（Rolling Update）实现现有Pod的更新。</p>
<div class="blog_h3"><span class="graybg">隔离Pod</span></div>
<p>要从RS中隔离一个Pod，可以修改Pod的标签。注意，此Pod会很快被代替，以满足ReplicaSet的复制数量要求。</p>
<div class="blog_h3"><span class="graybg">扩容</span></div>
<p>要对RS进行扩容/缩容，你仅仅需要更新.spec.replicas字段。</p>
<div class="blog_h3"><span class="graybg">配合HPA</span></div>
<p>RS可以作为Pod水平自动扩容器（Horizontal Pod Autoscaler）的目标。HPA的示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dfb556643924" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dfb556643924-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dfb556643924-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-1"><span class="crayon-v">apiVersion</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">autoscaling</span><span class="crayon-o">/</span><span class="crayon-e">v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-2"><span class="crayon-v">kind</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">HorizontalPodAutoscaler</span></div><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-3"><span class="crayon-v">metadata</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">frontend</span><span class="crayon-o">-</span><span class="crayon-e">scaler</span></div><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-5"><span class="crayon-v">spec</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 扩容控制的目标</span></div><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">scaleTargetRef</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">kind</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">ReplicaSet</span></div><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-9"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-10"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-v">minReplicas</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line" id="crayon-634f9a69b9dfb556643924-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">maxReplicas</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">10</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dfb556643924-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">targetCPUUtilizationPercentage</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>v2版本的HPA示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9dff997794083" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9dff997794083-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9dff997794083-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9dff997794083-1"><span class="crayon-s ">apiVersion</span><span class="">: autoscaling/v2beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-2"><span class="crayon-s ">kind</span><span class="">: HorizontalPodAutoscaler</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: podinfo</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">scaleTargetRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersion</span><span class="">: apps/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: podinfo</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">minReplicas</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">maxReplicas</span><span class="">: 5</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">metrics</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- type</span><span class="">: Resource</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resource</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9dff997794083-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: cpu</span></div><div class="crayon-line" id="crayon-634f9a69b9dff997794083-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetAverageUtilization</span><span class="">: 50 </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>针对上述配置文件调用kubectl create -f即可创建HPA。你也可以直接调用</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e03295354558" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e03295354558-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e03295354558-1"><span class="crayon-e">kubectl </span><span class="crayon-e">autoscale </span><span class="crayon-e">rs </span><span class="crayon-v">frontend</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p> 更加简便。</p>
<div class="blog_h2"><span class="graybg">ReplicationController</span></div>
<p>类似于ReplicaSet。ReplicaSet是下一代的复制控制器。</p>
<p>大部分支持ReplicationController的kubectl命令，同时也支持ReplicaSet，一个例外是rolling-update命令。此命令专门用于RC的滚动更新  —— 每次更新一个Pod。</p>
<div class="blog_h2"><span class="graybg">Deployment</span></div>
<p>此控制器为Pod或ReplicaSet提供声明式的更新支持。在Deployment中，你可以指定一个期望状态，Deployment控制器会以一定的控制速率来修改实际状态，让它和期望状态匹配。通过定义Deployment你可以创建新的ReplicaSet，或者移除现有的Deployment并接收其全部资源。</p>
<p>Deployment的典型应用场景：</p>
<ol>
<li>创建一个Deployment，来rollout一个ReplicaSet。ReplicaSet会在后台创建Pod。检查rollout的状态来确认是否成功</li>
<li>更新Deployment的PodTemplateSpec部分，来声明Pods的新状态。一个新的复制集会被创建，Pod会已移动的速率，从老的复制集中移动到新的复制集</li>
<li>回滚到旧的部署版本，如果当前版本的部署不稳定，则可以回滚到旧的Deployment版本</li>
<li>扩容以满足负载需要</li>
<li>暂停部署，对PodTemplateSpec进行更新，然后恢复部署，进行rollout</li>
<li>将Deployment的状态作为rollout卡死的提示器</li>
<li>清除你不再需要的复制集</li>
</ol>
<div class="blog_h3"><span class="graybg">创建</span></div>
<p>下面的例子创建了三个运行Nginx的Pod构成的复制集：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e07478506190" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e07478506190-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e07478506190-39">39</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e07478506190-1"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-2"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 复制集容量</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可选此控制器如何找到需要管理的Pod，必须匹配.spec.template.metadata.labels</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如何替换旧Pod的策略，Recreate或RollingUpdate，默认RollingUpdate</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Recreate 当新的Pod创建之前，所有旧Pod被删除</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># RollingUpdate 滚动更新（逐步替换）</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-17"><span class="crayon-h">&nbsp;&nbsp;</span>strategy<span class="crayon-o">.</span><span class="crayon-s ">type</span><span class="">: RollingUpdate</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 更新期间，处于不可用状态的Pod的数量，可以指定绝对值或者百分比。默认25</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-19"><span class="crayon-h">&nbsp;&nbsp;</span>strategy<span class="crayon-o">.</span>rollingUpdate<span class="crayon-o">.</span><span class="crayon-s ">maxUnavailable</span><span class="">: 0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 更新期间，同时存在的Pod可以超过期望数量的多少，可以指定绝对值或者百分比。默认25</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-21"><span class="crayon-h">&nbsp;&nbsp;</span>strategy<span class="crayon-o">.</span>rollingUpdate<span class="crayon-o">.</span><span class="crayon-s ">maxSurge</span><span class="">: 1 </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 在报告failed progressing之前等待更新完成的最长时间</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">progressDeadlineSeconds</span><span class="">: 60</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 新创建的Pod，最少在启动多久后，才被认为是Ready。默认0</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">minReadySeconds</span><span class="">: 0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 保留rollout历史的数量，默认无限</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">revisionHistoryLimit</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Pod的模板</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: nginx</span><span class="">:1.7.9</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e07478506190-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 打开端口80，供Pod使用</span></div><div class="crayon-line" id="crayon-634f9a69b9e07478506190-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->

<p>根据上述规格创建Deployment：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e0c313732203" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e0c313732203-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e0c313732203-32">32</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-1"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-e">.yaml</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-4"><span class="crayon-c"># 获取对象信息</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-5"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">deployments</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-6"><span class="crayon-c"># 部署名称&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;期望实例数&nbsp;&nbsp;当前运行实体数&nbsp;&nbsp;到达期望状态实例数 对用户可用实例数&nbsp;&nbsp; 应用运行时长</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-7"><span class="crayon-c"># UP-TO-DATE 意味着使用最新的Pod模板</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-8"><span class="crayon-c"># AVAILABLE的Pod至少进入Ready状态.spec.minReadySeconds秒</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-9"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DESIRED&nbsp;&nbsp; CURRENT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UP-TO-DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVAILABLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-10"><span class="crayon-c"># nginx-deployment&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1s</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-12"><span class="crayon-c"># 要查看部署的rollout状态，可以执行：</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-13"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">status </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-14"><span class="crayon-c"># Waiting for rollout to finish: 2 out of 3 new replicas have been updated...</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-15"><span class="crayon-c"># deployment "nginx-deployment" successfully rolled out</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-16">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-17"><span class="crayon-c"># 一段时间后，再次获取对象信息</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-18"><span class="crayon-e">NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">DESIRED&nbsp;&nbsp; </span><span class="crayon-e">CURRENT&nbsp;&nbsp; </span><span class="crayon-v">UP</span><span class="crayon-o">-</span><span class="crayon-st">TO</span><span class="crayon-o">-</span><span class="crayon-r">DATE</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">AVAILABLE&nbsp;&nbsp; </span><span class="crayon-e">AGE</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-19"><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-i">deployment</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">18s</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-20">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-21"><span class="crayon-c"># 要查看Deployment自动创建的复制集，执行</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-22"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">rs</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-23"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DESIRED&nbsp;&nbsp; CURRENT&nbsp;&nbsp; READY&nbsp;&nbsp; AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-24"><span class="crayon-c"># nginx-deployment-2035384211&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18s</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-25"><span class="crayon-c"># 复制集名称的格式为 [DEPLOYMENT-NAME]-[POD-TEMPLATE-HASH-VALUE]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-26">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-27"><span class="crayon-c"># 要查看为Pod自动创建的标签，执行</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-28"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">show</span><span class="crayon-o">-</span><span class="crayon-v">labels</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-29"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READY&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;RESTARTS&nbsp;&nbsp; AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LABELS</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-30"><span class="crayon-c"># nginx-deployment-2035384211-7ci7o&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app=nginx,pod-template-hash=2035384211</span></div><div class="crayon-line" id="crayon-634f9a69b9e0c313732203-31"><span class="crayon-c"># nginx-deployment-2035384211-kzszj&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app=nginx,pod-template-hash=2035384211</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e0c313732203-32"><span class="crayon-c"># nginx-deployment-2035384211-qqcnn&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app=nginx,pod-template-hash=2035384211</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

<div class="blog_h3"><span class="graybg">更新</span></div>
<p>部署的rollout仅仅在其Pod模板发生变化时才会触发。其它情况，例如进行扩容，不会触发rollout。</p>
<p>修改Pod使用的镜像，示例命令：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e11100502081" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e11100502081-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e11100502081-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e11100502081-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e11100502081-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e11100502081-1"><span class="crayon-c"># 方式一</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e11100502081-2"><span class="crayon-e">kubectl </span><span class="crayon-e">set </span><span class="crayon-e">image </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-e">deployment </span><span class="crayon-v">nginx</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span><span class="crayon-o">:</span><span class="crayon-cn">1.9.1</span></div><div class="crayon-line" id="crayon-634f9a69b9e11100502081-3"><span class="crayon-c"># 方式二</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e11100502081-4"><span class="crayon-e">kubectl </span><span class="crayon-e">edit </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>Deployment能够控制在更新时：</p>
<ol>
<li>仅一定数量的Pod可以处于宕机状态。默认值是，最多运行期望Pod数量 - 1个处于宕机状态</li>
<li>存在超过期望数量的Pod存在。默认值是，最多同时存在 期望Pod数量 + 1 个Pod。K8S会先创建新Pod，然后删除旧Pod，这会导致同时存在的Pod数量超过期望Pod数</li>
</ol>
<p>Deployment允许多重同时进行中的更新（multiple updates in-flight），所谓Rollover。每当部署控制器监控到新的Deployment对象时，旧有的控制标签匹配.spec.selector而模板不匹配.spec.template的Pod复制集会缩容为0，新的复制集则会扩容到期望Pod数量。如果你更新Deployment时，它正在进行rollout，则新的复制集被创建（每次更新对应一个）并扩容，并且roll over 前一次更新创建的复制集 —— 将其加入到旧复制集列表，并进行缩容。举例来说：</p>
<ol>
<li>某个部署创建了5实例的nginx:1.7.9</li>
<li>随后更新部署为5实例的nginx:1.9.1，此时nginx:1.7.9的3个实例已经被创建</li>
<li>这时，部署控制器会立刻杀死nginx:1.7.9的3个实例，随后开始创建nginx:1.9.1实例。而不是等待nginx:1.7.9的5个实例都创建完毕，再对其缩容</li>
</ol>
<p>你也可以进行标签选择器的更新，但是这并不推荐，你应该预先规划好标签。</p>
<div class="blog_h3"><span class="graybg">回滚</span></div>
<p>某些情况下你需要回滚一次部署，这通常是因为新版本存在问题，例如无限循环崩溃。</p>
<p>默认情况下，Deployment所有的rollout历史（revision）都会保存在系统中，方便你随时进行回滚。注意revision仅仅在Deployment的rollout被触发时才生成，也就是仅仅在Deployment的Pod模板变更时才生成。执行回滚后，仅仅Pod模板部分被回滚，扩容、标签部分不受影响。</p>
<p>相关命令：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e15851771754" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e15851771754-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e15851771754-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e15851771754-1"><span class="crayon-c"># 列出rollout历史</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-2"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">history </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-3"><span class="crayon-c"># deployments "nginx-deployment"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-4"><span class="crayon-c"># REVISION&nbsp;&nbsp;&nbsp;&nbsp;CHANGE-CAUSE</span></div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-5"><span class="crayon-c"># 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kubectl create -f docs/user-guide/nginx-deployment.yaml --record</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-6"><span class="crayon-c"># 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</span></div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-7"><span class="crayon-c"># 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kubectl set image deployment/nginx-deployment nginx=nginx:1.91</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-9"><span class="crayon-c"># 查看某次rollout的详细信息</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-10"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">history </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">revision</span><span class="crayon-o">=</span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-12"><span class="crayon-c"># 回滚到上一个版本</span></div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-13"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">undo </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e15851771754-15"><span class="crayon-c"># 回滚到指定的版本</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e15851771754-16"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">undo </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-st">to</span><span class="crayon-o">-</span><span class="crayon-v">revision</span><span class="crayon-o">=</span><span class="crayon-cn">2</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0023 seconds] -->

<div class="blog_h3"><span class="graybg">扩容</span></div>
<p>设置Pod实例数量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e1a777866639" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e1a777866639-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e1a777866639-1"><span class="crayon-e">kubectl </span><span class="crayon-e">scale </span><span class="crayon-e">deployment </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">10</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>如果集群启用了Pod自动水平扩容（horizontal pod autoscaling），你可以为Deployment设置autoscaler：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e1e777590472" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e1e777590472-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e1e777590472-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e1e777590472-1"><span class="crayon-c"># 实例数量在10到15之间，尽可能让这些实例的CPU占用靠近80%</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e1e777590472-2"><span class="crayon-e">kubectl </span><span class="crayon-e">autoscale </span><span class="crayon-e">deployment </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">=</span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">max</span><span class="crayon-o">=</span><span class="crayon-cn">15</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cpu</span><span class="crayon-o">-</span><span class="crayon-v">percent</span><span class="crayon-o">=</span><span class="crayon-cn">80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h3"><span class="graybg">暂停/恢复</span></div>
<p>在触发一个或多个更新之前，你可以暂停Deployment，避免不必要的rollout：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e22622429798" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e22622429798-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e22622429798-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e22622429798-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e22622429798-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e22622429798-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e22622429798-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e22622429798-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e22622429798-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e22622429798-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e22622429798-1"><span class="crayon-c"># 暂停rollout</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e22622429798-2"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">pause </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9e22622429798-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e22622429798-4"><span class="crayon-c"># 更新Deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9e22622429798-5"><span class="crayon-e">kubectl </span><span class="crayon-e">set </span><span class="crayon-e">image </span><span class="crayon-v">deploy</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-e">deployment </span><span class="crayon-v">nginx</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span><span class="crayon-o">:</span><span class="crayon-cn">1.9.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e22622429798-6"><span class="crayon-e">kubectl </span><span class="crayon-e">set </span><span class="crayon-e">resources </span><span class="crayon-e">deployment </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">c</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">limits</span><span class="crayon-o">=</span><span class="crayon-v">cpu</span><span class="crayon-o">=</span><span class="crayon-cn">200m</span><span class="crayon-sy">,</span><span class="crayon-v">memory</span><span class="crayon-o">=</span><span class="crayon-cn">512Mi</span></div><div class="crayon-line" id="crayon-634f9a69b9e22622429798-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e22622429798-8"><span class="crayon-c"># 恢复rollout</span></div><div class="crayon-line" id="crayon-634f9a69b9e22622429798-9"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">resume </span><span class="crayon-v">deploy</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0023 seconds] -->

<div class="blog_h3"><span class="graybg">查看状态</span></div>
<p>Deployment在其生命周期中，会进入若干不同的状态：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">状态</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>progressing</td>
<td>
<p>执行以下任务之一时，K8S将Deployment标记为此状态：</p>
<ol>
<li>Deployment创建了新的复制集</li>
<li>Deployment正在扩容到最新的复制集</li>
<li>Deployment正在缩容到较老的复制集</li>
<li>新的Pod变为ready或available</li>
</ol>
</td>
</tr>
<tr>
<td>complete</td>
<td>
<p>如果具有以下特征，K8S将Deployment标记为此状态：</p>
<ol>
<li>所有Pod实例都更新为最新的版本</li>
<li>所有Pod实例均可用</li>
<li>不存在旧版本的Pod实例在运行</li>
</ol>
</td>
</tr>
<tr>
<td>fail to progress</td>
<td>
<p>无法部署Deployment的最新复制集，可能原因是：</p>
<ol>
<li>配额不足</li>
<li>Readiness探针失败</li>
<li>Image拉取出错</li>
<li>权限不足</li>
<li>应用程序的运行时配置存在问题</li>
</ol>
<p>具体多久没有完成部署，会让Deployment变为此状态，受spec.progressDeadlineSeconds控制</p>
<p>一旦超过上述Deadline，则部署控制器为Deployment.status.conditions添加一个元素，其属性为</p>
<p style="padding-left: 60px;">Type=Progressing,Status=False,Reason=ProgressDeadlineExceeded</p>
<p>注意，暂停中的Deployment不会超过Deadline</p>
</td>
</tr>
</tbody>
</table>
<p>执行下面的命令可以查看Deployment的状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e26752958542" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e26752958542-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e26752958542-1"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-v">status</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<div class="blog_h3"><span class="graybg">更新历史清理</span></div>
<p>设置Deployment的.spec.revisionHistoryLimit字段，可以控制更新历史（也就是多少旧的ReplicaSet）被保留，默认所有历史都保留。</p>
<div class="blog_h2"><span class="graybg">StatefulSet</span></div>
<p>原先叫做PetSet。该控制器用于管理部署、扩容Pod集。并提供一个保证：确保Pod的有序性、唯一性。</p>
<p>和Deployment类似，SS也能管理（基于相同的容器规格的一组）Pods，但是SS还能够维护每个Pod的粘性身份（Sticky Identity ）。尽管这些Pod的规格完全一样，但是不能相互替换（有状态），每个Pod都有自己的持久化的唯一标识，即使发生重新调度，也不会改变。</p>
<p>SS的行为模式和其它控制器类似，你需要定义一个StatefulSet对象，说明期望的状态。StatefulSet控制器会执行必要的更新以达到此状态。</p>
<p>对于有以下需求的应用程序，考虑使用SS：</p>
<ol>
<li>稳定（Pod重调度后不变）的、唯一的网络标识符（network identity）</li>
<li>稳定的、持久的存储</li>
<li>有序的、优雅的部署和扩容</li>
<li>有序的、优雅的删除和终结</li>
<li>有序的、自动化的滚动更新</li>
</ol>
<p>如果不满足上述需求之一，你应该考虑提供无状态复制集的控制器，例如Deployment、ReplicaSet。</p>
<p>使用SS时，要注意：</p>
<ol>
<li>在1.9之前处于Beta状态，1.5-版本完全不可用</li>
<li>和其它所有Alpha/Beta资源一样，SS可以通过APIServer参数--runtime-config禁用</li>
<li>Pod所需的存储资源，要么由 PersistentVolume Provisioner 提供，要么由管理员预先提供</li>
<li>删除/缩容SS时，和SS关联的卷不会自动删除</li>
<li>SS目前依赖Headless Service，后者负责维护Pod的网络标识符，此Service需要你来创建</li>
</ol>
<p>Headless Service的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e2b054597817" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e2b054597817-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e2b054597817-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-1"><span class="crayon-c"># 用于控制网络域（Network Domain）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-3"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: web</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">clusterIP</span><span class="">: None</span></div><div class="crayon-line" id="crayon-634f9a69b9e2b054597817-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e2b054597817-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>StatefulSet的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e30801559206" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e30801559206-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e30801559206-40">40</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e30801559206-1"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-2"><span class="crayon-s ">kind</span><span class="">: StatefulSet</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: web</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 1.8-，如果spec.selector不设置，K8S使用默认值</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 1.8+，不设置和.spec.template.metadata.labels匹配的值会在创建SS时出现验证错误</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx # has to match .spec.template.metadata.labels</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 管理此SS的Headless Service的名称</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: "nginx"</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 包含三个有标识的Pod中启动的Nginx容器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 3&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx # has to match .spec.selector.matchLabels</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationGracePeriodSeconds</span><span class="">: 10</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: gcr.io/google_containers/nginx-slim</span><span class="">:0.8</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: web</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 将卷www挂载到目录树</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: www</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /usr/share/nginx/html</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-31"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 使用PersistentVolumeProvisioner提供的PersistentVolume，作为持久化的存储</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeClaimTemplates</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: www</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">: [ "ReadWriteOnce" ]</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storageClassName</span><span class="">: my-storage-class</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e30801559206-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e30801559206-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 1Gi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->

<div class="blog_h3"><span class="graybg">Pod身份</span></div>
<p>SS创建的Pod具有唯一性的身份，此身份对应了稳定的网络标识符、稳定的存储。 此身份总是关联到Pod，不管Pod被重新调度到哪个节点上。</p>
<p>序号索引：对于副本份数为N的SS，每个Pod被分配一个整数序号，值范围 [ 0, N)</p>
<p>稳定网络标识符：每个Pod的hostname的形式为
			<span id="crayon-634f9a69b9e34779251145" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-i">SS</span>名称<span class="crayon-sy">}</span><span class="crayon-o">-</span><span class="crayon-sy">$</span><span class="crayon-sy">{</span>序号索引<span class="crayon-sy">}</span></span></span>。例如上面的例子中，会创建web-0、web-1、web-2三个Pod。</p>
<p>SS可以利用Headless Service来控制其Pod的域名，HS的域名格式为
			<span id="crayon-634f9a69b9e38208418133" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-e">service </span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">namespace</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">svc</span><span class="crayon-sy">.</span><span class="crayon-v">cluster</span><span class="crayon-sy">.</span><span class="crayon-v">local</span></span></span>，其中cluster.local是集群的域名，上例中的HS域名为nginx.default.svc.cluster.local。</p>
<p>在HS的管理下，Pod的域名格式为
			<span id="crayon-634f9a69b9e3c986363854" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">podname</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-e">governing </span><span class="crayon-e">service </span><span class="crayon-v">domain</span><span class="crayon-sy">)</span></span></span>，因此web-0的域名为web-0.nginx.default.svc.cluster.local</p>
<div class="blog_h3"><span class="graybg">稳定存储</span></div>
<p>对于每个VolumeClaimTemplate，K8S会创建对应的PersistentVolume。在上面的例子中，每个Pod会被赋予StorageClass为my-storage-class的单个PersistentVolume，以及1GB的存储空间。如果不指定StorageClass使用默认值。</p>
<p>当Pod被重新调度时，volumeMounts指定的挂载规则会重新挂载PersistentVolume。此外，即使SS或Pod被删除，PersistentVolume也不会被自动删除，你必须手工的删除它。</p>
<div class="blog_h3"><span class="graybg">Pod标签</span></div>
<p>SS创建一个新Pod时，会为其添加一个标签：statefulset.kubernetes.io/pod-name。通过此标签，你可以为某个Pod实例Attach一个服务。</p>
<div class="blog_h3"><span class="graybg">部署/扩容保证</span></div>
<ol>
<li>当SS部署Pod时，会顺序的依次创建，从序号0开始逐个的</li>
<li>当SS删除Pod时，会逆序的依次删除，从序号N-1开始逐个的</li>
<li>水平扩容时，新序号之前的所有Pod必须已经Running &amp; Ready</li>
<li>在Pod被终结时，其后面的所有Pod必须已经被完全关闭</li>
</ol>
<p>SS不应该指定pod.Spec.TerminationGracePeriodSeconds=0。</p>
<div class="blog_h2"><span class="graybg">DaemonSet</span></div>
<p>该控制器能确保所有（或部分）节点运行Pod的单个副本。每当节点加入到集群时，Pod就被添加到其上；每当节点离开集群时，其上的Pod就被回收。删除DS会导致所有Pod被删除。</p>
<p>DS的典型应用场景包括：</p>
<ol>
<li>运行集群级别的存储守护程序，例如glusterd、ceph这些程序每个节点仅需要一个</li>
<li>在每个节点运行日志收集程序，例如fluentd、logstash</li>
<li>在每个节点上运行监控程序，例如collectd</li>
</ol>
<p>DS的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e41787337503" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9e41787337503-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e41787337503-44">44</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e41787337503-1"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-2"><span class="crayon-s ">kind</span><span class="">: DaemonSet</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: fluentd-elasticsearch</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: kube-system</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">k8s-app</span><span class="">: fluentd-logging</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: fluentd-elasticsearch</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: fluentd-elasticsearch</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 用于仅仅在部分节点上运行Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodeSelector</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">tolerations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: node-role.kubernetes.io/master</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">effect</span><span class="">: NoSchedule</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: fluentd-elasticsearch</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: gcr.io/google-containers/fluentd-elasticsearch</span><span class="">:1.20</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">limits</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">memory</span><span class="">: 200Mi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">cpu</span><span class="">: 100m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">memory</span><span class="">: 200Mi</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: varlog</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /var/log</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: varlibdockercontainers</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /var/lib/docker/containers</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationGracePeriodSeconds</span><span class="">: 30</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: varlog</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /var/log</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: varlibdockercontainers</span></div><div class="crayon-line" id="crayon-634f9a69b9e41787337503-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e41787337503-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /var/lib/docker/containers</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0040 seconds] -->

<div class="blog_h3"><span class="graybg">和DS的Pod通信</span></div>
<p>要和DaemonSet中的Pod通信，有以下几种手段：</p>
<ol>
<li>Push：DS中的Pod可能配置为，向其它服务发送更新，例如向统计数据库</li>
<li>节点IP + 已知端口：Pod可能使用hostPort来暴露端口</li>
<li>DNS：使用和DS相同的Pod选择器，创建一个Headless Service。然后你可以通过endpoints资源来发现DS</li>
</ol>
<div class="blog_h3"><span class="graybg">hostPort</span></div>
<p>可以为DaemonSet的Pod声明hostPort，这样，宿主机的端口会通过iptables的NAT转发给Pod：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e45596630448" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e45596630448-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e45596630448-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e45596630448-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e45596630448-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e45596630448-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e45596630448-1"><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e45596630448-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: http</span></div><div class="crayon-line" id="crayon-634f9a69b9e45596630448-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containerPort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e45596630448-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9e45596630448-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostPort</span><span class="">: 80 </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<div class="blog_h2"><span class="graybg">Job</span></div>
<p>Job可以创建一或多个Pod，并且确保一定数量的Pod成功的完成。Job会跟踪Pod们的执行状态，并判断它们是否成功执行，当指定数量的Pod成功了，则Job本身的状态变为成功。删除Job会清理掉它创建的Pod。</p>
<p>Job的一个简单用例是，确保Pod成功执行完成。如果第一个Pod失败/被删除，则Job会启动第二个实例。</p>
<p>Job也支持并行的运行多个Pod。</p>
<p>Job的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e54722236026" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e54722236026-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e54722236026-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e54722236026-1"><span class="crayon-s ">apiVersion</span><span class="">: batch/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-2"><span class="crayon-s ">kind</span><span class="">: Job</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pi</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pi</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: pi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: perl</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ["perl"</span><span class="crayon-o">,</span><span class="crayon-h">&nbsp;&nbsp;</span>"-Mbignum=bpi"<span class="crayon-o">,</span><span class="crayon-h"> </span>"-wle"<span class="crayon-o">,</span><span class="crayon-h"> </span>"print<span class="crayon-h"> </span>bpi<span class="crayon-sy">(</span>2000<span class="crayon-sy">)</span>"<span class="crayon-o">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e54722236026-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: Never</span></div><div class="crayon-line" id="crayon-634f9a69b9e54722236026-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">backoffLimit</span><span class="">: 4</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<div class="blog_h2"><span class="graybg">CronJob</span></div>
<p>定期调度执行的Job，规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e58518337819" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e58518337819-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e58518337819-32">32</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e58518337819-1"><span class="crayon-s ">apiVersion</span><span class="">: batch/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-2"><span class="crayon-s ">kind</span><span class="">: CronJob</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: hello</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Cron表达式，每分钟执行</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">schedule</span><span class="">: "*/1 * * * *"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果由于某些原因，错过了调度时间，那么在什么时间差异之内，允许启动Job。默认没有deadline，总是允许启动</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">startingDeadlineSeconds</span><span class="">: 5</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 并发控制策略，此CronJob创建的多个Job如何并发运行</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Allow，默认，允许并发运行多个Job</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Forbid，禁止并发运行，如果尝试调度时发现先前的Job仍然在运行，跳过本次调度</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Replace，禁止并发运行，如果尝试调度时发现先前的Job仍然在运行，替换掉先前的Job</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">concurrencyPolicy</span><span class="">: Allow</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果设置为true，则暂停后续调度，已经存在的Job不受影响</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">suspend</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 保留的成功、失败的Job的数量.超过限制则删除对应的K8S资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">successfulJobsHistoryLimit</span><span class="">: 3</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">failedJobsHistoryLimit</span><span class="">: 0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">jobTemplate</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 下面的配置同Job</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: hello</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">args</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>/bin/sh</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>-c</div><div class="crayon-line" id="crayon-634f9a69b9e58518337819-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>date</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e58518337819-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: OnFailure</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0026 seconds] -->

<div class="blog_h2"><span class="graybg">垃圾回收</span></div>
<p>Kubernetes garbage collector是控制器的一种，它的职责是<span style="background-color: #c0c0c0;">删除</span>哪些<span style="background-color: #c0c0c0;">曾经拥有</span>，但是<span style="background-color: #c0c0c0;">现在已经没有Owner的对象</span>。</p>
<div class="blog_h3"><span class="graybg">对象所有权</span></div>
<p>某些对象是其它对象的所有者（Owner），例如ReplicaSet是一系列Pod的所有者。被所有者管理的对象称为依赖者（Dependent ）。任何依赖者都具有字段 <span style="background-color: #c0c0c0;">metadata.ownerReferences</span>，指向其所有者。</p>
<p>某些情况下，K8S会自动设置ownerReference。例如创建ReplicaSet时，对应Pod的ownerReference即自动设置。常作为所有者的内置资源类型包括ReplicationController, ReplicaSet, StatefulSet, DaemonSet, Deployment, Job和CronJob。</p>
<p>你也可以手工配置ownerReference字段，以建立所有者-依赖者关系。</p>
<div class="blog_h3"><span class="graybg">依赖者的删除</span></div>
<p>在删除对象时，可以指定是否级联删除（Cascading deletion）其依赖者（依赖被删除对象的哪些对象）。级联删除有两种执行模式：前台删除、后台删除。</p>
<div class="blog_h3"><span class="graybg">前台删除</span></div>
<p>在这种模式下，根对象（被显式删除的顶级Owner）首先进入删除中“（deletion in progress）”状态。此时：</p>
<ol>
<li>对象仍然可以通过REST API看到</li>
<li>对象的deletionTimestamp字段不再为空</li>
<li>对象的
			<span id="crayon-634f9a69b9e5e486746568" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">metadata</span><span class="crayon-sy">.</span><span class="crayon-v">finalizers</span></span></span>数组包含元素“foregroundDeletion“</li>
</ol>
<p>一旦进入“删除中”状态，垃圾回收器就开始删除对象的依赖者。一旦所有<span style="background-color: #c0c0c0;">阻塞依赖者</span>（ownerReference.blockOwnerDeletion=true）全被删除，根对象就被删除。</p>
<p>当某种控制器设置了ownerReferences，它也会自动设置blockOwnerDeletion，不需要人工干预。</p>
<div class="blog_h3"><span class="graybg">后台删除</span></div>
<p>根对象立即被删除。垃圾回收器异步的在后台删除依赖者。</p>
<div class="blog_h3"><span class="graybg">设置删除模式</span></div>
<p>通过设置删除请求的DeleteOptions.propagationPolicy，可以修改级联删除模式：</p>
<ol>
<li>Orphan，孤儿化，解除ownerReferences而不删除</li>
<li>Foreground，前台级联删除</li>
<li>Background，后台级联删除</li>
</ol>
<div class="blog_h1"><span class="graybg">准许控制器</span></div>
<p>准许控制器（Admission Controller）是一小片的代码，被编译到kube-apiserver的二进制文件中。它能够拦截针对APIServer的请求，具体拦截时机是：操控对象被持久化之前、请求通过身份验证之后。很多K8S的高级特性需要准许控制器的介入。</p>
<p>准许控制器可以具有两个行为：</p>
<ol>
<li>validating：不能修改其admit的对象</li>
<li>mutating：能够修改其admit的对象</li>
</ol>
<p>准许控制的流程分为两个阶段，首先运行mutating类控制器，然后运行validating类控制器，任何一个控制器在任何阶段拒绝请求，则客户端收到一个错误。需要注意某些控制器同时有mutating、validating行为。</p>
<p>控制器的执行顺序，等同于它们在--admission-control参数中声明的顺序。</p>
<div class="blog_h2"><span class="graybg">推荐的准许控制器</span></div>
<p>对于1.9版本，建议按序开启以下准许控制器：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e62549555610" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e62549555610-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e62549555610-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e62549555610-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e62549555610-1"><span class="crayon-o">--</span><span class="crayon-v">admission</span><span class="crayon-o">-</span><span class="crayon-v">control</span><span class="crayon-o">=</span><span class="crayon-v">NamespaceLifecycle</span><span class="crayon-sy">,</span><span class="crayon-v">LimitRanger</span><span class="crayon-sy">,</span><span class="crayon-v">ServiceAccount</span><span class="crayon-sy">,</span><span class="crayon-v">PersistentVolumeLabel</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e62549555610-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">DefaultStorageClass</span><span class="crayon-sy">,</span><span class="crayon-v">ValidatingAdmissionWebhook</span><span class="crayon-sy">,</span><span class="crayon-v">ResourceQuota</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e62549555610-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">DefaultTolerationSeconds</span><span class="crayon-sy">,</span><span class="crayon-v">MutatingAdmissionWebhook</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h2"><span class="graybg"><a id="webhooks"></a>动态准许控制</span></div>
<p>（静态）准许控制器本身不够灵活：</p>
<ol>
<li>需要被编译到kube-apiserver镜像中</li>
<li>仅仅当API Server启动后才可以被配置</li>
</ol>
<p>Admission Webhooks可以解决此问题，用它可以来开发代码独立（Out-of-tree）、支持运行时配置的准许控制器。</p>
<p>和静态的准许控制器一样，Webhook也分为validating、mutating两类。</p>
<p>Webhook实际上是由ValidatingAdmissionWebhook、MutatingAdmissionWebhook这两个静态准许控制器适配（到API Server）的，因此这两个遵顼控制器必须启用。</p>
<div class="blog_h3"><span class="graybg">开发Webhook服务器</span></div>
<p>这种服务需要处理admissionReview请求，并将其准许决定封装在admissionResponse中。</p>
<p>admissionReview可以是版本化的，Webhook可以使用admissionReviewVersions字段声明它能处理的Review的版本列表。调用Webhook时API Server会选择此列表中、它支持的第一个版本，如果找不到匹配版本，则失败。</p>
<p>下面是Kubernetes官方提供的样例Webhook服务器代码：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e67491592568" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">kubernetes/v1.13.0/test/images/webhook/main.go</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-44">44</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-46">46</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-48">48</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-50">50</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-52">52</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-54">54</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-56">56</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-58">58</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-60">60</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-62">62</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-64">64</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-66">66</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-68">68</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-70">70</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-72">72</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-74">74</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-76">76</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-78">78</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-80">80</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-82">82</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-84">84</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-86">86</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-88">88</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-90">90</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-92">92</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-94">94</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-96">96</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-98">98</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-100">100</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-102">102</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-104">104</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-106">106</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-108">108</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-110">110</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-112">112</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-114">114</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-116">116</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-118">118</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-120">120</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-122">122</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-124">124</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-126">126</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-128">128</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-130">130</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-132">132</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-134">134</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-136">136</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-138">138</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-140">140</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-142">142</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-144">144</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-146">146</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-148">148</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-150">150</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-152">152</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-154">154</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-156">156</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-158">158</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-160">160</div><div class="crayon-num" data-line="crayon-634f9a69b9e67491592568-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e67491592568-162">162</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e67491592568-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-e">main</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"encoding/json"</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"flag"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"fmt"</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"io/ioutil"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"net/http"</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/api/admission/v1beta1"</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">metav1</span><span class="crayon-h"> </span><span class="crayon-s">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/klog"</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-13"><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-15"><span class="crayon-c">// 一个助手函数，创建内嵌error的AdmissionResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-16"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-e">err </span><span class="crayon-v">error</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-i">AdmissionResponse</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Result</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">Status</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Message</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-22"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-24"><span class="crayon-c">// 所有validators和mutators都由admitFunc类型的函数负责实现</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-25"><span class="crayon-r">type</span><span class="crayon-h"> </span><span class="crayon-e">admitFunc </span><span class="crayon-r">func</span><span class="crayon-sy">(</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-26">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-27"><span class="crayon-c">// 核心逻辑，API Server使用HTTP协议调用Webhook Server</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-28"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">admit </span><span class="crayon-v">admitFunc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-i">body</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">.</span><span class="crayon-v">Body</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ioutil</span><span class="crayon-sy">.</span><span class="crayon-e">ReadAll</span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-sy">.</span><span class="crayon-v">Body</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">body</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">data</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 请求体校验</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">contentType</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">.</span><span class="crayon-v">Header</span><span class="crayon-sy">.</span><span class="crayon-e">Get</span><span class="crayon-sy">(</span><span class="crayon-s">"Content-Type"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">contentType</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">"application/json"</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"contentType=%s, expect application/json"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">contentType</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">return</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-42">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Sprintf</span><span class="crayon-sy">(</span><span class="crayon-s">"handling request: %s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">body</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-44">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 请求Review</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">requestedAdmissionReview</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-47">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 响应Review</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-50">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">deserializer</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">codecs</span><span class="crayon-sy">.</span><span class="crayon-e">UniversalDeserializer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 反串行化响应体为requestedAdmissionReview</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">deserializer</span><span class="crayon-sy">.</span><span class="crayon-e">Decode</span><span class="crayon-sy">(</span><span class="crayon-v">body</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nil</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">requestedAdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-55"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-sy">.</span><span class="crayon-v">Response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 如果没有错误，则执行准许逻辑</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-58"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-sy">.</span><span class="crayon-v">Response</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">admit</span><span class="crayon-sy">(</span><span class="crayon-v">requestedAdmissionReview</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-59"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-60">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-61"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 返回相同的UID</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-sy">.</span><span class="crayon-v">Response</span><span class="crayon-sy">.</span><span class="crayon-v">UID</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">requestedAdmissionReview</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-e">UID</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-63">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-64"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Sprintf</span><span class="crayon-sy">(</span><span class="crayon-s">"sending response: %v"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-sy">.</span><span class="crayon-v">Response</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-65">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">respBytes</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-sy">.</span><span class="crayon-e">Marshal</span><span class="crayon-sy">(</span><span class="crayon-v">responseAdmissionReview</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-70"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">Write</span><span class="crayon-sy">(</span><span class="crayon-v">respBytes</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-72"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-73"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-74">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-75"><span class="crayon-c">/* 各种validators和mutators */</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-76"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveAlwaysDeny</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-77"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">alwaysDeny</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-78"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-79">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-80"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveAddLabel</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-81"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">addLabel</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-82"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-83">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-84"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">servePods</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-85"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">admitPods</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-86"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-87">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-88"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveAttachingPods</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-89"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">denySpecificAttachment</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-90"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-91">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-92"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveMutatePods</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mutatePods</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-94"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-95">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-96"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveConfigmaps</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">admitConfigMaps</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-98"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-99">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-100"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveMutateConfigmaps</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-101"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mutateConfigmaps</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-102"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-103">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-104"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveCustomResource</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-105"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">admitCustomResource</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-106"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-107">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-108"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveMutateCustomResource</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-109"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mutateCustomResource</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-110"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-111">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-112"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">serveCRD</span><span class="crayon-sy">(</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">ResponseWriter</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e ">r *</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-113"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">serve</span><span class="crayon-sy">(</span><span class="crayon-v">w</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">r</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">admitCRD</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-114"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-115">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-116"><span class="crayon-r">type</span><span class="crayon-h"> </span><span class="crayon-e">Config</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-117"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CertFile </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-118"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">KeyFile&nbsp;&nbsp;</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-119"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-120">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-121"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">c *</span><span class="crayon-v">Config</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">addFlags</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-122"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 包含用于HTTPS的x509服务器证书，如果包含CA证书，则连接在服务器证书后面</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-123"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">flag</span><span class="crayon-sy">.</span><span class="crayon-e">StringVar</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">CertFile</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"tls-cert-file"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">CertFile</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"..."</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-124"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 匹配上述服务器证书的私钥</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-125"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">flag</span><span class="crayon-sy">.</span><span class="crayon-e">StringVar</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">KeyFile</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"tls-private-key-file"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-sy">.</span><span class="crayon-v">KeyFile</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"..."</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-126"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-127">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-128"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">configTLS</span><span class="crayon-sy">(</span><span class="crayon-e">config </span><span class="crayon-v">Config</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">tls</span><span class="crayon-sy">.</span><span class="crayon-i">Config</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-129"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">sCert</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tls</span><span class="crayon-sy">.</span><span class="crayon-e">LoadX509KeyPair</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">CertFile</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">KeyFile</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-130"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-131"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Fatal</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-132"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-133"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">tls</span><span class="crayon-sy">.</span><span class="crayon-v">Config</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-134"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Certificates</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-v">tls</span><span class="crayon-sy">.</span><span class="crayon-v">Certificate</span><span class="crayon-sy">{</span><span class="crayon-v">sCert</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-135"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 下面一行用于启用mTLS，也就是对客户端（API Server）进行身份验证</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-136"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// ClientAuth:&nbsp;&nbsp; tls.RequireAndVerifyClientCert,</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-137"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-138"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-139">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-140"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-141"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-e">config </span><span class="crayon-e">Config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-142"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">addFlags</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-143"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">flag</span><span class="crayon-sy">.</span><span class="crayon-e">Parse</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-144">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-145"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 不同的URL路径，对应不同的Webhook，处理函数也不同</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-146"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/always-deny"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveAlwaysDeny</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-147"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/add-label"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveAddLabel</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-148"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/pods"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">servePods</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-149"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/pods/attach"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveAttachingPods</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-150"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/mutating-pods"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveMutatePods</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-151"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/configmaps"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveConfigmaps</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-152"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/mutating-configmaps"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveMutateConfigmaps</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-153"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/custom-resource"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveCustomResource</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-154"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/mutating-custom-resource"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveMutateCustomResource</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-155"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-e">HandleFunc</span><span class="crayon-sy">(</span><span class="crayon-s">"/crd"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">serveCRD</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-156">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-157"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">http</span><span class="crayon-sy">.</span><span class="crayon-v">Server</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-158"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Addr</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">":443"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-159"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">TLSConfig</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">configTLS</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-160"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e67491592568-161"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">ListenAndServeTLS</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e67491592568-162"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0352 seconds] -->

<p>此样例中包含<a href="https://github.com/kubernetes/kubernetes/tree/v1.13.0/test/images/webhook">很多Webhook的样板代码</a>。下面选取几个分析。</p>
<p>addlabel.go是一个mutator，它为对象添加{"added-label": "yes"}标签：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e6d930188523" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-44">44</div><div class="crayon-num" data-line="crayon-634f9a69b9e6d930188523-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e6d930188523-46">46</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-e">main</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"encoding/json"</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/api/admission/v1beta1"</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">metav1</span><span class="crayon-h"> </span><span class="crayon-s">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/klog"</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-9"><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-11"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">addFirstLabelPatch </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-s">"op"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"add"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"path"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"/metadata/labels"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"value"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"added-label"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"yes"</span><span class="crayon-sy">}</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">]</span><span class="crayon-sy">`</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">addAdditionalLabelPatch </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-s">"op"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"add"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"path"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"/metadata/labels/added-label"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"value"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"yes"</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">]</span><span class="crayon-sy">`</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-18"><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-20"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">addLabel</span><span class="crayon-sy">(</span><span class="crayon-e">ar </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-i">AdmissionResponse</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-s">"calling add-label"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">obj</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-e">ObjectMeta</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-24"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">Data </span><span class="crayon-v">map</span><span class="crayon-sy">[</span><span class="crayon-t">string</span><span class="crayon-sy">]</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 从Review中提取原始对象（被拦截的API Server请求中的对象）</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">raw</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Raw</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-28"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-sy">.</span><span class="crayon-e">Unmarshal</span><span class="crayon-sy">(</span><span class="crayon-v">raw</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">obj</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 响应</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 准许通过</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">ObjectMeta</span><span class="crayon-sy">.</span><span class="crayon-v">Labels</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Patch原始对象</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Patch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">(</span><span class="crayon-v">addFirstLabelPatch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Patch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">(</span><span class="crayon-v">addAdditionalLabelPatch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">pt</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-e">PatchTypeJSONPatch</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-44"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">PatchType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-e">pt</span></div><div class="crayon-line" id="crayon-634f9a69b9e6d930188523-45"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-i">reviewResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e6d930188523-46"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0098 seconds] -->

<p>pods.go提供了三个Webhook：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e72092644064" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-44">44</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-46">46</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-48">48</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-50">50</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-52">52</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-54">54</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-56">56</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-58">58</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-60">60</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-62">62</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-64">64</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-66">66</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-68">68</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-70">70</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-72">72</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-74">74</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-76">76</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-78">78</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-80">80</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-82">82</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-84">84</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-86">86</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-88">88</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-90">90</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-92">92</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-94">94</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-96">96</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-98">98</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-100">100</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-102">102</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-104">104</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-106">106</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-108">108</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-110">110</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-112">112</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-114">114</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-116">116</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-118">118</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-120">120</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-122">122</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e72092644064-124">124</div><div class="crayon-num" data-line="crayon-634f9a69b9e72092644064-125">125</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e72092644064-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-e">main</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"fmt"</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"strings"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-6">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">corev1</span><span class="crayon-h"> </span><span class="crayon-s">"k8s.io/api/core/v1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">metav1</span><span class="crayon-h"> </span><span class="crayon-s">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/api/admission/v1beta1"</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"k8s.io/klog"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-12"><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-14"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">podsInitContainerPatch </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span><span class="crayon-s">"op"</span><span class="crayon-o">:</span><span class="crayon-s">"add"</span><span class="crayon-sy">,</span><span class="crayon-s">"path"</span><span class="crayon-o">:</span><span class="crayon-s">"/spec/initContainers"</span><span class="crayon-sy">,</span><span class="crayon-s">"value"</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-sy">{</span><span class="crayon-s">"image"</span><span class="crayon-o">:</span><span class="crayon-s">"webhook-added-image"</span><span class="crayon-sy">,</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-s">"webhook-added-init-container"</span><span class="crayon-sy">,</span><span class="crayon-s">"resources"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">}</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span><span class="crayon-sy">`</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-18"><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-20"><span class="crayon-c">// 校验Pod的规格</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-21"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">admitPods</span><span class="crayon-sy">(</span><span class="crayon-e">ar </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-i">AdmissionResponse</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-s">"admitting pods"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 校验Review中的GVK</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">podResource</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">GroupVersionResource</span><span class="crayon-sy">{</span><span class="crayon-v">Group</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Version</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"v1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Resource</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"pods"</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">Resource</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">podResource</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"expect resource to be %s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">podResource</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 将原始对象转换为Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">raw</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Raw</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-32"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">corev1</span><span class="crayon-sy">.</span><span class="crayon-v">Pod</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">deserializer</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">codecs</span><span class="crayon-sy">.</span><span class="crayon-e">UniversalDeserializer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">deserializer</span><span class="crayon-sy">.</span><span class="crayon-e">Decode</span><span class="crayon-sy">(</span><span class="crayon-v">raw</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nil</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">pod</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 默认准许通过</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-41">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-e">msg </span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 演示各种不准许的情形</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">v</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ok</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-sy">.</span><span class="crayon-v">Labels</span><span class="crayon-sy">[</span><span class="crayon-s">"webhook-e2e-test"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">ok</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">v</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"webhook-disallow"</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"the pod contains unwanted label; "</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">for</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">container</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">range </span><span class="crayon-v">pod</span><span class="crayon-sy">.</span><span class="crayon-v">Spec</span><span class="crayon-sy">.</span><span class="crayon-i">Containers</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">strings</span><span class="crayon-sy">.</span><span class="crayon-e">Contains</span><span class="crayon-sy">(</span><span class="crayon-v">container</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"webhook-disallow"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">msg</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"the pod contains unwanted container name; "</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-55"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">if</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-i">Allowed</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">Status</span><span class="crayon-sy">{</span><span class="crayon-v">Message</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">strings</span><span class="crayon-sy">.</span><span class="crayon-e">TrimSpace</span><span class="crayon-sy">(</span><span class="crayon-v">msg</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-58"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-59"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-i">reviewResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-60"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-61">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-62"><span class="crayon-c">// 修改Pod，Patch一个Init容器进去</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-63"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">mutatePods</span><span class="crayon-sy">(</span><span class="crayon-e">ar </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-i">AdmissionResponse</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-64"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-s">"mutating pods"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-65"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">podResource</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">GroupVersionResource</span><span class="crayon-sy">{</span><span class="crayon-v">Group</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Version</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"v1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Resource</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"pods"</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">Resource</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">podResource</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"expect resource to be %s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">podResource</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-i">nil</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-70">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">raw</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Raw</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-72"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">corev1</span><span class="crayon-sy">.</span><span class="crayon-v">Pod</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-73"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">deserializer</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">codecs</span><span class="crayon-sy">.</span><span class="crayon-e">UniversalDeserializer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-74"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">deserializer</span><span class="crayon-sy">.</span><span class="crayon-e">Decode</span><span class="crayon-sy">(</span><span class="crayon-v">raw</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nil</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">pod</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-75"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-76"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-77"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-78"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-79"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Allowed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-80"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">pod</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"webhook-to-be-mutated"</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-81"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Patch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-t">byte</span><span class="crayon-sy">(</span><span class="crayon-v">podsInitContainerPatch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-82"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">pt</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-e">PatchTypeJSONPatch</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-83"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reviewResponse</span><span class="crayon-sy">.</span><span class="crayon-v">PatchType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-i">pt</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-85"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-i">reviewResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-86"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-87">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-88"><span class="crayon-c">// 禁止kubectl attach to-be-attached-pod -i -c=container1请求</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-89"><span class="crayon-r">func</span><span class="crayon-h"> </span><span class="crayon-e">denySpecificAttachment</span><span class="crayon-sy">(</span><span class="crayon-e">ar </span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionReview</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-i">AdmissionResponse</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-90"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-s">"handling attaching pods"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-91"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">if </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">"to-be-attached-pod"</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-92"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span><span class="crayon-v">Allowed</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 期望接收到的是Pod资源，attach子资源</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-95"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">podResource</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">GroupVersionResource</span><span class="crayon-sy">{</span><span class="crayon-v">Group</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Version</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"v1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Resource</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"pods"</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-96"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">podResource</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">Resource</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">a</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"expect resource to be %s, got %s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-99"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-100"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-101"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"attach"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">SubResource</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">a</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-102"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Errorf</span><span class="crayon-sy">(</span><span class="crayon-s">"expect subresource to be %s, got %s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">a</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-103"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-104"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-105"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-106">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-107"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">raw</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ar</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Raw</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-108"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">podAttachOptions</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">corev1</span><span class="crayon-sy">.</span><span class="crayon-v">PodAttachOptions</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-109"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">deserializer</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">codecs</span><span class="crayon-sy">.</span><span class="crayon-e">UniversalDeserializer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-110"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">if</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">_</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">deserializer</span><span class="crayon-sy">.</span><span class="crayon-e">Decode</span><span class="crayon-sy">(</span><span class="crayon-v">raw</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nil</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">podAttachOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">err</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-e">nil</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-111"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">Error</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-112"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">return </span><span class="crayon-e">toAdmissionResponse</span><span class="crayon-sy">(</span><span class="crayon-v">err</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-113"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-114"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">klog</span><span class="crayon-sy">.</span><span class="crayon-e">V</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Info</span><span class="crayon-sy">(</span><span class="crayon-v">fmt</span><span class="crayon-sy">.</span><span class="crayon-e">Sprintf</span><span class="crayon-sy">(</span><span class="crayon-s">"podAttachOptions=%#v\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">podAttachOptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-115"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 如果不使用Stdin，或者容器不是container1则允许，否则不允许</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-116"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">if</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-v">podAttachOptions</span><span class="crayon-sy">.</span><span class="crayon-v">Stdin</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">podAttachOptions</span><span class="crayon-sy">.</span><span class="crayon-v">Container</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">"container1"</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-117"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span><span class="crayon-v">Allowed</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-118"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-119"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">return</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">v1beta1</span><span class="crayon-sy">.</span><span class="crayon-v">AdmissionResponse</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-120"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Allowed</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-121"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Result</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">metav1</span><span class="crayon-sy">.</span><span class="crayon-v">Status</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-122"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Message</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"attaching to pod 'to-be-attached-pod' is not allowed"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-123"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e72092644064-124"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9e72092644064-125"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0345 seconds] -->

<div class="blog_h3"><span class="graybg">部署Webhook服务</span></div>
<p>可以直接作为Deployment部署在K8S集群内部，也可以部署在外面，需要对应的配置来配合。</p>
<div class="blog_h3"><span class="graybg">配置Webhook</span></div>
<p>Webhook的配置通过ValidatingWebhookConfiguration、MutatingWebhookConfiguration这两类K8S资源进行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e78339356397" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9e78339356397-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e78339356397-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e78339356397-1"><span class="crayon-s ">apiVersion</span><span class="">: admissionregistration.k8s.io/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-2"><span class="crayon-s ">kind</span><span class="">: ValidatingWebhookConfiguration</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: sidecar-injectors</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-5"><span class="crayon-s ">webhooks</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-6"><span class="crayon-c"># Webhoooks列表</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-7"><span class="crayon-s ">- name</span><span class="">: init-inject</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 匹配任意一个规则，则API Server会发送AdmissionReview</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 给clientConfig所指定的Webhook服务器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- apiGroups</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>""</div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>v1</div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>CREATE</div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>pods</div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">scope</span><span class="">: "Namespaced"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">clientConfig</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Webhook服务</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">service</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: kube-system</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: sidecar-injector</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 签名了服务器端证书的CA，PEM格式</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 有时候会设置为 caBundle: Cg== （\n），这是一个占位符，防止该CR被API Server拒绝。证书后续由程序自动更新</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">caBundle</span><span class="">: pem encoded ca cert that signs the server cert used by the webhook</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">admissionReviewVersions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e78339356397-29"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>v1beta1</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e78339356397-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">timeoutSeconds</span><span class="">: 1</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<div class="blog_h3"><span class="graybg">身份验证</span></div>
<p>如果Webhook需要对API Server进行身份验证，则需要进行以下步骤：</p>
<ol>
<li>为API Server提供
			<span id="crayon-634f9a69b9e7d551051590" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">admission</span><span class="crayon-o">-</span><span class="crayon-v">control</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-o">-</span><span class="crayon-v">file</span></span></span>参数，指定准许控制配置文件</li>
<li>在准许控制配置文件中，声明MutatingAdmissionWebhook、ValidatingAdmissionWebhook从何处读取凭证信息：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e81995582569" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e81995582569-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e81995582569-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e81995582569-1"><span class="crayon-s ">apiVersion</span><span class="">: apiserver.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-2"><span class="crayon-s ">kind</span><span class="">: AdmissionConfiguration</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-3"><span class="crayon-s ">plugins</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-4"><span class="crayon-s ">- name</span><span class="">: ValidatingAdmissionWebhook</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">configuration</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersion</span><span class="">: apiserver.config.k8s.io/v1alpha1</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: WebhookAdmission</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kubeConfigFile</span><span class="">: /path/to/kubeconfig</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-9"><span class="crayon-s ">- name</span><span class="">: MutatingAdmissionWebhook</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">configuration</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersion</span><span class="">: apiserver.config.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e81995582569-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: WebhookAdmission</span></div><div class="crayon-line" id="crayon-634f9a69b9e81995582569-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kubeConfigFile</span><span class="">: /path/to/kubeconfig</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

</li>
<li><span style="background-color: #c0c0c0;">凭证信息必须存放在KubeConfig文件中</span>，示例：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e85289816549" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e85289816549-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9e85289816549-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e85289816549-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-2"><span class="crayon-s ">kind</span><span class="">: Config</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-3"><span class="crayon-s ">users</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-5"><span class="crayon-c"># 基于数字证书的身份验证</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Webhook服务器的DNS名称</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-7"><span class="crayon-s ">- name</span><span class="">: 'webhook1.ns1.svc'&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">user</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">client-certificate-data</span><span class="">: pem encoded certificate</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">client-key-data</span><span class="">: pem encoded key</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-11"><span class="crayon-c"># HTTP基本验证</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可以使用通配符</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-13"><span class="crayon-s ">- name</span><span class="">: '*.webhook-company.org'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">user</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">password</span><span class="">: password</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">username</span><span class="">: name</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-17"><span class="crayon-c"># 基于令牌的身份验证</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-18"><span class="crayon-c"># 默认凭证</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-19"><span class="crayon-s ">- name</span><span class="">: '*'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e85289816549-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">user</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e85289816549-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">token</span><span class="">: </span><span class="crayon-o">&lt;</span>token<span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

</li>
</ol>
<div class="blog_h2"><span class="graybg">准许控制器列表</span></div>
<div class="blog_h3"><span class="graybg">AlwaysAdmit</span></div>
<p>总是允许所有请求通过。</p>
<div class="blog_h3"><span class="graybg">AlwaysDeny</span></div>
<p>总是拒绝所有请求通过，仅测试用。 </p>
<div class="blog_h3"><span class="graybg">AlwaysPullImages</span></div>
<p>修改所有新的Pod，将它们的镜像拉取策略改为Always。在多团队共享集群上有用，可以确保仅具有合法凭证的用户才能拉取镜像。</p>
<p>如果没有该AC，则一旦镜像被拉取到Node上，任何用户、Pod都可以不提供凭证的使用之。</p>
<div class="blog_h3"><span class="graybg">DefaultStorageClass</span></div>
<p>监控PersistentVolumeClaim对象的创建过程，如果PVC没有要求任何存储类，则为其自动添加。</p>
<div class="blog_h3"><span class="graybg">DefaultTolerationSeconds</span></div>
<p>设置当Taint和Toleration不匹配时，默认能够容忍的最长时间。</p>
<div class="blog_h3"><span class="graybg">DenyEscalatingExec</span></div>
<p>禁止对以特权级别（privileged Pod、能访问宿主机IPC名字空间的Pod、能访问宿主机PID名字空间的Pod）运行的Pod执行exec/attach命令。</p>
<div class="blog_h3"><span class="graybg">EventRateLimit</span></div>
<p>Alpha/1.9，可以缓和APIServer被事件请求泛洪的问题。</p>
<div class="blog_h3"><span class="graybg">ExtendedResourceToleration</span></div>
<p>1.9引入的插件，辅助带有扩展资源（GPU/FPGA...）的节点的创建，这类节点应该以扩展资源名为键配置Taints。</p>
<p>该控制器自动为请求扩展资源的Pod添加Tolerations，用户不需要手工添加。</p>
<div class="blog_h3"><span class="graybg">ImagePolicyWebhook</span></div>
<p>允许后端的webhook给出准许决策。</p>
<div class="blog_h3"><span class="graybg">Initializers</span></div>
<p>Alpha/1.7，根据现有的InitializerConfiguration来确定资源的初始化器。</p>
<div class="blog_h3"><span class="graybg">InitialResources</span></div>
<p>监控Pod创建请求，如果容器没有提供资源用量请求/限制，该AC会根据基于相同镜像的容器的历史运行状况，自动为容器添加资源用量请求/限制。</p>
<div class="blog_h3"><span class="graybg">LimitPodHardAntiAffinity</span></div>
<p>拒绝任何这样的Pod，它的AntiAffinity（requiredDuringSchedulingRequiredDuringExecution）拓扑键是kubernetes.io/hostname之外的值。</p>
<div class="blog_h3"><span class="graybg">LimitRanger</span></div>
<p>监控入站请求，确保Namespace中LimitRange对象列出的任何约束条件不被违反。如果在部署中使用LimitRange，你必须启用该AC。</p>
<div class="blog_h3"><span class="graybg">NamespaceAutoProvision</span></div>
<p>检查针对所有名字空间化的资源的请求，如果所引用的名字空间不存在，则自动创建名字空间。</p>
<div class="blog_h3"><span class="graybg">NamespaceExists</span></div>
<p>检查针对所有名字空间化的资源的请求，如果所引用的名字空间不存在，则返回错误。</p>
<div class="blog_h3"><span class="graybg">NamespaceLifecycle</span></div>
<p>具有以下功能：</p>
<ol>
<li>确保正在删除的名字空间中，不会由新的对象被创建</li>
<li>确保针对不存在名字空间的资源创建请求被拒绝</li>
<li>禁止删除三个系统保留名字空间：default, kube-system, kube-public</li>
</ol>
<p>Namespace删除操作会级联删除其内部的Pod、Service等对象，为了确保删除过程的完整性，应当使用此AC。</p>
<div class="blog_h3"><span class="graybg">NodeRestriction</span></div>
<p>限制Kubelet能够修改的Pod、Node对象。</p>
<div class="blog_h3"><span class="graybg">PersistentVolumeLabel</span></div>
<p>自动将云服务商定义的Region/Zone标签附加到PV。可以用于保证PV和Pod位于相同的Region/Zone。</p>
<div class="blog_h3"><span class="graybg">PodNodeSelector</span></div>
<p>读取Namespace上的注解和全局配置，限制某个命名空间中的Pod能够运行在什么节点（通过nodeSelector）。</p>
<p>要启用此控制器，需要修改APIServer的配置<span style="color: #242729;">/etc/kubernetes/manifests/kube-apiserver.yaml，在--enable-admission-plugins=后添加PodNodeSelector。</span></p>
<p>使用下面的注解，可以为命名空间中任何Pod添加默认nodeSelector：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e8b314005576" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e8b314005576-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e8b314005576-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e8b314005576-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e8b314005576-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e8b314005576-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e8b314005576-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e8b314005576-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e8b314005576-2"><span class="crayon-s ">kind</span><span class="">: Namespace</span></div><div class="crayon-line" id="crayon-634f9a69b9e8b314005576-3">metadata</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e8b314005576-4"><span class="crayon-h"> </span><span class="crayon-s ">name</span><span class="">: devops</span></div><div class="crayon-line" id="crayon-634f9a69b9e8b314005576-5"><span class="crayon-h"> </span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e8b314005576-6"><span class="crayon-h">&nbsp;&nbsp; </span>scheduler<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">node-selector</span><span class="">: k8s.gmem.cc/dedicated-to=devops</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>这样，此命名空间中创建的新Pod，都会具有nodeSelector：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e90836574213" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e90836574213-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e90836574213-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e90836574213-1">nodeSelector</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e90836574213-2"><span class="crayon-h">&nbsp;&nbsp;</span>k8s<span class="crayon-o">.</span>gmem<span class="crayon-o">.</span>cc/<span class="crayon-s ">dedicated-to</span><span class="">:devops</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<div class="blog_h3"><span class="graybg">PodTolerationRestriction</span></div>
<p>此控制器首先校验Pod的容忍和<span style="background-color: #c0c0c0;">命名空间的容忍</span>，如果存在冲突则拒绝Pod创建。然后，它将<span style="background-color: #c0c0c0;">命名空间的容忍合并到Pod的容忍</span>中，合并后的结果进行<span style="background-color: #c0c0c0;">命名空间容忍白名单检查</span>，如果检查不通过则Pod被拒绝创建。</p>
<p>命名空间的容忍，使用注解scheduler.alpha.kubernetes.io/defaultTolerations配置，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e94893321827" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e94893321827-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e94893321827-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e94893321827-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e94893321827-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e94893321827-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e94893321827-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e94893321827-2"><span class="crayon-s ">kind</span><span class="">: Namespace</span></div><div class="crayon-line" id="crayon-634f9a69b9e94893321827-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e94893321827-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e94893321827-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>scheduler<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">defaultTolerations</span><span class="">: '[</span><span class="crayon-o">{</span>"key"<span class="">:"k8s.gmem.cc/dedicated-to"</span><span class="crayon-o">,</span>"operator"<span class="">:"Equal"</span><span class="crayon-o">,</span>"value"<span class="">:"devops"</span><span class="crayon-o">,</span>"effect"<span class="">:"NoSchedule"</span><span class="crayon-o">}</span><span class="crayon-o">]</span>'</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>命名空间的容忍白名单，使用注解scheduler.alpha.kubernetes.io/tolerationsWhitelist配置。 此注解的值类似上面的注解。</p>
<div class="blog_h3"><span class="graybg">PersistentVolumeClaimResize</span></div>
<p>打开特性开关ExpandPersistentVolumes后，你应该启用该AC。</p>
<p>此AC默认即用所有PVC的Resizing请求，除非PVC的存储类明确的启用（allowVolumeExpansion=true）</p>
<div class="blog_h3"><span class="graybg">PodPreset</span></div>
<p>注入匹配的PodPreset中的规格字段。</p>
<div class="blog_h3"><span class="graybg">Priority</span></div>
<p>使用priorityClassName字段并为Pod产生一个整数类型的优先级。如果目标priorityClass不存在则Pod被拒绝。</p>
<div class="blog_h3"><span class="graybg">ResourceQuota</span></div>
<p>监控入站请求，确保没有违反Namespace中ResourceQuota对象所列出的资源配额限制。</p>
<p>如果你使用ResourceQuota对象，则必须启用此AC。</p>
<div class="blog_h3"><span class="graybg">ServiceAccount</span></div>
<p>实现ServiceAccount的自动化。当使用ServiceAccount对象是应当启用此AC。</p>
<div class="blog_h3"><span class="graybg">SecurityContextDeny</span></div>
<p>禁止那些尝试通过SecurityContext中某些字段实现权限提升的Pod。如果没有启用PodSecurityPolicy，应当考虑启用该控制器。</p>
<div class="blog_h1"><span class="graybg">Service</span></div>
<p>K8S中的Pod是有生命周期的，当Pod死掉后它无法复活。某些控制器会动态的创建、删除Pod。尽管Pod会获得一个IP地址，但是随着时间的推进，IP也不能作为联系它的可靠手段，因为IP会改变。</p>
<p>那么，如果某个Pod（后端）集向其它Pod（前端）集提供功能，那么前端如何找到、跟踪后端集中的Pod呢？Service能帮助你实现这一需求。</p>
<p>所谓Service，是一个抽象，它定义了：</p>
<ol>
<li>一个逻辑的Pod集合。常常通过标签选择器来锚定</li>
<li>访问这些Pod的策略</li>
</ol>
<p>Service有时候也被称为微服务（micro-service）。</p>
<p>举个例子，假设有一个图像处理后端，包括三个实例。这些实例是无状态的，因而前端不关心它调用的是哪一个。组成后端的Pod实例可能发生变化（宕机、扩容），如果前端跟踪其调用的Pod显然会造成耦合。Service这个抽象层可以实现解耦。</p>
<p>对于K8S-Native应用程序，K8S提供了Endpoints API。每当Service包含的Pod集发生变化后，即更新端点。对于非K8S-Native的应用程序，K8S为Service提供了一个基于虚拟IP的桥，用于将请求重定向到后端的Pod。</p>
<div class="blog_h2"><span class="graybg">定义服务</span></div>
<p>假设你有一组Pod，其标签为app=MyApp，并且都暴露了9376端口。你可以为它们定义如下服务：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e99414812334" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9e99414812334-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e99414812334-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e99414812334-1"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 被服务管理的Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: MyApp</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 服务的集群IP上的端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9e99414812334-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod的端口，可以指定为Pod中定义的端口名</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e99414812334-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 9376</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>Service本身也被分配一个IP（称为集群IP），此IP会被服务代理使用。</p>
<p>Service的selector会被不断的估算，其匹配结果会被发送给与Service同名的Endpoints对象。</p>
<p>Service能够进行端口映射。针对服务的请求可以被映射到Pod的端口。支持的网络协议包括TCP、UDP两种。</p>
<div class="blog_h3"><span class="graybg"><a id="service-without-selector"></a>不使用选择器的Service</span></div>
<p>尽管Service通常用来抽象对Pod的访问，它也可以用来抽象其它类型的后端，例如：</p>
<ol>
<li>在生产环境下你希望使用外部数据库集群，但是在开发/测试时你希望使用自己的数据库</li>
<li>你希望把服务指向其它名字空间中的服务，甚至其它集群中的服务</li>
<li>你在把一部分工作负载迁移到K8S，而让另一部分在外部运行</li>
</ol>
<p>以上情况下，你都可以定义一个没有选择器的Service。由于没有选择器，Endpoints对象不会被创建。你可能需要手工映射服务到端点：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9e9e810707471" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9e9e810707471-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e9e810707471-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9e9e810707471-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e9e810707471-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9e9e810707471-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e9e810707471-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9e9e810707471-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e9e810707471-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9e9e810707471-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9e9e810707471-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9e9e810707471-1"><span class="crayon-s ">kind</span><span class="">: Endpoints</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e9e810707471-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9e9e810707471-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e9e810707471-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9e9e810707471-5"><span class="crayon-c"># 端点列表，这个例子中流量被路由给1.2.3.4:9376</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e9e810707471-6"><span class="crayon-s ">subsets</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9e9e810707471-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- addresses</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e9e810707471-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- ip</span><span class="">: 1.2.3.4</span></div><div class="crayon-line" id="crayon-634f9a69b9e9e810707471-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9e9e810707471-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 9376</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">ExternalName</span></div>
<p>这是一种特殊的Service，它即不选择端点，也不定义端口。它只用于提供集群外部的服务的别名，集群内的组件可以基于别名访问外部服务：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ea2530358238" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ea2530358238-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ea2530358238-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ea2530358238-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ea2530358238-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ea2530358238-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ea2530358238-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ea2530358238-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ea2530358238-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ea2530358238-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ea2530358238-1"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ea2530358238-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9ea2530358238-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ea2530358238-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: database</span></div><div class="crayon-line" id="crayon-634f9a69b9ea2530358238-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: prod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ea2530358238-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ea2530358238-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: ExternalName</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ea2530358238-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># IP地址也支持</span></div><div class="crayon-line" id="crayon-634f9a69b9ea2530358238-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">externalName</span><span class="">: db.gmem.cc </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>当集群内组件查找database.prod.svc.${CLUSTER_DOMAIN}时，集群的DNS服务会返回一个CNAME记录，其值为db.gmem.cc。 </p>
<p>注意：经过试验，externalName填写IP地址也是可以的，这种情况下，集群DNS服务应该是做了一个A记录。</p>
<div class="blog_h2"><span class="graybg">虚拟IP和服务代理</span></div>
<p>K8S集群中的每个节点都运行着kube-proxy组件。该组件负责为服务（除了ExternalName）提供虚拟IP。</p>
<p>在1.0版本，Service属于第四层（TCP/UDP over IP）构造，kube-proxy完全工作在用户空间。从1.1开始引入了Ingress API，用于实现第七层（HTTP）Service。基于iptables的代理也被添加，并从1.2开始成为默认操作模式。从1.9开始，ipvs代理被添加。</p>
<div class="blog_h3"><span class="graybg">userspace模式</span></div>
<p>此模式下，kube-proxy监控Master，关注Service、Endpoints对象的添加和删除。</p>
<p>对于每个Service，KP会在本地节点随机打开一个代理端口，任何发向此端口的的请求会被转发给服务的某个后端Pod（从Endpoints对象中获取）。到底使用哪个Pod，取决于Service的SessionAffinity设置，默认选取后端的算法是round robin。KP会把转发规则写入到iptables中，捕获Service的集群IP（虚拟的）的流量。</p>
<p>这种模式下，需要在内核空间和用户空间传递流量。</p>
<div class="blog_h3"><span class="graybg">iptables模式</span></div>
<p>此模式下，KP会直接安装iptables规则，捕获Service的集群IP + Service 端口的流量，转发给某个Service后端Pod，选择Pod的算法是随机。</p>
<p>这种模式下，不需要在内核空间和用户空间之间切换，通常比userspace模式更快、更可靠。但是，该模式不支持当第一次选择的Pod不响应后重新选择另外一个Pod，因此需要配合Readness探针使用。</p>
<div class="blog_h3"><span class="graybg">ipvs模式</span></div>
<p>关于IPVS的知识参考：<a href="/ipvs-and-keepalived">IPVS和Keepalived</a></p>
<p>在1.9中处于Beta状态。</p>
<p>此模式下，KP会调用netlink网络接口，创建和K8S的Service/Endpoint对应的ipvs规则，并且周期性的将K/E和ipvs规则同步。当访问Service时，流量被转发给某个Pod。</p>
<p>类似于iptables，ipvs基于netfilter钩子函数，但是它使用哈希表作为底层数据结构，且运行在内核态。这意味着ipvs的流量转发速度会快的多，且同步代理规则时性能更好。</p>
<p>在未来的版本中，ipvs会提供更多的负载均衡算法，包括：</p>
<ol>
<li>rr：循环选择</li>
<li>lc：最少连接（least connection）</li>
<li>dh：目的地哈希（destination hashing）</li>
<li>sh：源哈希（destination hashing）</li>
<li>sed：最短预期延迟（shortest expected delay）</li>
<li>nq：绝不排队（never queue）</li>
</ol>
<p>注意，该模式要求节点上安装了IPVS内核模块。如果该模块没有安装，会自动fallback为iptables模式。</p>
<p>基于IPVS的K8S Service，都是使用NAT模式，原因是，只有NAT模式才能进行端口映射，让Sevice端口和Pod端口不一致。</p>
<p>IPVS模式下，客户端角色是当前节点（中的Pod，或者节点本身），Direct角色是当前节点，Real Server是当前或其它节点上的Pod。不同客户端，对应的网络路径不一样。<span style="background-color: #c0c0c0;">IPVS模式仍然需要iptables规则进行一些配合</span>。</p>
<p>考虑Service 10.96.54.11:8080，Pod 10.244.1.2:8080，基于Flannel构建容器网络，当前flannel.1的IP地址为10.244.0.0：</p>
<ol>
<li>当前节点<span style="background-color: #c0c0c0;">出现一个虚拟网络接</span>口
			<span id="crayon-634f9a69b9ea7476898389" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">ipvs0</span></span></span>，所有Service IP都绑定在上面，这是IPVS所要求的，Direct必须具有VIP。这也<span style="background-color: #c0c0c0;">导致了IPVS模式下，VIP可Ping</span>（iptables模式下不可以）</li>
<li>OUTPUT链被添加如下规则：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9eab496005483" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9eab496005483-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eab496005483-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9eab496005483-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eab496005483-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9eab496005483-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eab496005483-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9eab496005483-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eab496005483-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9eab496005483-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9eab496005483-1"><span class="crayon-o">-</span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-v">OUTPUT</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">comment</span><span class="crayon-h"> </span><span class="crayon-s">"kubernetes service portals"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">SERVICES</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eab496005483-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9eab496005483-3"><span class="crayon-c"># 如果源IP不是Pod IP，且目的IP是K8S Service（所有Service IP放在IPSet中，大大减少iptables规则条目数量）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eab496005483-4"><span class="crayon-o">-</span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">SERVICES</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-cn">10.244.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69b9eab496005483-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-i">comment</span><span class="crayon-h"> </span><span class="crayon-s">"Kubernetes service cluster ip + port for masquerade purpose"</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eab496005483-6"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 则打上标记</span></div><div class="crayon-line" id="crayon-634f9a69b9eab496005483-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">set</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">match</span><span class="crayon-o">-</span><span class="crayon-e">set </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">CLUSTER</span><span class="crayon-o">-</span><span class="crayon-e">IP </span><span class="crayon-v">dst</span><span class="crayon-sy">,</span><span class="crayon-v">dst</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">MARK</span><span class="crayon-o">-</span><span class="crayon-v">MASQ</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eab496005483-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9eab496005483-9"><span class="crayon-o">-</span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">MARK</span><span class="crayon-o">-</span><span class="crayon-v">MASQ</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">MARK</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-i">xmark</span><span class="crayon-h"> </span><span class="crayon-cn">0x4000</span><span class="crayon-o">/</span><span class="crayon-cn">0x4000</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0038 seconds] -->
</p>
<p>不是Pod发出的对Service IP的请求，<span style="background-color: #c0c0c0;">打标记0x4000/0x4000的目的是，后续进行SNAT</span>。因为节点自身（而非其中的Pod）对VIP进行访问时，因为VIP就在本机网卡，所以它<span style="background-color: #c0c0c0;">自动设置IP封包的源地址、目的地址均为10.96.54.11，这样的封包不做SNAT，仅仅DNAT到Pod上，回程报文是发不回来的</span>（因为每个节点都具有所有VIP）</p>
</li>
<li>POSTROUTING链被添加如下规则：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9eb0029964743" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9eb0029964743-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eb0029964743-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9eb0029964743-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eb0029964743-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9eb0029964743-1"><span class="crayon-o">-</span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-v">POSTROUTING</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">comment</span><span class="crayon-h"> </span><span class="crayon-s">"kubernetes postrouting rules"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">POSTROUTING</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eb0029964743-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9eb0029964743-3"><span class="crayon-o">-</span><span class="crayon-i">A</span><span class="crayon-h"> </span><span class="crayon-v">KUBE</span><span class="crayon-o">-</span><span class="crayon-v">POSTROUTING</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">comment</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">comment</span><span class="crayon-h"> </span><span class="crayon-s">"kubernetes service traffic requiring SNAT"</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eb0029964743-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-i">m</span><span class="crayon-h"> </span><span class="crayon-v">mark</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">mark</span><span class="crayon-h"> </span><span class="crayon-cn">0x4000</span><span class="crayon-o">/</span><span class="crayon-cn">0x4000</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-v">MASQUERADE</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->
</p>
<p>如第2条所属，需要作SNAT， MASQUERADE意味着源地址取决于封包出口网卡</p>
</li>
</ol>
<p>为了更深入的理解，可以看看地址映射的过程，在节点上访问curl http://10.96.54.11:8080时：</p>
<ol>
<li>产生如下封包： 10.96.54.11:xxxxx -&gt; 10.96.54.11:8080。原因是目标地址在kube-ipvs0这个本机网卡上</li>
<li>经过IPVS模块，选择一个RIP，进行DNAT：10.96.54.11:xxxxx -&gt; 10.244.2.2:8080</li>
<li>经过OUTPUT、POSTROUTING链，进行SNAT：10.244.0.0:xxxxx -&gt; 10.244.2.2:8080 。10.244.0.0是出口网卡flannel.1的地址，封包发给此网卡后，经过内核包装为vxlan UDP包，再由物理网卡发出去</li>
</ol>
<div class="blog_h3"><span class="graybg">IP和VIP</span></div>
<p>Pod具有普通的IP地址，因为针对此IP的请求被路由到固定的位置。</p>
<p>Service的IP则是虚拟的 —— 它不会由某台固定的主机来应答。K8S使用Linux的iptables来定义透明、按需进行重定向的VIP。当客户端连接到VIP时，流量会透明的传输给适当的端点。Service相关的环境变量、DNS条目使用的都是Service的VIP和端口。</p>
<div class="blog_h3"><span class="graybg">小结</span></div>
<p>不管使用哪种代理模式，均保证：</p>
<ol>
<li>任何从Service的集群IP:Port进入的流量，都被转发给适当的后端Pod。客户端不会感知到K8S、Service、Pod这些内部组件的存在</li>
<li>要实现基于客户端IP的会话绑定（session affinity ），可以设置service.spec.sessionAffinity = ClientIP （默认None）。你可以进一步设置service.spec.sessionAffinityConfig.clientIP.timeoutSeconds来指定会话绑定的最长时间（默认10800）</li>
</ol>
<div class="blog_h2"><span class="graybg">IPVS</span></div>
<p>由于Iptables底层数据结构是链表，而IPVS则是哈希，IPVS比起iptables模式显著提高的性能，几乎不受服务规模增大的影响。现在的集群都使用IPVS模式的服务代理。</p>
<p>IPVS支持<a href="/keepalived-faq#ipvs-mode">三种工作模式</a>：DR（直接路由）、Tunneling（ipip）、NAT（Masq）。其中只有NAT模式支持端口映射（ClusterIP端口和Pod端口不一样），因此K8S使用NAT模式。此外，K8S还在NAT的DNAT（将对服务的请求的目的地址改为Pod IP）的<span style="background-color: #c0c0c0;">基础上，进行SNAT（将对服务的请求的源地址改为入站网络接口的地址，否则Pod直接发送源地址为Pod IP的回程报文，客户端不接受）</span>，尽管fullNAT这种IPVS扩展可以支持DNAT+SNAT。</p>
<div class="blog_h3"><span class="graybg">实现原理</span></div>
<p>IPVS是<span style="background-color: #c0c0c0;">在INPUT链上挂了钩子，运行复杂的负载均衡算法</span>，然后执行DNAT后从FORWARD链离开本机网络栈。</p>
<p>让网络包进入INPUT链有两种方式：</p>
<ol>
<li>将虚IP写到内核路由表中</li>
<li>创建一个Dummy网卡，将续IP绑定到此网卡</li>
</ol>
<p>Kube Proxy使用的是第二种方式。一旦Service对象创建，Kube proxy就会：</p>
<ol>
<li>确保Dummy网卡kube-ipvs0存在</li>
<li>将服务的虚IP绑定给kube-ipvs0</li>
<li>通过socket创建IPVS的virtual server。virtual server和service是N:1关系，原因是Service可能有多个虚拟IP，例如LoadBalancer IP + Cluster IP</li>
</ol>
<p>当Endpoint对象创建后，Kube Proxy会：</p>
<ol>
<li>创建IPVS的real server。real server和endpoint是1:1关系</li>
</ol>
<div class="blog_h3"><span class="graybg">关于iptables</span></div>
<p>即使使用IPVS模式，只能解决流量转发的问题。Kube Proxy的其它问题仍然依靠 Iptables 解决，它在以下情况下依赖Iptables：</p>
<ol>
<li>如果配置启动参数
			<span id="crayon-634f9a69b9eb5003507502" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">masquerade</span><span class="crayon-o">--</span><span class="crayon-v">all</span><span class="crayon-o">=</span><span class="crayon-t">true</span></span></span>，也就是所有经过kube-proxy的包都进行一次SNAT</li>
<li>启动参数指定了集群IP地址范围</li>
<li>对于LoadBalancer类型的服务，需要Iptables配置白名单</li>
<li>对于NodePort类型的服务，用于在封包从入站节点发往其它节点的Pod时进行MASQUERADE</li>
</ol>
<div class="blog_h3"><span class="graybg">关于ipset</span></div>
<p>Kube Proxy使用ipset来减少需要创建的iptables规则，IPVS模式下iptables规则的数量不超过5个 </p>
<div class="blog_h2"><span class="graybg">多端口服务</span></div>
<p>很多服务需要暴露多个端口，K8S支持在Service的规格中指定多个端口：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9eba966596934" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9eba966596934-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eba966596934-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9eba966596934-1"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: MyApp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 端口1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: http</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 9376</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 端口2</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: https</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9eba966596934-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 443</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eba966596934-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 9377</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<div class="blog_h2"><span class="graybg">指定IP地址</span></div>
<p>在创建Service时，你可以指定你想要的集群IP，设置spec.clusterIP字段即可。</p>
<p>你选择的IP地址必须在service-cluster-ip-range（APIServer参数）范围内，如果IP地址不合法，APIServer会返回响应码422。</p>
<div class="blog_h2"><span class="graybg">发现服务</span></div>
<p>K8S提供两种途径，来发现一个服务：环境变量、DNS。</p>
<div class="blog_h3"><span class="graybg">基于环境变量</span></div>
<p>当Pod运行时，Kubelet会以环境变量的形式注入每个活动的服务的信息。环境变量名称格式为{SVCNAME}_SERVICE_HOST、{SVCNAME}_SERVICE_PORT。其中SVCNAME是转换为大写、-转换为_的服务名。</p>
<p>例如服务redis-master，暴露TCP端口6379，获得集群IP 10.0.0.11。它会产生以下环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ebe133998441" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ebe133998441-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ebe133998441-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ebe133998441-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ebe133998441-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ebe133998441-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ebe133998441-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ebe133998441-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ebe133998441-1"><span class="crayon-v">REDIS_MASTER_SERVICE_HOST</span><span class="crayon-o">=</span><span class="crayon-cn">10.0.0.11</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ebe133998441-2"><span class="crayon-v">REDIS_MASTER_SERVICE_PORT</span><span class="crayon-o">=</span><span class="crayon-cn">6379</span></div><div class="crayon-line" id="crayon-634f9a69b9ebe133998441-3"><span class="crayon-v">REDIS_MASTER_PORT</span><span class="crayon-o">=</span><span class="crayon-v">tcp</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-cn">10.0.0.11</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ebe133998441-4"><span class="crayon-v">REDIS_MASTER_PORT_6379_TCP</span><span class="crayon-o">=</span><span class="crayon-v">tcp</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-cn">10.0.0.11</span><span class="crayon-o">:</span><span class="crayon-cn">6379</span></div><div class="crayon-line" id="crayon-634f9a69b9ebe133998441-5"><span class="crayon-v">REDIS_MASTER_PORT_6379_TCP_PROTO</span><span class="crayon-o">=</span><span class="crayon-e">tcp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ebe133998441-6"><span class="crayon-v">REDIS_MASTER_PORT_6379_TCP_PORT</span><span class="crayon-o">=</span><span class="crayon-cn">6379</span></div><div class="crayon-line" id="crayon-634f9a69b9ebe133998441-7"><span class="crayon-v">REDIS_MASTER_PORT_6379_TCP_ADDR</span><span class="crayon-o">=</span><span class="crayon-cn">10.0.0.11</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>需要注意：服务必须在Pod之前就创建好，否则Pod的环境变量无法更新。 </p>
<div class="blog_h3"><span class="graybg">DNS</span></div>
<p>K8S提供了DNS Addon。此DNS服务器会监控新创建的Service，并为其提供DNS条目。集群中所有Pod都可以使用该DNS服务。</p>
<p>位于名字空间my-ns中的服务my-svc，创建的DNS条目是my-svc.my-ns。位于名字空间my-ns中的Pod可以直接通过my-svc访问服务，其它名字空间中的Pod则需要使用my-svc.my-ns访问服务。DNS名称解析的结果是服务的Cluster IP。</p>
<p>要访问ExternalName类型的Service，DNS是唯一的途径。</p>
<div class="blog_h2"><span class="graybg">Headless Service</span></div>
<p>某些情况下，你不需要Service提供的负载均衡功能，也不需要单个Service IP。这种情况下你可以创建Headless Service，其实就是设置spec.clusterIP=None。</p>
<p>使用HS，开发者可以减少和K8S的耦合，自行实现服务发现机制。</p>
<p>HS没有Cluster IP，kube-proxy也不会处理这类服务，K8S不会为这类服务提供负载均衡机制。</p>
<p>DNS记录如何创建，取决于HS有没有配置选择器。</p>
<div class="blog_h3"><span class="graybg">有选择器</span></div>
<p>如果定义了选择器，端点控制器为HS创建Endpoints对象。并且修改DNS配置，返回A记录（地址），直接指向HS选择的Pod。</p>
<div class="blog_h3"><span class="graybg">无选择器</span></div>
<p>端点控制器不会为这类Service创建Endpoints对象，但是DNS系统会配置：</p>
<ol>
<li>为ExternalName类型的Service配置CNAME记录</li>
<li>对于其它类型的Service，为和Service共享名称的任何Endpoints创建一条DNS记录</li>
</ol>
<p>对于无选择器的HS，不会自动创建关联的Endpoints，因此我们有机会手工的关联Endpoints，从而实现：</p>
<ol>
<li>指向一个集群外部的数据库</li>
<li>指向其它namespace或集群的服务</li>
</ol>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ec3904686196" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ec3904686196-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec3904686196-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ec3904686196-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec3904686196-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ec3904686196-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec3904686196-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ec3904686196-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec3904686196-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ec3904686196-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ec3904686196-1"><span class="crayon-s ">kind</span><span class="">: Endpoints</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec3904686196-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9ec3904686196-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec3904686196-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9ec3904686196-5"><span class="crayon-s ">subsets</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec3904686196-6"><span class="crayon-s ">- addresses</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec3904686196-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- ip</span><span class="">: 1.2.3.4</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec3904686196-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec3904686196-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 1234</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>Endpoint的地址不能是Loopback、link-local、link-local多播地址。 </p>
<div class="blog_h2"><span class="graybg">发布服务</span></div>
<p>对于应用程序中的某些部分（前端），你通常需要在外部（集群外部）IP上暴露一个服务。</p>
<p>K8S允许你指定为服务指定类型（ServiceTypes）：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">类型</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>ClusterIP</td>
<td>
<p>在集群内部的IP地址上暴露服务，如果你仅希望在集群内部能访问到服务，则使用该类型</p>
<p>这是默认的类型</p>
</td>
</tr>
<tr>
<td>NodePort</td>
<td>
<p>在所有节点的IP上的一个静态端口上暴露服务。K8S会自动创建一个ClusterIP类型的服务，用于把NodePort类型的服务路由到适当的Pod</p>
<p>外部可以将任何Node作为入口，访问此类型的服务</p>
<p>K8S会自动分配一个范围内的端口（默认30000-32767），每个节点都会转发到此端口的请求。此端口表现在spec.ports[*].nodePort字段中</p>
<p>如果你需要手工指定端口，设置nodePort的值即可。手工指定的值必须在允许的端口范围之内，你还需要注意可能存在的端口冲突。<span style="background-color: #c0c0c0;">建议自动分配端口</span></p>
<p>服务可以通过以下两种方式访问到：</p>
<ol>
<li>:spec.ports[*].nodePort</li>
<li>spec.clusterIP:spec.ports[*].port</li>
</ol>
<p>NodePort是丐版的LoadBalancer，可供外部访问且成本低廉。但是在大规模集群上</p>
</td>
</tr>
<tr>
<td>LoadBalancer</td>
<td>
<p>向外部暴露服务，并使用云服务提供的负载均衡器。外部负载均衡器所需要的NodePort，以及ClusterIP会自动创建</p>
<p>服务的EXTERNAL-IP字段为云提供商的负载均衡器的IP</p>
<p>某些云服务（GCE、AWS等）提供负载均衡器，K8S支持和这种外部LB集成：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ec8615401312" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ec8615401312-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9ec8615401312-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-1"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: MyApp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80 </span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 9376</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">clusterIP</span><span class="">: 10.0.171.239</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 某些云服务允许手工指定LB的IP地址。如果不指定则随机选择，如果指定了但是云服务不支持则忽略该字段</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">loadBalancerIP</span><span class="">: 78.11.24.19</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: LoadBalancer</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">loadBalancerSourceRanges</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许哪些地址访问此服务，此字段可以随时更新</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-18"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>1<span class="crayon-o">.</span>1<span class="crayon-o">.</span>1<span class="crayon-o">.</span>1/32</div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-19"><span class="crayon-s ">status</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 负载均衡器会异步的创建，其信息会发布到如下字段：</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">loadBalancer</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ec8615401312-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ingress</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ec8615401312-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- ip</span><span class="">: 146.148.47.155</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

</td>
</tr>
<tr>
<td>ExternalName</td>
<td>将外部服务映射为别名</td>
</tr>
</tbody>
</table>
<p>注：修改服务的类型，不会导致ClusterIP重新分配。
<div class="blog_h2"><span class="graybg">外部IP</span></div>
<p>如果你拥有一个或多个外部（例如公网）<span style="background-color: #c0c0c0;">IP路由到集群的某些节点</span>，<span style="background-color: #c0c0c0;">则Service可以在这些外部IP上暴露</span>。基于这些IP流入的流量，如果其端口就是Service的端口，会被K8S路由到服务的某个端点（Pod ...）上。</p>
<p>例如下面这个服务：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ecd600872408" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ecd600872408-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ecd600872408-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-1"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-service</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: MyApp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: http</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 9376</span></div><div class="crayon-line" id="crayon-634f9a69b9ecd600872408-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">externalIPs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ecd600872408-14"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>80<span class="crayon-o">.</span>11<span class="crayon-o">.</span>12<span class="crayon-o">.</span>10</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>外部客户端可以通过80.11.12.10:80访问服务，流量会被转发给app=MyApp的Pod的9376端口。 </p>
<div class="blog_h2"><span class="graybg">局部性访问</span></div>
<p>当访问NodePort、LoadBalancer类型的Service时，流量到达节点后，可能再被转发到其它节点，从而增加了一跳。</p>
<p>要避免这种情况，可以设置：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ed1667351161" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ed1667351161-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed1667351161-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ed1667351161-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed1667351161-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ed1667351161-1"><span class="crayon-s ">kind</span><span class="">: service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed1667351161-2"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ed1667351161-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认&nbsp;&nbsp;Cluster</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed1667351161-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">externalTrafficPolicy</span><span class="">: Local</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>这样，K8S会强制将流量发往具有Service后端Pod的端点。注意ClusterIP类型的服务不支持这种局部性访问配置。</p>
<div class="blog_h2"><span class="graybg">Endpoints</span></div>
<p>服务的端点，通常情况下对应到Pod的一个端口。带有选择器的Service通常自动管理Endpoint对象，你也可以<a href="#service-without-selector">定义不使用选择器的服务</a>，这种情况下需要手工管理端点，Endpoints对象的名字和Service的名字要一致，位于相同命名空间。</p>
<div class="blog_h2"><span class="graybg">EndpointSlice</span></div>
<p>所有网络端点都保存在同一个 Endpoints 资源中，这类资源可能变得非常巨大，进而影响控制平面组件性能，EndpointSlice可以<span style="background-color: #c0c0c0;">缓解这一（大量端点）问题</span>。此外涉及如何<span style="background-color: #c0c0c0;">路由内部流量时，EndpointSlice 可以充当 kube-proxy 的决策依据</span>。 </p>
<p>默认情况下，单个端点切片最多包含100个端点，可以通过控制器管理器的标记 --max-endpoints-per-slice来定制。</p>
<p>下面是端点切片对象的例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ed6726560779" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9ed6726560779-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ed6726560779-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-1"><span class="crayon-s ">apiVersion</span><span class="">: discovery.k8s.io/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-2"><span class="crayon-s ">kind</span><span class="">: EndpointSlice</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: example-abc</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">service-name</span><span class="">: example</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-7"><span class="crayon-c"># 端点的地址类型：支持IPv4&nbsp;&nbsp;IPv6&nbsp;&nbsp;FQDN</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-8"><span class="crayon-s ">addressType</span><span class="">: IPv4</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-9"><span class="crayon-c"># 端口列表，适用于切片中所有端点</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-10"><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: http</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-14"><span class="crayon-s ">endpoints</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- addresses</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"10<span class="crayon-o">.</span>1<span class="crayon-o">.</span>2<span class="crayon-o">.</span>3"</div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># EndpointSlice存储了可能对使用者有用的、有关端点的状况。 这三个状况分别是</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; ready&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对应Pod的Ready状态，运行中的Pod的Ready为True</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; serving&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果Pod处于终止过程中则Ready不为True，此时应该查看serving获知Pod是否就绪</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例外是spec.publishNotReadyAddresses的服务，这种服务的端点的Ready永远为True</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; terminating</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">conditions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ready</span><span class="">: true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostname</span><span class="">: pod-1</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 拓扑感知，1.20废弃</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">topology</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ed6726560779-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">hostname</span><span class="">: node-1&nbsp;&nbsp; # 未来使用nodeName字段代替</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ed6726560779-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>topology<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">zone</span><span class="">: us-west2-a</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<div class="blog_h3"><span class="graybg">管理</span></div>
<p>通常情况下，由端点切片控制器自动创建、管理 EndpointSlice 对象。EndpointSlice 对象还有一些其他使用场景， 例如作为服务网格的实现。这些场景都会<span style="background-color: #c0c0c0;">导致有其他实体 或者控制器负责管理额外的 EndpointSlice 集合</span>。</p>
<p>为了确保多个实体可以管理 EndpointSlice 而且不会相互产生干扰，Kubernetes 定义了 标签 <span style="background-color: #c0c0c0;">endpointslice.kubernetes.io/managed-by</span>，用来标明哪个实体在管理某个 EndpointSlice。端点切片控制器会在自己所管理的所有 EndpointSlice 上将该标签值设置 为 endpointslice-controller.k8s.io。 管理 EndpointSlice 的其他实体也应该为此标签设置一个唯一值。</p>
<div class="blog_h3"><span class="graybg">所属服务</span></div>
<p>在大多数场合下，EndpointSlice 都由某个 Service 所有，这一属主关系是通过：</p>
<ol>
<li>为每个 EndpointSlice 设置一个 owner引用</li>
<li>设置 kubernetes.io/service-name 标签来标明的，目的是方便查找隶属于某服务的所有 EndpointSlice</li>
</ol>
<div class="blog_h3"><span class="graybg">切片分布</span></div>
<p>每个 EndpointSlice 都有一组端口值，适用于资源内的所有端点。 当为服务使用命名端口时，<span style="background-color: #c0c0c0;">Pod 可能会就同一命名端口获得不同的端口号，因而需要 不同的 EndpointSlice</span>。</p>
<p>控制面尝试尽量将 EndpointSlice 填满，不过不会主动地在若干 EndpointSlice 之间 执行再平衡操作。这里的逻辑也是相对直接的：</p>
<ol>
<li>列举所有现有的 EndpointSlices，移除那些<span style="background-color: #c0c0c0;">不再需要的端点并更新那些已经变化的端点</span></li>
<li>列举所有在第一步中<span style="background-color: #c0c0c0;">被更改过的 EndpointSlices，用新增加的端点将其填满</span></li>
<li>如果还有新的端点未被添加进去，尝试<span style="background-color: #c0c0c0;">将这些端点添加到之前未更改的切片中， 或者创建新切片</span></li>
</ol>
<p>这里比较重要的是，与在 EndpointSlice 之间完成最佳的分布相比，第3步中更看重<span style="background-color: #c0c0c0;">限制 EndpointSlice 更新的操作次数</span>。例如，如果有 10 个端点待添加，有两个 EndpointSlice 中各有 5 个空位，上述方法会创建一个新的 EndpointSlice 而不是 将现有的两个 EndpointSlice 都填满。换言之，与执行多个 EndpointSlice 更新操作 相比较，方法会优先考虑执行一个 EndpointSlice 创建操作。</p>
<p>由于 kube-proxy 在每个节点上运行并监视 EndpointSlice 状态，<span style="background-color: #c0c0c0;">EndpointSlice 的 每次变更都变得相对代价较高，因为这些状态变化要传递到集群中每个节点上</span>。 这一方法尝试限制要发送到所有节点上的变更消息个数，即使这样做可能会导致有 多个 EndpointSlice 没有被填满。</p>
<p>在实践中，上面这种并非最理想的分布是很少出现的。大多数被 EndpointSlice 控制器 处理的变更都是足够小的，可以添加到某已有 EndpointSlice 中去的。并且，假使无法添加到已有的切片中，不管怎样都会快就会需要一个新的 EndpointSlice 对象。 Deployment 的滚动更新为 EndpointSlice重新打包提供了一个自然的机会，所有 Pod 及其对应的端点在这一期间都会被替换掉。</p>
<div class="blog_h3"><span class="graybg">重复的端点</span></div>
<p>由于 EndpointSlice 变化的自身特点，端点可能会同时出现在不止一个 EndpointSlice 中。鉴于不同的 EndpointSlice 对象在不同时刻到达 Kubernetes 的监视/缓存中， 这种情况的出现是很自然的。 使用 EndpointSlice 的实现必须能够处理端点出现在多个切片中的状况。 关于如何执行端点去重（deduplication）的参考实现，你可以在 kube-proxy 的 EndpointSlice 实现中找到。</p>
<div class="blog_h1"><span class="graybg">DNS支持</span></div>
<p>K8S支持在集群中调度DNS Service/Pod，并且让Kubelet告知每个容器，DNS服务器的IP地址。</p>
<p>集群中的每个服务，包括DNS服务本身，都被分配一个DNS名称。</p>
<p>默认的，Pod的DNS搜索列表会包含Pod自己的名字空间，以及集群的默认Domain。如果一个服务foo运行在名字空间bar中，则位于bar中的Pod可以通过foo引用服务，位于其它名字空间中的Pod则需要通过foo.bar引用服务。</p>
<div class="blog_h2"><span class="graybg">Service</span></div>
<div class="blog_h3"><span class="graybg">A记录</span></div>
<p>普通服务被分配以A记录，格式：my-svc.my-namespace.svc.cluster.local，此记录解析到服务的Cluster IP。</p>
<p>Headless服务（无Cluster IP）也被分配如上的A记录，但是记录解析到服务选择的Pod的IP集（如果没有选择器则解析到什么IP取决于你给出的Endpoints配置），客户端应当使用此IP集或者使用Round-Robin方式从IP集中选取IP。</p>
<div class="blog_h3"><span class="graybg">SRV记录</span></div>
<p>这类记录为服务的知名端口分配，SRV记录格式：_my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster.local。</p>
<p>对于普通服务，SRV记录解析为端口号 + CNAME（my-svc.my-namespace.svc.cluster.local）。</p>
<p>对于Headless服务，SVR记录解析到多个答复，每个对应服务选择的Pod：端口号 + Pod的CNAME（auto-generated-name.my-svc.my-namespace.svc.cluster.local）。</p>
<div class="blog_h2"><span class="graybg">Pods</span></div>
<div class="blog_h3"><span class="graybg">A记录</span></div>
<p>当启用后，Pod被分配一个DNS A记录：pod-ip-address.my-namespace.pod.cluster.local。例如：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9edd498600579" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9edd498600579-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9edd498600579-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9edd498600579-1"><span class="crayon-c"># 一个名为influx的Pod，它位于dev名字空间中，IP地址为172.27.0.20</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9edd498600579-2"><span class="crayon-cn">172</span><span class="crayon-o">-</span><span class="crayon-cn">27</span><span class="crayon-o">-</span><span class="crayon-cn">0</span><span class="crayon-o">-</span><span class="crayon-cn">20.dev.pod.k8s.gmem.cc</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<div class="blog_h3"><span class="graybg">主机名/子域</span></div>
<p>Pod被创建后，其hostname为metadata.name字段的值。</p>
<p>在Pod的Spec中你可以：</p>
<ol>
<li>指定可选的hostname字段，可以手工指定hostname，比metadata.name的优先级高</li>
<li>指定可选可选的subdomain字段，说明指定Pod的子域。例如一个Pod的hostname为influxdb，subdomain为pods，名字空间为default，则Pod的全限定名为influxdb.default.dev.svc.k8s.gmem.cc</li>
</ol>
<p>如果在Pod所在名字空间中，存在一个Headless服务，其名称与Pod的subdomain字段一致。则KubeDNS服务器会为Pod的全限定名返回一个A记录，指向Pod的IP地址。</p>
<div class="blog_h3"><span class="graybg">DNS策略</span></div>
<p>你可以为每个Pod定义DNS策略（在规格中使用dnsPolicy字段）。目前K8S支持以下策略：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">策略</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>Default</td>
<td>从Pod所在节点继承DNS解析设置</td>
</tr>
<tr>
<td>ClusterFirst</td>
<td>任何不匹配集群DNS后缀（可以设置）的查询，转发给上游（从节点继承）DNS处理</td>
</tr>
<tr>
<td>ClusterFirstWithHostNet</td>
<td>运行在hostNetwork中的Pod应当明确的设置为该值</td>
</tr>
<tr>
<td>None</td>
<td>1.9 Alpha，忽略来自K8S环境的DNS设置。所有<span style="background-color: #c0c0c0;">DNS设置从Pod规格的dnsConfig字段获取</span></td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">DNS配置</span></div>
<p>1.9 Alpha。用户可以对Pod的DNS设置进行细粒度控制。要启用该特性，集群管理员需要为APIServer、kubelet启用特性开关（Feature Gate）CustomPodDNS，示例：--feature-gates=CustomPodDNS=true,...  从1.14开始默认开启。</p>
<p>当启用上述特性后，用户可以设置Pod规格的dnsPolicy=None，并添加dnsConfig字段：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ee2376462029" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9ee2376462029-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee2376462029-40">40</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: ns1</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: dns-example</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: test</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">dnsPolicy</span><span class="">: "None"</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">dnsConfig</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 此Pod使用的DNS服务器列表</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nameservers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>1<span class="crayon-o">.</span>2<span class="crayon-o">.</span>3<span class="crayon-o">.</span>4</div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># DNS搜索后缀列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">searches</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ns1<span class="crayon-o">.</span>svc<span class="crayon-o">.</span>cluster<span class="crayon-o">.</span>local</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>my<span class="crayon-o">.</span>dns<span class="crayon-o">.</span>search<span class="crayon-o">.</span>suffix</div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">options</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 最大dot数量。最大值15</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: ndots</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "1"</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 重试另外一个DNS服务器之前，等待应答的最大时间，单位秒。最大值30</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: timeout</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "5"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 放弃并返回错误给调用者之前，最大尝进行DNS查询的次数。最大值5</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: attempts</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">value</span><span class="">: "2"</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 使用round-robin风格选择不同的DNS服务器，向其发送查询</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: rotate</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 支持RFC 2671描述的DNS扩展</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: edns0</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 串行发送A/AAAA请求</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: single-request</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 发送第二个请求时重新打开套接字</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: single-request-reopen</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 使用TCP协议发送DNS请求</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: use-vc</span></div><div class="crayon-line" id="crayon-634f9a69b9ee2376462029-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 禁止自动重新载入修改后的配置文件，需要glibc 2.26+</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee2376462029-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: no-reload</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0035 seconds] -->

<div class="blog_h1"><span class="graybg">网络</span></div>
<div class="blog_h2"><span class="graybg">连接应用和服务</span></div>
<p>本节以Nginx服务为例，说明如何在K8S集群中连接应用程序和服务。</p>
<div class="blog_h3"><span class="graybg">K8S网络模型</span></div>
<p>在讨论K8S的通信机制之前，我们先看一下普通的Docker网络如何运作。</p>
<p>默认情况下，Docker使用Host-private的网络，也就是说Docker容器仅能和同一台宿主机上的其它容器通信。为了让容器跨节点通信，它们必须在宿主机上暴露端口。这意味着，开发者需要仔细规划，让多个容器协调暴露宿主机的不同端口。</p>
<p>跨越多名开发者进行端口协调很麻烦，特别是进行扩容的时候，这种协调工作应该由集群负责，而不应该暴露给用户。</p>
<p>K8S假设所有Pod都是需要相互通信的，不管它们是不是位于同一台宿主机上。K8S为每个Pod分配集群私有IP地址，你不需要向Docker那样，为容器之间创建连接，或者暴露端口到宿主机的网络接口。</p>
<p>Pod内部的多个容器，可以利用localhost进行相互通信。</p>
<p>集群内所有Pod中的容器，都可以相互看到，不需要NAT的介入。</p>
<div class="blog_h3"><span class="graybg">暴露Pod到集群</span></div>
<p>考虑下面的Pod规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ee7865089594" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ee7865089594-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ee7865089594-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-1"><span class="crayon-v">apiVersion</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">apps</span><span class="crayon-o">/</span><span class="crayon-e">v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-2"><span class="crayon-v">kind</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-3"><span class="crayon-v">metadata</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-e">nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-5"><span class="crayon-v">spec</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">replicas</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">template</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">metadata</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">labels</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">run</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-e">nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-11"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">spec</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">containers</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-e">nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-14"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">image</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ee7865089594-15"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">ports</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ee7865089594-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">containerPort</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0027 seconds] -->

<p>你可以从集群的任何节点访问此Pod，执行下面的命令获得Pod的IP地址：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9eeb888551399" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9eeb888551399-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eeb888551399-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9eeb888551399-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9eeb888551399-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9eeb888551399-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">run</span><span class="crayon-o">=</span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">wide</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eeb888551399-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READY&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;RESTARTS&nbsp;&nbsp; AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NODE</span></div><div class="crayon-line" id="crayon-634f9a69b9eeb888551399-3"><span class="crayon-c"># my-nginx-3800858182-jr4a2&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;13s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10.244.3.4&nbsp;&nbsp;&nbsp;&nbsp;kubernetes-minion-905m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9eeb888551399-4"><span class="crayon-c"># my-nginx-3800858182-kna2y&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;13s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10.244.2.5&nbsp;&nbsp;&nbsp;&nbsp;kubernetes-minion-ljyd</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>登陆到任何集群节点后，你都可以访问上面的两个IP地址。需要注意，Pod不会使用节点的80端口，也不会使用任何NAT机制来把流量路由到Pod。这意味着你可以在单个节点上运行containerPort相同的多个Pod。</p>
<p>你可以像Docker那样，把容器端口映射到节点端口，单由于K8S网络模型的存在，这种映射往往没有必要。</p>
<div class="blog_h3"><span class="graybg">创建服务</span></div>
<p>现在，我们有了两个Pod，它们运行着Nginx，IP位于一个扁平的、集群范围的地址空间中。 理论上说，应用程序可以和Pod直接通信，但是如何Pod所在节点宕机了会怎么样？Deployment会自动在另外一个节点上调度一个Pod，这个新的Pod的IP地址会改变。如果直接和Pod 通信，你就要处理这种IP地址可能改变的情形。</p>
<p>服务可以避免上述处理逻辑，它是Pod之上的抽象层，它定义了一个逻辑的Pod集，这些Pod提供一模一样的功能。当创建服务时，它被分配以唯一性的IP地址（Cluster IP），在服务的整个生命周期中，该IP都不会变化。</p>
<p>应用程序可以配置和服务（而非Pod）通信，服务会进行负载均衡处理，把请求转发给某个Pod处理。</p>
<p>针对上述Deployment的Service规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ef0283204844" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef0283204844-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ef0283204844-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-2"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">run</span><span class="">: my-nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 服务暴露的端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 对接到Pod的端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef0283204844-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ef0283204844-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">run</span><span class="">: my-nginx</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>创建服务后，可以查询其状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ef4056630352" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ef4056630352-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef4056630352-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ef4056630352-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ef4056630352-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">svc </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-v">nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef4056630352-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLUSTER-IP&nbsp;&nbsp;&nbsp;&nbsp; EXTERNAL-IP&nbsp;&nbsp; PORT(S)&nbsp;&nbsp; AGE</span></div><div class="crayon-line" id="crayon-634f9a69b9ef4056630352-3"><span class="crayon-c"># my-nginx&nbsp;&nbsp; 10.0.162.149&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80/TCP&nbsp;&nbsp;&nbsp;&nbsp;21s</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>服务的背后是一个Pod集，服务的选择器会不断的估算，来选择匹配的Pods。匹配的Pod会被发送到一个Endpoints对象中，该对象的名字也叫my-nginx（和服务同名）。当Pod死去时它会自动从Endpoints中移除，类似的当新Pod出生后也被加入到Endpoints中。 </p>
<p>下面的命令可以获得端点的信息：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ef8042423413" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9ef8042423413-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ef8042423413-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-1"><span class="crayon-c"># 获得服务关联的端点</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-2"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-e">svc </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-v">nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-3"><span class="crayon-c"># Name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-4"><span class="crayon-c"># Namespace:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-5"><span class="crayon-c"># Labels:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run=my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-6"><span class="crayon-c"># Annotations:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-7"><span class="crayon-c"># Selector:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run=my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-8"><span class="crayon-c"># Type:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-9"><span class="crayon-c"># IP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.0.162.149</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-10"><span class="crayon-c"># Port:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80/TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-11"><span class="crayon-c"># Endpoints:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10.244.2.5:80,10.244.3.4:80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-12"><span class="crayon-c"># Session Affinity:&nbsp;&nbsp;&nbsp;&nbsp;None</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-13"><span class="crayon-c"># Events:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-15"><span class="crayon-c"># 获得端点信息</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-16"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">ep </span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-v">nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9ef8042423413-17"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ENDPOINTS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ef8042423413-18"><span class="crayon-c"># my-nginx&nbsp;&nbsp; 10.244.2.5:80,10.244.3.4:80&nbsp;&nbsp; 1m</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>注意：端点的IP/Port就是Pod的IP/Port。</p>
<p>现在，你可以在集群中任何节点上 wget :，再次强调，集群IP是纯粹的虚拟IP，它不会对应到哪一根网线。 </p>
<div class="blog_h3"><span class="graybg">访问服务 </span></div>
<p>K8S提供了两种服务访问方式：环境变量、DNS。</p>
<p>变量变量方式是开箱即用的，当Pod启动时，Kubelet会为其注入一系列的环境变量。这意味着在Pod创建之后才创建的服务，无法注入为环境变量。</p>
<p>K8S有一个DNS Addon，负责提供集群内的域名服务，执行下面的命令了解此服务是否启用：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9efd943095611" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9efd943095611-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9efd943095611-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9efd943095611-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9efd943095611-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9efd943095611-1"><span class="crayon-c"># 服务名为kube-dns，运行在kube-system名字空间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9efd943095611-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">services </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span></div><div class="crayon-line" id="crayon-634f9a69b9efd943095611-3"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLUSTER-IP&nbsp;&nbsp; EXTERNAL-IP&nbsp;&nbsp; PORT(S)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9efd943095611-4"><span class="crayon-c"># kube-dns&nbsp;&nbsp; 10.0.0.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;53/UDP,53/TCP&nbsp;&nbsp; 8m</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>如果没有运行DNS服务，你需要<a href="http://releases.k8s.io/master/cluster/addons/dns/README.md#how-do-i-configure-it">启用它</a>。 </p>
<p>DNS服务运行后，会为每个服务都分配一个域名，映射到它的集群IP。</p>
<div class="blog_h3"><span class="graybg">服务安全</span></div>
<p>现在，在集群内部的任何节点，都可以正常访问服务，而且可以享受K8S提供的负载均衡、HA了。</p>
<p>在把服务暴露到因特网之前，你需要确保信道的安全性。例如：</p>
<ol>
<li>提供数字证书，要么购买要么自签名</li>
<li>配置Nginx的HTTPS</li>
<li>配置一个Secret，让Pod都能访问证书 </li>
</ol>
<p>创建密钥和自签名证书，可以参考：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f01939776980" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f01939776980-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f01939776980-1"><span class="crayon-e">openssl </span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">x509</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">days</span><span class="crayon-h"> </span><span class="crayon-cn">365</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">newkey </span><span class="crayon-v">rsa</span><span class="crayon-o">:</span><span class="crayon-cn">2048</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">keyout</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">d</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">out</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">d</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">subj</span><span class="crayon-h"> </span><span class="crayon-s">"/CN=nginxsvc/O=nginxsvc"</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p>K8S提供了一些examples，可以简化第三步。执行下面的命令下载样例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f05211610591" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f05211610591-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f05211610591-1"><span class="crayon-e">git </span><span class="crayon-r">clone</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">github</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">examples</span><span class="crayon-e">.git</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>下面使用examples中的工具，根据上面生成的密钥，产生一个Secret的规格文件：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f09291323444" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f09291323444-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f09291323444-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f09291323444-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f09291323444-1"><span class="crayon-c"># make和go必须已经安装</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f09291323444-2"><span class="crayon-c"># 实际通过调用 make_secret.go 产生Secret，后者则是调用K8S的API</span></div><div class="crayon-line" id="crayon-634f9a69b9f09291323444-3"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-e">keys </span><span class="crayon-e">secret </span><span class="crayon-v">KEY</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-v">CERT</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-v">SECRET</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">secret</span><span class="crayon-e">.json</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>使用规格文件，在K8S上创建一个Secret对象：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f0d919546134" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f0d919546134-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f0d919546134-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f0d919546134-1"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">secret</span><span class="crayon-e">.json</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f0d919546134-2"><span class="crayon-c"># secret "nginxsecret" created</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>查看Secret对象列表：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f11185268281" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f11185268281-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f11185268281-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f11185268281-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f11185268281-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f11185268281-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">secrets</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f11185268281-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AGE</span></div><div class="crayon-line" id="crayon-634f9a69b9f11185268281-3"><span class="crayon-c"># default-token-il9rc&nbsp;&nbsp; kubernetes.io/service-account-token&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1d</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f11185268281-4"><span class="crayon-c"># nginxsecret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Opaque&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1m</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>下一步，修改Deployment、Service的规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f16597278219" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-44">44</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f16597278219-46">46</div><div class="crayon-num" data-line="crayon-634f9a69b9f16597278219-47">47</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f16597278219-1"><span class="crayon-c"># Deployment规格</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-2"><span class="crayon-s ">apiVersion</span><span class="">: apps/v1beta1</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-3"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">run</span><span class="">: my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 声明一个卷，引用Secret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: secret-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secret</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: nginxsecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: nginxhttps</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: bprashanth/nginxhttps</span><span class="">:1.0</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 443</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 挂载Secret卷到对应位置</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /etc/nginx/ssl</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: secret-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-28">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-29"><span class="crayon-c"># Service规格</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-30"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-31"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-32"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">run</span><span class="">: my-nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-36"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-37"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: NodePort</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-38"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 8080</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: http</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-43"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 443</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: https</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f16597278219-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f16597278219-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">run</span><span class="">: my-nginx</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0039 seconds] -->

<div class="blog_h3"><span class="graybg">暴露服务</span></div>
<p>要把服务暴露到集群外部的IP地址，可以使用NodePorts或者LoadBalancers。 </p>
<div class="blog_h2"><span class="graybg">Ingress</span></div>
<p>这是一个API对象，可以管理到集群内部服务（通常是HTTP）的访问。Ingress能够提供：负载均衡、SSL Termination、基于名称的虚拟主机服务。</p>
<div class="blog_h3"><span class="graybg">何为Ingress</span></div>
<p>典型情况下，Service/Pod的IP地址仅仅能在集群内部路由到，所有流量到达边缘路由器（Edge Router，为集群强制应用了防火墙策略的路由器，可能是云服务管理的网关，也可能是物理硬件）时要么被丢弃，要么被转发到别的地方。</p>
<p>Ingress（入口）是一个规则集，允许进入集群的连接到达对应的集群服务。</p>
<p>要定义Ingress对象，同样需要经过APIServer。一个Ingress控制器负责处理Ingress。</p>
<div class="blog_h3"><span class="graybg">前提条件</span></div>
<p>Ingress从1.1+开始可用，目前处于Beta版本。</p>
<p>要使用Ingress，你需要配备Ingress控制器。你可以在Pod中部署任意数量的自定义<a href="https://github.com/kubernetes/ingress-nginx/blob/master/README.md">Ingress控制器</a>，你需要为每个控制器标注适当的class。</p>
<div class="blog_h3"><span class="graybg">Ingress规格</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f1e119340401" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f1e119340401-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f1e119340401-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-1"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-2"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">rewrite-target</span><span class="">: /</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-7"><span class="crayon-c"># 规格中包含了创建LB或代理服务器所需的全部信息</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 匹配入站请求的规则列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 目前仅支持HTTP规则</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- http</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 将来自任何域名的/testpat这个URL下的请求，都转发给test服务处理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">host</span><span class="">: *</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- path</span><span class="">: /testpath</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">backend</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f1e119340401-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: test</span></div><div class="crayon-line" id="crayon-634f9a69b9f1e119340401-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<div class="blog_h3"><span class="graybg">Ingress控制器</span></div>
<p>注意：<span style="background-color: #c0c0c0;">Ingress控制器可以响应不同名字空间中的多个Ingress</span>。</p>
<p>为了让Ingress对象能生效，集群中必须存在Ingress控制器。Ingress实际上<span style="background-color: #c0c0c0;">仅仅声明了转发规则</span>，没有能执行转发的程序。</p>
<p>大部分控制器都是kube-controller-manager这个可执行程序的一部分，并且随着集群的创建而自动启动。但是Ingress控制器不一样，它作为Pod运行，你需要根据集群的需要来选择一个Ingress控制器实现，或者自己实现一个。</p>
<p>Ingress Controller的实现非常多，大多以Nginx或Envoy为基础。可以参考文章：<a href="https://medium.com/flant-com/comparing-ingress-controllers-for-kubernetes-9b397483b46b">Comparing Ingress controllers for Kubernetes</a>。</p>
<p>K8S目前实现并维护<a href="https://git.k8s.io/ingress-gce/README.md">GCE</a>和<a href="nginx">nginx</a>两个Ingress控制器。下面是基于Nginx的示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f25992407460" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-44">44</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-46">46</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-48">48</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-50">50</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-52">52</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-54">54</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-56">56</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-58">58</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-60">60</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-62">62</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-64">64</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-66">66</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-68">68</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-70">70</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-72">72</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-74">74</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-76">76</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-78">78</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-80">80</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-82">82</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-84">84</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-86">86</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-88">88</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-90">90</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-92">92</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-94">94</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-96">96</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-98">98</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-100">100</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-102">102</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-104">104</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-106">106</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-108">108</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-110">110</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-112">112</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-114">114</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-116">116</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-118">118</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-120">120</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-122">122</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-124">124</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-126">126</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-128">128</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-130">130</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-132">132</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-134">134</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-136">136</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-138">138</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-140">140</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-142">142</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-144">144</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-146">146</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-148">148</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-150">150</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-152">152</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-154">154</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-156">156</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-158">158</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-160">160</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-162">162</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-164">164</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-166">166</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-168">168</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-170">170</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-172">172</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-173">173</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-174">174</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-175">175</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-176">176</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-177">177</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-178">178</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-179">179</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-180">180</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-181">181</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-182">182</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-183">183</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-184">184</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-185">185</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-186">186</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-187">187</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-188">188</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-189">189</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-190">190</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-191">191</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-192">192</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-193">193</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-194">194</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-195">195</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-196">196</div><div class="crayon-num" data-line="crayon-634f9a69b9f25992407460-197">197</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f25992407460-198">198</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f25992407460-1"><span class="crayon-c"># 默认后端，如果Nginx无处理请求，此后端负责兜底</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-2"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-3"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">chart</span><span class="">: nginx-ingress-0.14.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: default-backend</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-default-backend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-10"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">replicas</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: default-backend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">strategy</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rollingUpdate</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">maxSurge</span><span class="">: 1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">maxUnavailable</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: RollingUpdate</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: null</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: default-backend</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- image</span><span class="">: k8s.gcr.io/defaultbackend</span><span class="">:1.3</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">imagePullPolicy</span><span class="">: IfNotPresent</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">livenessProbe</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">failureThreshold</span><span class="">: 3</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">httpGet</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /healthz</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 8080</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">scheme</span><span class="">: HTTP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">initialDelaySeconds</span><span class="">: 30</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 10</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">successThreshold</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">timeoutSeconds</span><span class="">: 5</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-default-backend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 8080</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationMessagePath</span><span class="">: /dev/termination-log</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationMessagePolicy</span><span class="">: File</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">dnsPolicy</span><span class="">: ClusterFirst</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: Always</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">schedulerName</span><span class="">: default-scheduler</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">securityContext</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationGracePeriodSeconds</span><span class="">: 60</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-54"><span class="crayon-o">---</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-55">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-56"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-57"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-58"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-59"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: null</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-60"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-61"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: default-backend</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-63"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-default-backend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-64"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-65"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-66"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- port</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 8080</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-69"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-70"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: default-backend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-72"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">sessionAffinity</span><span class="">: None</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-73"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: ClusterIP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-74">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-75"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-76">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-77"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-78"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-79"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">enable-vts-status</span><span class="">: "false"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-80"><span class="crayon-s ">kind</span><span class="">: ConfigMap</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-81"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-82"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-83"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-85"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-86">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-87"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-88"><span class="crayon-c"># 基于Nginx的Ingress Controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-89"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-90"><span class="crayon-s ">kind</span><span class="">: Deployment</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-91"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-92"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-95"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-96"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-97"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-99"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-100"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-101"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">strategy</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-102"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rollingUpdate</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-103"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">maxSurge</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-104"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">maxUnavailable</span><span class="">: 1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-105"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: RollingUpdate</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-106"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">template</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-107"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-108"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: null</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-109"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-110"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-111"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-112"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-113"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-114"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- args</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-115"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>/nginx-ingress-controller</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-116"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>--default-backend-service=kube-system/nginx-ingress-default-backend</div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-117"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>--election-id=ingress-controller-leader</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-118"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>--ingress-class=nginx</div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-119"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>--configmap=kube-system/nginx-ingress-controller</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-120"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">env</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-121"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_NAME</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-122"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-123"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-124"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-125"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: metadata.name</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-126"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: POD_NAMESPACE</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-127"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">valueFrom</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-128"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-129"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-130"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fieldPath</span><span class="">: metadata.namespace</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-131"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: quay.io/kubernetes-ingress-controller/nginx-ingress-controller</span><span class="">:0.12.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-132"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">imagePullPolicy</span><span class="">: IfNotPresent</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-133"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">livenessProbe</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-134"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">failureThreshold</span><span class="">: 3</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-135"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">httpGet</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-136"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /healthz</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-137"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 10254</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-138"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">scheme</span><span class="">: HTTP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-139"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">initialDelaySeconds</span><span class="">: 10</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-140"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 10</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-141"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">successThreshold</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-142"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">timeoutSeconds</span><span class="">: 1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-143"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-144"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-145"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-146"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: http</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-147"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-148"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- containerPort</span><span class="">: 443</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-149"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: https</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-150"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-151"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readinessProbe</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-152"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">failureThreshold</span><span class="">: 3</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-153"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">httpGet</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-154"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /healthz</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-155"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 10254</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-156"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">scheme</span><span class="">: HTTP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-157"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">initialDelaySeconds</span><span class="">: 10</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-158"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 10</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-159"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">successThreshold</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-160"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">timeoutSeconds</span><span class="">: 1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-161"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-162"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationMessagePath</span><span class="">: /dev/termination-log</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-163"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationMessagePolicy</span><span class="">: File</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-164"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">dnsPolicy</span><span class="">: ClusterFirst</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-165"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: Always</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-166"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">terminationGracePeriodSeconds</span><span class="">: 60</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-167">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-168"><span class="crayon-o">---</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-169"><span class="crayon-c"># 在裸金属集群上使用NodePort服务，将所有节点的80/443暴露出去，任何节点都可以作为Ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-170"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-171"><span class="crayon-s ">kind</span><span class="">: Service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-172"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-173"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">creationTimestamp</span><span class="">: null</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-174"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-175"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-176"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-177"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress-controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-178"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-179"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">externalTrafficPolicy</span><span class="">: Cluster</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-180"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-181"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: http</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-182"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 此服务在所有节点上暴露的端口</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-183"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodePort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-184"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 此服务在集群IP上暴露的端口</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-185"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-186"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-187"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 上述两套80端口，转发给Pod的什么端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-188"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-189"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: https</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-190"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodePort</span><span class="">: 443</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-191"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 443</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-192"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-193"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetPort</span><span class="">: 443</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-194"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-195"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: nginx-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-196"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">component</span><span class="">: controller</span></div><div class="crayon-line" id="crayon-634f9a69b9f25992407460-197"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">sessionAffinity</span><span class="">: None</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f25992407460-198"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: NodePort</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0166 seconds] -->

<p>此控制器配合的Ingress如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f2f542108624" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9f2f542108624-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f2f542108624-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-1"><span class="crayon-c"># kubectl create secret generic gmemk8scert --from-file=./k8s.gmem.cc</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-3"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-4"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-5"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: nginx-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/ingress<span class="crayon-o">.</span><span class="crayon-s ">class</span><span class="">: nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果后端服务本身就是以HTTPS方式暴露，则需要添加下面这行：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">secure-backends</span><span class="">: "true"</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-11"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">tls</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- hosts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>media-api<span class="crayon-o">.</span>k8s<span class="crayon-o">.</span>gmem<span class="crayon-o">.</span>cc</div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: gmemk8scert</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: media-api.k8s.gmem.cc</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">http</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- backend</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f2f542108624-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: media-api</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f2f542108624-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 8800</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<div class="blog_h3"><span class="graybg">运行多个控制器</span></div>
<p>如果Ingress资源上没有注解，则任何Ingress控制器都会处理此Ingress。</p>
<p>如果你希望仅仅让Nginx/Nginx Plus控制器来处理Ingress，则为后者添加Annotation：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f36852856369" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f36852856369-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f36852856369-1">kubernetes<span class="crayon-o">.</span>io/ingress<span class="crayon-o">.</span><span class="crayon-s ">class</span><span class="">: "nginx"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p> 这样，其它种类的Ingress Controller自动忽视此Ingress。</p>
<div class="blog_h3"><span class="graybg">ng控制器命令行</span></div>
<p>--configmap 指定配置的namespace/name</p>
<p>--default-ssl-certificate 指定包含默认数字整数的secret</p>
<p>--enable-dynamic-configuration 通过使用Lua，尽可能的避免Nginx Reload操作的必要，某些特性必须要求启用或禁用此特性</p>
<p>--enable-ssl-passthrough 是否启用SSL穿透的特性，默认禁用</p>
<p>--status-port Nginx状态信息在什么端口暴露，默认18080</p>
<p>--watch-namespace  监控哪些命名空间的Ingress资源，默认所有命名空间</p>
<p>--v 更多日志：</p>
<p style="padding-left: 30px;">2 显示配置文件的变动diff</p>
<p style="padding-left: 30px;">3 显示服务、Ingress规则、endpoint的变化细节，并输出为JSON</p>
<p style="padding-left: 30px;">5 让Nginx在Debug模式下运行</p>
<div class="blog_h3"><span class="graybg">ng控制器配置</span></div>
<p>配置文件通过参数--configmap=kube-system/ngress-controller参数注入。ConfigMap示意：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f3e128818270" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f3e128818270-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9f3e128818270-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-2"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 返回客户端时添加响应头</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">add-headers</span><span class="">: "false"</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 指定返回客户端时需要隐藏的头</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hide-headers</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 请求的缓冲和超时</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">client-header-buffer-size</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">client-header-timeout</span><span class="">: ""</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">client-body-buffer-size</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">client-body-timeout</span><span class="">: ""</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">enable-vts-status</span><span class="">: "false"</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ssl-redirect</span><span class="">: "false"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 启用压缩</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-15"><span class="crayon-h">&nbsp;&nbsp;</span>use-gzip</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">gzip-types</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 负载均衡算法</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可选：</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># least_conn 最少连接，不得联合--enable-dynamic-configuration</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># ip_hash 不得联合--enable-dynamic-configuration，可以用nginx.ingress.kubernetes.io/upstream-hash-by代替</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># ewma 峰值指数加权移动平均值算法，联合--enable-dynamic-configuration</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f3e128818270-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">load-balance</span><span class="">: "round_robin"</span></div><div class="crayon-line" id="crayon-634f9a69b9f3e128818270-23"><span class="crayon-s ">kind</span><span class="">: ConfigMap</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<p>可用配置项非常多，可查看<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md">官方文档</a>。 这些配置最终会填充到nginx配置文件模板中，<a href="https://github.com/kubernetes/ingress-nginx/blob/master/internal/ingress/controller/config/config.go">模板变量和配置项名称并不对应</a>，需要注意。</p>
<div class="blog_h3"><span class="graybg">ng控制器的ingress注解</span></div>
<p>注解列表（默认前缀都是nginx.ingress.kubernetes.io/），这些注解可以附加在使用Nginx作为控制器的Ingress规则上：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">注解</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>affinity</td>
<td>
<p>启用针对上游服务的会话绑定：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f45281621468" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f45281621468-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f45281621468-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f45281621468-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f45281621468-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f45281621468-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f45281621468-1"><span class="crayon-c"># 基于什么绑定，仅支持cookie</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f45281621468-2">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">affinity</span><span class="">: "cookie"</span></div><div class="crayon-line" id="crayon-634f9a69b9f45281621468-3">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">session-cookie-name</span><span class="">: "INGRESSCOOKIE"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f45281621468-4"><span class="crayon-c"># Cookie值的哈希算法，sha1/md5/index</span></div><div class="crayon-line" id="crayon-634f9a69b9f45281621468-5">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">session-cookie-hash</span><span class="">: "sha1" </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

</td>
</tr>
<tr>
<td>auth-tls-pass-certificate-to-upstream</td>
<td>是否把客户端证书转发给上游服务，默认false</td>
</tr>
<tr>
<td>default-backend</td>
<td>指定默认后端，这个后端处理Ingress规则没有匹配的任何请求</td>
</tr>
<tr>
<td>configuration-snippet</td>
<td>
<p>指定任意的Nginx配置片断，示例：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f4c166653981" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f4c166653981-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f4c166653981-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f4c166653981-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f4c166653981-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f4c166653981-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f4c166653981-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f4c166653981-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f4c166653981-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f4c166653981-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f4c166653981-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f4c166653981-1"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f4c166653981-2"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f4c166653981-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f4c166653981-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">configuration-snippet</span><span class="">: |</span></div><div class="crayon-line" id="crayon-634f9a69b9f4c166653981-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>location<span class="crayon-h"> </span>/avatar<span class="crayon-h"> </span><span class="crayon-o">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f4c166653981-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rewrite<span class="crayon-h">&nbsp;&nbsp;</span>^<span class="crayon-sy">(</span><span class="crayon-o">.</span>*<span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span>/public/<span class="crayon-sy">$</span>1<span class="crayon-o">.</span>png<span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-634f9a69b9f4c166653981-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f4c166653981-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f4c166653981-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f4c166653981-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: grafana.k8s.gmem.cc</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>对于上述Ingress，控制器会在自己的Nginx配置文件中生成：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f53979459590" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f53979459590-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f53979459590-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f53979459590-1"><span class="crayon-e">http</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-2"><span class="crayon-c">#...</span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">## start server grafana.k8s.gmem.cc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">server</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">server_name </span><span class="crayon-v">grafana</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-h"> </span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># ...</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 你定义的片断在这里</span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">avatar</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">rewrite</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">^</span><span class="crayon-sy">(</span><span class="crayon-sy">.</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">public</span><span class="crayon-o">/</span><span class="crayon-sy">$</span><span class="crayon-cn">1.png</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69b9f53979459590-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f53979459590-14"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<p>如果配置片断有错误，你会在控制器日志中发现：</p>
<p style="padding-left: 30px;">nginx: configuration file /tmp/nginx-*** test failed </p>
</td>
</tr>
<tr>
<td>enable-cors</td>
<td>
<p>是否启用跨站资源共享（CORS）：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f5a179812276" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f5a179812276-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f5a179812276-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f5a179812276-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f5a179812276-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f5a179812276-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f5a179812276-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f5a179812276-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f5a179812276-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f5a179812276-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f5a179812276-1">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">enable-cors</span><span class="">: "true"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f5a179812276-2"><span class="crayon-c"># 允许哪些HTTP方法</span></div><div class="crayon-line" id="crayon-634f9a69b9f5a179812276-3">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cors-allow-methods</span><span class="">: "PUT</span><span class="crayon-o">,</span><span class="crayon-h"> </span>GET<span class="crayon-o">,</span><span class="crayon-h"> </span>POST<span class="crayon-o">,</span><span class="crayon-h"> </span>OPTIONS"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f5a179812276-4"><span class="crayon-c"># 允许哪些头</span></div><div class="crayon-line" id="crayon-634f9a69b9f5a179812276-5">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cors-allow-headers</span><span class="">: "X-Forwarded-For</span><span class="crayon-o">,</span><span class="crayon-h"> </span>X-app123-XPTO"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f5a179812276-6"><span class="crayon-c"># 允许哪些源</span></div><div class="crayon-line" id="crayon-634f9a69b9f5a179812276-7">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cors-allow-origin</span><span class="">: "https</span><span class="">://gmem.site</span><span class="">:5443"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f5a179812276-8"><span class="crayon-c"># 是否允许凭证信息被跨站传递</span></div><div class="crayon-line" id="crayon-634f9a69b9f5a179812276-9">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cors-allow-credentials</span><span class="">: "true" </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

</td>
</tr>
<tr>
<td>
<p>force-ssl-redirect
<p>ssl-redirect</p>
</td>
<td>
<p>如果某个Ingress启用了TLS，则默认会发送308永久重定向，将HTTP请求重定向到HTTPS，如果需要禁用此行为，可以在Nginx ConfigMap中设置：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f61150575132" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f61150575132-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f61150575132-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f61150575132-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f61150575132-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f61150575132-1"><span class="crayon-c"># kubectl -n kube-system edit configmap nginx-ingress-controller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f61150575132-2"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f61150575132-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">enable-vts-status</span><span class="">: "false"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f61150575132-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ssl-redirect</span><span class="">: "false"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>如果要针对某个Ingress禁用SSL重定向，可以为此Ingress资源配置：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f67684926163" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f67684926163-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f67684926163-1">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">ssl-redirect</span><span class="">: "false"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>默认值true</p>
</td>
</tr>
<tr>
<td>ssl-passthrough</td>
<td>
<p>SSL穿透，允许在Pod上配置SSL服务端证书，而不是在Nginx上</p>
</td>
</tr>
<tr>
<td>limit-connections<br />limit-rps<br />limit-rpm </td>
<td>
<p>限制单个Client IP能够使用的资源量，用于缓和DDoS攻击：</p>
<p style="padding-left: 30px;">limit-connections 单IP最大连接<br />limit-rps 单IP没秒最多被接受的连接<br />limit-rpm 单IP每分最多被接受的连接</p>
</td>
</tr>
<tr>
<td>rewrite-target</td>
<td>
<p>某些情况下后端服务暴露的URL，和Ingress规则中的不同。如果不进行请求重写会导致404。示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f6e941076638" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f6e941076638-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f6e941076638-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-1"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-2"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">rewrite-target</span><span class="">: /</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: monocular</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: monocular.jx.k8s.gmem.cc</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">http</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- backend</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: jenkins-x-monocular-api</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># monocular.jx.k8s.gmem.cc/api被重写为jenkins-x-monocular-api/</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /api/</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- backend</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: jenkins-x-monocular-ui</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f6e941076638-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div><div class="crayon-line" id="crayon-634f9a69b9f6e941076638-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

</td>
</tr>
<tr>
<td>secure-backends</td>
<td>
<p>默认情况下Nginx使用HTTP协议访问后端服务，如果后端服务通过HTTPS暴露，需要在Ingress规则中设置：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f75525853738" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f75525853738-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f75525853738-1">nginx<span class="crayon-o">.</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">secure-backends</span><span class="">: "true"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

</td>
</tr>
<tr>
<td>service-upstream</td>
<td>
<p>默认情况下，在Nginx配置中使用Pod的ip:port作为upstream服务器
<p>设置此注解为true，则改用Service的集群IP，这可以避免反复Reload Nginx配置，防止Pod反复宕机导致可用性下降。但是需要注意：</p>
<ol>
<li>不能支持会话绑定</li>
</ol>
</td>
</tr>
<tr>
<td>load-balance</td>
<td>使用何种负载均衡算法，最新版本的balancer.lua脚本中引用，可以选择chash、round_robin、sticky、ewma</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">Ingress类型</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">类型</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>单服务</td>
<td>
<p>现有的Service类型可以向集群外部暴露单个服务。但是你也可以利用Ingress实现这种暴露：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f7c132504995" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f7c132504995-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f7c132504995-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f7c132504995-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f7c132504995-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f7c132504995-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f7c132504995-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f7c132504995-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f7c132504995-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f7c132504995-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f7c132504995-1"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f7c132504995-2"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f7c132504995-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f7c132504995-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f7c132504995-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f7c132504995-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 指定没有任何规则的后端即可</span></div><div class="crayon-line" id="crayon-634f9a69b9f7c132504995-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">backend</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f7c132504995-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: testsvc</span></div><div class="crayon-line" id="crayon-634f9a69b9f7c132504995-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>创建Ingress对象后，执行下面的命令可以查看其状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f82005598678" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f82005598678-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f82005598678-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f82005598678-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f82005598678-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">ing</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f82005598678-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RULE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BACKEND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADDRESS</span></div><div class="crayon-line" id="crayon-634f9a69b9f82005598678-3"><span class="crayon-c"># test-ingress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; testsvc:80&nbsp;&nbsp;&nbsp;&nbsp; 107.178.254.228</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>其中107.178.254.228是Ingress控制器为此Ingress分配的IP地址。RULE为 - 表示，所有发送到107.178.254.228的流量都被重定向给testsvc服务 </p>
</td>
</tr>
<tr>
<td>Fanout</td>
<td>
<p>前面提到过，Pod仅拥有集群内可用的IP，因此我们需要在集群的边界有那么一个组件，能够总揽所有入站请求，并转发给适当的端点，该组件常常是一个HA的负载均衡器。Ingress可以让你需要的负载均衡器数量尽可能小，例如下面这个流向示意：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f89894208035" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f89894208035-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f89894208035-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f89894208035-1">foo.bar.com -&gt; 178.91.123.132 -&gt; / foo&nbsp;&nbsp;&nbsp;&nbsp;s1:80</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f89894208035-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; / bar&nbsp;&nbsp;&nbsp;&nbsp;s2:80</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>对应的Ingress规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f8f870113941" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9f8f870113941-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f8f870113941-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-1"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-2"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>ingress<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">rewrite-target</span><span class="">: /</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 对于指向foo.bar.com的请求</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: foo.bar.com</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">http</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 把路径/foo下的HTTP请求转发给服务s1处理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- path</span><span class="">: /foo</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">backend</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: s1</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 把路径/bar下的HTTP请求转发给服务s2处理</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- path</span><span class="">: /bar</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">backend</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f8f870113941-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: s2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f8f870113941-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>创建上述Ingress后，查看其状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f94239164781" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f94239164781-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f94239164781-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f94239164781-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f94239164781-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f94239164781-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f94239164781-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f94239164781-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">ing</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f94239164781-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RULE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BACKEND&nbsp;&nbsp; ADDRESS</span></div><div class="crayon-line" id="crayon-634f9a69b9f94239164781-3"><span class="crayon-c"># test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f94239164781-4"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foo.bar.com</span></div><div class="crayon-line" id="crayon-634f9a69b9f94239164781-5"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /foo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s1:80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f94239164781-6"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /bar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s2:80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>Ingress控制器会提供一个负载均衡器（依赖于实现），以满足Ingress的规定。 ADDRESS列存放的是负载均衡器的地址</p>
</td>
</tr>
<tr>
<td>虚拟主机</td>
<td>
<p>根据URL中主机名字段的不同，将请求转发给不同的服务：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f98275197803" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9f98275197803-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f98275197803-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f98275197803-1"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-2"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 虚拟主机1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: foo.bar.com</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">http</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- backend</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: s1</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 虚拟主机2</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- host</span><span class="">: bar.foo.com</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">http</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">paths</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- backend</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f98275197803-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: s2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f98275197803-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<p>默认后端（Default Backend）：所有不匹配任何规则的流量都被发送给默认后端，你可以使用默认后端来提供404页面</p>
</td>
</tr>
<tr>
<td>TLS</td>
<td>
<p>通过提供一个包含TLS私钥、证书的Secret，你可以让Ingress支持HTTPS。当前Ingress仅仅支持单个TLS端口（443）</p>
<p>Secret对象规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9f9c605268327" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9f9c605268327-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f9c605268327-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9f9c605268327-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f9c605268327-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9f9c605268327-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f9c605268327-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9f9c605268327-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9f9c605268327-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9f9c605268327-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9f9c605268327-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f9c605268327-2"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f9c605268327-3"><span class="crayon-h">&nbsp;&nbsp;</span>tls<span class="crayon-o">.</span><span class="crayon-s ">crt</span><span class="">: base64 encoded cert</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f9c605268327-4"><span class="crayon-h">&nbsp;&nbsp;</span>tls<span class="crayon-o">.</span><span class="crayon-s ">key</span><span class="">: base64 encoded key</span></div><div class="crayon-line" id="crayon-634f9a69b9f9c605268327-5"><span class="crayon-s ">kind</span><span class="">: Secret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f9c605268327-6"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9f9c605268327-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: testsecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9f9c605268327-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69b9f9c605268327-9"><span class="crayon-s ">type</span><span class="">: Opaque</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>启用TLS的Ingress的示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fa0874852523" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fa0874852523-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa0874852523-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fa0874852523-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa0874852523-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fa0874852523-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa0874852523-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fa0874852523-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa0874852523-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fa0874852523-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa0874852523-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fa0874852523-1"><span class="crayon-s ">apiVersion</span><span class="">: extensions/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa0874852523-2"><span class="crayon-s ">kind</span><span class="">: Ingress</span></div><div class="crayon-line" id="crayon-634f9a69b9fa0874852523-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa0874852523-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: no-rules-map</span></div><div class="crayon-line" id="crayon-634f9a69b9fa0874852523-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa0874852523-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">tls</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa0874852523-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- secretName</span><span class="">: testsecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa0874852523-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">backend</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa0874852523-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">serviceName</span><span class="">: s1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa0874852523-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">servicePort</span><span class="">: 80 </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

</td>
</tr>
<tr>
<td>负载均衡</td>
<td>
<p>Ingress控制器自带某些负载均衡设置，会应用到所有Ingress，包括：负载均衡算法、后端权重规则（backend weight scheme）。更高级的负载均衡，例如持久会话、动态权重目前不支持，要使用这些特性可参考<a href="https://github.com/kubernetes/contrib/tree/master/service-loadbalancer">service-loadbalancer</a>
<p>Ingress不直接支持健康检查，但是K8S提供了类似的特性，例如Readiness探针</p>
</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg"><a id="network-policy"></a>网络策略</span></div>
<p>NetworkPolicy对象指定了：</p>
<ol>
<li>一组Pod是否允许和另外一组Pod通信</li>
<li>一组Pod是否允许和其它网络端点通信</li>
</ol>
<p>网络策略由网络插件实现，也就是说你需要一个支持NetworkPolicy的CNI插件。</p>
<div class="blog_h3"><span class="graybg">隔离/非隔离Pod</span></div>
<p>默认情况下Pod是非隔离的，任何来源的流量都可以访问它。</p>
<p>当某个NetworkPolicy选择（匹配）了Pod则它变成隔离的（isolated），这样，不被任何网络策略允许的流量，会被该Pod拒绝。</p>
<p>NetworkPolicy是叠加的，如果Pod被多个策略匹配，则所有这些策略的ingress/egress规则的union决定了Pod的连接性。</p>
<div class="blog_h3"><span class="graybg">NetworkPolicy资源</span></div>
<p>字段说明如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fa5057645114" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9fa5057645114-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa5057645114-44">44</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-1"><span class="crayon-s ">apiVersion</span><span class="">: networking.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-2"><span class="crayon-s ">kind</span><span class="">: NetworkPolicy</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-network-policy</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 选择/匹配的Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">role</span><span class="">: db</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 此策略应用到匹配Pod的出站，还是入站，或者both流量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">policyTypes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-13"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Ingress</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-14"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Egress</div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许哪些入站流量，每个元素是一个规则，每个规则由from+ports组成</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ingress</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- from</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 允许172.17.0.0/16中的实体，但是其中172.17.1.0/24不允许</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- ipBlock</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">cidr</span><span class="">: 172.17.0.0/16</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">except</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>172<span class="crayon-o">.</span>17<span class="crayon-o">.</span>1<span class="crayon-o">.</span>0/24</div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 或者具有如下命名空间、标签的Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- namespaceSelector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">project</span><span class="">: myproject</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- podSelector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">role</span><span class="">: frontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 允许TCP 6379端口</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 6379</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 类似ingress，每个规则由to+ports组成</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">egress</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-36"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- to</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- ipBlock</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">cidr</span><span class="">: 10.0.0.0/24</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ports</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- protocol</span><span class="">: TCP</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: 5978</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果有下面这个字段，则限定端口范围而非单个端口</span></div><div class="crayon-line" id="crayon-634f9a69b9fa5057645114-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 需要特性开关： --feature-gates=NetworkPolicyEndPort=true,...</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa5057645114-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">endPort</span><span class="">: 32768</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0038 seconds] -->

<p>下面是一些示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fa9100150541" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-28">28</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-30">30</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-32">32</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-34">34</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-36">36</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-38">38</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-40">40</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fa9100150541-42">42</div><div class="crayon-num" data-line="crayon-634f9a69b9fa9100150541-43">43</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-1"><span class="crayon-c"># 默认禁止所有入站流量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-2"><span class="crayon-s ">apiVersion</span><span class="">: networking.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-3"><span class="crayon-s ">kind</span><span class="">: NetworkPolicy</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: default-deny-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSelector</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">policyTypes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-9"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Ingress</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-11"><span class="crayon-c"># 默认允许所有入站流量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-12"><span class="crayon-s ">apiVersion</span><span class="">: networking.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-13"><span class="crayon-s ">kind</span><span class="">: NetworkPolicy</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-14"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: allow-all-ingress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-16"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSelector</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">ingress</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">policyTypes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-21"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Ingress</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-22">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-23"><span class="crayon-c"># 默认禁止所有出站流量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-24"><span class="crayon-s ">apiVersion</span><span class="">: networking.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-25"><span class="crayon-s ">kind</span><span class="">: NetworkPolicy</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-26"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: default-deny-egress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-28"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSelector</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">policyTypes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-31"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Egress</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-32">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-33"><span class="crayon-c"># 默认允许所有出站流量</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-34"><span class="crayon-s ">apiVersion</span><span class="">: networking.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-35"><span class="crayon-s ">kind</span><span class="">: NetworkPolicy</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-36"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-37"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: allow-all-egress</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-38"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSelector</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-40"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">egress</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-41"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fa9100150541-42"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">policyTypes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fa9100150541-43"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Egress</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0032 seconds] -->

<div class="blog_h3"><span class="graybg">不能做什么</span></div>
<p>到1.21为止，NetworkPolicy不支持：</p>
<ol>
<li>强制集群内部流量通过公共网关，可以考虑使用Service Mesh</li>
<li>任何TLS相关需求，可以考虑使用Service Mesh</li>
<li>特定于某个节点的策略</li>
<li>特定于某个服务（根据名称）的策略</li>
<li>应用到任何命名空间/Pod的默认策略</li>
<li>记录安全日志，也就是那些连接被禁止/接受</li>
<li>禁止loopback或者Pod所在节点（宿主命名空间）发来的流量</li>
</ol>
<div class="blog_h2"><span class="graybg">HostAliases</span></div>
<p>你可以在Pod规格中定义将会注入到/etc/hosts文件的条目：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fae525785071" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fae525785071-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fae525785071-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fae525785071-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: hostaliases-pod</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: Never</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 条目列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostAliases</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- ip</span><span class="">: "127.0.0.1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostnames</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"foo<span class="crayon-o">.</span>local"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"bar<span class="crayon-o">.</span>local"</div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- ip</span><span class="">: "10.1.2.3"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostnames</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"foo<span class="crayon-o">.</span>remote"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"bar<span class="crayon-o">.</span>remote"</div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: cat-hosts</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 启动后打印hosts文件内容</span></div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>cat</div><div class="crayon-line" id="crayon-634f9a69b9fae525785071-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">args</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fae525785071-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"/etc/hosts"</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<div class="blog_h1"><span class="graybg">卷</span></div>
<p>容器本身的文件系统是临时的，如果容器崩溃，文件立刻丢失。使用Docker时，你可以挂载外部卷，解决此问题。</p>
<p>K8S在存储方面面临两个问题：</p>
<ol>
<li>容器重新调度后文件丢失</li>
<li>Pod内的多个容器常需要共享文件 </li>
</ol>
<p>K8S引入和Docker类似的概念：卷（Volume）解决上述问题。</p>
<div class="blog_h2"><span class="graybg">背景</span></div>
<p>Docker已经包含了卷的概念，但是这些卷是松散、缺乏管理的。Docker中的卷仅仅是磁盘中的一个目录，或者其它容器中的目录。最近版本Docker引入了卷驱动的概念，但是使用场景很受限。</p>
<p>K8S的卷，提供了明确的生命周期，就好像使用它的Pod那样。卷的寿命比引用它的容器更长，容器重启后数据不会丢失。当Pod停止存在时则卷也被删除。</p>
<p>K8S支持多种类型的卷，每个Pod可以同时使用其中的多种卷。</p>
<p>卷的核心就是一个目录，可能其中有一些数据，这个目录可以被容器访问。至于这目录从哪来，何种介质存储它，取决于具体的卷类型。</p>
<p>要使用一个卷，在Pod规格中定义spec.volumes字段，并且在容器spec.containers.volumeMounts字段中声明在何处挂载卷。</p>
<div class="blog_h2"><span class="graybg">卷类型</span></div>
<p>全部卷类型参考<a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">K8S官网</a>。</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">类型</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>cephfs</td>
<td>允许一个既有的CephFS卷被挂载到Pod中。对CephFS卷的修改会永久保留</td>
</tr>
<tr>
<td>emptyDir</td>
<td>
<p>这种卷在Pod第一次被调度到某个节点上时，在节点上创建。只要Pod还在节点上运行，这个卷就继续存在，当节点被迁移走后，卷被删除掉，容器崩溃不会导致卷被删除</p>
<p>emptyDir初始是一个空目录</p>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fb3423259149" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fb3423259149-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb3423259149-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fb3423259149-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb3423259149-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fb3423259149-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb3423259149-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fb3423259149-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb3423259149-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fb3423259149-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb3423259149-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fb3423259149-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb3423259149-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fb3423259149-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- image</span><span class="">: gcr.io/google_containers/test-webserver</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb3423259149-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-container</span></div><div class="crayon-line" id="crayon-634f9a69b9fb3423259149-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb3423259149-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /cache</span></div><div class="crayon-line" id="crayon-634f9a69b9fb3423259149-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: cache-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb3423259149-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fb3423259149-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: cache-volume</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb3423259149-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">emptyDir</span><span class="">: </span><span class="crayon-o">{</span><span class="crayon-o">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>默认情况下，emptyDir将数据存储在节点所在的媒体上（可能是SDD、网络存储）。你可以设置emptyDir.medium=Memory来挂载一个内存文件系统</p>
</td>
</tr>
<tr>
<td>flocker</td>
<td>
<p>Flocker是一个开源的，集群化的容器数据卷管理器。它能管理、编排基于多种存储后端的数据卷</p>
<p>这类卷可以将Flocker数据集挂载到Pod，如果数据集不存在，你需要使用Flocker API或者CLI创建之 </p>
</td>
</tr>
<tr>
<td>glusterfs</td>
<td>Glusterfs是一个开源网络文件系统，这类卷能够把Glusterfs卷挂载到Pod</td>
</tr>
<tr>
<td>hostPath</td>
<td>
<p>从Node宿主机文件系统挂载一个文件/目录到Pod。示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fb7799765828" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fb7799765828-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fb7799765828-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-1"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- image</span><span class="">: gcr.io/google_containers/test-webserver</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-container</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 在容器内的挂载点</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /test-pd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: test-volume</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: test-volume</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 宿主机路径</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /data</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 类型：</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># DirectoryOrCreate 目录，如果不存在则创建，设置权限0755，组、所有者和Kubelet相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Directory 已经存在的目录</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># FileOrCreate 文件，如果不存在则创建，设置权限0644，组、所有者和Kubelet相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># File 已经存在的文件</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Socket UNIX套接字</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># CharDevice 一个字符设备</span></div><div class="crayon-line" id="crayon-634f9a69b9fb7799765828-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># BlockDevice 一个块设备</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fb7799765828-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: Directory</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

</td>
</tr>
<tr>
<td>nfs</td>
<td>
<p>挂载现有的NFS到Pod
<p>容器中挂载点的File mode取决于NFS的对应目录</p>
</td>
</tr>
<tr>
<td>persistentVolumeClaim</td>
<td>
<p>用于挂载PersistentVolume到Pod，PersistentVolume是一种声明（claim）持久性（调度后不变）存储（例如GCE PersistentDisk、iSCSI卷）的方式，这种方式不需要知道特定云环境的细节</p>
</td>
</tr>
<tr>
<td>projected</td>
<td>能够影射多个现有的卷资源到同一目录</td>
</tr>
<tr>
<td>secret</td>
<td>
<p>这种卷用于传递敏感信息（例如密码）到Pod，你可以通过K8S API创建Sercret，再通过卷的方式挂载到Pod</p>
<p>这类卷总是由内存后备（tmpfs）</p>
</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">卷的挂载</span></div>
<p>卷在Pod级别上定义，而在容器级别上挂载。容器将卷挂载到某个路径后，<span style="background-color: #c0c0c0;">此路径上原有的文件全部不可见</span>，这个特性和docker --volume是一致的。</p>
<div class="blog_h2"><span class="graybg">可选卷</span></div>
<p>你可以声明一个卷是“可选的”：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fbc332525548" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fbc332525548-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fbc332525548-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fbc332525548-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fbc332525548-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fbc332525548-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fbc332525548-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fbc332525548-1"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fbc332525548-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: ingressgateway-certs</span></div><div class="crayon-line" id="crayon-634f9a69b9fbc332525548-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secret</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fbc332525548-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">defaultMode</span><span class="">: 420</span></div><div class="crayon-line" id="crayon-634f9a69b9fbc332525548-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">optional</span><span class="">: true&nbsp;&nbsp;# 可选</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fbc332525548-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: istio-ingressgateway-certs</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>这样，即使目标ConfigMap、Secret、PVC不存在，Pod仍然可以启动。</p>
<p>注意：当目标ConfigMap、Secret在Pod<span style="background-color: #c0c0c0;">启动后创建，仍然会自动、立即挂载到Pod相应路径</span>。</p>
<div class="blog_h2"><span class="graybg">影射卷</span></div>
<p>用于将多个卷源影射为一个合并卷，当前，支持影射的卷类型包括：Secret、downwardAPI、ConfigMap、ServiceAccountToken。</p>
<p>所有需要影射的卷，必须和Pod在同一个命名空间。</p>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fc1598322819" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc1598322819-26">26</div><div class="crayon-num" data-line="crayon-634f9a69b9fc1598322819-27">27</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: volume-test</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: container-test</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: all-in-one</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: "/projected-volume"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: all-in-one</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">projected</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">sources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- secret</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mysecret</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">items</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: username</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: my-group/my-username</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- secret</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mysecret2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">items</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: password</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc1598322819-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: my-group/my-password</span></div><div class="crayon-line" id="crayon-634f9a69b9fc1598322819-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mode</span><span class="">: 511 </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<div class="blog_h1"><span class="graybg">持久卷</span></div>
<div class="blog_h2"><span class="graybg">简介</span></div>
<p>持久卷子系统提供了一套API，将存储如何提供的细节分离出去，存储的消费者不需要关心这一细节。为实现这种分离K8S引入两类对象PersistentVolume、PersistentVolumeClaim。</p>
<p>PersistentVolume（PV）是集群中，以及由管理员提供好的一个存储资源。它是一种集群资源，就好像节点是一种集群资源一样。持久卷和上节的卷类似，都属于一种卷插件（Volume Plugin），但是持久卷的生命周期和任何使用它的Pod都没有关联，不会因为这些Pod被删除而删除（不管是删除对象还是存储的数据）。该对象封装了存储的实现细节（NFS、iSCSI、云服务特定存储...）。</p>
<p>PersistentVolumeClaim（PVC）是用户发起的存储请求，它和Pod类似：</p>
<ol>
<li>Pod消耗节点资源而PVC消耗PV资源</li>
<li>Pod可以请求特定的资源级别（CPU和内存），PVC则可以请求特定的存储尺寸、访问模式（读/写）</li>
</ol>
<p>注意：PV和PVC是一一绑定的关系，<span style="background-color: #c0c0c0;">一个PV同时仅仅能绑定到一个PVC，但是一个PVC可以被多个Pod使用</span>。一旦PVC被删除，其对应的PV会变为RELEASED状态。</p>
<p>尽管利用PersistentVolumeClaim，用户可以消费抽象的存储资源。但是要求具有一定特质（例如性能）的PersistentVolume是很常见的。集群管理员需要提供多种多样（不仅仅是尺寸、访问模式不同）的PersistentVolume，同时不向用户暴露PersistentVolume的实现细节。StorageClass对象提供了更多相关的内容。</p>
<div class="blog_h2"><span class="graybg">持久卷类型</span></div>
<p>PersistentVolume类型被实现为插件，目前K8S支持的插件包括：GCEPersistentDisk、AWSElasticBlockStore、Flocker、NFS、iSCSI、RBD、CephFS、Glusterfs等。</p>
<div class="blog_h3"><span class="graybg">local</span></div>
<p>本地持久卷代表挂载到Pod运行节点的<span style="background-color: #c0c0c0;">磁盘、分区或者目录</span>。本地持久卷<span style="background-color: #c0c0c0;">不支持动态Provisioning</span>。</p>
<p>和HostPath相比，local卷<span style="background-color: #c0c0c0;">具有数据持久性、可移植性</span>。PV Controller和Scheduler会对Local PV做特殊的逻辑处理，确保Pod使用本地存储时，在发生reschedule的情况下能<span style="background-color: #c0c0c0;">再次调度到Local PV所在的节点</span>。如果节点宕机，则Local PV可能无法访问，应用程序需要容忍这种可用性降低的场景。</p>
<p>使用local卷时，你必须设置PV对象的nodeAffinity，以保证使用它的Pod被调度到恰当的节点：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fc6096090833" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-24">24</div><div class="crayon-num" data-line="crayon-634f9a69b9fc6096090833-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fc6096090833-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolume</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: example-pv</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">capacity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 100Gi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可以设置为Block，将原始块设备暴露出来</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeMode</span><span class="">: Filesystem</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-11"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteOnce</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">persistentVolumeReclaimPolicy</span><span class="">: Delete</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 必须声明SC，且该SC声明延迟绑定</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">storageClassName</span><span class="">: local-storage</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">local</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 卷在节点上的路径</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /mnt/disks/ssd1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 节点亲和性</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">nodeAffinity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">required</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nodeSelectorTerms</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- key</span><span class="">: kubernetes.io/hostname</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line" id="crayon-634f9a69b9fc6096090833-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fc6096090833-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>example-node</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>尽管本地持久卷不支持动态Provisioning，我们仍然需要为它创建StorageClass，用于延迟卷绑定（直到Pod调度完成） ：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fca191973410" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fca191973410-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fca191973410-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fca191973410-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fca191973410-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fca191973410-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fca191973410-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fca191973410-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fca191973410-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fca191973410-1"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fca191973410-2"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fca191973410-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fca191973410-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: local-storage</span></div><div class="crayon-line" id="crayon-634f9a69b9fca191973410-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/no-provisioner</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fca191973410-6"><span class="crayon-c"># 延迟卷的创建和绑定到（使用它的）Pod调度完成之后，这样可以保证Kubernetes为PVC作出绑定决策的时候，</span></div><div class="crayon-line" id="crayon-634f9a69b9fca191973410-7"><span class="crayon-c"># 能够同时评估使用它的Pod的约束（例如节点资源需求、Pod亲和性、节点亲和性、节点选择器）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fca191973410-8"><span class="crayon-s ">volumeBindingMode</span><span class="">: WaitForFirstConsumer</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>PV必须手工创建，工作负载通过声明PVC来匹配到这些已经存在的PV。如果你的集群大量使用Local PV，并且需要为不同工作负载提供不同性能的存储，你可能需要声明多个SC。</p>
<p>驱动<a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">Local Persistence Volume Static Provisioner</a>可以改善Local PV的生命周期管理。它能够检测宿主机上的磁盘，并为它们创建PV，在PV被释放之后，清理磁盘。</p>
<div class="blog_h2"><span class="graybg">生命周期 </span></div>
<div class="blog_h3"><span class="graybg">Provisioning</span></div>
<p>Provisioning的含义是提供。PV是集群中的资源，PVC则是对资源的请求。它们之间的交互遵循以下生命周期。</p>
<p>K8S支持以两种方式提供PV：</p>
<ol>
<li>静态提供：集群管理员创建一系列PV，这些PV映射到了底层的实际存储，这些PV存在于K8S API中，可以被消费</li>
<li>动态提供：当没有满足PVC要求的PV时，集群可以尝试动态的提供一个卷给PVC，如何提供取决于StorageClass：
<ol>
<li>PVC需要请求一个StorageClass，而管理员必须预先创建、配置好StorageClass对象，以便满足动态提供的需要</li>
<li>PVC如果设置StorageClass为""，则相当于禁止动态提供</li>
</ol>
</li>
</ol>
<p>要启用基于StorageClass的动态提供，集群管理员需要在APIServer启用准许控制器（Admission Controller）DefaultStorageClass。具体来说，就是在APIServer的选项--admission-control中附加DefaultStorageClass，注意该选项的值是逗号分隔的字符串列表。</p>
<div class="blog_h3"><span class="graybg">Binding</span></div>
<p>用户创建声明了一定容量、访问模式的PVC后，Master上的控制循环会监控到PVC，找到一个匹配的PV，然后将PV和PVC进行绑定。PV和PVC是One-To-One关系，也就是说<span style="background-color: #c0c0c0;">PVC对PV是独占使用</span>的。</p>
<p><span style="background-color: #c0c0c0;">如果没有满足的PV，则PVC会一直处于未绑定状态</span>。例如，集群提供了很多50G的PV，现在一个PVC要100G的，则PVC仅仅在集群中添加了100G+的PV后才能成功绑定。</p>
<p><span style="background-color: #c0c0c0;">PVC对象被删除后，其对应的PV对象可能被级联删除</span>。</p>
<div class="blog_h3"><span class="graybg">Using</span></div>
<p>Pod将PVC作为卷使用，集群会找到PVC绑定的PV，并挂载到Pod中容器的指定目录下。</p>
<div class="blog_h3"><span class="graybg">Reclaiming</span></div>
<p>当不再需要时，用户可以通过K8S API删除PVC对象，让K8S回收资源。</p>
<p>当PVC被删除时，也就释放了和PV之间的绑定。PV的回收策略（persistentVolumeReclaimPolicy字段）指示了如何回收PV。</p>
<div class="blog_h3"><span class="graybg">Expanding</span></div>
<p>1.8引入的特性，Alpha状态。在1.9版本中以下类型的卷支持扩容：gcePersistentDisk、awsElasticBlockStore、Cinder、glusterfs、rbd。</p>
<div class="blog_h2"><span class="graybg">回收策略</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 15%; text-align: center;">回收策略</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>Retain</td>
<td>
<p>PV保持存在，被标记为released，先前用户的数据仍然存在其中。管理员需要手工回收此PV，它才能被其它PVC使用。手工回收步骤：</p>
<ol>
<li>删除PersistentVolume对象。删除后底层的存储资源（Storage Asset）仍然存在</li>
<li>从底层存储资源手工清除数据</li>
<li>手工删除存储资源。如果想重用此存储资源，使用其存储资源定义创建一个新的PV</li>
</ol>
</td>
</tr>
<tr>
<td>Recycle</td>
<td>
<p>如果存储插件支持，则执行类似rm -rf的操作清除卷中的数据，并允许其被重新绑定</p>
<p>你也可以通过命令行参数为kube-controller-manager自定义<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#recycling">回收器Pod模板</a>，自定义清除数据的方式</p>
</td>
</tr>
<tr>
<td>Delete</td>
<td>
<p>如果存储插件支持，则删除PersistentVolume对象，同时删除关联的底层存储资源</p>
<p>动态提供的卷会从其StorageClass继承默认回收策略，此策略也是Delete</p>
</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">访问模式</span></div>
<p>每个卷在同一时刻只能使用一种访问模式，即使它可以支持多种模式。</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 25%; text-align: center;">模式</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>ReadWriteOnce</td>
<td>可以被单节点挂载为读写，所有卷插件都支持</td>
</tr>
<tr>
<td>ReadOnlyMany</td>
<td>可以被多节点挂载为读 CephFS、Glusterfs、iSCSI、NFS、RBD等支持</td>
</tr>
<tr>
<td>ReadWriteMany</td>
<td>CephFS、Glusterfs、NFS等支持</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">PersistentVolume</span></div>
<p>每个PV都包含一个规格、一个状态。下面是一个示例规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fd1125965679" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd1125965679-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fd1125965679-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: PersistentVolume</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pv0003</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 卷的容量</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">capacity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 5Gi</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 卷模式，1.9之前都会在卷上创建文件系统，1.9支持设置为Block，即使用裸块</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMode</span><span class="">: Filesystem</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteOnce</div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 回收策略</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">persistentVolumeReclaimPolicy</span><span class="">: Recycle</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 类别</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storageClassName</span><span class="">: slow</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 挂载选项</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountOptions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>hard</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>nfsvers=4<span class="crayon-o">.</span>1</div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">nfs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd1125965679-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /tmp</span></div><div class="crayon-line" id="crayon-634f9a69b9fd1125965679-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">server</span><span class="">: 172.17.0.2</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<div class="blog_h3"><span class="graybg">StorageClass</span></div>
<p>PV可以有一个类型字段，其值为 StorageClass对象的名称。具有给定 StorageClass的PV，只能和请求相同 StorageClass的PVC进行绑定；没有指定 StorageClass的PV只能和没有请求 StorageClass的PVC绑定。</p>
<p>在过去，注解volume.beta.kubernetes.io/storage-class用于代替storageClassName属性，未来该注解可能被废弃。</p>
<div class="blog_h3"><span class="graybg">挂载选项</span></div>
<p>某些持久卷类型（NFS、iSCSI、RBD、CephFS、Glusterfs等）支持挂载选项，当卷被挂载到节点时会应用这些选项。 </p>
<p>在过去，注解volume.beta.kubernetes.io/mount-options用于代替mountOptions属性，未来该注解可能被废弃。</p>
<div class="blog_h3"><span class="graybg">Phase</span></div>
<p>一个卷可以处于以下阶段：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">Phase</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>Available</td>
<td>游离的资源，没有绑定到PVC</td>
</tr>
<tr>
<td>Bound</td>
<td>绑定到了一个PVC</td>
</tr>
<tr>
<td>Released</td>
<td>PVC被删除了，但是PV的资源尚未被集群回收</td>
</tr>
<tr>
<td>Failed</td>
<td>卷的自动回收失败了</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">PersistentVolumeClaims</span></div>
<p>和PV一样，每个PVC也都有一个规格、一个状态。下面是一个示例规格：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fd6466886446" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fd6466886446-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fd6466886446-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-1"><span class="crayon-s ">kind</span><span class="">: PersistentVolumeClaim</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: myclaim</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 我需要什么样的访问模式</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteOnce</div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 我需要什么样的卷模式（文件系统还是裸设备）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeMode</span><span class="">: Filesystem</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 我需要多少资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 8Gi</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 我需要的存储类</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">storageClassName</span><span class="">: slow</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 使用选择器对备选卷进行过滤</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">release</span><span class="">: "stable"</span></div><div class="crayon-line" id="crayon-634f9a69b9fd6466886446-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fd6466886446-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- </span><span class="crayon-o">{</span><span class="crayon-s ">key</span><span class="">: environment</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">operator</span><span class="">: In</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-s ">values</span><span class="">: [dev]</span><span class="crayon-o">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>其中storageClassName 如果指定为""则仅仅存储类为""的PV才能绑定。如果不指定该属性，则系统的行为取决于是否启用了准许控制器DefaultStorageClass：</p>
<ol>
<li>如果启用，则集群管理员可以指定一个默认的StorageClass。这样所有不指定存储类的PVC都只能绑定到具有此默认存储类的PV
<ol>
<li>设置默认存储类的方法：为作为默认的StorageClass的storageclass.kubernetes.io/is-default-class注解设置为true</li>
<li>如果集群管理员没有设置默认StorageClass，创建PVC时你收到的提示和没有启用准许控制器DefaultStorageClass一样</li>
<li>如果将多个StorageClass注解为“默认”则准许控制器阻止任何PVC的创建</li>
</ol>
</li>
<li>如果准许控制器没有启用，则不存在默认StorageClass这一概念。不指定storageClassName和指定为""效果一样</li>
</ol>
<p>取决于集群安装方式，默认StorageClass可能被集群的Addon管理器在安装阶段部署。</p>
<p>如果PVC同时指定selector + storageClassName，则目标PV必须同时符合两个条件。注意：目前不支持对带有selector的PVC进行动态提供。</p>
<div class="blog_h2"><span class="graybg">挂载PVC为卷</span></div>
<p>Pod可以将PVC作为卷来挂载，供容器使用。PVC必须和Pod位于同一个名字空间中，集群会找到绑定到PVC的PV，并将PV挂载给Pod。</p>
<p>声明使用PVC的Pod的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fdb026149276" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdb026149276-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fdb026149276-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-1"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mypod</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: myfrontend</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: dockerfile/nginx</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: "/var/www/html"</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: mypd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: mypd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdb026149276-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">persistentVolumeClaim</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdb026149276-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">claimName</span><span class="">: myclaim</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<div class="blog_h2"><span class="graybg">裸卷的支持</span></div>
<p>在1.9引入的Alpha特性是对裸块卷（Raw Block Volume）的静态提供的支持，目前仅仅光纤通道（Fibre Channel，FC）是唯一支持此特性的插件。</p>
<p>PV规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fdf486672415" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fdf486672415-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fdf486672415-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolume</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: block-pv</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">capacity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 10Gi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteOnce</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeMode</span><span class="">: Block</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">persistentVolumeReclaimPolicy</span><span class="">: Retain</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">fc</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">targetWWNs</span><span class="">: ["50060e801049cfd1"]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fdf486672415-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">lun</span><span class="">: 0</span></div><div class="crayon-line" id="crayon-634f9a69b9fdf486672415-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: false</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>PVC规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fe3548915369" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe3548915369-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe3548915369-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe3548915369-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe3548915369-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe3548915369-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fe3548915369-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe3548915369-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolumeClaim</span></div><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe3548915369-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: block-pvc</span></div><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe3548915369-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteOnce</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe3548915369-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumeMode</span><span class="">: Block</span></div><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe3548915369-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fe3548915369-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 10Gi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<div class="blog_h2"><span class="graybg">可移植配置 </span></div>
<p>如果你在编写能够在很大范围的集群上使用的配置模板/样例，且需要使用持久化存储，可以参考如下建议：</p>
<ol>
<li>在Deployments/ConfigMap等配置中包含PersistentVolumeClaim声明</li>
<li> 不要在配置中包含PersistentVolume对象，因为实例化配置的用户可能没有创建PV的权限</li>
<li>允许用户实例化配置模板时，提供storageClassName</li>
<li>监控PVC的绑定情况，如果一段时间后没有绑定成功，应当通知用户。绑定失败意味着集群可能没有动态存储支持（用户需要手工创建PV）</li>
</ol>
<div class="blog_h2"><span class="graybg">动态提供</span></div>
<p>这一特性可以实现按需创建存储卷。如果没有动态提供，集群管理员必须手工调用云/存储提供商的接口，来创建新的存储卷，然后通过K8S API注册和存储卷对应的PV对象。</p>
<p>动态提供是基于API组storage.k8s.io中的StorageClass对象实现的。集群管理员可以定义任意数量的StorageClass，每个SC需要指定一个卷插件（也叫provisioner）和一组参数。卷插件基于这些参数来按需创建卷。对于一个存储系统，你可以定义多个SC，以暴露不同风味（例如速度快或慢）的存储资源。</p>
<div class="blog_h3"><span class="graybg">启用动态提供</span></div>
<p>要启用动态提供，一系列StorageClass需要被预先创建。下面的两个规格，分别创建了基于HDD的慢速SC和SDD的快速SC：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fe8439452248" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fe8439452248-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fe8439452248-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-1"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-2"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: slow</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/gce-pd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-6"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: pd-standard</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-9"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-11"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-12"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-13"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: fast</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-15"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/gce-pd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fe8439452248-16"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fe8439452248-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: pd-ssd</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>很多类型的卷没有内置的Provisioner，而动态提供需要由Provisioner来完成。你可能需要借助<a href="https://github.com/kubernetes-incubator/external-storage">external-storage</a>项目。</p>
<div class="blog_h3"><span class="graybg">使用动态提供</span></div>
<p>前面已经提到过，要使用动态提供，你需要为PVC声明storageClassName字段，也就是声明需要哪种风格的存储资源。 </p>
<div class="blog_h2"><span class="graybg">静态提供</span></div>
<p>你也可以手工创建持久卷对象，不依赖于内置或外置的Provisioner。任何K8S支持的<span style="background-color: #c0c0c0;">存储资源，并非必须依赖于Provisioner或者StorageClass才能使用</span>。</p>
<div class="blog_h3"><span class="graybg"><a id="static-provisioning-ceph"></a>ceph</span></div>
<p>下面是基于Ceph，创建静态持久卷的例子。持久卷定义如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9fec701708255" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-16">16</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-18">18</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-20">20</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-22">22</div><div class="crayon-num" data-line="crayon-634f9a69b9fec701708255-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9fec701708255-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9fec701708255-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolume</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: maven-repository</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: maven-repository</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-7"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-9"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteMany</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">capacity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 16Gi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">cephfs</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Ceph MON节点列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">monitors</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>xenial-100</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Carbon</div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>Radon</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 存储在默认CephFS的什么路径下</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /maven-repository</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 访问密钥</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">secretRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pvc-ceph-key</span></div><div class="crayon-line" id="crayon-634f9a69b9fec701708255-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 访问用户</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9fec701708255-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">user</span><span class="">: admin</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>Pod不能直接引用持久卷，因此需要创建一个PVC，关联到上面的PV：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69b9ff0672842243" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-2">2</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-4">4</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-6">6</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-8">8</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-10">10</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-12">12</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-14">14</div><div class="crayon-num" data-line="crayon-634f9a69b9ff0672842243-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69b9ff0672842243-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolumeClaim</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: maven-repository</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 访问模式，这里是允许多写</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteMany</div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">storageClassName</span><span class="">: ""</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 16Gi</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">selector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 使用标签来匹配目标卷</span></div><div class="crayon-line" id="crayon-634f9a69b9ff0672842243-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">matchLabels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69b9ff0672842243-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: maven-repository</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>使用上面PV的Pod的例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba206851083615" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba206851083615-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba206851083615-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba206851083615-1"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: maven-repository-0</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: maven-repository</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: docker.gmem.cc/busybox</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"/bin/sh"</div><div class="crayon-line" id="crayon-634f9a69ba206851083615-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">args</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"-c"</div><div class="crayon-line" id="crayon-634f9a69ba206851083615-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"sleep<span class="crayon-h"> </span>365d"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: data</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: "/data"</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">restartPolicy</span><span class="">: "Never"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: data</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba206851083615-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">persistentVolumeClaim</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba206851083615-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">claimName</span><span class="">: maven-repository</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<div class="blog_h3"><span class="graybg">nfs</span></div>
<p>持久卷示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba211491072846" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba211491072846-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba211491072846-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba211491072846-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-2"><span class="crayon-s ">kind</span><span class="">: PersistentVolume</span></div><div class="crayon-line" id="crayon-634f9a69ba211491072846-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: datastore</span></div><div class="crayon-line" id="crayon-634f9a69ba211491072846-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">capacity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba211491072846-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">storage</span><span class="">: 1Ti</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">accessModes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba211491072846-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ReadWriteMany</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">nfs</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba211491072846-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">server</span><span class="">: 10.255.223.141</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba211491072846-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: "/datastore"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h1"><span class="graybg">存储类</span></div>
<p>StorageClass（存储类）为集群管理员提供了一种方法，用于描述集群提供的存储的“类型”。不同的存储类，可能映射到了不同的QoS级别、备份策略，等等。K8S本身不对存储类表示什么进行解释，存储类的类似其它存储系统中的Profile。</p>
<div class="blog_h2"><span class="graybg">StorageClass对象</span></div>
<p>每个SC对象都包含provisioner、parameters、reclaimPolicy字段，当属于此存储类的PersistentVolume需要被提供出去时，这些参数会被K8S使用。</p>
<p>StorageClass的名称很关键，因为用户根据其名称来请求特定的存储类。SC的所有属性都在管理员初次创建时指定，后续不能更改。</p>
<p>在启用准许控制器DefaultStorageClass的情况下，管理员可以设置默认StorageClass。这样不关心SC是何物的PVC可以使用默认的SC。</p>
<p>SC对象的规格示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba215805352223" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba215805352223-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba215805352223-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba215805352223-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba215805352223-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba215805352223-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba215805352223-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba215805352223-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba215805352223-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba215805352223-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba215805352223-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba215805352223-1"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba215805352223-2"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba215805352223-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba215805352223-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: standard</span></div><div class="crayon-line" id="crayon-634f9a69ba215805352223-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/aws-ebs</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba215805352223-6"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba215805352223-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: gp2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba215805352223-8"><span class="crayon-s ">reclaimPolicy</span><span class="">: Retain</span></div><div class="crayon-line" id="crayon-634f9a69ba215805352223-9"><span class="crayon-s ">mountOptions</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba215805352223-10"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>debug</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">provisioner</span></div>
<p>该属性指定用于提供PV的存储插件，必须字段。K8S自带了一系列内部存储插件（以kubernetes.io/前缀开头） 。你也可以使用外部存储插件（服务K8S规范的独立程序）。K8S允许外部存储插件被非常自由的实现，一些可用的外部插件位于<a href="https://github.com/kubernetes-incubator/external-storage">K8S孵化器</a>中。</p>
<div class="blog_h3"><span class="graybg">reclaimPolicy</span></div>
<p>对于动态提供的PV，其回收策略从存储类继承。如果你没有给存储类指定该字段，默认为Delete。</p>
<div class="blog_h3"><span class="graybg">mountOptions</span></div>
<p>由存储类动态创建的PV会继承此挂载选项。</p>
<div class="blog_h2"><span class="graybg">配置参数</span></div>
<p>存储类有一个parameters字段，用于描述存储类创建的卷是什么样的。parameters包含哪些子字段取决于provisioner。</p>
<div class="blog_h3"><span class="graybg">AWS</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba21a747180063" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba21a747180063-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21a747180063-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba21a747180063-1"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-2"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba21a747180063-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: slow</span></div><div class="crayon-line" id="crayon-634f9a69ba21a747180063-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/aws-ebs</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-6"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba21a747180063-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># io1, gp2, sc1, st1，默认gp2</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: io1</span></div><div class="crayon-line" id="crayon-634f9a69ba21a747180063-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># AWS区域，如果不指定，则在包含K8S节点的Zone上循环创建卷。zone指定单个值，zones指定逗号分隔的多个值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">zones</span><span class="">: us-east-1d</span><span class="crayon-o">,</span><span class="crayon-h"> </span>us-east-1c</div><div class="crayon-line" id="crayon-634f9a69ba21a747180063-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 每GB数据在每秒内支持的IO次数，近用于io1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21a747180063-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">iopsPerGB</span><span class="">: "10"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h3"><span class="graybg">Glusterfs</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba21e141318638" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba21e141318638-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba21e141318638-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba21e141318638-1"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-2"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: slow</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/glusterfs</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-6"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Gluster的REST服务/Heketi服务的URL，存储类依赖于此URL来提供卷</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resturl</span><span class="">: "http</span><span class="">://127.0.0.1</span><span class="">:8081"</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Heketi用来提供卷的集群ID，可以是逗号分隔的多个值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">clusterid</span><span class="">: "630372ccdc720a92c681fb928f27b53f"</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Gluster REST服务是否需要身份验证，如果是，则需要restuser字段、restuserkey或secretNamespace+secretName字段</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">restauthenabled</span><span class="">: "true"</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">restuser</span><span class="">: "admin"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">secretNamespace</span><span class="">: "default"</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">secretName</span><span class="">: "heketi-secret"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 存储类的GID范围</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">gidMin</span><span class="">: "40000"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">gidMax</span><span class="">: "50000"</span></div><div class="crayon-line" id="crayon-634f9a69ba21e141318638-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 卷类型及其参数</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba21e141318638-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumetype</span><span class="">: "replicate</span><span class="">:3"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<div class="blog_h3"><span class="graybg">Ceph RBD </span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba222354843047" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba222354843047-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba222354843047-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba222354843047-1"><span class="crayon-s ">kind</span><span class="">: StorageClass</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-2"><span class="crayon-s ">apiVersion</span><span class="">: storage.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: fast</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-5"><span class="crayon-s ">provisioner</span><span class="">: kubernetes.io/rbd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-6"><span class="crayon-s ">parameters</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Ceph monitors，逗号分隔，必须</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">monitors</span><span class="">: 10.16.153.105</span><span class="">:6789</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 能够在池中创建image的 Ceph client ID</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">adminId</span><span class="">: kube</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># adminSecret的名字</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">adminSecretName</span><span class="">: ceph-secret</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># adminSecret的名字空间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">adminSecretNamespace</span><span class="">: kube-system</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Ceph RBD pool，默认rbd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">pool</span><span class="">: kube</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 用于映射RBD image的Ceph client ID，默认等于adminId</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">userId</span><span class="">: kube</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># user的Ceph Secret的名字必须和PVC位于同一名字空间。Secret的类型必须为kubernetes.io/rbd</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">userSecretName</span><span class="">: ceph-secret-user</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 支持的文件类型</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">fsType</span><span class="">: ext4</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Ceph RBD image 格式，1或2，默认1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba222354843047-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">imageFormat</span><span class="">: "2"</span></div><div class="crayon-line" id="crayon-634f9a69ba222354843047-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">imageFeatures</span><span class="">: "layering" </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<div class="blog_h2"><span class="graybg">默认StorageClass</span></div>
<p>要设置某个StorageClass为默认，执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba226224783612" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba226224783612-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba226224783612-1"><span class="crayon-e">kubectl </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">storageclass </span><span class="crayon-v">ceph</span><span class="crayon-o">-</span><span class="crayon-v">rbd</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-s">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>这样，没有显示指定StorageClass的PVC，会自动使用ceph-rbd这个存储类。 </p>
<div class="blog_h1"><span class="graybg">使用API</span></div>
<div class="blog_h2"><span class="graybg">API概述</span></div>
<p>K8S APIServer暴露了REST风格的API，所有组件之间的通信都基于此API进行，包括kubectl或kubeadm等Shell工具。</p>
<p>你也可以直接进行REST调用，或者使用对应编程语言的<a href="https://kubernetes.io/docs/reference/client-libraries/">客户端库</a>发起API调用。</p>
<p>K8S支持版本化的API，不同版本包含的字段可以不一样。版本号示例：/api/v1、/apis/extensions/v1beta1。</p>
<p><span style="background-color: #c0c0c0;">人类用户、服务账号（SA）都可以访问API</span>，访问过程有三个阶段：</p>
<ol>
<li>身份验证</li>
<li>访问控制（授权）</li>
<li>Admission Control</li>
</ol>
<div class="blog_h2"><span class="graybg">传输层安全</span></div>
<p>典型情况下，APIServer使用端口443提供服务，它通常使用一个自签名的证书。客户端机器的$USER/.kube/config中通常包含了APIServer的根证书。</p>
<div class="blog_h2"><span class="graybg">身份验证</span></div>
<p>建立TLS连接后，API调用请求需要进行身份验证。自动创建集群的脚本，或者集群管理员，会为APIServer配置1-N个身份验证器（Authenticator）模块。身份验证器通常会检查客户端证书，或者HTTP请求头。</p>
<p>身份验证器模块包括：客户端证书、密码、明文Token、Bootstrap Token、JWT Token（SA使用）这几种。如果配置多个模块，会顺序尝试，直到成功。</p>
<p>如果身份验证失败，APIServer返回401错误。否则用户被验证为指定的Principal（用户名，username），某些身份验证器也提供了用户所属的组信息。K8S使用用户名进行后续的访问控制和日志记录。</p>
<div class="blog_h3"><span class="graybg">K8S的用户</span></div>
<p>集群的用户被分为两类：Service Account和普通用户，后者由外部系统管理，无法在K8S集群中进行登记。</p>
<p>Service Account由K8S API管理，绑定到特定的名字空间。API Server可能会自动创建SA，你也可以手工创建。SA关联到一系列保存了凭证的Secret中，例如，下面这个Secret就保存了Token这种凭证：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba22b816533641" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba22b816533641-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba22b816533641-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba22b816533641-1"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-e">describe </span><span class="crayon-e">secret </span><span class="crayon-st">default</span><span class="crayon-o">-</span><span class="crayon-v">token</span><span class="crayon-o">-</span><span class="crayon-v">vgvll</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba22b816533641-2"><span class="crayon-c"># token: ...</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">身份验证策略</span></div>
<p>K8S使用客户端证书、不记名令牌（bearer token）、 身份验证代理（authenticating proxy）、HTTP基本验证来对API请求者的身份进行验证。具体的验证工作由身份验证插件负责。</p>
<p>身份验证插件会尝试从请求中获取以下属性：</p>
<ol>
<li>用户名，例如kube-admin或者alex@gmem.cc</li>
<li>用户标识符</li>
<li>用户组，用户所属的多个分组</li>
<li>身份验证插件可能需要的其它额外字段</li>
</ol>
<p>你可以同时启用多种身份验证策略，并至少：</p>
<ol>
<li>为SA提供基于Token的身份验证</li>
<li>为普通用户提供某种认证策略</li>
</ol>
<p>当启用多种身份验证策略时，第一个成功的验证器获胜，K8S不保证验证器的执行顺序。</p>
<p>所有经过身份验证的用户都会归属于用户组：system:authenticated。</p>
<div class="blog_h3"><span class="graybg">客户端证书</span></div>
<p>为API Server提供选项 --client-ca-file=/path/to/cafile，即可启用基于客户端证书的身份验证。指定的文件必须包含1-N个CA证书，这些证书将用户客户端证书的校验。<span style="background-color: #c0c0c0;">如果客户端证书通过校验，则其Common name字段将作为用户名</span>，如果要将用户关联到多个组，你需要指定多个organization证书字段。CSR示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba230359625298" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba230359625298-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba230359625298-1"><span class="crayon-e">openssl </span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">key </span><span class="crayon-v">alex</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">alex</span><span class="crayon-e">.csr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">subj</span><span class="crayon-h"> </span><span class="crayon-s">"/CN=alex/O=app1/O=app2"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<div class="blog_h3"><span class="graybg">静态Token文件</span></div>
<p>为API Server提供选项--token-auth-file=/path/to/token，则API Server从文件中读取静态Token列表，修改Token文件后必须重启API Server。</p>
<p>静态Token是一个CSV文件，包含至少三个字段：Token、用户名、UID，可以包含一个分组字段，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba23d175309820" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba23d175309820-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba23d175309820-1"><span class="crayon-v">token</span><span class="crayon-sy">,</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-v">uid</span><span class="crayon-sy">,</span><span class="crayon-s">"group1,group2,group3"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<div class="blog_h3"><span class="graybg">在请求中包含Token</span></div>
<p>设置请求头即可：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba241937011459" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba241937011459-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba241937011459-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba241937011459-1"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c"># 必须以Bearer开始，后面跟着Token内容</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba241937011459-2"><span class="crayon-v">Authorization</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">Bearer</span><span class="crayon-h"> </span><span class="crayon-cn">31ada4fd</span><span class="crayon-o">-</span><span class="crayon-v">adec</span><span class="crayon-o">-</span><span class="crayon-cn">460c</span><span class="crayon-o">-</span><span class="crayon-cn">809a</span><span class="crayon-o">-</span><span class="crayon-cn">9e56ceb75269</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">Bootstrap Token </span></div>
<p>为了方便的搭建新集群，K8S提供了一种动态管理的不记名Token —— Bootstrap Token这些Token存储为kube-system中的Secrets，可以被动态的创建和管理。</p>
<p>控制器管理器（Controller Manager）包含了一种控制器TokenCleaner，自动在过期后删除Bootstrap Token。</p>
<p>使用APIServer选项--experimental-bootstrap-token-auth来启用Bootstrap Token验证，使用 --controllers=***,tokencleaner来启用TokenCleaner。Kubeadm自动添加了这些选项。</p>
<p>基于Bootstrap Token认证的请求，其用户名设置为system:bootstrap:，分配到用户组system:bootstrappers。</p>
<div class="blog_h3"><span class="graybg">静态密码文件</span></div>
<p>为API Server提供选项--basic-auth-file=/path/to/passwd，则启用HTTP基本验证。密码文件也是CSV格式，形式如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba245643861795" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba245643861795-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba245643861795-1"><span class="crayon-v">password</span><span class="crayon-sy">,</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-v">uid</span><span class="crayon-sy">,</span><span class="crayon-s">"group1,group2,group3"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>你必须提供如下格式的请求头来使用基本验证：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba24a375992194" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba24a375992194-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba24a375992194-1"><span class="crayon-v">Authorization</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Basic </span><span class="crayon-e">BASE64ENCODED</span><span class="crayon-sy">(</span><span class="crayon-v">USER</span><span class="crayon-o">:</span><span class="crayon-v">PASSWORD</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h3"><span class="graybg">SA Token</span></div>
<p>Service Account验证器（验证插件，authenticator）总是自动启用。这种验证器基于签名过的Bearer Token来验证请求。该插件使用以参数：</p>
<ol>
<li>--service-account-key-file 用于签名Bearer Token的PEM编码的私钥</li>
<li>--service-account-lookup 被删除的Token自动吊销</li>
</ol>
<p>SA通常由APIServer自动创建，并关联到集群中的Pod，关联行为由准许控制器ServiceAccount负责。使用serviceAccountName字段你可以显式的关联某个SA到Pod。</p>
<p>执行命令
			<span id="crayon-634f9a69ba24e846247277" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-v">serviceaccount</span></span></span>，你可以手工创建一个SA。K8S会自动创建与此SA关联的Secret，该Secret中包含：</p>
<ol>
<li>ca.crt，APIServer的证书，Base64编码</li>
<li>token，签名后的JSON Web Token。你在请求中提供此Token则APIServer将你验证为对应的SA</li>
</ol>
<p>SA的用户名为system:serviceaccount:(NAMESPACE):(SERVICEACCOUNT)，分配到用户组system:serviceaccounts、system:serviceaccounts:(NAMESPACE)。</p>
<p>警告：用于SA的账户Token存放在Secret中，因此你向用户授予读Secret权限时要小心。任何获取Secret的人都可以伪装为SA。</p>
<div class="blog_h3"><span class="graybg">匿名用户</span></div>
<p>从1.6+开始，如果使用了除AlwaysAllow之外的验证模式 ，则默认允许匿名访问。你可以使用APIServer选项--anonymous-auth=false显式禁用匿名访问。</p>
<p>匿名用户被分配用户名system:anonymous，分配用户组system:unauthenticated。从1.6开始，ABAC/RBAC授权器要求对匿名用户/组进行显式授权。</p>
<div class="blog_h3"><span class="graybg">用户仿冒</span></div>
<p>如果被授权，一个用户可以仿冒为任何其它用户，需要提供以下请求头：</p>
<ol>
<li>Impersonate-User，仿冒的目标用户。使用kubectl时，你可以用--as来指定</li>
<li>Impersonate-Group， 仿冒的目标组。使用kubectl时，你可以用--as-group来指定</li>
<li>Impersonate-Extra-***，用户的***动态字段</li>
</ol>
<p>要仿冒其它用户，原用户必须被授权。对于启用RBAC的集群，可以定义如下ClusterRole：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba252586939340" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba252586939340-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba252586939340-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba252586939340-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba252586939340-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba252586939340-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba252586939340-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba252586939340-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba252586939340-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba252586939340-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba252586939340-1"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba252586939340-2"><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line" id="crayon-634f9a69ba252586939340-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba252586939340-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: impersonator</span></div><div class="crayon-line" id="crayon-634f9a69ba252586939340-5"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba252586939340-6"><span class="crayon-s ">- apiGroups</span><span class="">: [""]</span></div><div class="crayon-line" id="crayon-634f9a69ba252586939340-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 允许设置Impersonate-Extra-scopes头</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba252586939340-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ["users"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"groups"<span class="crayon-o">,</span><span class="crayon-h"> </span>"serviceaccounts"<span class="crayon-o">,</span><span class="crayon-h"> </span>"userextras/scopes"<span class="crayon-o">]</span></div><div class="crayon-line" id="crayon-634f9a69ba252586939340-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">verbs</span><span class="">: ["impersonate"]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<div class="blog_h2"><span class="graybg">访问控制</span></div>
<p>经过身份验证后，请求（的username）还必须确认是否具有访问API的权限。请求中除了包含<span style="background-color: #c0c0c0;">username</span>之外，还包括需要<span style="background-color: #c0c0c0;">执行的操作</span>，<span style="background-color: #c0c0c0;">操作针对的对象</span>。</p>
<p>K8S支持多种授权模块，包括ABAC（基于属性的访问控制）、RBAC（基于角色的访问控制）、Webhook。管理员创建集群时，会配置使用的授权模块。</p>
<p>如果请求没有访问权限，APIServer返回403错误。</p>
<div class="blog_h3"><span class="graybg">授权器</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 15%; text-align: center;">授权器</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>Node</td>
<td>特殊用途的授权器，根据在节点上运行的Pod，来授予kubectl权限</td>
</tr>
<tr>
<td>ABAC</td>
<td>
<p>基于属性的访问控制（Attribute-based access control），通过文件来指定策略</p>
<p>策略（Policy）将访问权限分组到一起，用户被关联到策略，策略可以使用任何类型的属性——用户属性、资源属性、对象属性……</p>
<p>使用API Server选项--authorization-mode=ABAC启用</p>
</td>
</tr>
<tr>
<td>RBAC</td>
<td>
<p>基于角色的访问控制（Role-based access control），通过API来创建、存储策略kind: ConfigMap<br />apiVersion: v1<br />metadata:<br /> name: calico-config<br /> namespace: kube-system<br />data:<br /> # The location of your etcd cluster. This uses the Service clusterIP defined below.<br /> etcd_endpoints: "http://10.5.38.24:2379,http://10.5.38.39:2379,http://10.5.39.41:2379"</p>
<p>使用API Server选项--authorization-mode=RBAC启用该授权器</p>
</td>
</tr>
<tr>
<td>AlwaysAllow</td>
<td>
<p>允许所有访问，相当于禁止访问控制</p>
<p>使用API Server选项 --authorization-mode=AlwaysAllow启用该授权器</p>
</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">检查权限</span></div>
<p>使用kubectl可以快速检查用户有没有特定的权限：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba258560715134" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba258560715134-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba258560715134-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba258560715134-1"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c"># 是否具有在dev创建deployment的权限</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba258560715134-2"><span class="crayon-e">kubectl </span><span class="crayon-e">auth </span><span class="crayon-v">can</span><span class="crayon-o">-</span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-e">create </span><span class="crayon-v">deployments</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">namespace </span><span class="crayon-v">dev</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h2"><span class="graybg">RBAC</span></div>
<p>这是使用最广泛的授权器，Kubeadm默认启用Node和RBAC两种授权器。</p>
<div class="blog_h3"><span class="graybg">Role</span></div>
<p>Role代表针对某个特定名字空间的一系列的权限（permissions），示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba25c188748649" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba25c188748649-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba25c188748649-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba25c188748649-1"><span class="crayon-s ">kind</span><span class="">: Role</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 针对default名字空间</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pod-reader</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-7"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># "" 表示核心API组</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-9"><span class="crayon-s ">- apiGroups</span><span class="">: [""]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可以访问核心API组的pods资源</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ["pods"]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba25c188748649-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可以针对资源进行下面三类操作</span></div><div class="crayon-line" id="crayon-634f9a69ba25c188748649-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">verbs</span><span class="">: ["get"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"watch"<span class="crayon-o">,</span><span class="crayon-h"> </span>"list"<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>某些API会牵涉到“子资源”，例如访问Pod的日志，URL为：GET /api/v1/namespaces/{namespace}/pods/{name}/log。如果你需要允许用户访问Pod，及其日志，需要这样配置：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba261010439495" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba261010439495-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba261010439495-1"><span class="crayon-s ">resources</span><span class="">: ["pods"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"pods/log"<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<div class="blog_h3"><span class="graybg">ClusterRole</span></div>
<p>ClusterRole代表针对整个集群的一系列权限，支持Role的任何权限，此外还可以授权对以下资源的访问：</p>
<ol>
<li>集群级别的资源，例如node</li>
<li>非资源端点，例如/healthz</li>
<li>跨越所有名字空间的namespaced资源，使用--all-namespace需要这种权限</li>
</ol>
<p>示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba265321648999" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba265321648999-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba265321648999-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba265321648999-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba265321648999-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba265321648999-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba265321648999-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba265321648999-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba265321648999-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba265321648999-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba265321648999-1"><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba265321648999-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba265321648999-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba265321648999-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 没有名字空间，因为ClusterRole不是namespaced的资源</span></div><div class="crayon-line" id="crayon-634f9a69ba265321648999-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: secret-reader</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba265321648999-6"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba265321648999-7"><span class="crayon-s ">- apiGroups</span><span class="">: [""]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba265321648999-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ["secrets"]</span></div><div class="crayon-line" id="crayon-634f9a69ba265321648999-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">verbs</span><span class="">: ["get"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"watch"<span class="crayon-o">,</span><span class="crayon-h"> </span>"list"<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

<p>从1.9开始，K8S允许组合一个ClusterRole，产生新的ClusterRole：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba269163116422" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba269163116422-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba269163116422-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba269163116422-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba269163116422-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba269163116422-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba269163116422-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba269163116422-1"><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba269163116422-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba269163116422-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba269163116422-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: monitoring</span></div><div class="crayon-line" id="crayon-634f9a69ba269163116422-5"><span class="crayon-c"># 根据标签匹配相关ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba269163116422-6"><span class="crayon-s ">aggregationRule</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba269163116422-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">clusterRoleSelectors</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba269163116422-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- matchLabels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba269163116422-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rbac<span class="crayon-o">.</span>example<span class="crayon-o">.</span>com/<span class="crayon-s ">aggregate-to-monitoring</span><span class="">: "true"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba269163116422-10"><span class="crayon-c"># 控制器管理器会自动填写下面的字段</span></div><div class="crayon-line" id="crayon-634f9a69ba269163116422-11"><span class="crayon-s ">rules</span><span class="">: []</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<div class="blog_h3"><span class="graybg">RoleBinding</span></div>
<p>将角色绑定到一个或者一组用户（User、Group、SA），示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba26e756531466" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba26e756531466-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba26e756531466-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba26e756531466-1"><span class="crayon-s ">kind</span><span class="">: RoleBinding</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: read-pods</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-6"><span class="crayon-c"># 被授权的主体，可以是用户、组、或者Service Account</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-7"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-8"><span class="crayon-s ">- kind</span><span class="">: User</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: admin@gmem.cc</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-11"><span class="crayon-c"># 授予的角色</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-12"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: Role</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba26e756531466-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: pod-reader</span></div><div class="crayon-line" id="crayon-634f9a69ba26e756531466-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>注意：roleRef可以引用ClusterRole，但是仅仅授予会当前名字空间的访问权限。</p>
<div class="blog_h3"><span class="graybg">ClusterRoleBinding</span></div>
<p>将集群角色绑定到一个或者一组用户，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba272968757682" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba272968757682-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba272968757682-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba272968757682-1"><span class="crayon-s ">kind</span><span class="">: ClusterRoleBinding</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: read-secrets-global</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-5"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-6"><span class="crayon-s ">- kind</span><span class="">: Group</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: system</span><span class="">:authenticated</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-9"><span class="crayon-s ">- kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: kube-system</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-12"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba272968757682-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: secret-reader</span></div><div class="crayon-line" id="crayon-634f9a69ba272968757682-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>使用命令：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba276156991218" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba276156991218-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba276156991218-1"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">clusterrolebinding </span><span class="crayon-v">cluster</span><span class="crayon-o">-</span><span class="crayon-v">admin</span><span class="crayon-o">-</span><span class="crayon-st">default</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">clusterrole</span><span class="crayon-o">=</span><span class="crayon-v">cluster</span><span class="crayon-o">-</span><span class="crayon-v">admin</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">serviceaccount</span><span class="crayon-o">=</span><span class="crayon-v">tke</span><span class="crayon-o">:</span><span class="crayon-st">default</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h3"><span class="graybg">默认角色 </span></div>
<p>API Server自动创建了一些ClusterRole、ClusterRoleBinding对象。大部分对象都具有system:前缀，提示这些对象供K8S基础设施使用，随意修改这些对象会导致集群不可用。所有这些对象都具有标签kubernetes.io/bootstrapping=rbac-defaults。</p>
<p>默认角色/绑定如下表：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 150px; text-align: center;">角色</td>
<td style="width: 200px; text-align: center;">角色绑定（到组）</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>system:basic-user</td>
<td>system:authenticated<br />system:unauthenticated</td>
<td>允许用户只读访问自己的基本信息</td>
</tr>
<tr>
<td>cluster-admin</td>
<td>system:masters</td>
<td>
<p>超级用户角色：</p>
<ol>
<li>在ClusterRoleBinding中使用时，允许任意访问</li>
<li>在RoleBinding中使用时，允许针对目标名字空间的任意访问</li>
</ol>
</td>
</tr>
<tr>
<td>admin</td>
<td> </td>
<td>允许针对名字空间的绝大部分操作，包括创建角色/绑定</td>
</tr>
<tr>
<td>edit</td>
<td> </td>
<td>允许针对名字空间的绝大部分资源进行写操作</td>
</tr>
<tr>
<td>view</td>
<td> </td>
<td>允许针对名字空间的绝大部分资源进行读操作</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">Admission Control</span></div>
<p><a href="https://kubernetes.io/docs/admin/admission-controllers/">准许控制器</a>是可以<span style="background-color: #c0c0c0;">修改或者拒绝请求</span>的软件模块。准许控制器能够访问被创建、修改、删除的对象的内容。</p>
<p>管理员可以配置多个准许控制器，这些控制器会按照顺序被调用。</p>
<p>如果存在任何准许控制器拒绝请求，则请求立即停止处理。</p>
<div class="blog_h1"><span class="graybg">安全</span></div>
<div class="blog_h2"><span class="graybg">安全上下文</span></div>
<p>安全上下文（Security Context）定义操作系统相关的、Pod的安全性配置，例如uid、gid、SELinux角色。可以规定Pod级别或容器级别的安全上下文。</p>
<div class="blog_h3"><span class="graybg">Pod级别</span></div>
<p>应用到所有容器：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba27b560222368" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27b560222368-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba27b560222368-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba27b560222368-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: hello-world</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">securityContext</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 运行容器入口点脚本的UID</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">runAsUser</span><span class="">: 1000</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 提示容器必须以非超级用户身份执行，Kubelet会在运行时检查容器用户的PID，如果为0且此选项为true则拒绝启动容器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">runAsNonRoot</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 为容器PID为1的进程添加的额外组信息</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">supplementalGroups</span><span class="">: []</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 支持所有权管理的那些卷，其所有者GID设置为下面的值，且允许下面的GID进行读写</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果读取挂载的PV时出现permission denied错误，可以考虑将该字段配置为运行Docker容器所使用的用户</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">fsGroup</span><span class="">: 1000</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">supplementalGroups</span><span class="">: [5678]</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 支持SELinux标签的卷，允许别下面的标签访问</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27b560222368-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">seLinuxOptions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27b560222368-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">level</span><span class="">: "s0</span><span class="">:c123</span><span class="crayon-o">,</span>c456"</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<div class="blog_h3"><span class="graybg">容器级别</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba27f765544401" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba27f765544401-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba27f765544401-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba27f765544401-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: hello-world</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: my-container</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">securityContext</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 是否在特权模式下执行容器，如果为true，则容器中进程的权限实际上等同于宿主机的root</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 特权容器可以访问宿主机上的所有设备，非特权容器不能访问任何宿主机设备</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果容器需要操控网络栈、访问硬件，则需要特权模式</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">privileged</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 容器的根文件系统是否为只读</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnlyRootFilesystem</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 容器以什么UID运行</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">runAsUser</span><span class="">: 1000</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 容器以什么GID运行（primary group）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">runAsGroup</span><span class="">: 1000</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 添加supplemental groups</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">supplementalGroups</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">runAsNonRoot</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba27f765544401-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">seLinuxOptions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba27f765544401-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">level</span><span class="">: "s0</span><span class="">:c123</span><span class="crayon-o">,</span>c456" </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<div class="blog_h2"><span class="graybg"><a id="psp"></a>PodSecurityPolicy</span></div>
<p>该对象用于细粒度的控制Pod安全，可以限制Pod的创建/更新，或者为某些字段提供默认值。下面是一些例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba284861747490" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-40">40</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-42">42</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-44">44</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-46">46</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-48">48</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-50">50</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-52">52</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-54">54</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-56">56</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-58">58</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-60">60</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-62">62</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-64">64</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-66">66</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-68">68</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-70">70</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-72">72</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-74">74</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-76">76</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-78">78</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-80">80</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-82">82</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-84">84</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-86">86</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-88">88</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba284861747490-90">90</div><div class="crayon-num" data-line="crayon-634f9a69ba284861747490-91">91</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba284861747490-1"><span class="crayon-c"># 最少限制的Policy，等价于没有启用PodSecurityPolicy准入控制器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-3"><span class="crayon-s ">apiVersion</span><span class="">: policy/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-4"><span class="crayon-s ">kind</span><span class="">: PodSecurityPolicy</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-5"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: privileged</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 允许使用任何安全Porfile</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>seccomp<span class="crayon-o">.</span>security<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">allowedProfileNames</span><span class="">: '*'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-10"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 可以运行特权容器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">privileged</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许权限提升，直接决定是否向容器传递no_new_privs标记</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># no_new_privs标记可以防止setuid的可执行文件改变它的Effective UID</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 设置该字段为false，则容器中发起的子进程不会得到比父进程更多的权限，即使它setuid</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">allowPrivilegeEscalation</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许使用任何Linux Caps</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">allowedCapabilities</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-19"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'*'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许使用任何类型的卷</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-22"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'*'</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许使用宿主机网络命名空间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostNetwork</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPorts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- min</span><span class="">: 0</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">max</span><span class="">: 65535</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostIPC</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPID</span><span class="">: true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">runAsUser</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'RunAsAny'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">seLinux</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'RunAsAny'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">supplementalGroups</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'RunAsAny'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-36"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">fsGroup</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'RunAsAny'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-38">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-39"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-40">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-41"><span class="crayon-c"># 要求不得运行特权容器，禁止权限提升</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-42">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-43"><span class="crayon-s ">apiVersion</span><span class="">: policy/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-44"><span class="crayon-s ">kind</span><span class="">: PodSecurityPolicy</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-45"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: restricted</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-47"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 限制允许的Apparmor/Seccomp模板</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-48"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>seccomp<span class="crayon-o">.</span>security<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">allowedProfileNames</span><span class="">: 'docker/default</span><span class="crayon-o">,</span>runtime/default'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>apparmor<span class="crayon-o">.</span>security<span class="crayon-o">.</span>beta<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">allowedProfileNames</span><span class="">: 'runtime/default'</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>seccomp<span class="crayon-o">.</span>security<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">defaultProfileName</span><span class="">:&nbsp;&nbsp;'runtime/default'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>apparmor<span class="crayon-o">.</span>security<span class="crayon-o">.</span>beta<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">defaultProfileName</span><span class="">:&nbsp;&nbsp;'runtime/default'</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-53"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-54"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 禁止特权容器</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-55"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">privileged</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-56"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 禁止提升为root</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-57"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">allowPrivilegeEscalation</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-58"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 这一条和禁止特权容器+禁止提升的功效重复，提供额外一层保护</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-59"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">requiredDropCapabilities</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-60"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>ALL</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-61"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 允许核心的卷类型</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-62"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-63"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'configMap'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-64"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'emptyDir'</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-65"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'projected'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'secret'</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'downwardAPI'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>'persistentVolumeClaim'</div><div class="crayon-line" id="crayon-634f9a69ba284861747490-69"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 禁止使用宿主机的命名空间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-70"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostNetwork</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-71"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostIPC</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-72"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPID</span><span class="">: false</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-73"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">runAsUser</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-74"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 不得以root身份允许容器进程</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-75"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'MustRunAsNonRoot'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-76"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">seLinux</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-77"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 假设节点运行AppArmor而非SELinux</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-78"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'RunAsAny'</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-79"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">supplementalGroups</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-80"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'MustRunAs'</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-81"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ranges</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-82"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 禁止加入root组</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-83"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- min</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">max</span><span class="">: 65535</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-85"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">fsGroup</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-86"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rule</span><span class="">: 'MustRunAs'</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-87"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">ranges</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-88"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 禁止加入root组</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-89"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- min</span><span class="">: 1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba284861747490-90"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">max</span><span class="">: 65535</span></div><div class="crayon-line" id="crayon-634f9a69ba284861747490-91"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">readOnlyRootFilesystem</span><span class="">: false</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0077 seconds] -->

<p>Pod安全策略被实现为Admission Controller，启用该控制器，但是不配置任何PodSecurityPolicy，则你无法创建任何Pod。</p>
<div class="blog_h3"><span class="graybg">策略控制角度</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="text-align: center;">角度</td>
<td style="text-align: center;">字段名称</td>
</tr>
</thead>
<tbody>
<tr>
<td>运行特权容器</td>
<td>privileged</td>
</tr>
<tr>
<td>使用宿主名字空间</td>
<td>hostPID、hostIPC</td>
</tr>
<tr>
<td>使用宿主的网络和端口</td>
<td>hostNetwork, hostPorts</td>
</tr>
<tr>
<td>控制卷类型的使用</td>
<td>volumes</td>
</tr>
<tr>
<td>使用宿主文件系统</td>
<td>allowedHostPaths</td>
</tr>
<tr>
<td>允许使用特定的 FlexVolume 驱动</td>
<td>allowedFlexVolumes</td>
</tr>
<tr>
<td>分配拥有 Pod 卷的 FSGroup 账号</td>
<td>fsGroup</td>
</tr>
<tr>
<td>以只读方式访问根文件系统</td>
<td>readOnlyRootFilesystem</td>
</tr>
<tr>
<td>器的用户和组 ID</td>
<td>runAsUser, runAsGroup, supplementalGroups</td>
</tr>
<tr>
<td>限制 root 账号特权级提升</td>
<td>allowPrivilegeEscalation, defaultAllowPrivilegeEscalation</td>
</tr>
<tr>
<td>Linux 权能字（Capabilities）</td>
<td>defaultAddCapabilities, requiredDropCapabilities, allowedCapabilities</td>
</tr>
<tr>
<td>设置容器的 SELinux 上下文</td>
<td>seLinux</td>
</tr>
<tr>
<td>指定容器可以挂载的 proc 类型</td>
<td>allowedProcMountTypes</td>
</tr>
<tr>
<td>指定容器使用的 AppArmor 模版</td>
<td>annotations</td>
</tr>
<tr>
<td>指定容器使用的 seccomp 模版</td>
<td>annotations</td>
</tr>
<tr>
<td>指定容器使用的 sysctl 模版</td>
<td>forbiddenSysctls,allowedUnsafeSysctls</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">通过RBAC将Policy授予用户</span></div>
<p>新创建的PodSecurityPolicy不起任何作用，发起请求的用户/Pod的SA必须<span style="background-color: #c0c0c0;">对该PodSecurityPolicy具有use权限</span>：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba28a576236856" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba28a576236856-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28a576236856-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba28a576236856-1"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-2"><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>role<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-5"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-6"><span class="crayon-s ">- apiGroups</span><span class="">: ['policy']</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ['podsecuritypolicies']</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">verbs</span><span class="">:&nbsp;&nbsp;&nbsp;&nbsp; ['use']</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">resourceNames</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-10"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>list<span class="crayon-h"> </span>of<span class="crayon-h"> </span>policies<span class="crayon-h"> </span>to<span class="crayon-h"> </span>authorize<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-12"><span class="crayon-o">---</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-14"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-15"><span class="crayon-s ">kind</span><span class="">: ClusterRoleBinding</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-16"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>binding<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-18"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>role<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-22"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-23"><span class="crayon-c"># 授权给特定SA</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-24"><span class="crayon-s ">- kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>authorized<span class="crayon-h"> </span>service<span class="crayon-h"> </span>account<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: </span><span class="crayon-o">&lt;</span>authorized<span class="crayon-h"> </span>pod<span class="crayon-h"> </span>namespace<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-27"><span class="crayon-c"># 授权给指定用户（不推荐）</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-28"><span class="crayon-s ">- kind</span><span class="">: User</span></div><div class="crayon-line" id="crayon-634f9a69ba28a576236856-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28a576236856-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>authorized<span class="crayon-h"> </span>user<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->

<p>如果使用RoleBinding而非ClusterRoleBinding，则仅仅特定命名空间下创建的Pod才可能获得PSP授权：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba28e803740323" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba28e803740323-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba28e803740323-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba28e803740323-1"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-2"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-3"><span class="crayon-s ">kind</span><span class="">: RoleBinding</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>binding<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-7"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: </span><span class="crayon-o">&lt;</span>role<span class="crayon-h"> </span>name<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-11"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-12"><span class="crayon-c"># 该命名空间下所有SA获得授权，这些SA创建的Pod都可以使用目标PodSecurityPolicy</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-13"><span class="crayon-s ">- kind</span><span class="">: Group</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: system</span><span class="">:serviceaccounts</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-16"><span class="crayon-c"># 该命名空间下所有认证过的用户获得授权（和上个元素等效）</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-17"><span class="crayon-s ">- kind</span><span class="">: Group</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba28e803740323-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba28e803740323-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: system</span><span class="">:authenticated</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<div class="blog_h3"><span class="graybg">Policy优先级 </span></div>
<p>如果创建Pod的用户具有多个Policy的use权限，那么选取Policy的规则如下：</p>
<ol>
<li>不需要设置默认值、改变Pod规格的Policy，被优先使用</li>
<li>如果Pod必须被设置默认值 、修改规格，则使用按名称排序的第一个Policy</li>
</ol>
<div class="blog_h3"><span class="graybg">启用PSP准入控制器</span></div>
<p>需要设置API Server的参数：
			<span id="crayon-634f9a69ba293770310270" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">enable</span><span class="crayon-o">-</span><span class="crayon-v">admission</span><span class="crayon-o">-</span><span class="crayon-v">plugins</span><span class="crayon-o">=</span><span class="crayon-v">PodSecurityPolicy</span><span class="crayon-sy">,</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></span></span>来启用此准入控制器。启用后，如果没有任何策略定义，则无法创建Pod。</p>
<div class="blog_h3"><span class="graybg">给kubelet授权</span></div>
<p>为API Server启用准入控制器PodSecurityPolicy之后，你会发现API Server的Pod不见了，这是因为Kubelet没有被授予PSP。可以为它授予：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba297928059168" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-40">40</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-42">42</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba297928059168-44">44</div><div class="crayon-num" data-line="crayon-634f9a69ba297928059168-45">45</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba297928059168-1"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-2"><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: privileged</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cluster-service</span><span class="">: "true"</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>addonmanager<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">mode</span><span class="">: Reconcile</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-8"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- apiGroups</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>policy</div><div class="crayon-line" id="crayon-634f9a69ba297928059168-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>podsecuritypolicies</div><div class="crayon-line" id="crayon-634f9a69ba297928059168-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 引用具有完整权限的PSP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resourceNames</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>privileged</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">verbs</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>use</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba297928059168-19"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-20">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba297928059168-21"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-22"><span class="crayon-s ">kind</span><span class="">: RoleBinding</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-23"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: psp-nodes</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: kube-system</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">description</span><span class="">: 'Allow nodes to create privileged pods. Should</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>be<span class="crayon-h"> </span>used<span class="crayon-h"> </span>in<span class="crayon-h"> </span>combination<span class="crayon-h"> </span>with<span class="crayon-h"> </span>the<span class="crayon-h"> </span>NodeRestriction<span class="crayon-h"> </span>admission<span class="crayon-h"> </span>plugin<span class="crayon-h"> </span>to<span class="crayon-h"> </span>limit</div><div class="crayon-line" id="crayon-634f9a69ba297928059168-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>nodes<span class="crayon-h"> </span>to<span class="crayon-h"> </span>mirror<span class="crayon-h"> </span>pods<span class="crayon-h"> </span>bound<span class="crayon-h"> </span>to<span class="crayon-h"> </span>themselves<span class="crayon-o">.</span>'</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>addonmanager<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">mode</span><span class="">: Reconcile</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">cluster-service</span><span class="">: 'true'</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-33"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-36"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: psp-privileged</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-37"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-38"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 授权给Kubelet</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- kind</span><span class="">: Group</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: system</span><span class="">:nodes</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-42"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- kind</span><span class="">: User</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba297928059168-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Legacy node ID</span></div><div class="crayon-line" id="crayon-634f9a69ba297928059168-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: kubelet</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0045 seconds] -->

<div class="blog_h3"><span class="graybg">为当前系统生成PSP</span></div>
<p>可以利用Kubectl插件kube-psp-advisor，它可以：</p>
<ol>
<li>连接到现有K8S环境，根据其中的工作负载来创建PSP</li>
<li>读取一个YAML，根据其中的工作负载清单来创建PSP</li>
</ol>
<p>执行命令：
			<span id="crayon-634f9a69ba29c216189105" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">krew </span><span class="crayon-e">install </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-v">psp</span></span></span>安装此插件，并且将
			<span id="crayon-634f9a69ba2a0331950897" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span><span class="crayon-v">HOME</span><span class="crayon-o">/</span><span class="crayon-sy">.</span><span class="crayon-v">krew</span><span class="crayon-o">/</span><span class="crayon-v">bin</span></span></span>加入到$PATH环境变量。</p>
<p>连接到K8S并为工作负载生成PSP/RBAC：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2a4848971540" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2a4848971540-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a4848971540-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-1"><span class="crayon-c"># 打印匹配当前集群所有工作负载的一个PSP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-2"><span class="crayon-e">kubectl </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-e">psp </span><span class="crayon-v">inspect</span></div><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-4"><span class="crayon-c"># 打印匹配当前工作负载的PSPs，附加RBAC规则</span></div><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-5"><span class="crayon-e">kubectl </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-e">psp </span><span class="crayon-v">inspect</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">g</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-6">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-7"><span class="crayon-c"># 报告集群为什么需要PSP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-8"><span class="crayon-e">kubectl </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-e">psp </span><span class="crayon-v">inspect</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">report</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-i">jq</span><span class="crayon-h"> </span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2a4848971540-11"><span class="crayon-c"># 打印匹配指定命名空间的PSP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a4848971540-12"><span class="crayon-e">kubectl </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-e">psp </span><span class="crayon-v">inspect</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-st">default</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<p>读取包含Pod Spec的文件，并生成PSP： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2a8042284024" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2a8042284024-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2a8042284024-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2a8042284024-1"><span class="crayon-c"># --podFile中可以包含Deployment/DaemonSet/StatefulSet/Pod等形式的工作负载定义</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2a8042284024-2"><span class="crayon-e">kubectl </span><span class="crayon-v">advise</span><span class="crayon-o">-</span><span class="crayon-e">psp </span><span class="crayon-v">convert</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">podFile</span><span class="crayon-o">=</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">K8S</span><span class="crayon-o">/</span><span class="crayon-v">rook</span><span class="crayon-o">/</span><span class="crayon-v">toolbox</span><span class="crayon-e">.yaml</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">pspFile</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">psp</span><span class="crayon-e">.yaml</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h2"><span class="graybg">审计</span></div>
<p>API Server支持审计功能，可以记录用户/K8S组件的活动，并可以指定<span style="background-color: #c0c0c0;">监控到某些活动后的处理逻辑</span>。</p>
<div class="blog_h3"><span class="graybg">审计阶段</span></div>
<p>在处理请求的不同阶段，都可以生成审计事件，这些阶段包括：</p>
<ol>
<li>RequestReceived 审计处理器（Handler，API Server具有由一系列处理器的链条组成）接收到请求后，委托给其它Handler处理之前</li>
<li>ResponseStarted 响应头发送之后，响应体发送之前。仅仅长时间运行的请求才有这个阶段，例如watch操作</li>
<li>ResponseComplete 响应完全发送完毕后</li>
<li>Panic 当发生panic时</li>
</ol>
<p>审计事件回根据特定的策略进行预处理，记录到后端。<span style="background-color: #c0c0c0;">支持的后端包括文件、Webhook</span>。</p>
<div class="blog_h3"><span class="graybg">审计策略</span></div>
<p>你可以定义审计策略，格式如下：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2ac885359782" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba2ac885359782-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ac885359782-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-1"><span class="crayon-s ">apiVersion</span><span class="">: audit.k8s.io/v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-2"><span class="crayon-s ">kind</span><span class="">: Policy</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-3"><span class="crayon-c"># 哪些阶段不做审计</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-4"><span class="crayon-s ">omitStages</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-5"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"RequestReceived"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-6"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 审计规则</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 审计级别：</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; None - 符合这条规则的日志将不会记录</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; Metadata - 记录请求的元数据（请求的用户、时间戳、资源、动词等等）， 但是不记录请求或者响应的消息体</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; Request - 记录事件的元数据和请求的消息体，但是不记录响应的消息体。 不适用于非资源类型的请求</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp; RequestResponse - 记录事件的元数据，请求和响应的消息体。不适用于非资源类型的请求</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- level</span><span class="">: RequestResponse</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 规则针对的资源</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- group</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ["pods"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"deployments"<span class="crayon-o">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- level</span><span class="">: Metadata</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- group</span><span class="">: ""</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">: ["pods/exec"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"pods/portforward"<span class="crayon-o">,</span><span class="crayon-h"> </span>"pods/proxy"<span class="crayon-o">,</span><span class="crayon-h"> </span>"services/proxy"<span class="crayon-o">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- level</span><span class="">: Metadata</span></div><div class="crayon-line" id="crayon-634f9a69ba2ac885359782-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">omitStages</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ac885359782-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class="crayon-h"> </span>"RequestReceived"</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0023 seconds] -->

<p>下面这个示例，为所有请求在Metadata级别生成日志： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2b1607160836" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2b1607160836-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b1607160836-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2b1607160836-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b1607160836-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2b1607160836-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2b1607160836-1"><span class="crayon-c"># 在 Metadata 级别为所有请求生成日志</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b1607160836-2"><span class="crayon-s ">apiVersion</span><span class="">: audit.k8s.io/v1beta1</span></div><div class="crayon-line" id="crayon-634f9a69ba2b1607160836-3"><span class="crayon-s ">kind</span><span class="">: Policy</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b1607160836-4"><span class="crayon-s ">rules</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2b1607160836-5"><span class="crayon-s ">- level</span><span class="">: Metadata</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<div class="blog_h3"><span class="graybg">使用日志后端</span></div>
<p>需要为API Server指定以下参数：</p>
<p style="padding-left: 30px;">--audit-log-path 指定用来写入审计事件的日志文件路径。不指定此标志会禁用日志后端<br />--audit-policy-file 审计策略文件<br />--audit-log-maxage 定义了保留旧审计日志文件的最大天数<br />--audit-log-maxbackup 定义了要保留的审计日志文件的最大数量<br />--audit-log-maxsize 定义审计日志文件的最大大小（兆字节）</p>
<p>由于通常情况下，API Server以静态Pod的形式运行，因此，需要将宿主机上的策略文件、日志文件挂载为数据卷：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2b5914470930" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2b5914470930-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2b5914470930-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-1"><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /etc/kubernetes/audit-policy.yaml</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: audit</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: true</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- mountPath</span><span class="">: /var/log/audit.log</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: audit-log</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">readOnly</span><span class="">: false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-10"><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-11"><span class="crayon-s ">- name</span><span class="">: audit</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /etc/kubernetes/audit-policy.yaml</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: File</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-16"><span class="crayon-s ">- name</span><span class="">: audit-log</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2b5914470930-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /var/log/audit.log</span></div><div class="crayon-line" id="crayon-634f9a69ba2b5914470930-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">type</span><span class="">: FileOrCreate</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<div class="blog_h3"><span class="graybg">使用Webhook后端</span></div>
<p>你需要开发一个Webhook服务器，它提供和API Server相同的API。</p>
<p>需要为API Server指定以下参数：</p>
<p style="padding-left: 30px;">--audit-webhook-config-file webhook 配置文件的路径。Webhook 配置文件实际上是一个 kubeconfig 文件<br /> --audit-webhook-initial-backoff 指定在第一次失败后重发请求等待的时间。随后的请求将以指数退避重试</p>
<div class="blog_h3"><span class="graybg">批处理模式</span></div>
<p>不管使用哪种后端，都可以支持批处理，也就是缓存一批审计日志，然后一起发送给后端。默认情况下Log后端禁用批处理，Webhook后端启用批处理。</p>
<p>如果使用Webhook后端，你可以通过下面的参数配置批处理模式：</p>
<p style="padding-left: 30px;">--audit-webhook-mode 定义缓存策略，可选值如下：</p>
<ol>
<ol>
<li>batch   缓存事件，异步发送给后端。这是默认值</li>
<li>blocking   在 API 服务器处理每个单独事件时，阻塞其响应</li>
<li>blocking-strict  与 blocking 相同，不过当审计日志在 RequestReceived 阶段失败时，整个 API 服务请求会失效</li>
</ol>
</ol>
<p>当上述mode设置为batch时，你可以使用下面的额外参数：</p>
<p style="padding-left: 30px;">--audit-webhook-batch-buffer-size 定义 batch 之前要缓存的事件数。 如果传入事件的速率溢出缓存区，则会丢弃事件<br /> --audit-webhook-batch-max-size 定义一个 batch 中的最大事件数<br /> --audit-webhook-batch-max-wait 无条件 batch 队列中的事件前等待的最大事件<br /> --audit-webhook-batch-throttle-qps 每秒生成的最大批次数<br /> --audit-webhook-batch-throttle-burst 在达到允许的 QPS 前，同一时刻允许存在的最大 batch 生成数</p>
<p>使用Log后端时，将上述参数的前缀都改为--audit-log。</p>
<div class="blog_h2"><span class="graybg"><a id="opa"></a>Open Policy Agent</span></div>
<p><a href="https://www.openpolicyagent.org/docs/latest">开放策略代理</a>（OPA，读音oh-pa）是一个开源的、一般用途（不依赖于K8S）的策略引擎。OPA提供接口：</p>
<ol>
<li>声明式的语言Rego（读音ray-go），用来编写策略</li>
<li>简单的API，用于从其它应用来发起策略决策（policy decision-making）</li>
</ol>
<p>当需要作出策略决策时，你需要查询OPA，以结构化数据作为输入。OPA根据输入、策略定义，来输出策略决策。OPA和Rego是业务无感知（domain-agnostic）的，你几乎用它来描述任何策略，例如：</p>
<ol>
<li>什么用户可以访问什么资源</li>
<li>出口流量可以访问什么子网</li>
<li>工作负载必须部署到哪个集群</li>
<li>允许从何处下载容器镜像</li>
<li>容器可以使用哪些操作系统权能（Capability）</li>
<li>在什么时间允许访问系统</li>
</ol>
<p>OPA和PSP之类的K8S内置安全机制比起来，功能更加广泛。</p>
<p>策略决策也不简单的是Yes/No，而可以是任何结构化的数据。</p>
<div class="blog_h3"><span class="graybg">决策输入</span></div>
<p>可以是任何结构化的数据。例如一个描述系统状态的JSON：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2ba690665635" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JSON</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ba690665635-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba2ba690665635-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-1"><span class="crayon-c">// 这个数据结构描述了一个网络拓扑</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"servers"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"app"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"protocols"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"https"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ssh"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"p1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"p2"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"p3"</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"db"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"protocols"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"mysql"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"p3"</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"cache"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"protocols"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"memcache"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"p3"</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"ci"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"protocols"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"http"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"p1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"p2"</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"busybox"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"protocols"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"telnet"</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"p1"</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"networks"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"public"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">false</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net2"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"public"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">false</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net3"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"public"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">true</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net4"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"public"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">true</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"ports"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"p1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"network"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net1"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"p2"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"network"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net3"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"id"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"p3"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"network"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"net2"</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ba690665635-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba2ba690665635-21"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0084 seconds] -->

<div class="blog_h3"><span class="graybg">Rego语言语法</span></div>
<p>此语言用于针对复杂数据结构（输入）来描述策略。语法类似于Go： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2c0323960703" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-40">40</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-42">42</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-44">44</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-46">46</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-48">48</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-50">50</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c0323960703-52">52</div><div class="crayon-num" data-line="crayon-634f9a69ba2c0323960703-53">53</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-1"><span class="crayon-c">// 访问接口输入的service数据结构</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-2"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-3"><span class="crayon-c">// 访问数组元素</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-4"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-6"><span class="crayon-c">// 如果访问不存在的数据，则OPA返回undefined decision，表示OPA不能根据输入作出决策</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-7"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">deadbeef</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-9"><span class="crayon-c">// 如果需要作出策略决策，你需要编写表达式</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-10"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"app"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-12"><span class="crayon-c">// Rego提供了一些内置函数</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-13"><span class="crayon-e">count</span><span class="crayon-sy">(</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-16"><span class="crayon-c">// 多个表达式可以使用逻辑与操作符 ; 链接在一起</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-17"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"app"</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"https"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-18"><span class="crayon-c">// 等价于</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-19"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"app"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-20"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"https"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-21"><span class="crayon-c">// 任何一个表达式结果不是true，或者是undefined，则决策结果是undefined decision</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-22">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-24"><span class="crayon-c">// 变量</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-25"><span class="crayon-v">s</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-26"><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"app"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-27"><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-28"><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"https"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-29">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-30">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-31"><span class="crayon-c">// 迭代数据集</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-32"><span class="crayon-c">// 获得满足条件的network索引集合</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-33"><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-34"><span class="crayon-c">// 获得满足条件的server、protocol索引组合</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-35"><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"http"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-36"><span class="crayon-c">// 变量可以被赋值给其它变量</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-37"><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">j</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-38"><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">ports</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">id</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-39"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">ports</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">network</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">id</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-40"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-m">public</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-41"><span class="crayon-c">// +---+------+---+</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-42"><span class="crayon-c">// | i |&nbsp;&nbsp;id&nbsp;&nbsp;| j |</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-43"><span class="crayon-c">// +---+------+---+</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-44"><span class="crayon-c">// | 1 | "p2" | 2 |</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-45"><span class="crayon-c">// +---+------+---+</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-46">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-47"><span class="crayon-c">// 如果后续你不需要引用变量名，可以用_代替：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-48"><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"http"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-49"><span class="crayon-p"># true</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-50">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-51"><span class="crayon-c">// 如果找不到什么匹配表达式的变量，则结果是undefined</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c0323960703-52"><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"ssh"</span></div><div class="crayon-line" id="crayon-634f9a69ba2c0323960703-53"><span class="crayon-c">// undefined decision</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0093 seconds] -->

<div class="blog_h3"><span class="graybg">完整规则</span></div>
<p>Rego支持将可复用逻辑封装为规则（Rule） 。</p>
<p>规则可以是完整的（Complete），这样的规则是一个if-then语句，并且分配单个值到变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2c6701666810" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2c6701666810-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c6701666810-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2c6701666810-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c6701666810-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2c6701666810-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2c6701666810-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2c6701666810-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2c6701666810-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">rules</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c6701666810-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2c6701666810-3"><span class="crayon-c">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里的true可以省略</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c6701666810-4"><span class="crayon-v">any_public_networks</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p"># 变量any_public_networks是true，如果</span></div><div class="crayon-line" id="crayon-634f9a69ba2c6701666810-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">net</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p"># 存在某个网络</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2c6701666810-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-m">public</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 并且它是public的</span></div><div class="crayon-line" id="crayon-634f9a69ba2c6701666810-7"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<p>规则由头、体两部分组成。如果<span style="background-color: #c0c0c0;">规则体中的某种变量组合（例如上面的_取值为0）可以让规则体结果为true，那么规则头为true</span>。</p>
<p>要调用上面的规则，使用它的名字即可
			<span id="crayon-634f9a69ba2cb322577944" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">any_public_networks</span></span></span>。规则产生的值存放在全局变量data中：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2cf853764213" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2cf853764213-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2cf853764213-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2cf853764213-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2cf853764213-1"><span class="crayon-c">//&nbsp;&nbsp; 包名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2cf853764213-2"><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">rules</span><span class="crayon-sy">.</span><span class="crayon-v">any_public_networks</span></div><div class="crayon-line" id="crayon-634f9a69ba2cf853764213-3"><span class="crayon-c">// true</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>如果想定义一个常量，省略规则体即可： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2d3874315985" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2d3874315985-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2d3874315985-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2d3874315985-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2d3874315985-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">constants</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2d3874315985-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2d3874315985-3"><span class="crayon-v">pi</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3.14</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>如果找不到任何变量组合，满足规则体的表达式，则规则是未定义的（undefined decision），</p>
<div class="blog_h3"><span class="graybg">部分规则</span></div>
<p>规则可以是部分（Partial）的，与完整规则生成一个值不同，部分规则生成一组值，并且将这组值分配给一个变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2d7673089078" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2d7673089078-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2d7673089078-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2d7673089078-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2d7673089078-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2d7673089078-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2d7673089078-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2d7673089078-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">rules</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2d7673089078-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2d7673089078-3"><span class="crayon-v">public_network</span><span class="crayon-sy">[</span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># net.id 作 public_network的元素，如果</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2d7673089078-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">net</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p"># 如果网络存在</span></div><div class="crayon-line" id="crayon-634f9a69ba2d7673089078-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-m">public</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 且它是public的</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2d7673089078-6"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>你可以查询生成的数据集的值：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2db667243367" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2db667243367-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2db667243367-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2db667243367-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2db667243367-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2db667243367-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2db667243367-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2db667243367-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2db667243367-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2db667243367-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2db667243367-1"><span class="crayon-v">public_network</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2db667243367-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2db667243367-3"><span class="crayon-c">// [</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2db667243367-4"><span class="crayon-c">//&nbsp;&nbsp;"net3",</span></div><div class="crayon-line" id="crayon-634f9a69ba2db667243367-5"><span class="crayon-c">//&nbsp;&nbsp;"net4"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2db667243367-6"><span class="crayon-c">// ]</span></div><div class="crayon-line" id="crayon-634f9a69ba2db667243367-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2db667243367-8"><span class="crayon-c">// public_network["net3"]</span></div><div class="crayon-line" id="crayon-634f9a69ba2db667243367-9"><span class="crayon-c">// "net3"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>通过部分规则，除了定义上面这种Set，还可以定义键值对（对象）：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2df922787304" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2df922787304-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2df922787304-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2df922787304-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2df922787304-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2df922787304-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2df922787304-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2df922787304-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2df922787304-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2df922787304-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2df922787304-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2df922787304-1"><span class="crayon-v">apps_by_hostname</span><span class="crayon-sy">[</span><span class="crayon-v">hostname</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">app</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2df922787304-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-i">i</span></div><div class="crayon-line" id="crayon-634f9a69ba2df922787304-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sites</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2df922787304-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">hostname</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">hostname</span></div><div class="crayon-line" id="crayon-634f9a69ba2df922787304-5"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">apps</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2df922787304-6"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">apps</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-i">name</span></div><div class="crayon-line" id="crayon-634f9a69ba2df922787304-7"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2df922787304-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2df922787304-9"><span class="crayon-c">// apps_by_hostname["hello"]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2df922787304-10"><span class="crayon-c">// "world"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<div class="blog_h3"><span class="graybg">规则逻辑或</span></div>
<p>下面的语句，表示协议为telnet或者ssh， shell_accessible的值都是true：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2e3139303694" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2e3139303694-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2e3139303694-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">logical_or</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-3"><span class="crayon-c">// 如果所有具有此名字的规则的结果都是undefined，则设置默认值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-4"><span class="crayon-r">default</span><span class="crayon-h"> </span><span class="crayon-v">shell_accessible</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-6"><span class="crayon-v">shell_accessible</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"telnet"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-8"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-10"><span class="crayon-v">shell_accessible</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"ssh"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-12"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2e3139303694-14"><span class="crayon-c">// shell_accessible</span></div><div class="crayon-line" id="crayon-634f9a69ba2e3139303694-15"><span class="crayon-c">// true</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->

<p>针对部分规则进行逻辑或，则最终的Set，是参与逻辑或的规则的结果的并集： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2ea524681157" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2ea524681157-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2ea524681157-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">logical_or</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-3"><span class="crayon-v">shell_accessible</span><span class="crayon-sy">[</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"telnet"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-6"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-8"><span class="crayon-v">shell_accessible</span><span class="crayon-sy">[</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"ssh"</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-11"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-12">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-13"><span class="crayon-c">// shell_accessible</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-14"><span class="crayon-c">// [</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-15"><span class="crayon-c">//&nbsp;&nbsp; "busybox",</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2ea524681157-16"><span class="crayon-c">//&nbsp;&nbsp; "db"</span></div><div class="crayon-line" id="crayon-634f9a69ba2ea524681157-17"><span class="crayon-c">// ]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0027 seconds] -->

<div class="blog_h3"><span class="graybg">规则示例 </span></div>
<p>针对上面的数据集， 假设我们需要检查拓扑是否满足安全策略：</p>
<ol>
<li>所有可以通过Internet访问的服务器，不能暴露http协议</li>
<li>所有服务器不得暴露telnet协议</li>
</ol>
<p>可以这样编写Rego规则：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2f1864831388" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Go</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba2f1864831388-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2f1864831388-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-1"><span class="crayon-t">package</span><span class="crayon-h"> </span><span class="crayon-e">example</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-3"><span class="crayon-r">default</span><span class="crayon-h"> </span><span class="crayon-v">allow</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-p"># 除非明确定义，否则任何不满足策略</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-5"><span class="crayon-v">allow</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 如果违反集中没有成员，则满足策略</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">count</span><span class="crayon-sy">(</span><span class="crayon-v">violation</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-7"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-9"><span class="crayon-c">// 两个部分规则进行逻辑与</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-10"><span class="crayon-v">violation</span><span class="crayon-sy">[</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 以下条件下服务器（的ID）加入违反集</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">some </span><span class="crayon-e">server</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-12"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">public_server</span><span class="crayon-sy">[</span><span class="crayon-v">server</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-p"># 它存在于public_server集</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"http"</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-p"># 它暴露了http协议</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-14"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-16"><span class="crayon-v">violation</span><span class="crayon-sy">[</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 以下条件下服务器（的ID）加入违反集</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 它属于输入的服务器集</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">protocols</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"telnet"</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-p"># 它暴露了telnet协议</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-19"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-20">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-21"><span class="crayon-c">// 下面的规则生成上面规则需要的public_server集</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-22"><span class="crayon-e">public_server</span><span class="crayon-sy">[</span><span class="crayon-e">server</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-p"># 以下条件下服务器加入public_server集</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">some</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">j</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">servers</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 服务器位于输入的服务器集中</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">ports</span><span class="crayon-sy">[</span><span class="crayon-v">_</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">ports</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 服务器的ports定义在输入端口集中</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">ports</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">network</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p"># 端口的network定义在输入的网络集中</span></div><div class="crayon-line" id="crayon-634f9a69ba2f1864831388-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">input</span><span class="crayon-sy">.</span><span class="crayon-v">networks</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-m">public</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p"># 网络是public的</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2f1864831388-28"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0067 seconds] -->

<div class="blog_h2"><span class="graybg">Gatekeeper</span></div>
<p>Gatekeeper将OPA整合到Kubernetes，它通过Validation Webhook和API Server对接，允许Kubernetes 管理员可以定义策略来保证集群的合规性，并符合最佳实践的要求。</p>
<p>使用Gatekeeper时，你需要在自定义资源中声明OPA规则。Gatekeeper会同步规则到OPA引擎中，当API Server接收到各种资源创建请求后，会转发给Gatekeeper进行策略检查。</p>
<div class="blog_h3"><span class="graybg">ContstraintTemplate</span></div>
<p>GateKeeper使用此CR来存储OPA规则，下面的例子，禁止使用latest标签的镜像：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba2fa387492585" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba2fa387492585-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba2fa387492585-39">39</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-1"><span class="crayon-s ">apiVersion</span><span class="">: templates.gatekeeper.sh/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-2"><span class="crayon-s ">kind</span><span class="">: ConstraintTemplate</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: k8simagetagvalid</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-5"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 此模板生成的自定义资源</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">crd</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">names</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: K8sImageTagValid</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">targets</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- target</span><span class="">: admission.k8s.gatekeeper.sh</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">rego</span><span class="">: |</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>package<span class="crayon-h"> </span>k8simagetagvalid</div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 输入是传递给Webhook的请求对象</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 逻辑或构造违反集</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 规则1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>violation<span class="crayon-o">[</span><span class="crayon-o">{</span>"msg"<span class="">: msg</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"details"<span class="">:</span><span class="crayon-o">{</span><span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-o">]</span><span class="crayon-h"> </span><span class="crayon-o">{</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果某个容器的镜像</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="crayon-h"> </span><span class="">:= input.review.object.spec.template.spec.containers[_].image</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 没有指定tag部分</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>not<span class="crayon-h"> </span>count<span class="crayon-sy">(</span>split<span class="crayon-sy">(</span>image<span class="crayon-o">,</span><span class="crayon-h"> </span>"<span class="">:")) == 2</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 则加入违反集，且构造出违反集元素</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">msg</span><span class="crayon-h"> </span><span class="">:= sprintf("image '%v' doesn't specify a valid tag"</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-o">[</span>image<span class="crayon-o">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 规则2</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>violation<span class="crayon-o">[</span><span class="crayon-o">{</span>"msg"<span class="">: msg</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"details"<span class="">:</span><span class="crayon-o">{</span><span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-o">]</span><span class="crayon-h"> </span><span class="crayon-o">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 如果某个容器的镜像名字以latest结尾</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="crayon-h"> </span><span class="">:= input.review.object.spec.template.spec.containers[_].image</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>endswith<span class="crayon-sy">(</span>image<span class="crayon-o">,</span><span class="crayon-h"> </span>"latest"<span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">msg</span><span class="crayon-h"> </span><span class="">:= sprintf("image '%v' uses latest tag"</span><span class="crayon-o">,</span><span class="crayon-h"> </span><span class="crayon-o">[</span>image<span class="crayon-o">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">}</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 隐含下面的规则</span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># allow = true {</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba2fa387492585-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp; count(violation) == 0 </span></div><div class="crayon-line" id="crayon-634f9a69ba2fa387492585-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># }</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0042 seconds] -->

<div class="blog_h3"><span class="graybg">Constraint</span></div>
<p>有了ContstraintTemplate，还不会对集群产生任何影响。你还需要定义对应的 Constraint —— 由ContstraintTemplate生成的自定义资源：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba302991574161" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba302991574161-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba302991574161-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba302991574161-1"><span class="crayon-s ">apiVersion</span><span class="">: constraints.gatekeeper.sh/v1beta1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-2"><span class="crayon-c"># 类型是ContstraintTemplate创建的CRD的名字</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-3"><span class="crayon-s ">kind</span><span class="">: K8sImageTagValid</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: valid-image-tag</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-6"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 如果启用dryrun，不会阻止资源的创建，而是仅仅记录违反策略的情况</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">enforcementAction</span><span class="">: dryrun</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 将策略应用到哪些类型的K8S资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">match</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kinds</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba302991574161-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">- apiGroups</span><span class="">: [ "apps" ]</span></div><div class="crayon-line" id="crayon-634f9a69ba302991574161-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">kinds</span><span class="">: [ "Deployment"</span><span class="crayon-o">,</span><span class="crayon-h"> </span>"StatefulSet"<span class="crayon-h"> </span><span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>在dryrun模式下，可以describe 上述资源，查询策略违反情况。</p>
<div class="blog_h1"><span class="graybg">CNI</span></div>
<p>CNI即容器网络接口（Container Network Interface），比起Docker的CNI，对开发者以来更少，也不受限制于Docker。</p>
<p>在CNI中，网络插件是一个独立的可执行文件，它会被上层容器平台调用，并实现：</p>
<ol>
<li>将容器加入到网络</li>
<li>将容器从网络中删除</li>
</ol>
<p>调用时需要的信息，通过环境变量、或标准输入传递。</p>
<p>实现CNI很简单，只需要：</p>
<ol>
<li>一个配置文件，描述CNI插件的版本、名称、描述等信息</li>
<li>开发CNI的可执行文件：
<ol>
<li>从环境变量或命令行中读取需要执行的操作、目标网络命名空间、容器网卡必要信息</li>
<li>实现两个操作：ADD/DEL</li>
</ol>
</li>
</ol>
<p>Kubernetes调用CNI的流程如下：</p>
<ol>
<li>调用CRI创建pause容器，生成网络命名空间</li>
<li>调用网络驱动，即CNI驱动</li>
<li>CNI驱动根据配置调用CNI插件</li>
<li>CNI插件给pause容器配置正确的网络。Pod中其它容器都使用pause容器的网络栈</li>
</ol>
<p>CNI具体负责的事情包括：</p>
<ol>
<li>为容器分配IP地址</li>
<li>为荣庆网络接口绑定IP地址</li>
<li>实现多主机连接功能</li>
</ol>
<div class="blog_h2"><span class="graybg">常见CNI实现简介</span></div>
<div class="blog_h3"><span class="graybg">flannel</span></div>
<p>flannel由CoreOS开发，能让集群内所有容器使用一个网络，<span style="background-color: #c0c0c0;">每个主机从该网络中划分一个子网</span>（防止IP地址冲突），主机创建容器中从子网分配一个IP地址。</p>
<p>为了解决容器之间的通信（路由）问题，flanne支持多种网络模式：</p>
<ol>
<li>overlay：早期使用的模式。这种模式下容器发出的数据包被flannel再次包装。新包头里面包含了主机本身IP，确保封包可以在底层网络中正确传递。再次包装的方式有：
<ol>
<li>UDP：flannel自定义的一种协议。在用户态解包、封包</li>
<li>VXLAN：在内核态解包、封包，性能比UDP好很多</li>
</ol>
</li>
<li>Host-Gateway模式：由运行在各节点上的Agent容器，将容器网络的路由信息同步到所有节点。这种模式不需要修改封包，<span style="background-color: #c0c0c0;">性能甚至比Calico更好</span>。问题是，<span style="background-color: #c0c0c0;">Host-Gateway模式只能改节点的路由，底层网络必须是二层</span>的，不像Calico的BGP那样可以将路由同步到路由器。由于广播封包问题，这种网络通常规模不能太大。近年来，也出现一些专门的设备，用以支持大规模二层网络，即所谓”大二层“</li>
</ol>
<p>从架构上来说，flannel分为两部分：</p>
<ol>
<li>控制平面：主要包含一个Etcd，用于协调各节点上容器网段的划分。控制平面没有服务器</li>
<li>数据平面，运行在节点上的flanneld进程，它会读取Etcd获取空闲网段，也把自己申请到的网段信息回填到Etcd中</li>
</ol>
<p>对于”固定IP“这种需求，flannel天生无法支持，原因是节点和网络的绑定关系。</p>
<div class="blog_h3"><span class="graybg">Calico</span></div>
<p>该插件将所有节点看做虚拟路由器，使用BGP协议，可以跨越多个二层网络。</p>
<p>除了提供网络连接外，Calico还支持网络策略，可以对容器、虚拟机工作负载、宿主机各节点之间的网络通信进行细粒度、动态的控制。</p>
<p>Calico还支持和Istio集成，在Service Mesh层面实施网络策略。</p>
<p>Calico允许容器漂移，在不同主机之前迁移容器不受限制。</p>
<p>Calico也支持隧道模式（ipip），性能稍差，但是对底层网络没有要求。</p>
<div class="blog_h3"><span class="graybg">Cilium</span></div>
<p>Cilium是一个CNI插件，是一个<span style="background-color: #c0c0c0;">API感知</span>的网络、安全开源软件，独特之处是安全，而且能理解<span style="background-color: #c0c0c0;">RESTful、Kafka协议</span>这样的API，因此比那种基于IP、端口的防火墙软件厉害的多。</p>
<p>在微服务时代，iptables无法满足安全策略的需求，一个安全策略的数量很多，而且需要频繁的更新。解决办法是利用BPF（Berkeley Packet Filter），它是一个内核中的高性能沙箱虚拟机，将内核变为可编程的。BPF可以在不影响安全、性能的前提下扩展Linux内核，进行网络数据包的处理。</p>
<p>BPF是类似于iptables的框架，允许在内核的多个挂钩点添加逻辑。</p>
<p>BPF是一个虚拟机，你可以将封包过滤规则以BPF虚拟机指令的形式写入内核，BPF会对指令进行验证，并JIT编译成CPU指令。任何网络报文都不能绕开BPF。</p>
<p>Cilium原生的理解服务、容器、Pod标志，能够理解gRPC、HTTP、Kafka等协议。</p>
<p>在服务网络方面，Cilium和IPVS具有同样的O(1)复杂度，可以用来作为Kube Proxy的代替。</p>
<p>Cilium甚至可以用来加速Istio。Istio的Sidecar可能引入10倍的性能损耗，原因是Istio使用iptables在数据包级别执行重定向，这导致每个数据包需要多次通过完整的网络栈。Linux内核基于BPF进行了一项所谓<span style="background-color: #c0c0c0;">Sockmap</span>的改进，可以直接在套接字层安全的进行重定向，QPS比iptables、甚至loopback网卡更高。</p>
<div class="blog_h3"><span class="graybg">CNI-Genie</span></div>
<p>华为开源的CNI适配器，它允许你动态按需的切换底层CNI插件。它允许用户在同一个集群中<span style="background-color: #c0c0c0;">使用多个底层CNI</span>，为<span style="background-color: #c0c0c0;">容器创建多个网络接口</span>。</p>
<div class="blog_h1"><span class="graybg">管理配置</span></div>
<div class="blog_h2"><span class="graybg">管理任务概览</span></div>
<div class="blog_h3"><span class="graybg">集群规划</span></div>
<p>第一步是选择<a href="https://kubernetes.io/docs/setup/pick-right-solution/">适当的部署方案</a>。K8S支持单机、本地计算机集群、云服务、VM集群、裸金属等多种运行环境，你需要考虑以下几点：</p>
<ol>
<li>是想在本机上学习K8S，还是需要搭建高可用、多节点的集群</li>
<li>为了实现HA，可以考虑跨Zone集群</li>
<li>某些服务商提供开箱即用的K8S集群，例如GKE</li>
<li>集群是内部部署（on-premises），还是在云端（IaaS）</li>
<li>对于内部部署的集群，你需要考虑使用何种K8S的网络模型</li>
<li>是否希望在裸金属或者VM上运行K8S</li>
</ol>
<div class="blog_h3"><span class="graybg">集群管理</span></div>
<p>集群的日常管理任务包括：</p>
<ol>
<li>集群生命周期管理：创建集群、升级Master/Worker节点、执行节点维护（例如内核升级）、升级API版本</li>
<li>对于多个团队共享的集群，需要进行配额的管理</li>
</ol>
<div class="blog_h3"><span class="graybg">集群安全</span></div>
<p>安全性相关的管理主题包括：</p>
<ol>
<li>数字证书管理</li>
<li>K8S API的访问控制</li>
<li>身份验证和授权</li>
<li>准许控制器：能够在身份验证和授权后，拦截发送给K8S API服务器的请求</li>
<li>内核参数调整（sysctl）</li>
<li>审计，和K8S的审计日志交互</li>
</ol>
<p>和Kubelet安全性相关的管理主题：</p>
<ol>
<li>与Master节点的安全通信</li>
<li>TLS支持</li>
<li>Kubelet的身份验证/授权</li>
</ol>
<div class="blog_h2"><span class="graybg">数字证书管理</span></div>
<p>要基于数字证书来进行客户端身份验证，你可以选用现有的部署脚本，或者使用easyrsa、openssl、cfssl之类的工具来生成数字证书。</p>
<div class="blog_h3"><span class="graybg">脚本</span></div>
<p>现有部署脚本调用方式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba30f224972101" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba30f224972101-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba30f224972101-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba30f224972101-1"><span class="crayon-c"># subject-alternate-names格式为 IP: or DNS:的列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba30f224972101-2"><span class="crayon-v">cluster</span><span class="crayon-o">/</span><span class="crayon-v">saltbase</span><span class="crayon-o">/</span><span class="crayon-v">salt</span><span class="crayon-o">/</span><span class="crayon-v">generate</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-o">/</span><span class="crayon-r">make</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-e">.sh</span> <span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-o">-</span><span class="crayon-v">of</span><span class="crayon-o">-</span><span class="crayon-e">apiserver </span><span class="crayon-v">subject</span><span class="crayon-o">-</span><span class="crayon-v">alternate</span><span class="crayon-o">-</span><span class="crayon-v">names</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<p>上述脚本产生三个文件：ca.crt, server.crt, server.key。然后修改API Server的启动参数：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba317851855706" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba317851855706-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba317851855706-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba317851855706-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba317851855706-1"><span class="crayon-o">--</span><span class="crayon-v">client</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">srv</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba317851855706-2"><span class="crayon-o">--</span><span class="crayon-v">tls</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">srv</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">server</span><span class="crayon-e">.crt</span></div><div class="crayon-line" id="crayon-634f9a69ba317851855706-3"><span class="crayon-o">--</span><span class="crayon-v">tls</span><span class="crayon-o">-</span><span class="crayon-v">private</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">srv</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">server</span><span class="crayon-e">.key</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<div class="blog_h3"><span class="graybg">openssl</span></div>
<p>基于OpenSSL来手工生成证书的方法如下：</p>
<ol>
<li>生成CA的密钥对：
			<span id="crayon-634f9a69ba31d210356593" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">openssl </span><span class="crayon-v">genrsa</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">ca</span><span class="crayon-sy">.</span><span class="crayon-i">key</span><span class="crayon-h"> </span><span class="crayon-cn">2048</span></span></span></li>
<li>CA生成自签名证书：
			<span id="crayon-634f9a69ba323394417378" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">openssl </span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">x509</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">key </span><span class="crayon-v">ca</span><span class="crayon-sy">.</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">subj</span><span class="crayon-h"> </span><span class="crayon-s">"/CN=${MASTER_IP}"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">days</span><span class="crayon-h"> </span><span class="crayon-cn">10000</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">ca</span><span class="crayon-sy">.</span><span class="crayon-v">crt</span></span></span></li>
<li>生成API Server的密钥对：
			<span id="crayon-634f9a69ba32a076520351" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">openssl </span><span class="crayon-v">genrsa</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-i">key</span><span class="crayon-h"> </span><span class="crayon-cn">2048</span></span></span></li>
<li>创建一个配置文件，用于生成API Server的证书签名请求（CSR）：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba330996990162" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">csr.conf</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba330996990162-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba330996990162-36">36</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba330996990162-1"><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-i">req</span><span class="crayon-h"> </span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-2"><span class="crayon-v">default_bits</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2048</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-3"><span class="crayon-v">prompt</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">no</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-4"><span class="crayon-v">default_md</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sha256</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-5"><span class="crayon-v">req_extensions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">req_ext</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-6"><span class="crayon-v">distinguished_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">dn</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-8"><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-i">dn</span><span class="crayon-h"> </span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-9"><span class="crayon-v">C</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-10"><span class="crayon-v">ST</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-11"><span class="crayon-v">L</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-12"><span class="crayon-v">O</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-13"><span class="crayon-v">OU</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-14"><span class="crayon-v">CN</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">MASTER_IP</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-16"><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-v">req</span><span class="crayon-sy">_</span>ext<span class="crayon-h"> </span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-17"><span class="crayon-v">subjectAltName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-v">alt_names</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba330996990162-19"><span class="crayon-p"># 所有可能用于访问APIServer的域名或IP地址&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-20"><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-v">alt</span><span class="crayon-sy">_</span>names<span class="crayon-h"> </span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-21"><span class="crayon-v">DNS</span><span class="crayon-sy">.</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">kubernetes</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-22"><span class="crayon-v">DNS</span><span class="crayon-sy">.</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-st">default</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-23"><span class="crayon-p"># 假设你使用cluster.local作为域名（后缀），这个可配置</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-24"><span class="crayon-v">DNS</span><span class="crayon-sy">.</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-st">default</span><span class="crayon-sy">.</span><span class="crayon-e">svc</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-25"><span class="crayon-v">DNS</span><span class="crayon-sy">.</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-st">default</span><span class="crayon-sy">.</span><span class="crayon-v">svc</span><span class="crayon-sy">.</span><span class="crayon-e">cluster</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-26"><span class="crayon-v">DNS</span><span class="crayon-sy">.</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-st">default</span><span class="crayon-sy">.</span><span class="crayon-v">svc</span><span class="crayon-sy">.</span><span class="crayon-v">cluster</span><span class="crayon-sy">.</span><span class="crayon-e">local</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-27"><span class="crayon-v">IP</span><span class="crayon-sy">.</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">MASTER_IP</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-28"><span class="crayon-p"># 往往是Servic CIDR中（由APIServer、控制器管理全的--service-cluster-ip-range参数指定）的第一个地址</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-29"><span class="crayon-v">IP</span><span class="crayon-sy">.</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">MASTER_CLUSTER_IP</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-31"><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-v">v3</span><span class="crayon-sy">_</span>ext<span class="crayon-h"> </span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-32"><span class="crayon-v">authorityKeyIdentifier</span><span class="crayon-o">=</span><span class="crayon-v">keyid</span><span class="crayon-sy">,</span><span class="crayon-v">issuer</span><span class="crayon-o">:</span><span class="crayon-e">always</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-33"><span class="crayon-v">basicConstraints</span><span class="crayon-o">=</span><span class="crayon-v">CA</span><span class="crayon-o">:</span><span class="crayon-t">FALSE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-34"><span class="crayon-v">keyUsage</span><span class="crayon-o">=</span><span class="crayon-v">keyEncipherment</span><span class="crayon-sy">,</span><span class="crayon-e">dataEncipherment</span></div><div class="crayon-line" id="crayon-634f9a69ba330996990162-35"><span class="crayon-v">extendedKeyUsage</span><span class="crayon-o">=</span><span class="crayon-v">serverAuth</span><span class="crayon-sy">,</span><span class="crayon-e">clientAuth</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba330996990162-36"><span class="crayon-v">subjectAltName</span><span class="crayon-o">=</span><span class="crayon-sy">@</span><span class="crayon-v">alt</span><span class="crayon-sy">_</span>names </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0069 seconds] -->

</li>
<li>生成CSR：
			<span id="crayon-634f9a69ba338195710527" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">openssl </span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">key </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-v">csr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">config </span><span class="crayon-v">csr</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span></span></span></li>
<li>根据CSR来签名，生成APIServer的服务器证书：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba33e920498250" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba33e920498250-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba33e920498250-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba33e920498250-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba33e920498250-1"><span class="crayon-e">openssl </span><span class="crayon-v">x509</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-e">.csr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">CA </span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">CAkey </span><span class="crayon-v">ca</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba33e920498250-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-v">CAcreateserial</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">server</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">days</span><span class="crayon-h"> </span><span class="crayon-cn">10000</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba33e920498250-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-e">extensions </span><span class="crayon-v">v3_ext</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">extfile </span><span class="crayon-v">csr</span><span class="crayon-e">.conf</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

</li>
</ol>
<p>然后，用相同的方法，修改APIServer的启动参数。</p>
<div class="blog_h3"><span class="graybg">分发自签名CA证书</span></div>
<p>自签名证书可能不被客户端节点信任，你需要手工分发：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba345219300558" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba345219300558-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba345219300558-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba345219300558-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba345219300558-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba345219300558-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba345219300558-1"><span class="crayon-c"># 在每个客户端执行：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba345219300558-2"><span class="crayon-c"># 复制CA证书到本地证书目录</span></div><div class="crayon-line" id="crayon-634f9a69ba345219300558-3"><span class="crayon-e">sudo </span><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">share</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-v">certificates</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-e">.crt</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba345219300558-4"><span class="crayon-c"># 更新证书配置</span></div><div class="crayon-line" id="crayon-634f9a69ba345219300558-5"><span class="crayon-e">sudo </span><span class="crayon-v">update</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-v">certificates</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<div class="blog_h3"><span class="graybg">证书API</span></div>
<p>你可以使用<a href="https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster">certificates.k8s.io</a>API来提供数字证书。 </p>
<div class="blog_h2"><span class="graybg">资源管理</span></div>
<div class="blog_h3"><span class="graybg">组织资源配置</span></div>
<p>很多应用程序需要多项K8S资源（对象），你可以在单个YAML中同时定义它们，只需要用 
			<span id="crayon-634f9a69ba34c621278131" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-o">-</span></span></span> 分隔两项资源即可。 </p>
<p>K8S会按照YAML中的声明顺序来创建资源，因此你应该先定义Service、再定义Deployment。</p>
<p>
			<span id="crayon-634f9a69ba352621856943" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span></span></span>也支持多个
			<span id="crayon-634f9a69ba358169383387" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">-</span><span class="crayon-v">f</span></span></span>参数，你可以同时指定多个配置文件。你还可以为-f指定一个配置目录，其中的yaml、yml、json文件都会被读取。你也可以为-f 指定为一个URL</p>
<p>K8S建议：</p>
<ol>
<li>将和一个微服务/应用程序分层（Tier）相关的资源，放到同一配置文件中</li>
<li>将和你的整个应用程序相关的所有资源，放到同一目录中</li>
<li>如果你的应用程序各Tier通过DNS相互绑定，那么，你可以简单的一起部署所有组件</li>
</ol>
<p>使用
			<span id="crayon-634f9a69ba35f338145387" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">-</span><span class="crayon-v">R</span></span></span>参数可以递归的读取子目录中的配置文件，来创建对象。</p>
<p>使用
			<span id="crayon-634f9a69ba365500842479" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">-</span><span class="crayon-v">o</span></span></span>参数可以输出被创建对象的名称：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba36b870094495" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba36b870094495-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba36b870094495-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba36b870094495-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba36b870094495-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba36b870094495-1"><span class="crayon-c"># -o name 输出resources/name格式&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba36b870094495-2">kubectl<span class="crayon-h"> </span>get<span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span>kubectl<span class="crayon-h"> </span>create<span class="crayon-h"> </span>-f<span class="crayon-h"> </span>docs/user-guide/nginx/<span class="crayon-h"> </span>-o<span class="crayon-h"> </span>name<span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span>grep<span class="crayon-h"> </span>service<span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69ba36b870094495-3"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLUSTER-IP&nbsp;&nbsp; EXTERNAL-IP&nbsp;&nbsp; PORT(S)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba36b870094495-4"><span class="crayon-c"># my-nginx-svc&nbsp;&nbsp; 10.0.0.208&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;80/TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0s</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<div class="blog_h3"><span class="graybg">kubectl批量操作</span></div>
<p>除了创建资源，其它操作也支持批量式的操作。例如删除操作：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba370127957056" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba370127957056-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba370127957056-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba370127957056-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba370127957056-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba370127957056-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba370127957056-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba370127957056-1"><span class="crayon-c"># 从指定目录中寻找资源配置，并删除对应的K8S对象</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba370127957056-2"><span class="crayon-e">kubectl </span><span class="crayon-v">delete</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">docs</span><span class="crayon-o">/</span><span class="crayon-v">user</span><span class="crayon-o">-</span><span class="crayon-v">guide</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">/</span></div><div class="crayon-line" id="crayon-634f9a69ba370127957056-3"><span class="crayon-c"># 删除多个对象，对象以 resources/name格式指定</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba370127957056-4"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-v">deployments</span><span class="crayon-o">/</span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-e">nginx </span><span class="crayon-v">services</span><span class="crayon-o">/</span><span class="crayon-v">my</span><span class="crayon-o">-</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">svc</span></div><div class="crayon-line" id="crayon-634f9a69ba370127957056-5"><span class="crayon-c"># 删除多个对象，根据标签 + 类型</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba370127957056-6"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-v">deployment</span><span class="crayon-sy">,</span><span class="crayon-v">services</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<div class="blog_h2"><span class="graybg">集群网络管理 </span></div>
<p>集群的网络架构和Docker不同，它需要解决四个不同的网络问题：</p>
<ol>
<li>高耦合容器之间的通信，在Pod内部，使用localhost相互通信</li>
<li>Pod之间的通信，使用集群网络，是本节的主题</li>
<li>Pod与Service之间的通信，利用K8S的Service机制解决</li>
<li>外部与Service之间的通信，也是利用K8S的Service机制解决</li>
</ol>
<p>K8S假设所有Pod之间都有通信的需求，因此不去罗嗦的为容器之间指定link。K8S为每个Pod分配了IP地址，你几乎从不需要进行容器到宿主机的端口映射。</p>
<p>Pod更像是一个VM或者物理主机，不管从端口分配、命名、服务发现、负载均衡、应用程序配置、迁移等角度。</p>
<div class="blog_h3"><span class="graybg">Docker网络架构</span></div>
<p>容器使用宿主机私有网络，它会创建一个名为docker0的虚拟网桥，并分配一个子网。每个创建的容器被分配一个虚拟以太网设备（veth），这些以太网卡被连接到网桥。在容器中veth被映射为eth0这个网络接口（使用了Linux名字空间机制，因此不会和宿主机冲突）。容器中的eth0被分配以网桥地址范围中的一个IP。</p>
<p>结果是，同一宿主机上，基于同一网桥（docker network）的容器可以相互通信。但是跨宿主机则无法通信，需要使用端口映射机制（映射到宿主机），你要么需要小心的分配端口，要么使用自动端口映射。</p>
<div class="blog_h3"><span class="graybg">K8S网络架构</span></div>
<p>K8S强制要求了以下网络特性：</p>
<ol>
<li>所有容器之间的通信，不使用NAT（端口映射）</li>
<li>所有节点 - 容器之间的通信不使用NAT</li>
<li>容器看到自己的IP地址，其它角色也能看到</li>
</ol>
<p>K8S为每个Pod分配了一个IP地址，Pod中的容器共享此IP地址。在Docker中，实现方式是，利用一个容器持有网络名字空间，然后Pod中其它容器加入到此名字空间：
			<span id="crayon-634f9a69ba375840139655" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">net</span><span class="crayon-o">=</span><span class="crayon-v">container</span><span class="crayon-o">:</span></span></span></p>
<p>可以利用多种技术来实现K8S的网络架构，例如Cilium、Contiv、Contrail、Flannel、GCE、Kube-router、Linux网桥、Multus、OpenVSwitch、OVN </p>
<div class="blog_h2"><span class="graybg">日志架构 </span></div>
<p>应用和系统日志有利于了解集群中发生了什么，在调试问题和监控集群性能时日志非常有效。大部分应用程序都实现了某种日志机制，大部分容器引擎都支持某种日志收集方式，最常用的时标准输出/错误。</p>
<p>应用、容器的日志机制不能作为K8S的日志解决方案，容器可能崩溃、Pod可能被清除、节点也可能死掉，即使这些异常情况出现，你仍然需要访问自己的应用程序日志。</p>
<p>K8S引入集群级别日志（cluster-level-logging）的概念。CLL要求独立的日志存储机制，以便分析和查询。</p>
<p>K8S没有提供原生的日志数据存储方案，但是你可以把现有的方案集成进来。CLL假设你已经做好了位于集群内部/外部的存储方案</p>
<div class="blog_h3"><span class="graybg">基本日志</span></div>
<p>对于容器输出到标准输出的日志，可以使用命令直接查看：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba379923132141" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba379923132141-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba379923132141-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba379923132141-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba379923132141-1"><span class="crayon-e">kubectl </span><span class="crayon-e">logs </span><span class="crayon-v">counter</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c"># counter是Pod名</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba379923132141-2"><span class="crayon-c"># 要查看先前的容器实例（已经崩溃）的日志，可以附加 --previous 参数</span></div><div class="crayon-line" id="crayon-634f9a69ba379923132141-3"><span class="crayon-c"># 如果Pod中有多个容器，使用 -c CONTAINER 参数可以查看指定容器的日志</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>节点本地的Kubelet负责响应kubectl logs的请求。</p>
<div class="blog_h3"><span class="graybg">节点级日志</span></div>
<p>所有容器化应用程序输出到stderr/stdout的信息都被容器引擎重定向到某个地方 。Docker将其重定向到一个日志驱动处，K8S配置了个日志驱动，将容器日志输出为JSON文件格式。</p>
<p>默认情况下，容器重启后，Kubelet保留被终结的容器及其日志。如果Pod被从节点清除，所有容器及其日志都被清除。</p>
<p>对于节点级日志，需要实现日志轮换，防止节点存储空间被耗尽。K8S本身目前不负责日志轮换，但是kube-up.sh脚本提供了logrotate工具，负责每小时处理日志轮换。你也可以自己启动容器来处理日志轮换（例如基于Docker的log-opt）。</p>
<div class="blog_h3"><span class="graybg">K8S系统组件日志 </span></div>
<p>K8S系统组件可以分为两类：</p>
<ol>
<li>运行在容器中的组件，例如K8S Scheduler、kube-proxy。这类组件的日志总是写入到/var/log目录</li>
<li>直接运行在节点上的组件，例如Docker、Kubelet。在启用systemd的机器上，这些组件的日志写入到journald，没有启用systemd则写入到/var/log目录</li>
</ol>
<p>查看日志的命令示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba37e374680753" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba37e374680753-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba37e374680753-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba37e374680753-1"><span class="crayon-c"># Ubuntu 16.04</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba37e374680753-2"><span class="crayon-v">journalctl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">u</span><span class="crayon-h"> </span><span class="crayon-v">kubelet</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>日志冗长级别说明：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba382543020836" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba382543020836-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba382543020836-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba382543020836-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba382543020836-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba382543020836-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba382543020836-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba382543020836-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba382543020836-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba382543020836-1">--v=0&nbsp;&nbsp;&nbsp;&nbsp;Generally useful for this to ALWAYS be visible to an operator.</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba382543020836-2">--v=1&nbsp;&nbsp;&nbsp;&nbsp;A reasonable default log level if you don’t want verbosity.</div><div class="crayon-line" id="crayon-634f9a69ba382543020836-3">--v=2&nbsp;&nbsp;&nbsp;&nbsp;Useful steady state information about the service and important log messages that may correlate to significant changes in the system. This is the recommended default log level for most systems.</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba382543020836-4">--v=3&nbsp;&nbsp;&nbsp;&nbsp;Extended information about changes.</div><div class="crayon-line" id="crayon-634f9a69ba382543020836-5">--v=4&nbsp;&nbsp;&nbsp;&nbsp;Debug level verbosity.</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba382543020836-6">--v=6&nbsp;&nbsp;&nbsp;&nbsp;Display requested resources.</div><div class="crayon-line" id="crayon-634f9a69ba382543020836-7">--v=7&nbsp;&nbsp;&nbsp;&nbsp;Display HTTP request headers.</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba382543020836-8">--v=8&nbsp;&nbsp;&nbsp;&nbsp;Display HTTP request contents.</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<div class="blog_h3"><span class="graybg">集群级别日志 </span></div>
<p>要实现集群级别的日志，你可以参考一些通用的实现途径：</p>
<ol>
<li>在每个节点上，使用节点级别的日志代理</li>
<li>在Pod中包含一个专用的、负责日志的容器</li>
<li>从应用程序中直接推送日志到一个后端实现 </li>
</ol>
<div class="blog_h2"><span class="graybg">垃圾回收</span></div>
<p>Kubelet的垃圾回收功能可以适时的清理无用的镜像、容器。默认镜像清理5min一次，容器清理1min一次。</p>
<div class="blog_h3"><span class="graybg">镜像回收</span></div>
<p>镜像管理器（在cadvisor的协作下）负责管理image的生命周期。两个相关的因素为HighThresholdPercent、LowThresholdPercent。如果磁盘用量大于HighThresholdPercent则会触发镜像的回收，会按照LRU算法清理镜像，知道磁盘用量小于LowThresholdPercent。</p>
<p>要定制上述两个参数，修改Kubelet的启动选项：image-gc-high-threshold（默认90%）、image-gc-low-threshold（默认80%）</p>
<div class="blog_h3"><span class="graybg">容器回收</span></div>
<p>和容器回收的三个用户定义参数为：</p>
<ol>
<li>MinAge，容器的最小生命，超过此生命时间才能被回收。对应Kubelet启动选项minimum-container-ttl-duration</li>
<li>MaxPerPodContainer，单个容器拥有的死亡容器个数。对应Kubelet启动选项maximum-dead-containers-per-container</li>
<li>MaxContainers，总计最大死亡容器个数。对应Kubelet启动选项maximum-dead-containers</li>
</ol>
<p>设置MinAge为0，MaxPerPodContainer、MaxContainers为负数则禁用回收。</p>
<div class="blog_h2"><span class="graybg">集群联邦</span></div>
<p>某些应用场景下，你可能考虑使用多个K8S集群：</p>
<ol>
<li>降低延迟：在不同区域（Regions）部署集群，让用户访问离的近的入口点</li>
<li>故障隔离：使用多个较小的集群，可能比一个大的集群更加容易隔离故障。你可以考虑在一个云服务商的多个Zone分别创建集群</li>
<li>扩容：单个K8S集群不能无限扩容，尽管对于大部分用户来说，单个K8S集群足够使用</li>
<li>混合云：你需要在多个云服务商、内部部署数据中心上创建多个集群</li>
</ol>
<p>联邦（Federation）用于管理多个K8S集群，它的主要功能是：</p>
<ol>
<li>跨集群同步资源，保证资源（例如Deployment）在多个集群之间保持同步</li>
<li>跨集群发现，支持基于来自多个集群的后端，来配置DNS和负载均衡器</li>
<li>HA：防止整个集群的崩溃、断网导致的不可用</li>
<li>避免绑定到云服务商，因为可以方便的跨集群迁移应用程序</li>
</ol>
<p>使用联邦时，单个集群的Scope应该保持在单个Zone/Availability Zone内部，原因是：</p>
<ol>
<li>比起全局单一大集群，这样部署可以减少单点故障</li>
<li>可用性属性更加容易估算</li>
<li>开发者设计系统时，可以对网络延迟、带宽等进行有根据的假设</li>
</ol>
<p>在单个Zone/Availability Zone部署多个集群也是可以的，但是K8S建议越少越好，原因是：</p>
<ol>
<li>可以减少运维成本（但是随着运维工具、过程的成熟此优势会变小）</li>
<li>减少每集群的固定资源开销，例如APIServer VMs（但是对于大型集群来说，这点开销也不算什么）</li>
</ol>
<div class="blog_h2"><span class="graybg">内核调优</span></div>
<p>Linux中的sysctl接口允许管理员在运行时修改内核参数。这些参数存在于虚拟文件系统/proc/sys/中。这些参数牵涉到多个子系统，例如：</p>
<ol>
<li>内核（前缀kernel.）</li>
<li>网络（前缀net.）</li>
<li>虚拟内存（前缀vm.）</li>
<li>MDADM（前缀dev.）</li>
</ol>
<p>执行命令
			<span id="crayon-634f9a69ba387305049278" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sudo </span><span class="crayon-v">sysctl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">a</span></span></span>可以获得所有系统参数的取值。</p>
<div class="blog_h3"><span class="graybg">名字空间支持</span></div>
<p>很多sysctl支持名字空间，包括kernel.shm*、kernel.msg*、kernel.sem、fs.mqueue.*、net.*。也就是说，节点上的每个Node可以分别、独立的设置这些内核参数。</p>
<p>不支持名字空间的sysctl，叫做节点级sysctl，必须由管理员手工设定。</p>
<p>对于定制了sysctl的节点，最好标记为tainted，并且仅仅将需要这些特定的sysctl设置的Pod调度到其上。</p>
<div class="blog_h3"><span class="graybg">安全sysctl </span></div>
<p>Sysctls被划分为两组：安全、不安全。安全Sysctl必须能适当的在同节点上的Pod之间隔离：</p>
<ol>
<li>不能对其它Pod产生任何影响</li>
<li>不能危害节点的健康</li>
<li> 不能超过配额获取CPU、内存资源</li>
</ol>
<p>对于K8S 1.4来说，以下Sysctl属于安全的：kernel.shm_rmid_forced、net.ipv4.ip_local_port_range、net.ipv4.tcp_syncookies</p>
<p>非安全的Sysctl默认是被禁用的，集群管理员必须手工在目标节点上启用：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba38c750265444" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba38c750265444-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba38c750265444-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba38c750265444-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba38c750265444-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba38c750265444-1"><span class="crayon-c"># 对于Kubelet</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba38c750265444-2"><span class="crayon-v">kubelet</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">experimental</span><span class="crayon-o">-</span><span class="crayon-v">allowed</span><span class="crayon-o">-</span><span class="crayon-v">unsafe</span><span class="crayon-o">-</span><span class="crayon-i">sysctls</span><span class="crayon-h"> </span><span class="crayon-s">'kernel.msg*,net.ipv4.route.min_pmtu'</span></div><div class="crayon-line" id="crayon-634f9a69ba38c750265444-3"><span class="crayon-c"># 对于 Minikube</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba38c750265444-4"><span class="crayon-e">minikube </span><span class="crayon-v">start</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">extra</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-o">=</span><span class="crayon-s">"kubelet.AllowedUnsafeSysctls=kernel.msg*,net.ipv4.route.min_pmtu"</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h3"><span class="graybg">为Pod设置</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba390544041124" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba390544041124-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba390544041124-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba390544041124-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba390544041124-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba390544041124-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba390544041124-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba390544041124-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba390544041124-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69ba390544041124-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba390544041124-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: sysctl-example</span></div><div class="crayon-line" id="crayon-634f9a69ba390544041124-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 使用注解实现针对Pod的sysctl调优</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba390544041124-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">annotations</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba390544041124-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>security<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">sysctls</span><span class="">: kernel.shm_rmid_forced=1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba390544041124-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Pod无法被调度到没有启用以下两个Unsafe sysctl的节点上，除非使用Taints</span></div><div class="crayon-line" id="crayon-634f9a69ba390544041124-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span>security<span class="crayon-o">.</span>alpha<span class="crayon-o">.</span>kubernetes<span class="crayon-o">.</span>io/<span class="crayon-s ">unsafe-sysctls</span><span class="">: net.ipv4.route.min_pmtu=1000</span><span class="crayon-o">,</span>kernel<span class="crayon-o">.</span>msgmax=1<span class="crayon-h"> </span>2<span class="crayon-h"> </span>3</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba390544041124-10"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba390544041124-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">.</span><span class="crayon-o">.</span><span class="crayon-o">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<div class="blog_h2"><span class="graybg">K8S中的代理</span></div>
<p>使用Kubernetes时，你会注意到多个不同的代理。</p>
<div class="blog_h3"><span class="graybg">kubectl proxy</span></div>
<ol>
<li>在用户的桌面或者Pod中运行</li>
<li>将localhost地址代理为K8S APIServer地址</li>
<li>客户端到代理使用HTTP连接，代理到APIServer使用HTTPS连接</li>
<li>负责定位APIServer</li>
<li>添加身份验证请求头</li>
</ol>
<div class="blog_h3"><span class="graybg">APIServer proxy</span></div>
<ol>
<li>构建在APIServer内部</li>
<li>将集群外部的用户连接到集群IP，没有这种机制集群外部是无法直接访问集群IP的</li>
<li>在APIServer进程内部运行</li>
<li>客户端到此代理使用HTTPS协议，你也可以修改APIServer，使用HTTP协议</li>
<li>用于连接到任何节点、Pod、服务</li>
<li>当用于连接到服务时，负责负载均衡</li>
</ol>
<div class="blog_h3"><span class="graybg">kube proxy</span></div>
<ol>
<li>在每个节点上运行</li>
<li>代理UDP、TCP流量</li>
<li>不理解HTTP</li>
<li>提供负载均衡功能</li>
<li>仅仅用于连接到服务</li>
</ol>
<div class="blog_h3"><span class="graybg">前置代理/LB</span></div>
<p>位于APIServer前面的代理或负载均衡器：</p>
<ol>
<li>存在有否，实现方式依具体集群而不同</li>
<li>位于所有客户端和APIServers之间</li>
<li>如果集群存在多个APIServers，作为负载均衡器使用</li>
</ol>
<div class="blog_h3"><span class="graybg">云LB</span></div>
<ol>
<li>由云服务提供商提供</li>
<li>定义LoadBalancer类型的服务时，自动创建</li>
<li>仅仅使用UDP/TCP</li>
<li>具体实现依赖于云服务商</li>
</ol>
<div class="blog_h2"><span class="graybg">配置最佳实践</span></div>
<div class="blog_h3"><span class="graybg">配置的一般性建议</span></div>
<ol>
<li>定义配置时，指定最新版本的API，当前是v1</li>
<li>配置文件应当采用版本控制</li>
<li>使用YAML而不是JSON来编写配置文件</li>
<li>紧密耦合的一组对象，放在单个YAML中。应用程序的所有对象，可以放在单个目录中</li>
<li>不要指定默认值，让文件尽可能简短</li>
<li>将对象描述放到注解中</li>
</ol>
<div class="blog_h3"><span class="graybg">服务的配置</span></div>
<ol>
<li>应当先创建Service，然后创建复制控制器（或者Deployment等）</li>
<li>尽可能避免映射到宿主机端口</li>
<li>尽可能避免使用hostNetwork</li>
<li>如果不需要kube-proxy负载均衡，可以使用Headless Service进行简单的服务发现</li>
</ol>
<div class="blog_h3"><span class="graybg">合理使用标签</span></div>
<ol>
<li>使用标签来识别应用、部署的语义属性，例如这些标签：{ app: myapp, tier: frontend, phase: test, deployment: v3 }。而不要简单粗暴的定义{service: myservice}</li>
</ol>
<div class="blog_h2"><span class="graybg">命名空间资源配额</span></div>
<p>当多个团队共享一个固定节点数的集群时，需要进行资源的配额管理。</p>
<p>ResourceQuota对象用于定义资源的配额，<span style="background-color: #c0c0c0;">为某个名字空间限定总计的最大资源消耗</span>。包括：</p>
<ol>
<li>每个K8S名字空间最多能创建多少个指定类型的对象</li>
<li>上述对象总计消耗的计算资源的总量</li>
</ol>
<p>资源配额的工作机制为：</p>
<ol>
<li>不同的团队使用不同的名字空间，因而可以依照名字空间来管理配额。目前名字空间是自愿加入的，未来K8S会对其施加ACL</li>
<li>管理员为每个名字空间创建一个或多个资源配额对象</li>
<li>用户会在名字空间中创建对象（Service、Pod等），配额系统会跟踪名字空间的资源用量，确保不超过限制</li>
<li>当创建、更新资源，导致违反配额约束时，请求会失败，并且获得HTTP响应码403</li>
<li>如果配额中限定了CPU、内存等计算资源的用量，那么你必须在请求中指定需要的用量，否则配额系统会拒绝Pod的创建</li>
</ol>
<div class="blog_h3"><span class="graybg">启用配额</span></div>
<p>对于很多K8S发行版来说，资源配额支持是默认启用的。你可以设置--admission-control，添加ResourceQuota。</p>
<p>当名字空间中有ResourceQuota对象时，则该名字空间就启用了配额管理，每个名字空间最多有一个ResourceQuota对象。</p>
<div class="blog_h2"><span class="graybg">Pod资源配额</span></div>
<p>在创建Pod时，你可以指定某个容器需要使用的CPU、内存资源数量。调度器会根据Pod的需求，将其调度到适当的节点上。</p>
<div class="blog_h3"><span class="graybg">资源类型</span></div>
<p>CPU、内存是主要的计算资源（compute resources，有时简称resources），计算资源和K8S API资源不是一个概念。计算资源可以被请求、分配、消耗。</p>
<div class="blog_h3"><span class="graybg">资源请求和限制</span></div>
<p>每个容器的规格中，都可以包含以下数据项：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="text-align: center;">规格配置项</td>
</tr>
</thead>
<tbody>
<tr>
<td>
<p>spec.containers[].resources.limits.cpu  容器最多可以使用的CPU资源</p>
<p>以CPU核心数为单位，可以指定小数，也可以使用m作为单位 1000m = 1</p>
</td>
</tr>
<tr>
<td>
<p>spec.containers[].resources.limits.memory  容器最多可以使用的内存资源</p>
<p>内存用量单位可以是E, P, T, G, M, k或者Ei, Pi, Ti, Gi, Mi, Ki，后者以2的次方计算</p>
</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu 容器至少可以获得的CPU资源</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory 容器至少可以获得的内存资源</td>
</tr>
</tbody>
</table>
<p>Pod占有的资源，即每个容器占用的资源的总和。</p>
<div class="blog_h3"><span class="graybg">监控资源使用</span></div>
<p>Pod的资源使用状况，被报告为Pod Status的一部分。</p>
<div class="blog_h2"><span class="graybg">资源预留</span></div>
<p>Describe节点的时候，可以看到其Capacity、Allocatable两个字段，它们表示节点总计的、可被K8S分配给Pod的资源量：</p>
<p style="padding-left: 30px;"><strong>Allocatable</strong> = <strong>Node Capacity</strong> - <strong>kube-reserved</strong> - <strong>system-reserved</strong>   - <strong>eviction-threshold</strong></p>
<p>资源当前主要支持CPU、临时存储、内存者三类。至于磁盘IOPS、网络流量之类目前是无法配额的。</p>
<p>默认情况下，Pod可以使用Capacity指定的全部资源。这可能导致问题，因为K8S、操作系统本身需要运行一些守护程序，不做限制会导致Pod和守护程序竞争资源，导致系统卡死。</p>
<p>要使用资源预留，必须启用kubelet选项--cgroups-per-qos（默认启用）。该选项会将所有用户的Pod放在共同的、被kubelet管理的cgroups下面。</p>
<p>kubelet依赖于Cgroup驱动来管理cgroups，默认--cgroup-driver=cgroupfs，可以选取systemd。</p>
<div class="blog_h3"><span class="graybg">Kube Reserved</span></div>
<p>为kubelet、容器运行时服务、节点问题检测器等守护程序预留资源。作为DaemonSet运行的守护程序，不在内。取值多少，<a href="https://kubernetes.io/blog/2016/11/visualize-kubelet-performance-with-node-dashboard">通常是节点Pod密度的函数</a>。</p>
<p>要启用其资源预留，指定kubelet参数--kube-reserved-cgroup，其值为现有的、作为父控制组的cgroups名称。建议指定顶级cgroups，例如基于systemd的系统上可以指定runtime.slice。</p>
<p>要指定预留资源量，指定kubelet参数：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba398473424597" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba398473424597-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba398473424597-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba398473424597-1"><span class="crayon-o">--</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">cpu</span><span class="crayon-o">=</span><span class="crayon-cn">100m</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">memory</span><span class="crayon-o">=</span><span class="crayon-cn">100Mi</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-v">storage</span><span class="crayon-o">=</span><span class="crayon-cn">1Gi</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba398473424597-2"><span class="crayon-o">--</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-o">-</span><span class="crayon-v">cgroup</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-e">.service</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<p>Cgroup目录一定要预先创建，否则kubelet启动失败。CentOS下示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba39d123547976" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba39d123547976-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba39d123547976-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba39d123547976-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba39d123547976-1"><span class="crayon-v">ExecStartPre</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">sys</span><span class="crayon-o">/</span><span class="crayon-v">fs</span><span class="crayon-o">/</span><span class="crayon-v">cgroup</span><span class="crayon-o">/</span><span class="crayon-v">cpuset</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-e">.slice</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba39d123547976-2"><span class="crayon-v">ExecStartPre</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">sys</span><span class="crayon-o">/</span><span class="crayon-v">fs</span><span class="crayon-o">/</span><span class="crayon-v">cgroup</span><span class="crayon-o">/</span><span class="crayon-v">memory</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-e">.slice</span></div><div class="crayon-line" id="crayon-634f9a69ba39d123547976-3"><span class="crayon-v">ExecStartPre</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">sys</span><span class="crayon-o">/</span><span class="crayon-v">fs</span><span class="crayon-o">/</span><span class="crayon-v">cgroup</span><span class="crayon-o">/</span><span class="crayon-v">hugetlb</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-e">.slice</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0027 seconds] -->

<div class="blog_h3"><span class="graybg">System Reserved</span></div>
<p>为OS 守护程序、系统内核预留资源：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3a1349813640" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3a1349813640-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3a1349813640-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3a1349813640-1"><span class="crayon-o">--</span><span class="crayon-v">system</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">cpu</span><span class="crayon-o">=</span><span class="crayon-cn">100mi</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">memory</span><span class="crayon-o">=</span><span class="crayon-cn">100Mi</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-v">storage</span><span class="crayon-o">=</span><span class="crayon-cn">1Gi</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3a1349813640-2"><span class="crayon-o">--</span><span class="crayon-v">system</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-o">-</span><span class="crayon-v">cgroup</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">system</span><span class="crayon-e">.slice</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<p>警告，上述限制可能导致关键OS服务遭遇OOM。</p>
<div class="blog_h3"><span class="graybg">Enforce Node Allocatable</span></div>
<p>默认值为pods，表示为Pods进行Cgroups控制。要为kube组件和系统预留资源，需要设置为pods,kube-reserved,system-reserve。</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3a5669169250" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3a5669169250-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3a5669169250-1"><span class="crayon-o">--</span><span class="crayon-v">enforce</span><span class="crayon-o">-</span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">allocatable</span><span class="crayon-o">=</span><span class="crayon-v">pods</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">system</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-sy">,</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">reserved</span><span class="crayon-sy">]</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h2"><span class="graybg"><a id="out-of-resource"></a>资源不足</span></div>
<p>当资源不足时，Kubelet会采取一些措施，例如驱除Pod，以保证系统稳定运行。</p>
<div class="blog_h3"><span class="graybg">驱除信号</span></div>
<p>Kubelet可以在资源耗尽前，主动的停止一或多个Pod。触发驱除的信号来自节点状态，包括：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">信号</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>memory.available</td>
<td>等于node.status.capacity[memory] - node.stats.memory.workingSet</td>
</tr>
<tr>
<td>nodefs.available</td>
<td>
<p>等于node.stats.fs.available</p>
<p>nodefs是Kubelet用作卷、守护进程日志的文件系统</p>
</td>
</tr>
<tr>
<td>nodefs.inodesFree</td>
<td>等于node.stats.fs.inodesFree</td>
</tr>
<tr>
<td>imagefs.available</td>
<td>
<p>等于node.stats.runtime.imagefs.available</p>
<p>容器运行时用作存储镜像、可写层的文件系统</p>
</td>
</tr>
<tr>
<td>imagefs.inodesFree</td>
<td>等于node.stats.runtime.imagefs.inodesFree</td>
</tr>
</tbody>
</table>
<p>上述信号，均可以指定绝对值或者百分比。</p>
<div class="blog_h3"><span class="graybg">驱除阈值</span></div>
<p>驱除行为分为两类，分别为<span style="background-color: #c0c0c0;">软驱除、硬驱除</span>。后者没有grace period。</p>
<p>驱除阈值是kubelet命令行参数，指定Pod驱除发生的规则。包括：
			<span id="crayon-634f9a69ba3aa831050888" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">eviction</span><span class="crayon-o">-</span><span class="crayon-v">soft</span></span></span>、
			<span id="crayon-634f9a69ba3ae273968898" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">eviction</span><span class="crayon-o">-</span><span class="crayon-v">hard</span></span></span>。阈值的语法为：
			<span id="crayon-634f9a69ba3b2335800513" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">[</span><span class="crayon-v">eviction</span><span class="crayon-o">-</span><span class="crayon-v">signal</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">operator</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">quantity</span><span class="crayon-sy">]</span></span></span>，例如memory.available&lt;10%、memory.available&lt;1Gi。一个实际的例子：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3b6548797129" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3b6548797129-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3b6548797129-1"><span class="crayon-o">--</span><span class="crayon-v">eviction</span><span class="crayon-o">-</span><span class="crayon-v">hard</span><span class="crayon-o">=</span><span class="crayon-v">memory</span><span class="crayon-e">.available</span><span class="crayon-o">&lt;</span><span class="crayon-cn">500Mi</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.available</span><span class="crayon-o">&lt;</span><span class="crayon-cn">10</span><span class="crayon-o">%</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>和软驱除相关的额外的命令行参数包括：</p>
<ol>
<li>eviction-soft-grace-period，优雅期长度，取值例如1m30s，阈值到达后，此优雅期到达前，不会触发清除</li>
<li>eviction-max-pod-grace-period，执行delete pod操作的优雅期，单位秒</li>
</ol>
<p>Kubelet默认的硬清除阈值是：内存小于100Mi、nodefs可用小于10%、imagefs可用小于15%、nodefs可用inode小于5%</p>
<p>计算取值阈值是否到达的时间间隔，由housekeeping-interval控制。</p>
<div class="blog_h3"><span class="graybg">NodeCondition</span></div>
<p>Kubelet将驱除信号映射为节点状态。当超过硬、软清除阈值时，会更新节点的Condition：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 150px; text-align: center;">Condition</td>
<td style="text-align: center;">Eviction Signal</td>
</tr>
</thead>
<tbody>
<tr>
<td>MemoryPressure</td>
<td>memory.available</td>
</tr>
<tr>
<td>DiskPressure</td>
<td>nodefs.available, nodefs.inodesFree, imagefs.available,  imagefs.inodesFree</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">处理振荡</span></div>
<p>节点可能反复高于、低于软驱除阈值，且其切换周期低于软驱除优雅期。这导致NodeCondition反复在true/false之间变动，也导致Kubelet不能做出应当的驱除动作。</p>
<p>参数eviction-pressure-transition-period指定MemoryPressure、DiskPressure从true变为false至少需要等待的时间，避免振荡问题。</p>
<div class="blog_h3"><span class="graybg">驱除行为</span></div>
<p>到达驱除阈值、并过了优雅期后，Kubelet会执行回收操作，直到低于阈值：</p>
<ol>
<li>回收节点级资源，优先于回收Pod资源：
<ol>
<li>nodefs信号处理：删除死掉的Pod及其容器</li>
<li>imagefs信号处理：删除所有没有使用的镜像</li>
</ol>
</li>
<li>驱除Pod：
<ol>
<li>驱除优先级排名规则：
<ol>
<li>第一级排序：那些使用资源大于requests量的Pod排前面</li>
<li>第二级排序：那些低优先级的Pod排前面</li>
<li>第三集排序：根据Pod的调度请求声明排序</li>
</ol>
</li>
<li>驱除行为：
<ol>
<li>BestEffort或Burstable的Pod，超量使用资源的，根据优先级，依次驱除</li>
<li>Guaranteed且Burstable，没有使用超量资源的，最后驱除</li>
<li>Guaranteed的且每个容器的requests=limits!=0的Pod，不会因为其它Pod的资源消耗而被驱除</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>DaemonSet创建的Pod永远不应该被驱除，因为控制器会立即重新创建。但是Kubelet目前没办法识别Pod是否由DS创建，为避免被误驱除，DaemonSet永远不应该创建BestEffort的Pod。</p>
<div class="blog_h3"><span class="graybg">最低资源回收量</span></div>
<p>某些情况下，Kubelet虽然驱除了多个Pod，但是回收的资源量并不多。为了避免这种无效的大量驱除，可以设置参数：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3bb907865244" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3bb907865244-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3bb907865244-1"><span class="crayon-o">--</span><span class="crayon-v">eviction</span><span class="crayon-o">-</span><span class="crayon-v">minimum</span><span class="crayon-o">-</span><span class="crayon-v">reclaim</span><span class="crayon-o">=</span><span class="crayon-s">"memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>这样，仅当Pod驱除后能回收500+内存，它才会被清除。 </p>
<div class="blog_h3"><span class="graybg">节点OOM行为</span></div>
<p>如果节点在kubelet回收内存之前经历了OOM事件，它将基于oom-killer进行响应。</p>
<div class="blog_h2"><span class="graybg">kubeconfig</span> </div>
<p>你可以使用kubeconfig文件来组织集群、用户、名字空间、身份验证机制，等信息。 </p>
<p>kubectl也使用kubeconfig来获得需要连接到的集群的信息。默认的，kubectl会寻找~/.kube/config文件。你可以使用环境变量KUBECONFIG或者--kubeconfig选项覆盖此默认行为。</p>
<p>执行命令
			<span id="crayon-634f9a69ba3bf866863361" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-v">view</span></span></span>可以查看当前配置信息。</p>
<div class="blog_h3"><span class="graybg">Context</span></div>
<p>context元素用于在一个别名下组织集群、名字空间、用户这三类访问参数。默认的kubectl使用“当前Context”，要切换当前Context，可以执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3c3038523979" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3c3038523979-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3c3038523979-1"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-st">use</span><span class="crayon-o">-</span><span class="crayon-i">context</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<div class="blog_h2"><span class="graybg">kubectl</span></div>
<p>命令行接口默认使用kubeconfig位于~/.kube/config。</p>
<p>添加Bash自动完成支持：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3c7066843542" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3c7066843542-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3c7066843542-1"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"source &lt;(kubectl completion bash)"</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.bashrc</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>子命令如下表：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 15%; text-align: center;">子命令</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td colspan="2"><em>基本命令</em></td>
</tr>
<tr>
<td class="blog_h3">create</td>
<td>
<p>根据文件或者标准输入来创建一个资源，配置信息可以是YML或JSON格式</p>
<p><span style="background-color: #c0c0c0;">格式：</span>
			<span id="crayon-634f9a69ba3cb229240076" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-i">FILENAME</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">选项：</span></p>
<p>--dry-run=false 如果true则仅仅显示命令的后果，不实际执行<br />--edit=false  在创建前编辑</p>
</td>
</tr>
<tr>
<td class="blog_h3">expose</td>
<td>
<p>将复制控制器、服务、部署、Pod暴露为K8S服务</p>
<p><span style="background-color: #c0c0c0;">格式：</span>
			<span id="crayon-634f9a69ba3d0077865918" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">expose</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">FILENAME</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">TYPE </span><span class="crayon-v">NAME</span><span class="crayon-sy">)</span> <span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">选项：</span></p>
<p>--cluster-ip='' 分配给服务的集群IP，为空则自动分配<br />--external-ip='' 服务的外部IP，不受K8S管理。此外部IP如果路由到某个集群节点，则可用来访问服务<br />-l, --labels='' 服务的标签<br />--load-balancer-ip='' 分配给负载均衡器的 IP<br />--name='' 服务的名称<br />--port=''  服务的监听端口<br />--protocol='' 服务使用的网络协议，默认TCP<br />--selector='' 此服务使用的标签选择器<br />--target-port=''  被暴露的容器的端口，服务端口转发到此端口<br />--type='ClusterIP' 服务类型，可选值ClusterIP, NodePort, LoadBalancer, ExternalName</p>
</td>
</tr>
<tr>
<td class="blog_h3">run</td>
<td>
<p>在集群上运行特定的镜像，实际上是创建Deployment或Job</p>
<p><span style="background-color: #c0c0c0;">格式：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3d4924987432" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3d4924987432-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d4924987432-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3d4924987432-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3d4924987432-1"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">NAME</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-i">image</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d4924987432-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-r">env</span><span class="crayon-o">=</span><span class="crayon-s">"key=value"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">port</span><span class="crayon-o">=</span><span class="crayon-v">port</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-v">replicas</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">dry</span><span class="crayon-o">-</span><span class="crayon-v">run</span><span class="crayon-o">=</span><span class="crayon-t">bool</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba3d4924987432-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">overrides</span><span class="crayon-o">=</span><span class="crayon-v">inline</span><span class="crayon-o">-</span><span class="crayon-v">json</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-r">command</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-r">COMMAND</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">args</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0027 seconds] -->

<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3d9068279426" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3d9068279426-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba3d9068279426-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-1"><span class="crayon-c"># 运行单个实例的Nginx</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-2"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-4"><span class="crayon-c"># 运行单个实例的hazelcast并暴露容器端口5701</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-5"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">hazelcast</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">hazelcast</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">port</span><span class="crayon-o">=</span><span class="crayon-cn">5701</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-6"><span class="crayon-c"># 运行单个实例的hazelcast并设置容器的环境变量</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-7"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">hazelcast</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">hazelcast</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-r">env</span><span class="crayon-o">=</span><span class="crayon-s">"DNS_DOMAIN=cluster"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-8"><span class="crayon-c"># 运行单个实例的hazelcast并设置标签</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-9"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">hazelcast</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">labels</span><span class="crayon-o">=</span><span class="crayon-s">"app=hazelcast,env=prod"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-11"><span class="crayon-c"># 5实例的复制</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-12"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">5</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3d9068279426-14"><span class="crayon-c"># 运行一个Job</span></div><div class="crayon-line" id="crayon-634f9a69ba3d9068279426-15"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">pi</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">schedule</span><span class="crayon-o">=</span><span class="crayon-s">"0/5 * * * ?"</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">perl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">restart</span><span class="crayon-o">=</span><span class="crayon-v">OnFailure</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-v">perl</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->

</td>
</tr>
<tr>
<td>debug</td>
<td>
<p>使用交互式的调试容器来调试集群资源
<p>该命令的行为可以是：</p>
<ol>
<li>拷贝一个Pod，修改它的某些属性，然后运行<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3dd764095750" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3dd764095750-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3dd764095750-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3dd764095750-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3dd764095750-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3dd764095750-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3dd764095750-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba3dd764095750-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3dd764095750-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba3dd764095750-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3dd764095750-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3dd764095750-1"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">myapp</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">busybox</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">restart</span><span class="crayon-o">=</span><span class="crayon-v">Never</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-r">sleep</span><span class="crayon-h"> </span><span class="crayon-cn">1d</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3dd764095750-2"><span class="crayon-c"># 调试Pod myapp，将其拷贝为myapp-debug，添加一个ubuntu容器</span></div><div class="crayon-line" id="crayon-634f9a69ba3dd764095750-3"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;允许ubuntu容器看到Pod中其它容器的进程</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3dd764095750-4"><span class="crayon-e">kubectl </span><span class="crayon-e">debug </span><span class="crayon-v">myapp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">ubuntu</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">share</span><span class="crayon-o">-</span><span class="crayon-v">processes</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">copy</span><span class="crayon-o">-</span><span class="crayon-st">to</span><span class="crayon-o">=</span><span class="crayon-v">myapp</span><span class="crayon-o">-</span><span class="crayon-v">debug</span></div><div class="crayon-line" id="crayon-634f9a69ba3dd764095750-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3dd764095750-6"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 修改容器myapp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;的命令</span></div><div class="crayon-line" id="crayon-634f9a69ba3dd764095750-7"><span class="crayon-e">kubectl </span><span class="crayon-e">debug </span><span class="crayon-v">myapp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">copy</span><span class="crayon-o">-</span><span class="crayon-st">to</span><span class="crayon-o">=</span><span class="crayon-v">myapp</span><span class="crayon-o">-</span><span class="crayon-v">debug</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">container</span><span class="crayon-o">=</span><span class="crayon-v">myapp</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-r">sh</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3dd764095750-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3dd764095750-9"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 修改所有容器的镜像为ubuntu</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3dd764095750-10"><span class="crayon-e">kubectl </span><span class="crayon-e">debug </span><span class="crayon-v">myapp</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">copy</span><span class="crayon-o">-</span><span class="crayon-st">to</span><span class="crayon-o">=</span><span class="crayon-v">myapp</span><span class="crayon-o">-</span><span class="crayon-v">debug</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-o">*=</span><span class="crayon-v">ubuntu</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

</li>
<li>添加一个临时的容器到运行中的Pod，而不重新启动容器<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3e1390709696" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3e1390709696-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3e1390709696-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3e1390709696-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3e1390709696-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3e1390709696-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3e1390709696-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba3e1390709696-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3e1390709696-1"><span class="crayon-e">kubectl </span><span class="crayon-e">run </span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-v">demo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">k8s</span><span class="crayon-e">.gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">pause</span><span class="crayon-o">:</span><span class="crayon-cn">3.1</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">restart</span><span class="crayon-o">=</span><span class="crayon-v">Never</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3e1390709696-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3e1390709696-3"><span class="crayon-c"># 报错，此容器没有sh</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3e1390709696-4"><span class="crayon-e">kubectl </span><span class="crayon-v">exec</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">it </span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-v">demo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-r">sh</span></div><div class="crayon-line" id="crayon-634f9a69ba3e1390709696-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3e1390709696-6"><span class="crayon-c"># 我们可以为Pod添加一个临时容器，在此容器里执行shell</span></div><div class="crayon-line" id="crayon-634f9a69ba3e1390709696-7"><span class="crayon-e">kubectl </span><span class="crayon-v">debug</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">it </span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-v">demo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">busybox</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">target</span><span class="crayon-o">=</span><span class="crayon-v">ephemeral</span><span class="crayon-o">-</span><span class="crayon-i">demo</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0023 seconds] -->

</li>
<li>在节点上创建一个容器，运行在宿主机的命名空间，可以访问宿主机资源<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3e5635169994" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3e5635169994-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3e5635169994-1"><span class="crayon-e">kubectl </span><span class="crayon-e">debug </span><span class="crayon-v">node</span><span class="crayon-o">/</span><span class="crayon-v">mynode</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">ubuntu</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

</li>
</ol>
</td>
</tr>
<tr>
<td class="blog_h3">set</td>
<td>在对象上设置特性</td>
</tr>
<tr>
<td class="blog_h3">get</td>
<td>
<p>列表形式显示一个或多个资源</p>
<p><span style="background-color: #c0c0c0;">格式：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3e9453038263" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3e9453038263-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3e9453038263-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3e9453038263-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3e9453038263-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3e9453038263-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3e9453038263-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3e9453038263-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">json</span><span class="crayon-o">|</span><span class="crayon-v">yaml</span><span class="crayon-o">|</span><span class="crayon-v">wide</span><span class="crayon-o">|</span><span class="crayon-v">custom</span><span class="crayon-o">-</span><span class="crayon-v">columns</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">|</span><span class="crayon-v">custom</span><span class="crayon-o">-</span><span class="crayon-v">columns</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-o">|</span></div><div class="crayon-line" id="crayon-634f9a69ba3e9453038263-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">go</span><span class="crayon-o">-</span><span class="crayon-v">template</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">|</span><span class="crayon-v">go</span><span class="crayon-o">-</span><span class="crayon-v">template</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">|</span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">|</span><span class="crayon-v">jsonpath</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3e9453038263-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba3e9453038263-5"><span class="crayon-sy">(</span><span class="crayon-r">TYPE</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">NAME</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">TYPE</span><span class="crayon-o">/</span><span class="crayon-i">NAME</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">flags</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

<p><span style="background-color: #c0c0c0;">资源类型：</span></p>
<p>支持的资源类型包括：</p>
<p style="padding-left: 30px;">all<br />certificatesigningrequests (简写 'csr')<br />clusterrolebindings<br />clusterroles<br />componentstatuses (简写 'cs')<br />configmaps (简写 'cm')<br />controllerrevisions<br />cronjobs<br />customresourcedefinition (简写 'crd')<br />daemonsets (简写 'ds')<br />deployments (简写 'deploy')<br />endpoints (简写 'ep')<br />events (简写 'ev')<br />horizontalpodautoscalers (简写 'hpa')<br />ingresses (简写 'ing')<br />jobs<br />limitranges (简写 'limits')<br />namespaces (简写 'ns')<br />networkpolicies (简写 'netpol')<br />nodes (简写 'no')<br />persistentvolumeclaims (简写 'pvc')<br />persistentvolumes (简写 'pv')<br />poddisruptionbudgets (简写 'pdb')<br />podpreset<br />pods (简写 'po')<br />podsecuritypolicies (简写 'psp')<br />podtemplates<br />replicasets (简写 'rs')<br />replicationcontrollers (简写 'rc')<br />resourcequotas (简写 'quota')<br />rolebindings<br />roles<br />secrets<br />serviceaccounts (简写 'sa')<br />services (简写 'svc')<br />statefulsets (简写 'sts')<br />storageclasses (简写 'sc')</p>
<p><span style="background-color: #c0c0c0;">选项：</span></p>
<p>--all-namespaces 获取所有名字空间的资源<br />--export=false  如果设置为true，将集群相关的信息移除，这样可以在其它地方部署它<br />--field-selector='k1=v1,k2!=v2,k3==v3' 根据字段查询<br />-f 指定资源的配置文件，作为查询依据<br />-L  资源必须具有的标签，逗号分隔<br />-l  指定标签选择器，支持操作符== !=和=<br />-o 输出格式，支持json|yaml|wide|name|custom-columns=...<br />-w 获取请求的资源后，监控其变化</p>
<p><span style="background-color: #c0c0c0;">举例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3ee276849882" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ee276849882-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba3ee276849882-33">33</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-1"><span class="crayon-c"># 列出默认名字空间的所有Pod。字段 NAME READY STATUS RESTARTS AGE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-3"><span class="crayon-c"># 列出dev中的所有Pod。字段 NAME READY STATUS RESTARTS AGE IP NODE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-4"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">wide</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">dev</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-5"><span class="crayon-c"># 列出名为web的replicationcontroller</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-6"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">replicationcontroller </span><span class="crayon-v">web</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-7"><span class="crayon-c"># 获取两种不同类型的资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-8"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">rc</span><span class="crayon-sy">,</span><span class="crayon-v">services</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-9"><span class="crayon-c"># 获取所有资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-10"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">all</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-12"><span class="crayon-c"># 仅仅获取Phase字段</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-13"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">dev</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-e">template </span><span class="crayon-v">pod</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">-</span><span class="crayon-v">api</span><span class="crayon-o">-</span><span class="crayon-cn">56b5db7c65</span><span class="crayon-o">-</span><span class="crayon-cn">8nvpf</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">template</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-sy">{</span><span class="crayon-e">.status</span><span class="crayon-e">.phase</span><span class="crayon-sy">}</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-14">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-15"><span class="crayon-c"># 仅仅获取IP地址</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-16"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-e">dev&nbsp;&nbsp;</span><span class="crayon-v">pod</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">-</span><span class="crayon-v">api</span><span class="crayon-o">-</span><span class="crayon-cn">56b5db7c65</span><span class="crayon-o">-</span><span class="crayon-cn">8nvpf</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{.status.podIP}'</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-18"><span class="crayon-c"># 遍历所有匹配的资源，获取它们的IP，后缀以8800，然后连接为单个字符串</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-19"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">dev</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{range.items[*]}{.status.podIP}:8800 '</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-20"><span class="crayon-c"># 输出 172.27.41.137:8800 172.27.97.74:8800 172.27.61.80:8800 172.27.121.73:8800 172.27.187.201:8800</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-21">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-22"><span class="crayon-c"># 多重循环获取，逐行打印</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-23"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">workloadclusters</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{range .items[*]}{ range .status.cluster.masters[*]}{.ip}{"\n"}'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-24">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-25"><span class="crayon-c"># 过滤：获取InternalIP</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-26"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-v">carbon</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{.status.addresses[?(@.type=="InternalIP")].address}'</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-27">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-28"><span class="crayon-c"># 查询处于Running阶段的Pod</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-29"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">field</span><span class="crayon-o">-</span><span class="crayon-v">selector</span><span class="crayon-o">=</span><span class="crayon-s">'status.phase=Running'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-30">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-31"><span class="crayon-c"># 查询事件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ee276849882-32"><span class="crayon-c"># 查询指定Pod相关的事件</span></div><div class="crayon-line" id="crayon-634f9a69ba3ee276849882-33"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">event</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-st">default</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">field</span><span class="crayon-o">-</span><span class="crayon-e">selector </span><span class="crayon-v">involvedObject</span><span class="crayon-e">.name</span><span class="crayon-o">=</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">name</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0067 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">explain</td>
<td>显示资源的文档</td>
</tr>
<tr>
<td class="blog_h3">edit</td>
<td>编辑一个资源</td>
</tr>
<tr>
<td class="blog_h3">delete</td>
<td>
<p>根据文件名、Stdin、名称、标签来删除资源
<p><span style="background-color: #c0c0c0;">格式：</span>
			<span id="crayon-634f9a69ba3f3423194520" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">delete</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">FILENAME</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-i">TYPE</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">(</span><span class="crayon-v">NAME</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">label</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">all</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3f7408633057" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba3f7408633057-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3f7408633057-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-1"><span class="crayon-c"># 根据JSON中的type和name来删除资源</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-2"><span class="crayon-e">kubectl </span><span class="crayon-v">delete</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">pod</span><span class="crayon-e">.json</span></div><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-3"><span class="crayon-c"># 删除名字为baz foo的pod、service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-4"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-v">pod</span><span class="crayon-sy">,</span><span class="crayon-e">service </span><span class="crayon-e">baz </span><span class="crayon-v">foo</span></div><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-5"><span class="crayon-c"># 删除具有标签name=myLabel的pod、service</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-6"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-v">pods</span><span class="crayon-sy">,</span><span class="crayon-v">services</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-v">myLabel</span></div><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-7"><span class="crayon-c"># 立即删除pod，最小化延迟</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-8"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">pod </span><span class="crayon-v">foo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">now</span></div><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-9"><span class="crayon-c"># 强制删除pod，即使其所在节点宕机</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-10"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">pod </span><span class="crayon-v">foo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">grace</span><span class="crayon-o">-</span><span class="crayon-v">period</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">force</span></div><div class="crayon-line" id="crayon-634f9a69ba3f7408633057-11"><span class="crayon-c"># 删除所有pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3f7408633057-12"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">all</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

</td>
</tr>
<tr>
<td>cp</td>
<td>
<p>在当前目录和Pod容器目录之间进行文件拷贝
<p><span style="background-color: #c0c0c0;">格式：</span>
			<span id="crayon-634f9a69ba3fb838478487" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-i">cp</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba3ff365111007" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba3ff365111007-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ff365111007-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba3ff365111007-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba3ff365111007-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba3ff365111007-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba3ff365111007-1"><span class="crayon-c"># 拷贝当前目录中的图片，到Pod nginx的/usr/share/nginx/html/grafana目录，重命名</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ff365111007-2"><span class="crayon-e">kubectl </span><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-v">dang</span><span class="crayon-e">.png</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">share</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">/</span><span class="crayon-v">html</span><span class="crayon-o">/</span><span class="crayon-v">grafana</span><span class="crayon-o">/</span><span class="crayon-v">avatar</span><span class="crayon-e">.png</span></div><div class="crayon-line" id="crayon-634f9a69ba3ff365111007-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba3ff365111007-4"><span class="crayon-c"># 拷贝到指定容器</span></div><div class="crayon-line" id="crayon-634f9a69ba3ff365111007-5"><span class="crayon-e">kubectl </span><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">foo</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">bar</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

</td>
</tr>
<tr>
<td colspan="2"><em>部署命令</em></td>
</tr>
<tr>
<td class="blog_h3">rollout</td>
<td>
<p>管理资源的滚动更新，可以用于滚动更新复制集（Replica Set）
<p><span style="background-color: #c0c0c0;">格式：</span>
			<span id="crayon-634f9a69ba403188554973" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-i">SUBCOMMAND</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">子命令：</span><br />history  查看滚动更新历史<br /> pause 将资源标记为暂停<br /> resume 恢复被暂停的资源<br /> status 显示滚动更新状态<br /> undo 撤销之前的一个滚动更新</p>
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba407941235125" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba407941235125-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba407941235125-1"><span class="crayon-e">kubectl </span><span class="crayon-e">rollout </span><span class="crayon-e">status </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">deployment</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">rolling-update</td>
<td>
<p>针对指定的复制控制器（Replication Controller）进行滚动更新。将指定的的复制控制器替换为新的复制控制器，每次更新其中一个Pod（使用新Pod模板）
<p><span style="background-color: #c0c0c0;">格式：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba40b210264540" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba40b210264540-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba40b210264540-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba40b210264540-1"><span class="crayon-e">kubectl </span><span class="crayon-v">rolling</span><span class="crayon-o">-</span><span class="crayon-e">update </span><span class="crayon-e">OLD_CONTROLLER_NAME</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">NEW_CONTROLLER_NAME</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba40b210264540-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">=</span><span class="crayon-v">NEW_CONTAINER_IMAGE</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">NEW_CONTROLLER_SPEC</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">scale</td>
<td>
<p>对 Deployment, ReplicaSet, Replication Controller, Job进行扩容
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba410098335822" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba410098335822-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba410098335822-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba410098335822-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba410098335822-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba410098335822-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba410098335822-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba410098335822-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba410098335822-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba410098335822-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba410098335822-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba410098335822-1"><span class="crayon-c"># 将复制集foo扩容到3实例</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba410098335822-2"><span class="crayon-e">kubectl </span><span class="crayon-v">scale</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-v">rs</span><span class="crayon-o">/</span><span class="crayon-v">foo</span></div><div class="crayon-line" id="crayon-634f9a69ba410098335822-3"><span class="crayon-c"># 将foo.yaml所声明的资源扩容到3实例</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba410098335822-4"><span class="crayon-e">kubectl </span><span class="crayon-v">scale</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">foo</span><span class="crayon-e">.yaml</span></div><div class="crayon-line" id="crayon-634f9a69ba410098335822-5"><span class="crayon-c"># 如果部署mysql当前是2实例，则扩容到3实例</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba410098335822-6"><span class="crayon-e">kubectl </span><span class="crayon-v">scale</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">current</span><span class="crayon-o">-</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-v">mysql</span></div><div class="crayon-line" id="crayon-634f9a69ba410098335822-7"><span class="crayon-c"># 扩容多个复制控制器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba410098335822-8"><span class="crayon-e">kubectl </span><span class="crayon-v">scale</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-v">rc</span><span class="crayon-o">/</span><span class="crayon-e">foo </span><span class="crayon-v">rc</span><span class="crayon-o">/</span><span class="crayon-e">bar </span><span class="crayon-v">rc</span><span class="crayon-o">/</span><span class="crayon-v">baz</span></div><div class="crayon-line" id="crayon-634f9a69ba410098335822-9"><span class="crayon-c"># 扩容JOB</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba410098335822-10"><span class="crayon-e">kubectl </span><span class="crayon-v">scale</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">replicas</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-v">job</span><span class="crayon-o">/</span><span class="crayon-v">cron</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0030 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">autoscale</td>
<td>
<p>对Deployment, ReplicaSet, ReplicationController进行自动扩容
<p><span style="background-color: #c0c0c0;">格式：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba414373976154" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba414373976154-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba414373976154-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba414373976154-1"><span class="crayon-e">kubectl </span><span class="crayon-e">autoscale</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">FILENAME</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">TYPE</span><span class="crayon-h"> </span><span class="crayon-v">NAME</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">TYPE</span><span class="crayon-o">/</span><span class="crayon-v">NAME</span><span class="crayon-sy">)</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba414373976154-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">=</span><span class="crayon-v">MINPODS</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">max</span><span class="crayon-o">=</span><span class="crayon-i">MAXPODS</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">--</span><span class="crayon-v">cpu</span><span class="crayon-o">-</span><span class="crayon-v">percent</span><span class="crayon-o">=</span><span class="crayon-v">CPU</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">flags</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p><span style="background-color: #c0c0c0;"> 示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba418459727252" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba418459727252-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba418459727252-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba418459727252-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba418459727252-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba418459727252-1"><span class="crayon-c"># 自动扩容部署foo，实例数量在2-10之间</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba418459727252-2"><span class="crayon-e">kubectl </span><span class="crayon-e">autoscale </span><span class="crayon-e">deployment </span><span class="crayon-v">foo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">min</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">max</span><span class="crayon-o">=</span><span class="crayon-cn">10</span></div><div class="crayon-line" id="crayon-634f9a69ba418459727252-3"><span class="crayon-c"># 自动扩容复制控制器foo，最大实例数量5，当CPU占用80%时执行扩容</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba418459727252-4"><span class="crayon-e">kubectl </span><span class="crayon-e">autoscale </span><span class="crayon-e">rc </span><span class="crayon-v">foo</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">max</span><span class="crayon-o">=</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cpu</span><span class="crayon-o">-</span><span class="crayon-v">percent</span><span class="crayon-o">=</span><span class="crayon-cn">80</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

</td>
</tr>
<tr>
<td colspan="2"><em>集群管理命令</em></td>
</tr>
<tr>
<td class="blog_h3">certificate</td>
<td>修改证书资源</td>
</tr>
<tr>
<td class="blog_h3">cluster-info</td>
<td>显示集群信息</td>
</tr>
<tr>
<td class="blog_h3">top</td>
<td>显示资源（CPU、内存、存储）用量</td>
</tr>
<tr>
<td class="blog_h3">cordon</td>
<td>将节点标记为不可调度</td>
</tr>
<tr>
<td class="blog_h3">uncordon</td>
<td>将节点标记为可调度</td>
</tr>
<tr>
<td class="blog_h3">drain</td>
<td>
<p>抽干节点上部署的资源，准备进行节点维护。节点不再接受Pod调度
<p>要恢复，执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba41c197043821" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba41c197043821-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba41c197043821-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba41c197043821-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba41c197043821-1"><span class="crayon-e">kubectl </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-s">'{"spec":{"unschedulable":false}}'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba41c197043821-2"><span class="crayon-c"># 或者</span></div><div class="crayon-line" id="crayon-634f9a69ba41c197043821-3"><span class="crayon-e">kubectl </span><span class="crayon-i">uncordon</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">taint</td>
<td>
<p>为一个或多个节点标记Taint，每个Taint可以包含三个部分：
<ol>
<li>键：253字符以内，可以包含域名前缀和/，例如gmem.cc/app</li>
<li>值：可选，63字符以内</li>
<li>效果：必须是NoSchedule、PreferNoSchedule、NoExecute之一</li>
</ol>
<p>目前仅仅支持在Node上添加Taint</p>
<p><span style="background-color: #c0c0c0;">格式：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba420903520156" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba420903520156-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba420903520156-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba420903520156-1"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-e">NODE </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba420903520156-2"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">NAME </span><span class="crayon-v">KEY_1</span><span class="crayon-o">=</span><span class="crayon-v">VAL_1</span><span class="crayon-o">:</span><span class="crayon-v">TAINT_EFFECT</span><span class="crayon-sy">_</span>1<span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-v">KEY_N</span><span class="crayon-o">=</span><span class="crayon-v">VAL_N</span><span class="crayon-o">:</span><span class="crayon-v">TAINT_EFFECT</span><span class="crayon-sy">_</span>N<span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba424533107129" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba424533107129-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba424533107129-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba424533107129-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba424533107129-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba424533107129-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba424533107129-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba424533107129-1"><span class="crayon-c"># 为节点foo添加一个键为dedicated，值为special-user，效果为NoSchedule的taint</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba424533107129-2"><span class="crayon-c"># 如果指定键、效果的taint已经存在，则替换其值</span></div><div class="crayon-line" id="crayon-634f9a69ba424533107129-3"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-e">nodes </span><span class="crayon-e">foo </span><span class="crayon-v">dedicated</span><span class="crayon-o">=</span><span class="crayon-v">special</span><span class="crayon-o">-</span><span class="crayon-v">user</span><span class="crayon-o">:</span><span class="crayon-v">NoSchedule</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba424533107129-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba424533107129-5"><span class="crayon-c"># 移除节点foo上键为dedicated、效果为NoSchedule的taint</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba424533107129-6"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-e">nodes </span><span class="crayon-e">foo </span><span class="crayon-v">dedicated</span><span class="crayon-o">:</span><span class="crayon-v">NoSchedule</span><span class="crayon-o">-</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

</td>
</tr>
<tr>
<td colspan="2"><em>调试诊断命令</em></td>
</tr>
<tr>
<td class="blog_h3">describe</td>
<td>描述一个资源的详细信息</td>
</tr>
<tr>
<td class="blog_h3">logs</td>
<td>查看容器日志</td>
</tr>
<tr>
<td class="blog_h3">attach</td>
<td>连接到容器的控制台</td>
</tr>
<tr>
<td class="blog_h3">exec</td>
<td>
<p>在容器上执行命令，示例：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba428386118783" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba428386118783-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba428386118783-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba428386118783-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba428386118783-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba428386118783-1"><span class="crayon-c"># 连接到Pod redis的容器sidecar，执行Bash</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba428386118783-2"><span class="crayon-e">kubectl </span><span class="crayon-v">exec</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-e">dev </span><span class="crayon-v">redis</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-v">sidecar</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-e">it </span><span class="crayon-r">bash</span> </div><div class="crayon-line" id="crayon-634f9a69ba428386118783-3"><span class="crayon-c"># 要传递参数给容器中的命令，需要用 -- 做分隔符</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba428386118783-4"><span class="crayon-e">kubectl </span><span class="crayon-v">exec</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-e">dev </span><span class="crayon-v">redis</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-e">redis </span><span class="crayon-v">it</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h"> </span><span class="crayon-v">rediscli</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">c</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">port-forward</td>
<td>转发一个或多个本地的端口到Pod</td>
</tr>
<tr>
<td class="blog_h3">proxy</td>
<td>运行API Server的代理</td>
</tr>
<tr>
<td class="blog_h3">auth</td>
<td>查看授权信息</td>
</tr>
<tr>
<td colspan="2"><em>网络命令</em></td>
</tr>
<tr>
<td class="blog_h3">port-forward</td>
<td>
<p>端口转发，将指定的本地端口转发给K8S对象（Service、Pod等）
<p>格式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba42d009139786" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba42d009139786-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba42d009139786-1"><span class="crayon-e">kubectl </span><span class="crayon-v">port</span><span class="crayon-o">-</span><span class="crayon-e">forward </span><span class="crayon-r">TYPE</span><span class="crayon-o">/</span><span class="crayon-i">NAME</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">LOCAL_PORT</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-v">REMOTE</span><span class="crayon-sy">_</span>PORT<span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">[</span><span class="crayon-v">LOCAL_PORT_N</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-v">REMOTE_PORT_N</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>示例： </p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba431827852048" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba431827852048-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba431827852048-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba431827852048-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba431827852048-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba431827852048-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba431827852048-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba431827852048-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba431827852048-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba431827852048-1"><span class="crayon-c"># 转发本地端口5000、6000到容器mypod的相应端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba431827852048-2"><span class="crayon-e">kubectl </span><span class="crayon-v">port</span><span class="crayon-o">-</span><span class="crayon-e">forward </span><span class="crayon-v">pod</span><span class="crayon-o">/</span><span class="crayon-i">mypod</span><span class="crayon-h"> </span><span class="crayon-cn">5000</span><span class="crayon-h"> </span><span class="crayon-cn">6000</span></div><div class="crayon-line" id="crayon-634f9a69ba431827852048-3"><span class="crayon-c"># 类似，但是转发给Deployment，自动选择一个Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba431827852048-4"><span class="crayon-e">kubectl </span><span class="crayon-v">port</span><span class="crayon-o">-</span><span class="crayon-e">forward </span><span class="crayon-v">deployment</span><span class="crayon-o">/</span><span class="crayon-i">mydeployment</span><span class="crayon-h"> </span><span class="crayon-cn">5000</span><span class="crayon-h"> </span><span class="crayon-cn">6000</span></div><div class="crayon-line" id="crayon-634f9a69ba431827852048-5"><span class="crayon-c"># 将本地端口8888转发给mypod的5000</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba431827852048-6"><span class="crayon-e">kubectl </span><span class="crayon-v">port</span><span class="crayon-o">-</span><span class="crayon-e">forward </span><span class="crayon-v">pod</span><span class="crayon-o">/</span><span class="crayon-i">mypod</span><span class="crayon-h"> </span><span class="crayon-cn">8888</span><span class="crayon-o">:</span><span class="crayon-cn">5000</span></div><div class="crayon-line" id="crayon-634f9a69ba431827852048-7"><span class="crayon-c"># 随机监听一个本地端口并转父爱给mypod的5000</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba431827852048-8"><span class="crayon-e">kubectl </span><span class="crayon-v">port</span><span class="crayon-o">-</span><span class="crayon-e">forward </span><span class="crayon-v">pod</span><span class="crayon-o">/</span><span class="crayon-v">mypod</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-cn">5000</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

</td>
</tr>
<tr>
<td colspan="2"><em>高级命令</em></td>
</tr>
<tr>
<td class="blog_h3">apply</td>
<td>
<p>根据指定的文件或者Stdin来给资源应用一个配置
<p>如果操控的资源尚不存在，则此命令会自动创建之</p>
</td>
</tr>
<tr>
<td class="blog_h3">patch</td>
<td>
<p>更新资源的某些字段</p>
<p>可以用一段YAML来打补丁：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba435250984473" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba435250984473-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba435250984473-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba435250984473-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba435250984473-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba435250984473-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba435250984473-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba435250984473-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba435250984473-1"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">service </span><span class="crayon-v">core</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-r">patch</span><span class="crayon-h"> </span>"<span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">cat</span><span class="crayon-h"> </span><span class="crayon-o">&lt;&lt;</span><span class="crayon-h"> </span><span class="crayon-e">EOF</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba435250984473-2"><span class="crayon-v">spec</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-634f9a69ba435250984473-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">topologyKeys</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba435250984473-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">hostname</span></div><div class="crayon-line" id="crayon-634f9a69ba435250984473-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-s">'*'</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba435250984473-6"><span class="crayon-i">EOF</span></div><div class="crayon-line" id="crayon-634f9a69ba435250984473-7"><span class="crayon-sy">)</span>"<span class="crayon-h"> </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p> 也可以用一段JSON来打补丁：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba439642058138" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba439642058138-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba439642058138-1"><span class="crayon-e">kubectl </span><span class="crayon-r">patch</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-s">'{"spec":{"unschedulable":true}}'</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">replace</td>
<td>根据指定的文件或者Stdin来替换掉资源</td>
</tr>
<tr>
<td class="blog_h3">convert</td>
<td>在不同API版本之间转换配置文件</td>
</tr>
<tr>
<td colspan="2"><em>设置命令</em></td>
</tr>
<tr>
<td class="blog_h3">label</td>
<td>
<p>为资源更新标签
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba43d778091924" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba43d778091924-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba43d778091924-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba43d778091924-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba43d778091924-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba43d778091924-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba43d778091924-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba43d778091924-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba43d778091924-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba43d778091924-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba43d778091924-1"><span class="crayon-c"># 为某个节点添加标签</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba43d778091924-2"><span class="crayon-e">kubectl </span><span class="crayon-e">label </span><span class="crayon-e">node </span><span class="crayon-v">master</span><span class="crayon-o">-</span><span class="crayon-e">nQxw </span><span class="crayon-v">ceph</span><span class="crayon-o">-</span><span class="crayon-v">osd</span><span class="crayon-o">=</span><span class="crayon-v">enabled</span></div><div class="crayon-line" id="crayon-634f9a69ba43d778091924-3"><span class="crayon-c"># 为某个节点添加标签，如果该标签已经存在，则覆盖其值</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba43d778091924-4"><span class="crayon-e">kubectl </span><span class="crayon-v">label</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">overwrite&nbsp;&nbsp;</span><span class="crayon-e">node </span><span class="crayon-v">master</span><span class="crayon-o">-</span><span class="crayon-e">nQxw </span><span class="crayon-v">ceph</span><span class="crayon-o">-</span><span class="crayon-v">osd</span><span class="crayon-o">=</span><span class="crayon-v">enabled</span></div><div class="crayon-line" id="crayon-634f9a69ba43d778091924-5"><span class="crayon-c"># 移除所有节点的ceph-osd标签</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba43d778091924-6"><span class="crayon-e">kubectl </span><span class="crayon-e">label </span><span class="crayon-v">node</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">all </span><span class="crayon-v">ceph</span><span class="crayon-o">-</span><span class="crayon-v">osd</span><span class="crayon-o">-</span></div><div class="crayon-line" id="crayon-634f9a69ba43d778091924-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba43d778091924-8"><span class="crayon-c"># 查询所有节点的所有标签</span></div><div class="crayon-line" id="crayon-634f9a69ba43d778091924-9"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">node</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">go</span><span class="crayon-o">-</span><span class="crayon-v">template</span><span class="crayon-o">=</span><span class="crayon-s">'{{range .items}}Labels of {{.metadata.name}}{{":\n"}}{{range $k, $v := .metadata.labels}}{{$k}}={{$v}}{{"\n"}}{{end}}{{"\n\n"}}{{end}}'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

</td>
</tr>
<tr>
<td class="blog_h3">annotate</td>
<td>为资源更新注解</td>
</tr>
<tr>
<td colspan="2"><em>客户端设置</em></td>
</tr>
<tr>
<td>config</td>
<td>
<p>此命令用于修改kubeconfig，即默认位于~/.kube/confg中的配置信息
<p><span style="background-color: #c0c0c0;">格式：</span> 
			<span id="crayon-634f9a69ba441400369397" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-i">SUBCOMMAND</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">options</span><span class="crayon-sy">]</span></span></span></p>
<p><span style="background-color: #c0c0c0;">子命令：</span></p>
<p>current-context 显示当前使用的<span style="background-color: #c0c0c0;">上下文（集群+命名空间+用户的组合）</span><br /> delete-cluster 从配置文件中删除集群信息<br /> delete-context 从配置文件中删除指定的上下文<br /> get-clusters 显示可用的集群<br /> get-contexts 描述一个或多个上下文<br /> rename-context 重命名一个上下文<br /> set 设置配置文件中的单个项<br /> set-cluster 设置集群<br /> set-context 设置上下文<br /> set-credentials 设置用户信息<br /> use-context 修改当前上下文</p>
<p><span style="background-color: #c0c0c0;">示例：</span></p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba445284331664" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba445284331664-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba445284331664-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba445284331664-1"><span class="crayon-c"># 创建一个新的集群设置</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-2"><span class="crayon-e">kubectl </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubeconfig</span><span class="crayon-o">=</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-e">config </span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-e">cluster </span><span class="crayon-v">dang</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">server</span><span class="crayon-o">=</span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-cn">10.5.39.222</span><span class="crayon-o">:</span><span class="crayon-cn">6443</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba445284331664-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">certificate</span><span class="crayon-o">-</span><span class="crayon-v">authority</span><span class="crayon-o">=</span><span class="crayon-v">fake</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-r">file</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba445284331664-5"><span class="crayon-c"># 创建一个新的用户设置</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-6"><span class="crayon-e">kubectl </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubeconfig</span><span class="crayon-o">=</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-e">config </span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-e">credentials </span><span class="crayon-i">developer</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba445284331664-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">client</span><span class="crayon-o">-</span><span class="crayon-v">certificate</span><span class="crayon-o">=</span><span class="crayon-v">fake</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">client</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-o">=</span><span class="crayon-v">fake</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-o">-</span><span class="crayon-v">seefile</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba445284331664-9"><span class="crayon-c"># 创建一个新的Context</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-10"><span class="crayon-e">kubectl </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubeconfig</span><span class="crayon-o">=</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-e">config </span><span class="crayon-v">set</span><span class="crayon-o">-</span><span class="crayon-e">context </span><span class="crayon-v">dev</span><span class="crayon-o">-</span><span class="crayon-i">frontend</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba445284331664-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cluster</span><span class="crayon-o">=</span><span class="crayon-v">development</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">frontend</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">user</span><span class="crayon-o">=</span><span class="crayon-v">developer</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-12">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba445284331664-13"><span class="crayon-c"># 显示可用Context列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-14"><span class="crayon-c"># kubectl config get-contexts </span></div><div class="crayon-line" id="crayon-634f9a69ba445284331664-15"><span class="crayon-e">CURRENT&nbsp;&nbsp; </span><span class="crayon-e">NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CLUSTER&nbsp;&nbsp; </span><span class="crayon-e">AUTHINFO&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">NAMESPACE</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-16"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dang&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dang&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">dang</span><span class="crayon-o">-</span><span class="crayon-e">admin&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">default</span></div><div class="crayon-line" id="crayon-634f9a69ba445284331664-17"><span class="crayon-o">*</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">local&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">local&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">local</span><span class="crayon-o">-</span><span class="crayon-e">admin&nbsp;&nbsp; </span><span class="crayon-st">default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba445284331664-19"><span class="crayon-c"># 切换到新的Context</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba445284331664-20"><span class="crayon-e">kubectl </span><span class="crayon-e">config </span><span class="crayon-st">use</span><span class="crayon-o">-</span><span class="crayon-e">context </span><span class="crayon-v">dang</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0052 seconds] -->

</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">日志级别</span></div>
<p><!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba449008715071" class="crayon-syntax crayon-theme-none crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba449008715071-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba449008715071-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba449008715071-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba449008715071-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba449008715071-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba449008715071-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba449008715071-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba449008715071-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba449008715071-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba449008715071-1"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp; </span>用于那些应该<span class="crayon-h"> </span>始终<span class="crayon-h"> </span>对运维人员可见的信息，因为这些信息一般很有用</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba449008715071-2"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-h">&nbsp;&nbsp; </span>如果您不想要看到冗余信息，此值是一个合理的默认日志级别</div><div class="crayon-line" id="crayon-634f9a69ba449008715071-3"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-h">&nbsp;&nbsp; </span>输出有关服务的稳定状态的信息以及重要的日志消息，这些信息可能与系统中的重大变化有关。这是建议大多数系统设置的默认日志级别</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba449008715071-4"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp; </span>包含有关系统状态变化的扩展信息</div><div class="crayon-line" id="crayon-634f9a69ba449008715071-5"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">4</span><span class="crayon-h">&nbsp;&nbsp; </span>包含调试级别的冗余信息</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba449008715071-6"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">6</span><span class="crayon-h">&nbsp;&nbsp; </span>显示所请求的资源</div><div class="crayon-line" id="crayon-634f9a69ba449008715071-7"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">7</span><span class="crayon-h">&nbsp;&nbsp; </span>显示<span class="crayon-h"> </span><span class="crayon-i">HTTP</span><span class="crayon-h"> </span>请求头</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba449008715071-8"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">8</span><span class="crayon-h">&nbsp;&nbsp; </span>显示<span class="crayon-h"> </span><span class="crayon-i">HTTP</span><span class="crayon-h"> </span>请求内容</div><div class="crayon-line" id="crayon-634f9a69ba449008715071-9"><span class="crayon-o">--</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">9</span><span class="crayon-h">&nbsp;&nbsp; </span>显示<span class="crayon-h"> </span><span class="crayon-i">HTTP</span><span class="crayon-h"> </span>请求内容而且不截断内容 </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0033 seconds] -->

<div class="blog_h1"><span class="graybg">集群搭建（Kubeadm）</span></div>
<p>Kubeadm是K8S提供的一个工具箱，用于快速安装、初始化多机器环境下的K8S集群。</p>
<div class="blog_h2"><span class="graybg">前提条件</span></div>
<ol>
<li>Ubuntu 16.04、Debian 9、Fedora 25等操作系统</li>
<li>2GB或者更多内存</li>
<li>2核心或者更多</li>
<li>所有节点之间的完整网络连接性</li>
<li>每个节点具有唯一的主机名、MAC地址、product_uuid。product_uuid可以利用命令
			<span id="crayon-634f9a69ba44e829526570" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sudo </span><span class="crayon-v">cat</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">sys</span><span class="crayon-o">/</span><span class="crayon-t">class</span><span class="crayon-o">/</span><span class="crayon-v">dmi</span><span class="crayon-o">/</span><span class="crayon-v">id</span><span class="crayon-o">/</span><span class="crayon-v">product_uuid</span></span></span>获得</li>
<li><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#check-required-ports">必要的端口</a>已经打开。可以简单的禁用防火墙：
			<span id="crayon-634f9a69ba452095665727" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sudo </span><span class="crayon-e">ufw </span><span class="crayon-v">disable</span></span></span></li>
<li>禁用交换分区/文件：
			<span id="crayon-634f9a69ba456318381544" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sudo </span><span class="crayon-v">swapoff</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">a</span></span></span> ，这样kubelet才能正常工作</li>
</ol>
<div class="blog_h2"><span class="graybg">Docker安装</span></div>
<p>每个节点都需要安装Docker，推荐1.12，但是17.03、1.13、1.11等版本也可以使用。17.06+可能是可以的，但是没有经过K8S团队验证。安装方法：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba45a912482707" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba45a912482707-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba45a912482707-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba45a912482707-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba45a912482707-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba45a912482707-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba45a912482707-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba45a912482707-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba45a912482707-1"><span class="crayon-c"># Ubuntu / Debian</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba45a912482707-2"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">update</span></div><div class="crayon-line" id="crayon-634f9a69ba45a912482707-3"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-v">docker</span><span class="crayon-e">.io</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba45a912482707-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba45a912482707-5"><span class="crayon-c"># CentOS / RHEL / Fedora</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba45a912482707-6"><span class="crayon-e">yum </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-e">docker</span></div><div class="crayon-line" id="crayon-634f9a69ba45a912482707-7"><span class="crayon-e">systemctl </span><span class="crayon-e">enable </span><span class="crayon-v">docker</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-e">systemctl </span><span class="crayon-e">start </span><span class="crayon-v">docker</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<div class="blog_h2"><span class="graybg">Cgroup驱动</span></div>
<p>你需要确保Kubelet使用的Cgroup驱动和Docker的一致。要查看Docker当前的Cgroup驱动，执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba45e652219240" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba45e652219240-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba45e652219240-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba45e652219240-1"><span class="crayon-e">docker </span><span class="crayon-v">info</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">Driver</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba45e652219240-2"><span class="crayon-c"># Cgroup Driver: cgroupfs</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>可选值是cgroupfs、systemd，如果要修改Docker的驱动，可以：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba462710563598" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">/etc/docker/daemon.json</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba462710563598-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba462710563598-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba462710563598-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba462710563598-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba462710563598-1"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba462710563598-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-634f9a69ba462710563598-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"exec-opts"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"native.cgroupdriver=systemd"</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba462710563598-4"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>或者，修改Kubelet的启动选项 
			<span id="crayon-634f9a69ba466406219118" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">cgroup</span><span class="crayon-o">-</span><span class="crayon-v">driver</span><span class="crayon-o">=</span><span class="crayon-v">cgroupfs</span></span></span>。 </p>
<div class="blog_h2"><span class="graybg"><a id="install-k8s-comps"></a>K8S组件安装</span></div>
<p>Kubeadm用于集群的自举，在所有节点安装。kubeadm不会帮你安装kubelet、kubectl，因此你需要自己确保后两者的版本和K8S控制平面（由kubeadm安装）兼容。</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba46a404234127" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba46a404234127-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba46a404234127-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba46a404234127-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba46a404234127-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba46a404234127-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba46a404234127-1"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">update</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-v">transport</span><span class="crayon-o">-</span><span class="crayon-e">https</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba46a404234127-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba46a404234127-3"><span class="crayon-v">curl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">packages</span><span class="crayon-e">.cloud</span><span class="crayon-e">.google</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">/</span><span class="crayon-v">doc</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-v">key</span><span class="crayon-e">.gpg</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">key </span><span class="crayon-v">add</span><span class="crayon-h"> </span><span class="crayon-o">-</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba46a404234127-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba46a404234127-5"><span class="crayon-r">cat</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<div class="blog_h2"><span class="graybg">创建集群</span></div>
<div class="blog_h3"><span class="graybg">初始化Master</span></div>
<p>选取一台机器作为Master，控制平面组件将在其上运行，包括etcd（集群数据库）和APIServer。执行命令：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba46e086517228" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba46e086517228-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba46e086517228-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba46e086517228-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba46e086517228-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba46e086517228-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba46e086517228-1"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">advertise</span><span class="crayon-o">-</span><span class="crayon-i">address</span><span class="crayon-h"> </span><span class="crayon-cn">10.28.191.166</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba46e086517228-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba46e086517228-3"><span class="crayon-c"># 会在下面这一步卡住很长时间，如果在国内，要正确配置docker pull的代理，否则位于私服gcr.io下的APIServer等镜像是无法下载的</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba46e086517228-4"><span class="crayon-c"># Kubelet的日志信息，在Ubuntu上可以到/var/log/syslog查看，但是因为APIServer镜像拉取非常慢，所以报6443无法连接的日志非常多</span></div><div class="crayon-line" id="crayon-634f9a69ba46e086517228-5"><span class="crayon-c"># This might take a minute or longer if the control plane images have to be pulled.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>执行完毕后，会提示：Your Kubernetes master has initialized successfully，并下载以下镜像：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba472839288873" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba472839288873-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba472839288873-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba472839288873-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba472839288873-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba472839288873-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba472839288873-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba472839288873-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba472839288873-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba472839288873-1"><span class="crayon-e">docker </span><span class="crayon-v">images</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba472839288873-2"><span class="crayon-c"># REPOSITORY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IMAGE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CREATED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SIZE</span></div><div class="crayon-line" id="crayon-634f9a69ba472839288873-3"><span class="crayon-c"># gcr.io/google_containers/kube-proxy-amd64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f6f363e6e98e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12 days ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 109 MB</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba472839288873-4"><span class="crayon-c"># gcr.io/google_containers/kube-apiserver-amd64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7bff5aa286d7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12 days ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 210 MB</span></div><div class="crayon-line" id="crayon-634f9a69ba472839288873-5"><span class="crayon-c"># gcr.io/google_containers/kube-controller-manager-amd64&nbsp;&nbsp; v1.9.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3bb172f9452c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12 days ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 138 MB</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba472839288873-6"><span class="crayon-c"># gcr.io/google_containers/kube-scheduler-amd64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5ceb21996307&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12 days ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 62.7 MB</span></div><div class="crayon-line" id="crayon-634f9a69ba472839288873-7"><span class="crayon-c"># gcr.io/google_containers/etcd-amd64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.1.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1406502a6459&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 months ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;193 MB</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba472839288873-8"><span class="crayon-c"># gcr.io/google_containers/pause-amd64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 99e59f495ffa&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20 months ago&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 747 kB</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>如果网络实在太慢，或者无法访问gcr.io，则kubeadm init最终会time out。可以到阿里云的海外站建立一个按时收费的VM，在其上执行kubeadm init并把Docker 镜像拷贝、下载到本地使用。 默认情况下镜像文件存放在/var/lib/docker/aufs目录中，/var/lib/docker/image下则是镜像的元数据。</p>
<p>记住控制台上输出的信息：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba476242957271" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba476242957271-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba476242957271-1"><span class="crayon-e">kubeadm </span><span class="crayon-r">join</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">token</span><span class="crayon-h"> </span><span class="crayon-cn">24ae55.951196a500d44f96</span><span class="crayon-h"> </span><span class="crayon-cn">10.28.191.166</span><span class="crayon-o">:</span><span class="crayon-cn">6443</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">discovery</span><span class="crayon-o">-</span><span class="crayon-v">token</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-o">-</span><span class="crayon-r">hash</span><span class="crayon-h"> </span><span class="crayon-v">sha256</span><span class="crayon-o">:</span><span class="crayon-cn">1b99aad2ed25b8f05e14a4a2c20c9aa3e116dfb027f3544a7ac6a926669b3ed7</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>添加节点的时候需要使用。 </p>
<div class="blog_h3"><span class="graybg">检查状态</span></div>
<p>首先要确保当前用户的kubectl的配置文件正确。</p>
<p>如果以root身份运行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba47b944362347" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba47b944362347-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba47b944362347-1"><span class="crayon-e">export </span><span class="crayon-v">KUBECONFIG</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>其它用户可以使用如下方式指定kubectl配置文件：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba47f196814926" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba47f196814926-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba47f196814926-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba47f196814926-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba47f196814926-1"><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-v">$HOME</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba47f196814926-2"><span class="crayon-e">sudo </span><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-v">$HOME</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-e">config</span></div><div class="crayon-line" id="crayon-634f9a69ba47f196814926-3"><span class="crayon-e">sudo </span><span class="crayon-r">chown</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">u</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">g</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">$HOME</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>然后，你可以执行命令查看组件状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba483477479509" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba483477479509-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba483477479509-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba483477479509-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba483477479509-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba483477479509-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba483477479509-1"><span class="crayon-e">kubectl</span><span class="crayon-h"> </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">cs</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba483477479509-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ERROR</span></div><div class="crayon-line" id="crayon-634f9a69ba483477479509-3"><span class="crayon-c"># controller-manager&nbsp;&nbsp; Healthy&nbsp;&nbsp; ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba483477479509-4"><span class="crayon-c"># scheduler&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Healthy&nbsp;&nbsp; ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba483477479509-5"><span class="crayon-c"># etcd-0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Healthy&nbsp;&nbsp; {"health": "true"}&nbsp;&nbsp; </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<div class="blog_h3"><span class="graybg">安装Pod网络支持 </span></div>
<p>必须安装一个Pod Network Addon，这样Pod才能相互通信。安装Addon的通用命令格式为：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba487253062012" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba487253062012-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba487253062012-1"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">add</span><span class="crayon-o">-</span><span class="crayon-v">on</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>Pod Network Addon必须在任何应用程序之前部署， 完成之前，kube-dns（集群DNS服务）不会启动。</p>
<p>Kubeadm仅仅支持基于容器网络接口（Container Network Interface，CNI）的网络，不支持kubenet（单机环境下的网络插件）。因此kubelet必须使用选项--network-plugin=cni。</p>
<p>CNI由一系列规范、用于编写插件的库组成，这些插件用于配置Linux容器的网络接口，目前已经有一系列CNI插件。CNI仅仅关注容器的连接性、容器删除时的资源回收。</p>
<p>有多个开源项目为K8S提供CNI网络支持，其中一些支持<a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">网络策略</a>：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 20%; text-align: center;">Addon</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://docs.projectcalico.org/latest/getting-started/kubernetes/installation/hosted/">Calico </a></td>
<td>
<p>一个安全的第三层网络连接，提供网络策略支持。仅仅支持amd64</p>
<p>要求kubeadm init参数：
			<span id="crayon-634f9a69ba48b633081207" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">cidr</span><span class="crayon-o">=</span><span class="crayon-cn">192.168.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span></span></span></p>
<p>安装此Addon：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba48f697503758" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba48f697503758-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba48f697503758-1"><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">docs</span><span class="crayon-e">.projectcalico</span><span class="crayon-e">.org</span><span class="crayon-o">/</span><span class="crayon-v">v3</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span><span class="crayon-o">/</span><span class="crayon-v">getting</span><span class="crayon-o">-</span><span class="crayon-v">started</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">installation</span><span class="crayon-o">/</span><span class="crayon-v">hosted</span><span class="crayon-o">/</span><span class="crayon-v">kubeadm</span><span class="crayon-o">/</span><span class="crayon-cn">1.7</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

</td>
</tr>
<tr>
<td><a href="https://github.com/tigera/canal/tree/master/k8s-install">Canal</a></td>
<td>
<p>联合使用Flannel+Calico，提供网络连接和策略。仅仅支持amd64
<p>要求kubeadm init参数：
			<span id="crayon-634f9a69ba493397732021" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">cidr</span><span class="crayon-o">=</span><span class="crayon-cn">10.244.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span></span></span></p>
<p>安装此Addon：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba497438139987" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba497438139987-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba497438139987-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba497438139987-1"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">raw</span><span class="crayon-e">.githubusercontent</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">projectcalico</span><span class="crayon-o">/</span><span class="crayon-v">canal</span><span class="crayon-o">/</span><span class="crayon-v">master</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">install</span><span class="crayon-o">/</span><span class="crayon-cn">1.7</span><span class="crayon-o">/</span><span class="crayon-v">rbac</span><span class="crayon-e">.yaml</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba497438139987-2"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">raw</span><span class="crayon-e">.githubusercontent</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">projectcalico</span><span class="crayon-o">/</span><span class="crayon-v">canal</span><span class="crayon-o">/</span><span class="crayon-v">master</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">install</span><span class="crayon-o">/</span><span class="crayon-cn">1.7</span><span class="crayon-o">/</span><span class="crayon-v">canal</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

</td>
</tr>
<tr>
<td><a href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml">Flannel</a></td>
<td>
<p>一个覆盖网络实现，支持和K8S一起使用。支持amd64, arm, arm64, ppc64le，但是除了amd64之外需要手工的处理
<p>要求kubeadm init参数：
			<span id="crayon-634f9a69ba49b345704446" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">cidr</span><span class="crayon-o">=</span><span class="crayon-cn">10.244.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span></span></span></p>
<p>你需要设置：
			<span id="crayon-634f9a69ba49f473779577" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sysctl </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-o">-</span><span class="crayon-v">nf</span><span class="crayon-o">-</span><span class="crayon-v">call</span><span class="crayon-o">-</span><span class="crayon-v">iptables</span><span class="crayon-o">=</span><span class="crayon-cn">1</span></span></span>，将桥接的IPv4流量传递给iptables chain，确保某些CNI正常工作</p>
<p>安装此Addon：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4a3211787602" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4a3211787602-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4a3211787602-1"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">raw</span><span class="crayon-e">.githubusercontent</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">coreos</span><span class="crayon-o">/</span><span class="crayon-v">flannel</span><span class="crayon-o">/</span><span class="crayon-v">v0</span><span class="crayon-sy">.</span><span class="crayon-cn">9.1</span><span class="crayon-o">/</span><span class="crayon-v">Documentation</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">flannel</span><span class="crayon-e">.yml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

</td>
</tr>
<tr>
<td><a href="https://github.com/cloudnativelabs/kube-router/blob/master/Documentation/kubeadm.md">Kube-router</a></td>
<td>
<p>提供网络连接、策略、高性能的基于IPVS（IP虚拟服务器）/LVS（Linux虚拟服务器）的服务代理
<p>你需要设置：
			<span id="crayon-634f9a69ba4a7356437648" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sysctl </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-o">-</span><span class="crayon-v">nf</span><span class="crayon-o">-</span><span class="crayon-v">call</span><span class="crayon-o">-</span><span class="crayon-v">iptables</span><span class="crayon-o">=</span><span class="crayon-cn">1</span></span></span>，将桥接的IPv4流量传递给iptables chain，确保某些CNI正常工作</p>
<p>Kube-router依赖于控制器管理器来为节点分配Pod CIDR，你需要指定--pod-network-cidr标记</p>
</td>
</tr>
<tr>
<td><a href="https://www.weave.works/docs/net/latest/kube-addon/">Weave Net</a></td>
<td>
<p>支持amd64/arm/arm64且不需要额外的处理。默认设置hairpin mode，允许Pod通过它们的Service IP访问自己</p>
<p>你需要设置：
			<span id="crayon-634f9a69ba4ab337399327" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sysctl </span><span class="crayon-v">net</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-sy">.</span><span class="crayon-v">bridge</span><span class="crayon-o">-</span><span class="crayon-v">nf</span><span class="crayon-o">-</span><span class="crayon-v">call</span><span class="crayon-o">-</span><span class="crayon-v">iptables</span><span class="crayon-o">=</span><span class="crayon-cn">1</span></span></span>，将桥接的IPv4流量传递给iptables chain，确保某些CNI正常工作</p>
<p>安装此Addon：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4af894137086" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4af894137086-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4af894137086-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4af894137086-1"><span class="crayon-e">export </span><span class="crayon-v">kubever</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-e">kubectl </span><span class="crayon-v">version</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">base64</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">tr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4af894137086-2"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-s">"https://cloud.weave.works/k8s/net?k8s-version=$kubever"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

</td>
</tr>
</tbody>
</table>
<p>安装网络支持后，K8S需要到gcr.io下载三个镜像，如果网络不好的话又需要很长时间。你可以检查kube-dns是否进入Running状态：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4b3477844818" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4b3477844818-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4b3477844818-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pods</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">all</span><span class="crayon-o">-</span><span class="crayon-v">namespaces</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">dns</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>如果是，则可以将节点加入到集群了。 否则，查看一下kube-dns这个Pod的详细状态：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4b7781766754" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba4b7781766754-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4b7781766754-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-1"><span class="crayon-c"># kube-system&nbsp;&nbsp; kube-dns-6f4fd4bdf-h84mc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0/3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pending&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-3"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">namespace</span><span class="crayon-o">=</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-e">describe </span><span class="crayon-e">pod&nbsp;&nbsp;</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-cn">6f4fd4bdf</span><span class="crayon-o">-</span><span class="crayon-v">h84mc</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-5"><span class="crayon-c"># Controlled By:&nbsp;&nbsp;ReplicaSet/kube-dns-6f4fd4bdf</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-6"><span class="crayon-c"># Containers:</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-7"><span class="crayon-c">#&nbsp;&nbsp; kubedns:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-8"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp; Requests:</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-9"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-10"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory:&nbsp;&nbsp; 70Mi</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-11"><span class="crayon-c">#&nbsp;&nbsp; dnsmasq:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-12"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp; Requests:</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-13"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;150m</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-14"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory:&nbsp;&nbsp;&nbsp;&nbsp; 20Mi</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-15"><span class="crayon-c"># Events:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-16"><span class="crayon-c">#&nbsp;&nbsp;Type&nbsp;&nbsp;&nbsp;&nbsp; Reason&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Age&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; From&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Message</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-17"><span class="crayon-c">#&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp; ------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -------</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-18"><span class="crayon-c">#&nbsp;&nbsp;Warning&nbsp;&nbsp;FailedScheduling&nbsp;&nbsp;3m (x7 over 3m)&nbsp;&nbsp; default-scheduler&nbsp;&nbsp;0/1 nodes are available: 1 NodeNotReady.</span></div><div class="crayon-line" id="crayon-634f9a69ba4b7781766754-19"><span class="crayon-c">#&nbsp;&nbsp;Warning&nbsp;&nbsp;FailedScheduling&nbsp;&nbsp;2m (x2 over 2m)&nbsp;&nbsp; default-scheduler&nbsp;&nbsp;0/1 nodes are available: 1 Insufficient cpu, 1 NodeNotReady.</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4b7781766754-20"><span class="crayon-c">#&nbsp;&nbsp;Warning&nbsp;&nbsp;FailedScheduling&nbsp;&nbsp;53s (x3 over 1m)&nbsp;&nbsp;default-scheduler&nbsp;&nbsp;0/1 nodes are available: 1 Insufficient cpu.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<p>可以发现CPU资源不足会导致kube-dns无法运行。 </p>
<div class="blog_h3"><span class="graybg">允许在Master上调度Pod </span></div>
<p>默认情况下，集群不会在Master节点上调度Pod，主要是安全方面的考虑。如果你希望改变这一行为（例如仅仅有单个节点，开发用），可以去除taint：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4bb230927438" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4bb230927438-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4bb230927438-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4bb230927438-1"><span class="crayon-c"># 移除所有节点上的Taint: node-role.kubernetes.io/master，这样调度器可以在任何地方调度Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4bb230927438-2"><span class="crayon-e">kubectl </span><span class="crayon-e">taint </span><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">all </span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">role</span><span class="crayon-e">.kubernetes</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">master</span><span class="crayon-o">-</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">添加节点</span></div>
<p>执行kubeadm的最后，有一段用于加入节点的命令，执行执行它就可以加入到集群中。然后在Master节点上验证此新节点的加入：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4bf034286885" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4bf034286885-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4bf034286885-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4bf034286885-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4bf034286885-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4bf034286885-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4bf034286885-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATUS&nbsp;&nbsp;&nbsp;&nbsp;ROLES&nbsp;&nbsp;&nbsp;&nbsp; AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VERSION</span></div><div class="crayon-line" id="crayon-634f9a69ba4bf034286885-3"><span class="crayon-c"># izj6c2ryo8ck3lt8mzx0ezz&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp; master&nbsp;&nbsp;&nbsp;&nbsp;25m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v1.9.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4bf034286885-4"><span class="crayon-c"># izj6cdwcrbnfjxwlznyjvnz&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>信息信息 在普通节点上，你都可以对集群进行控制，只需要将kubectl的配置文件拷贝过来就可以了：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4c3053387641" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4c3053387641-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4c3053387641-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4c3053387641-1"><span class="crayon-e">scp </span><span class="crayon-v">root</span><span class="crayon-sy">@</span><span class="crayon-cn">10.28.191.166</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4c3053387641-2"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">kubeconfig</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p> 你也可以从集群外部的节点来控制集群：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4c7989340595" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4c7989340595-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4c7989340595-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4c7989340595-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4c7989340595-1"><span class="crayon-e">scp </span><span class="crayon-v">root</span><span class="crayon-sy">@</span><span class="crayon-cn">10.28.191.166</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4c7989340595-2"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-i">kubeconfig</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-v">proxy</span></div><div class="crayon-line" id="crayon-634f9a69ba4c7989340595-3"><span class="crayon-c"># 现在可以通过http://localhost:8001/api/v1访问APIServer了</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h2"><span class="graybg">删除集群</span></div>
<div class="blog_h3"><span class="graybg">删除节点</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4cb329458208" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4cb329458208-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4cb329458208-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4cb329458208-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4cb329458208-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4cb329458208-1"><span class="crayon-c"># 抽干节点，忽略DaemonSet控制器管理Pods</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4cb329458208-2"><span class="crayon-e">kubectl </span><span class="crayon-e">drain </span><span class="crayon-v">izj6cdwcrbnfjxwlznyjvnz</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">delete</span><span class="crayon-o">-</span><span class="crayon-v">local</span><span class="crayon-o">-</span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">force</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">ignore</span><span class="crayon-o">-</span><span class="crayon-v">daemonsets</span></div><div class="crayon-line" id="crayon-634f9a69ba4cb329458208-3"><span class="crayon-c"># 从集群中删除节点</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4cb329458208-4"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">node </span><span class="crayon-v">izj6cdwcrbnfjxwlznyjvnz</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<div class="blog_h3"><span class="graybg">重置集群 </span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4cf485481351" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4cf485481351-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4cf485481351-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4cf485481351-1"><span class="crayon-c"># 已经下载的镜像不会被删除，但是创建的容器会全部删除</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4cf485481351-2"><span class="crayon-e">kubeadm </span><span class="crayon-i">reset</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<div class="blog_h2"><span class="graybg">kubeadm init</span></div>
<div class="blog_h3"><span class="graybg">工作流程</span></div>
<p>初始化一个K8S集群的Master节点。该子命令的工作流程如下：</p>
<ol>
<li>执行一系列的pre-flight检查，验证系统状态。某些验证会导致警告，另一些则触发错误并终止流程</li>
<li>生成自签名CA（或者使用你提供的）来为每个集群组件创建identity。你可以把自己生成好的CA证书/密钥放入--cert-dir目录（默认/etc/kubernetes/pki），则此步骤可以跳过</li>
<li>为Kubelet、控制器管理器、调度器创建配置文件，放入/etc/kubernetes/目录。这些组件利用配置文件（自己的identity）连接到APIServer</li>
<li>创建一个名为admin.conf的kubeconfig</li>
<li>如果使用选项--feature-gates=DynamicKubeletConfig。则将Kubelet<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file.md">初始化配置</a>写入/var/lib/kubelet/config/init/kubelet。此特性未来可能默认开启</li>
<li>为APIServer、控制器管理器、调度器生成静态Pod清单（manifests）。如果没有提供外部的etcd，则额外创建etcd的静态Pod清单<br />清单文件位于/etc/kubernetes/manifests目录下，Kubelet会监控此目录，并在启动时创建需要的Pod</li>
<li>上一步会初始化、启动控制平面，一旦完成，流程继续</li>
<li>如果使用选项--feature-gates=DynamicKubeletConfig，则继续完成Kubelet的动态配置——创建ConfigMap、一些RBAC规则，更新节点将Node.spec.configSource指向刚刚创建的ConfigMap</li>
<li>为Master节点添加Label、Taints，不让工作负载在Master节点上运行</li>
<li>生成令牌，方便Worker节点注册，你可以通过--token手工提供令牌</li>
<li>进行必要的配置，允许节点通过<a href="https://kubernetes.io/docs/admin/bootstrap-tokens/">Bootstrap Tokens</a> 和 <a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/">TLS Bootstrap</a>加入到集群：
<ol>
<li>创建一个ConfigMap，添加加入集群所需的信息，创建相关的RBAC访问规则</li>
<li>让Bootstrap令牌访问CSR签名API</li>
<li>配置CSR请求的自动准许</li>
</ol>
</li>
<li>为APIServer安装内部DNS、kube-proxy Addon组件。尽管DNS Pod被部署，但是CNI准备好之前它不会被调度</li>
<li>如果使用选项--feature-gates=SelfHosting=true。则基于静态Pod的控制平面被转换为<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#self-hosting">自托管（self-hosted）控制平面</a></li>
</ol>
<div class="blog_h3"><span class="graybg">命令选项</span></div>
<p>命令行参数可以用配置文件代替，传入
			<span id="crayon-634f9a69ba4d4510590677" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">config</span></span></span>选项即可。配置文件格式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4d8730510823" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-40">40</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-42">42</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-44">44</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-46">46</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-48">48</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-50">50</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-52">52</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-54">54</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-56">56</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-58">58</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-60">60</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-62">62</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-64">64</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-66">66</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-68">68</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-70">70</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-72">72</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-74">74</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-76">76</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-78">78</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-80">80</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-82">82</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-84">84</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-86">86</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-88">88</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-90">90</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-92">92</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-94">94</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-96">96</div><div class="crayon-num" data-line="crayon-634f9a69ba4d8730510823-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4d8730510823-98">98</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-1"><span class="crayon-c"># --dry-run 仅仅输出会做什么</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-2"><span class="crayon-c"># --config 传入此配置文件</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-3"><span class="crayon-c"># --ignore-preflight-errors stringSlice&nbsp;&nbsp;将错误看作警告，值IsPrivilegedUser,Swap,all</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-4"><span class="crayon-c"># --skip-token-print 不在控制台上打印kubeadm join的令牌</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-6"><span class="crayon-s ">apiVersion</span><span class="">: kubeadm.k8s.io/v1alpha1</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-7"><span class="crayon-s ">kind</span><span class="">: MasterConfiguration</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-8"><span class="crayon-s ">api</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># --apiserver-advertise-address string </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># APIServer在其上监听的网络接口，设置0.0.0.0则使用默认网络接口</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">advertiseAddress</span><span class="">: </span><span class="crayon-o">&lt;</span>address<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># --apiserver-bind-port int32</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># APIServer监听端口，默认6443</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">bindPort</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-15"><span class="crayon-s ">etcd</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">endpoints</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-17"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>endpoint1<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-18"><span class="crayon-h">&nbsp;&nbsp;</span>-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>endpoint2<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">caFile</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">certFile</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">keyFile</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">dataDir</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">extraArgs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 使用定制的镜像，不从k8s.gcr.io拉取</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-28"><span class="crayon-s ">networking</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># --service-dns-domain string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 服务的DNS域名后缀，默认cluster.local</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-31"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">dnsDomain</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># --service-cidr string</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 服务的虚拟IP地址范围，默认10.96.0.0/12</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">serviceSubnet</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># --pod-network-cidr string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-36"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># Pod网络的的IP地址范围</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-37"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSubnet</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-38"><span class="crayon-c"># --kubernetes-version string</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-39"><span class="crayon-c"># 创建的控制平面版本</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-40"><span class="crayon-s ">kubernetesVersion</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-41"><span class="crayon-s ">cloudProvider</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-42"><span class="crayon-c"># --node-name string</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-43"><span class="crayon-c"># 设置节点名称</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-44"><span class="crayon-s ">nodeName</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-45"><span class="crayon-s ">authorizationModes</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-46">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>authorizationMode1<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-47">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>authorizationMode2<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-48"><span class="crayon-s ">token</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-49"><span class="crayon-c"># --token-ttl duration </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-50"><span class="crayon-c"># Bootstrap令牌的寿命，默认24h</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-51"><span class="crayon-s ">tokenTTL</span><span class="">: </span><span class="crayon-o">&lt;</span>time<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-52"><span class="crayon-s ">selfHosted</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-53"><span class="crayon-c"># 用于覆盖、扩展APIServer的行为</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-54"><span class="crayon-c"># 示例：</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-55"><span class="crayon-c"># apiServerExtraArgs:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-56"><span class="crayon-c">#&nbsp;&nbsp; feature-gates: APIResponseCompression=true</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-57"><span class="crayon-s ">apiServerExtraArgs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-58"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-59"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-60"><span class="crayon-c"># 用于覆盖、扩展控制器管理器的行为</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-61"><span class="crayon-s ">controllerManagerExtraArgs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-62"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-63"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-64"><span class="crayon-c"># 用于覆盖、扩展调度器的行为</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-65"><span class="crayon-s ">schedulerExtraArgs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-66"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-67"><span class="crayon-h">&nbsp;&nbsp;</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-68"><span class="crayon-s ">apiServerExtraVolumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-69"><span class="crayon-s ">- name</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-70"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-71"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-72"><span class="crayon-s ">controllerManagerExtraVolumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-73"><span class="crayon-s ">- name</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-74"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-75"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-76"><span class="crayon-s ">schedulerExtraVolumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-77"><span class="crayon-s ">- name</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-78"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-79"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: </span><span class="crayon-o">&lt;</span>value<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-80"><span class="crayon-c"># --apiserver-cert-extra-sans stringSlice</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-81"><span class="crayon-c"># APIServer HTTPS证书的，额外的主体备选名字（Subject Alternative Names，SAN），可以指定IP和DNS名</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-82"><span class="crayon-s ">apiServerCertSANs</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-83">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>name1<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-84">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>name2<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-85"><span class="crayon-c"># --cert-dir string</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-86"><span class="crayon-c"># 数字证书存放目录，默认/etc/kubernetes/pki</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-87"><span class="crayon-s ">certificatesDir</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-88"><span class="crayon-c"># 不从k8s.gcr.io拉取镜像，从自定义位置拉取</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-89"><span class="crayon-s ">imageRepository</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-90"><span class="crayon-c"># 使用其它的镜像作为控制平面组件</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-91"><span class="crayon-s ">unifiedControlPlaneImage</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-92"><span class="crayon-c"># --feature-gates string</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-93"><span class="crayon-c"># 特性开关，包括：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-94"><span class="crayon-c">#&nbsp;&nbsp; CoreDNS=true|false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ALPHA - default=false)</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-95"><span class="crayon-c">#&nbsp;&nbsp; DynamicKubeletConfig=true|false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ALPHA - default=false)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-96"><span class="crayon-c">#&nbsp;&nbsp; SelfHosting=true|false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ALPHA - default=false)</span></div><div class="crayon-line" id="crayon-634f9a69ba4d8730510823-97"><span class="crayon-c">#&nbsp;&nbsp; StoreCertsInSecrets=true|false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ALPHA - default=false)</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4d8730510823-98"><span class="crayon-s ">featureGates</span><span class="">:</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0085 seconds] -->

<div class="blog_h3"><span class="graybg">使用定制镜像</span></div>
<p>默认情况下，Kubeadm从k8s.gcr.io拉取镜像。如果使用的K8S是CI版本，则从gcr.io/kubernetes-ci-images拉取镜像。</p>
<p>你可以设置配置文件的imageRepository选项，指定从其它服务器拉取镜像。</p>
<div class="blog_h3"><span class="graybg">使用定制证书</span></div>
<p>默认情况下，Kubeadm为集群生成所有需要的证书。你只需要在证书目录放置自己生成的证书，即可改变此行为。</p>
<p>如果/etc/kubernetes/pki/ca.crt、/etc/kubernetes/pki/ca.key文件存在，则分别被用作CA证书和私钥。Kubeadm会使用它们对其它CSR进行签名。</p>
<div class="blog_h3"><span class="graybg">管理Kubelet配置</span></div>
<p>Kubeadm包附带了一些配置文件，这些文件影响Kubelet的运行方式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4de795755006" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba4de795755006-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4de795755006-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4de795755006-1"><span class="crayon-sy">[</span><span class="crayon-v">Service</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-2"><span class="crayon-c"># --bootstrap-kubeconfig 一个kubeconfig文件，用于节点加入集群时得到客户端证书信息，此文件会被写入到--kubeconfig指定位置</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-3"><span class="crayon-c"># --kubeconfig&nbsp;&nbsp;包含了APIServer的位置、Kubelet的凭证</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-4"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_KUBECONFIG_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">bootstrap</span><span class="crayon-o">-</span><span class="crayon-v">kubeconfig</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">bootstrap</span><span class="crayon-o">-</span><span class="crayon-v">kubelet</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">--</span><span class="crayon-v">kubeconfig</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">kubelet</span><span class="crayon-e">.conf</span>"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-6"><span class="crayon-c"># --pod-manifest-path 从何处读取静态Pod的规格文件，这些Pod是控制平面的组件</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-7"><span class="crayon-c"># --allow-privileged 是否允许Kubelet执行特权Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-8"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_SYSTEM_PODS_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">manifest</span><span class="crayon-o">-</span><span class="crayon-v">path</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">manifests</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">allow</span><span class="crayon-o">-</span><span class="crayon-v">privileged</span><span class="crayon-o">=</span><span class="crayon-t">true</span>"</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-10"><span class="crayon-c"># --network-plugin 网络插件类型，Kubeadm仅仅支持CNI</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-11"><span class="crayon-c"># --cni-conf-dir CNI规格文件位置</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-12"><span class="crayon-c"># --cni-bin-dir&nbsp;&nbsp;CNI可执行文件位置</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-13"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_NETWORK_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">plugin</span><span class="crayon-o">=</span><span class="crayon-v">cni</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cni</span><span class="crayon-o">-</span><span class="crayon-v">conf</span><span class="crayon-o">-</span><span class="crayon-v">dir</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">cni</span><span class="crayon-o">/</span><span class="crayon-v">net</span><span class="crayon-e">.d</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cni</span><span class="crayon-o">-</span><span class="crayon-v">bin</span><span class="crayon-o">-</span><span class="crayon-v">dir</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">opt</span><span class="crayon-o">/</span><span class="crayon-v">cni</span><span class="crayon-o">/</span><span class="crayon-i">bin</span>"</div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-15"><span class="crayon-c"># --cluster-dns 集群内部DNS的地址，会写入到Pod的/etc/resolv.conf的nameserver条目</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-16"><span class="crayon-c"># --cluster-domain 集群内部域名，会写入到Pod的/etc/resolv.conf的search条目</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-17"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_DNS_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">cluster</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">=</span><span class="crayon-cn">10.96.0.10</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cluster</span><span class="crayon-o">-</span><span class="crayon-v">domain</span><span class="crayon-o">=</span><span class="crayon-v">cluster</span><span class="crayon-e">.local</span>"</div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-19"><span class="crayon-c"># --authorization-mode 授权模式。Webhook表示通过POST一个SubjectAccessReview到APIServer来验证客户端</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-20"><span class="crayon-c"># --client-ca-file 用于验证的CA文件</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-21"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_AUTHZ_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">authorization</span><span class="crayon-o">-</span><span class="crayon-v">mode</span><span class="crayon-o">=</span><span class="crayon-v">Webhook</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">client</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span>"</div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-23"><span class="crayon-c"># --cadvisor-port，设置为0表示禁用cAdvisor</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-24"><span class="crayon-v">Environment</span><span class="crayon-o">=</span><span class="crayon-s">"KUBELET_CADVISOR_ARGS=--cadvisor-port=0"</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-25"><span class="crayon-c"># --rotate-certificates 证书过期后，自动向APIServer重新申请</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-26"><span class="crayon-c"># --cert-dir TLS证书目录</span></div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-27"><span class="crayon-v">Environment</span><span class="crayon-o">=</span>"<span class="crayon-v">KUBELET_CERTIFICATE_ARGS</span><span class="crayon-o">=</span><span class="crayon-o">--</span><span class="crayon-v">rotate</span><span class="crayon-o">-</span><span class="crayon-v">certificates</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cert</span><span class="crayon-o">-</span><span class="crayon-v">dir</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-t">var</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">kubelet</span><span class="crayon-o">/</span><span class="crayon-i">pki</span>"</div><div class="crayon-line" id="crayon-634f9a69ba4de795755006-29"><span class="crayon-v">ExecStart</span><span class="crayon-o">=</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4de795755006-30"><span class="crayon-v">ExecStart</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-i">kubelet</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_KUBECONFIG_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_SYSTEM_PODS_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_NETWORK_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_DNS_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_AUTHZ_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_CADVISOR_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_CERTIFICATE_ARGS</span><span class="crayon-h"> </span><span class="crayon-v">$KUBELET_EXTRA_ARGS</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0086 seconds] -->

<div class="blog_h3"><span class="graybg">使用内部网络</span></div>
<p>如果集群有多套网络，你需要明确选择其中一套时，可以：</p>
<ol>
<li>初始化集群时指定APIServer监听端口：
			<span id="crayon-634f9a69ba4e3337188775" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">advertise</span><span class="crayon-o">-</span><span class="crayon-v">address</span><span class="crayon-o">=</span><span class="crayon-cn">10.0.0.1</span></span></span></li>
<li>在Worker节点上安装好软件后，修改/etc/systemd/system/kubelet.service.d/10-kubeadm.conf，添加
			<span id="crayon-634f9a69ba4e7778510147" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">ip</span><span class="crayon-o">=</span><span class="crayon-cn">10.0.0.x</span></span></span></li>
<li>调用kubeadm join时，确保其中的IP地址填写的是10.0.0.1</li>
</ol>
<div class="blog_h3"><span class="graybg">自托管控制平面</span></div>
<p>从1.8开始，K8S支持所谓自托管控制平面，当前处于Alpha状态。自托管控制平面中，APIServer、控制器管理器、调度器等关键组件将以 DaemonSet而不是静态Pod方式运行。</p>
<div class="blog_h2"><span class="graybg">kubeadm join</span></div>
<p>初始化一个K8S集群的Worker节点，并加入到集群中。</p>
<p>当加入基于Kubeadm初始化的集群时，需要双向的身份验证，这通过两部分达成：</p>
<ol>
<li>Discovery：让Worker信任Master</li>
<li>TLS bootstrap：让Master信任Worker</li>
</ol>
<p>Discovery主要有两种模式：</p>
<ol>
<li>使用共享令牌 + APIServer的地址</li>
<li>使用一个文件，其内容是标准kubeconfig的子集</li>
</ol>
<p>TLS bootstrap也是基于共享令牌驱动的，用于临时的向APIServer提交身份验证，以便发起CSR请求。默认情况下，Kubeadm会自动配置Master，以完成对CSR的准许和签名。此令牌以–tls-bootstrap-token参数传递。</p>
<div class="blog_h3"><span class="graybg">工作流程</span></div>
<p>该命令初始化Worker节点并加入到集群。主要步骤：</p>
<ol>
<li>从APIServer下载必要的集群信息，默认的，使用Bootstrap令牌 + CA键的哈希来对信息进行验证</li>
<li>如果使用选项--feature-gates=DynamicKubeletConfig。则首先从Master下载Kubelet初始化配置，写入到磁盘。当Kubelet启动后Kubeadm更新节点的Node.spec.configSource属性</li>
<li>一旦集群信息获得，Kubelet可以启动TLS bootstrapping：
<ol>
<li>使用共享密钥临时和APIServer通信，提交CSRcat /etc/yum.repos.d/ceph.repo </li>
<li>默认的，控制平面会自动签名CSR</li>
</ol>
</li>
<li>Kubelet以后使用确定的Identity和APIServer通信</li>
</ol>
<div class="blog_h3"><span class="graybg">命令选项</span></div>
<table class="full-width fixed-word-wrap">
<tbody>
<tr>
<td>
<p><em>--config  string</em>  指定一个kubeadm配置文件</p>
</td>
</tr>
<tr>
<td>
<p><em>--cri-socket string</em>  连接到的CRI（容器运行时接口，例如Docker）套接字，默认/var/run/dockershim.sock</p>
</td>
</tr>
<tr>
<td><em>--discovery-file string</em>  用于加载集群信息的文件或者URL </td>
</tr>
<tr>
<td><em>--discovery-token string</em>  用于验证加载到的集群信息的令牌</td>
</tr>
<tr>
<td>
<p><em>--discovery-token-ca-cert-hash stringSlice</em>  对于基于共享令牌的发现，使用此哈希验证根CA的公钥</p>
</td>
</tr>
<tr>
<td><em>--discovery-token-unsafe-skip-ca-verification</em>   对于基于共享令牌的发现，此选项禁用根CA的验证</td>
</tr>
<tr>
<td>
<p><em>--feature-gates string</em>  特性开关</p>
</td>
</tr>
<tr>
<td><em>--ignore-preflight-errors stringSlice</em>  忽略预先检查中出现的某些错误</td>
</tr>
<tr>
<td><em>--node-name string</em>   指定当前节点的名称</td>
</tr>
<tr>
<td><em>--tls-bootstrap-token string</em>   用于TLS bootstrap的共享令牌</td>
</tr>
<tr>
<td><em>--token string</em>  同时用于发现、TLS自举的令牌</td>
</tr>
</tbody>
</table>
<p>等价的配置文件形式：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4ec652823954" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4ec652823954-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba4ec652823954-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-1"><span class="crayon-c"># 使用 --config选项传入此文件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-3"><span class="crayon-s ">apiVersion</span><span class="">: kubeadm.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-4"><span class="crayon-s ">kind</span><span class="">: NodeConfiguration</span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-5"><span class="crayon-s ">caCertPath</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-6"><span class="crayon-s ">discoveryFile</span><span class="">: </span><span class="crayon-o">&lt;</span>path<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-7"><span class="crayon-s ">discoveryToken</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-8"><span class="crayon-s ">discoveryTokenAPIServers</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-9">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>address<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-10">-<span class="crayon-h"> </span><span class="crayon-o">&lt;</span>address<span class="crayon-o">|</span>string<span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-11"><span class="crayon-s ">nodeName</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-12"><span class="crayon-s ">tlsBootstrapToken</span><span class="">: </span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-13"><span class="crayon-s ">token</span><span class="">: </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-14"><span class="crayon-s ">discoveryTokenCACertHashes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-15">-<span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4ec652823954-16"><span class="crayon-s ">- </span></div><div class="crayon-line" id="crayon-634f9a69ba4ec652823954-17"><span class="crayon-s ">discoveryTokenUnsafeSkipCAVerification</span><span class="">: </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->

<div class="blog_h3"><span class="graybg">Master发现</span></div>
<p>Kubeadm提供了多种发现机制：</p>
<table class="full-width fixed-word-wrap">
<tbody>
<tr>
<td>
<p><em>基于令牌的发现 + CA pinning</em></p>
<p>1.8+的默认机制。Kubeadm下载包括根CA在内的集群配置信息。使用令牌来验证配置信息，使用哈希来验证根CA公钥</p>
<p>缺点是：直到Master准备好之前，CA哈希是不知道的</p>
</td>
</tr>
<tr>
<td>
<p><em>基于令牌的发现，不验证CA</em></p>
<p>需要kubeadm --discovery-token-unsafe-skip-ca-verification</p>
<p>如果攻击者获得Bootstrap令牌，则他能够假扮（面向其它Worker）Master节点</p>
</td>
</tr>
<tr>
<td>
<p><em>基于文件/HTTPS的发现</em></p>
<p>需要kubeadm --discovery-file  path-or-url</p>
<p>缺点是，需要有某种机制把发现信息从Master传输到正在Join的节点上</p>
</td>
</tr>
</tbody>
</table>
<div class="blog_h3"><span class="graybg">安全加固</span></div>
<table class="full-width fixed-word-wrap">
<tbody>
<tr>
<td>
<p><em>关闭Worker的CSR自动许可/签名</em></p>
<p>默认情况下，只要准备加入的Kubelet提供了合法的Bootstrap令牌，Master会自动准许其CSR。要关闭此特性，执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4f1252340521" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4f1252340521-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4f1252340521-1"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">clusterrole </span><span class="crayon-v">kubeadm</span><span class="crayon-o">:</span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">autoapprove</span><span class="crayon-o">-</span><span class="crayon-v">bootstrap</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p> 这样的话，除非你手工准许了CSR，工作节点的Join请求会阻塞。准许方法：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4f5416775849" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4f5416775849-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f5416775849-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4f5416775849-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f5416775849-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4f5416775849-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f5416775849-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4f5416775849-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f5416775849-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4f5416775849-1"><span class="crayon-c"># 获得CSR列表</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f5416775849-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">csr</span></div><div class="crayon-line" id="crayon-634f9a69ba4f5416775849-3"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; REQUESTOR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CONDITION</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f5416775849-4"><span class="crayon-c"># node-csr-c69HXe7aYcqkS1bKmH4faEnHAWxn6i2bHZ2mD04jZyQ&nbsp;&nbsp; 18s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; system:bootstrap:878f07&nbsp;&nbsp; Pending</span></div><div class="crayon-line" id="crayon-634f9a69ba4f5416775849-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f5416775849-6"><span class="crayon-c"># 准许CSR</span></div><div class="crayon-line" id="crayon-634f9a69ba4f5416775849-7"><span class="crayon-e">kubectl </span><span class="crayon-e">certificate </span><span class="crayon-e">approve </span><span class="crayon-v">node</span><span class="crayon-o">-</span><span class="crayon-v">csr</span><span class="crayon-o">-</span><span class="crayon-v">c69HXe7aYcqkS1bKmH4faEnHAWxn6i2bHZ2mD04jZyQ</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f5416775849-8"><span class="crayon-c"># certificatesigningrequest "node-csr-c69HXe7aYcqkS1bKmH4faEnHAWxn6i2bHZ2mD04jZyQ" approved</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->

</td>
</tr>
<tr>
<td>
<p><em>关闭对集群信息ConfigMap的开放访问</em>
</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">kubeadm upgrade</span></div>
<p>升级一个K8S集群到更新的版本，它将复杂的升级逻辑包装到单条命令当中。</p>
<div class="blog_h2"><span class="graybg">kubeadm token</span></div>
<p>管理用于kubeadm join的令牌：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4f9176730962" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4f9176730962-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f9176730962-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba4f9176730962-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f9176730962-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba4f9176730962-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f9176730962-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba4f9176730962-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba4f9176730962-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4f9176730962-1"><span class="crayon-c"># 创建Bootstrap令牌</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f9176730962-2"><span class="crayon-e">kubeadm </span><span class="crayon-e">token </span><span class="crayon-i">create</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">token</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba4f9176730962-3"><span class="crayon-c"># 删除Bootstrap令牌</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f9176730962-4"><span class="crayon-e">kubeadm </span><span class="crayon-e">token </span><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">token</span><span class="crayon-o">-</span><span class="crayon-v">value</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba4f9176730962-5"><span class="crayon-c"># 产生一个Bootstrap令牌，打印到屏幕上，但是不创建令牌对象</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f9176730962-6"><span class="crayon-e">kubeadm </span><span class="crayon-e">token </span><span class="crayon-v">generate</span></div><div class="crayon-line" id="crayon-634f9a69ba4f9176730962-7"><span class="crayon-c"># 列出令牌</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba4f9176730962-8"><span class="crayon-e">kubeadm </span><span class="crayon-e">token </span><span class="crayon-v">list</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<div class="blog_h2"><span class="graybg">kubeadm reset</span></div>
<p>撤销init/join命令对宿主机做出的任何改变。</p>
<p>如果使用外部etcd，则需要手工清除其中的数据：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba4fd315563195" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba4fd315563195-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba4fd315563195-1"><span class="crayon-e">etcdctl </span><span class="crayon-i">del</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">prefix</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<div class="blog_h2"><span class="graybg">集群搭建实例</span></div>
<p>本集群由4台KVM虚拟机构成，静态IP地址分别为10.0.0.100-105，其中10.0.0.100作为Master节点。</p>
<p>由于本地网络访问Google存在困难，因此Docker镜像已经在云端下载并覆盖到各虚拟机。</p>
<div class="blog_h3"><span class="graybg"><a id="with-calico"></a>基于Calico</span></div>
<p>集群初始化：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba501353843339" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba501353843339-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba501353843339-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba501353843339-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba501353843339-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba501353843339-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba501353843339-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba501353843339-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba501353843339-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba501353843339-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba501353843339-1"><span class="crayon-c"># 访问Google需要代理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba501353843339-2"><span class="crayon-e">export </span><span class="crayon-v">http_proxy</span><span class="crayon-o">=</span><span class="crayon-s">"http://10.0.0.1:8088/"</span></div><div class="crayon-line" id="crayon-634f9a69ba501353843339-3"><span class="crayon-e">export </span><span class="crayon-v">https_proxy</span><span class="crayon-o">=</span><span class="crayon-s">"http://10.0.0.1:8088/"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba501353843339-4"><span class="crayon-c"># 如果要使用其它CIDR，修改calico.yaml中的CALICO_IPV4POOL_CIDR</span></div><div class="crayon-line" id="crayon-634f9a69ba501353843339-5"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">advertise</span><span class="crayon-o">-</span><span class="crayon-i">address</span><span class="crayon-h"> </span><span class="crayon-cn">10.0.0.100</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">cidr</span><span class="crayon-o">=</span><span class="crayon-cn">192.168.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba501353843339-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">service</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-e">domain&nbsp;&nbsp;</span><span class="crayon-v">k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-i">version</span><span class="crayon-h"> </span><span class="crayon-cn">1.9.0</span></div><div class="crayon-line" id="crayon-634f9a69ba501353843339-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba501353843339-8"><span class="crayon-c"># 拷贝kubeconfig</span></div><div class="crayon-line" id="crayon-634f9a69ba501353843339-9"><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-r">chown</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">u</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">g</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

<p>完毕后，创建基于Calico的CNI网络：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba506676402028" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba506676402028-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba506676402028-1"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">docs</span><span class="crayon-e">.projectcalico</span><span class="crayon-e">.org</span><span class="crayon-o">/</span><span class="crayon-v">v3</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span><span class="crayon-o">/</span><span class="crayon-v">getting</span><span class="crayon-o">-</span><span class="crayon-v">started</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">installation</span><span class="crayon-o">/</span><span class="crayon-v">hosted</span><span class="crayon-o">/</span><span class="crayon-v">kubeadm</span><span class="crayon-o">/</span><span class="crayon-cn">1.7</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>等待所有控制平面组件Ready：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba50a273657677" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba50a273657677-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba50a273657677-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba50a273657677-1"><span class="crayon-c"># 根据下面的命令输出判断</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba50a273657677-2"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">all</span><span class="crayon-o">-</span><span class="crayon-v">namespaces</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>准备加入Worker节点，如果忘记了令牌，可以 这样查看：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba50e471260419" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba50e471260419-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba50e471260419-1"><span class="crayon-e">kubeadm </span><span class="crayon-e">token </span><span class="crayon-v">list</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>下面到Worker节点上执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba511271410283" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba511271410283-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba511271410283-1"><span class="crayon-e">kubeadm </span><span class="crayon-r">join</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">token </span><span class="crayon-v">f467bb</span><span class="crayon-sy">.</span><span class="crayon-cn">0cd7f59a071919a8</span><span class="crayon-h"> </span><span class="crayon-cn">10.0.0.15</span><span class="crayon-o">:</span><span class="crayon-cn">6443</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">discovery</span><span class="crayon-o">-</span><span class="crayon-v">token</span><span class="crayon-o">-</span><span class="crayon-v">unsafe</span><span class="crayon-o">-</span><span class="crayon-v">skip</span><span class="crayon-o">-</span><span class="crayon-v">ca</span><span class="crayon-o">-</span><span class="crayon-v">verification</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>可以拷贝Master上的kubeconfig，以便在Worker上执行集群管理：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba515495593218" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba515495593218-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba515495593218-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba515495593218-1"><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba515495593218-2"><span class="crayon-e">scp </span><span class="crayon-v">root</span><span class="crayon-sy">@</span><span class="crayon-cn">10.0.0.15</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>依次加入所有工作节点。然后验证所有节点均正常：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba519374104264" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba519374104264-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba519374104264-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba519374104264-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba519374104264-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba519374104264-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba519374104264-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba519374104264-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba519374104264-2"><span class="crayon-c"># NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATUS&nbsp;&nbsp;&nbsp;&nbsp;ROLES&nbsp;&nbsp;&nbsp;&nbsp; AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VERSION</span></div><div class="crayon-line" id="crayon-634f9a69ba519374104264-3"><span class="crayon-c"># xenial-15&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp; master&nbsp;&nbsp;&nbsp;&nbsp;12h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v1.9.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba519374104264-4"><span class="crayon-c"># xenial-16&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v1.9.0</span></div><div class="crayon-line" id="crayon-634f9a69ba519374104264-5"><span class="crayon-c"># xenial-17&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba519374104264-6"><span class="crayon-c"># xenial-18&nbsp;&nbsp; Ready&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1.9.0</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>下面测试Pod联通性。先创建一个Pod：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba51d244211484" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba51d244211484-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba51d244211484-1"><span class="crayon-e">kubectl </span><span class="crayon-v">create</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">alex</span><span class="crayon-o">/</span><span class="crayon-v">Vmware</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">/</span><span class="crayon-v">pods</span><span class="crayon-o">/</span><span class="crayon-v">busybox</span><span class="crayon-o">/</span><span class="crayon-r">sleep</span><span class="crayon-o">-</span><span class="crayon-cn">600.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba521986020989" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">sleep-600.yaml</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba521986020989-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba521986020989-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba521986020989-1"><span class="crayon-c"># Pod规格如下：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-2"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line" id="crayon-634f9a69ba521986020989-3"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba521986020989-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: sleep-600</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba521986020989-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: sleep-600</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-8"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba521986020989-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: sleep-600-container</span></div><div class="crayon-line" id="crayon-634f9a69ba521986020989-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba521986020989-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'sleep<span class="crayon-h"> </span>600'<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>获得此Pod的基本信息：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba525743871059" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba525743871059-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba525743871059-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba525743871059-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba525743871059-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba525743871059-1"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-e">pod </span><span class="crayon-r">sleep</span><span class="crayon-o">-</span><span class="crayon-cn">600</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">Node</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba525743871059-2"><span class="crayon-c"># Node: xenial-17/10.0.0.17</span></div><div class="crayon-line" id="crayon-634f9a69ba525743871059-3"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-e">pod </span><span class="crayon-r">sleep</span><span class="crayon-o">-</span><span class="crayon-cn">600</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">IP</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba525743871059-4"><span class="crayon-c"># IP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.227.1</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>尝试在Master节点上Ping此Pod，成功。然后在创建另外一个Pod，Ping它：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba529255606695" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba529255606695-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba529255606695-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba529255606695-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-2"><span class="crayon-s ">kind</span><span class="">: Podkind</span><span class="">: ConfigMap</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-3"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-4"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-5"><span class="crayon-h"> </span><span class="crayon-s ">name</span><span class="">: calico-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-6"><span class="crayon-h"> </span><span class="crayon-s ">namespace</span><span class="">: kube-system</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-7"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-8"><span class="crayon-h"> </span><span class="crayon-c"># The location of your etcd cluster. This uses the Service clusterIP defined below.</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-9"><span class="crayon-h"> </span><span class="crayon-s ">etcd_endpoints</span><span class="">: "http</span><span class="">://10.5.38.24</span><span class="">:2379</span><span class="crayon-o">,</span><span class="crayon-s ">http</span><span class="">://10.5.38.39</span><span class="">:2379</span><span class="crayon-o">,</span><span class="crayon-s ">http</span><span class="">://10.5.39.41</span><span class="">:2379"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-10"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: ping</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">labels</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">app</span><span class="">: ping</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-14"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: ping-container</span></div><div class="crayon-line" id="crayon-634f9a69ba529255606695-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">image</span><span class="">: busybox</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba529255606695-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">command</span><span class="">: ['sh'</span><span class="crayon-o">,</span><span class="crayon-h"> </span>'-c'<span class="crayon-o">,</span><span class="crayon-h"> </span>'ping<span class="crayon-h"> </span>192<span class="crayon-o">.</span>168<span class="crayon-o">.</span>227<span class="crayon-o">.</span>1'<span class="crayon-o">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<p>然后查看日志确认两个Pod可以联通：
			<span id="crayon-634f9a69ba55c142018580" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">logs </span><span class="crayon-v">ping</span></span></span></p>
<div class="blog_h3"><span class="graybg">提供根密钥对</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba560194930894" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba560194930894-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba560194930894-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba560194930894-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba560194930894-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba560194930894-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba560194930894-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba560194930894-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba560194930894-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba560194930894-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba560194930894-1"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba560194930894-2"><span class="crayon-c"># 将加密的私钥转换为明文，根据提示输入密码</span></div><div class="crayon-line" id="crayon-634f9a69ba560194930894-3"><span class="crayon-e">openssl </span><span class="crayon-v">rsa</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">ca</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">ca</span><span class="crayon-e">.key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba560194930894-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba560194930894-5"><span class="crayon-c"># 到Master节点执行：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba560194930894-6"><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span></div><div class="crayon-line" id="crayon-634f9a69ba560194930894-7"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba560194930894-8"><span class="crayon-e">scp </span><span class="crayon-v">alex</span><span class="crayon-sy">@</span><span class="crayon-v">zircon</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">alex</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span></div><div class="crayon-line" id="crayon-634f9a69ba560194930894-9"><span class="crayon-e">scp </span><span class="crayon-v">alex</span><span class="crayon-sy">@</span><span class="crayon-v">zircon</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">alex</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-v">ca</span><span class="crayon-e">.key</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0034 seconds] -->

<div class="blog_h3"><span class="graybg">拷贝配置到客户端</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba564900314374" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba564900314374-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba564900314374-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba564900314374-1"><span class="crayon-c"># 在客户端机器（不是Kubernetes集群成员，仅仅使用kubectl命令）上执行：</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba564900314374-2"><span class="crayon-v">scp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">Documents</span><span class="crayon-o">/</span><span class="crayon-v">puTTY</span><span class="crayon-o">/</span><span class="crayon-v">gmem</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">@</span><span class="crayon-v">xenial</span><span class="crayon-o">-</span><span class="crayon-cn">100.gmem.cc</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<div class="blog_h3"><span class="graybg">基于Flannel</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba569856535224" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba569856535224-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba569856535224-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba569856535224-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba569856535224-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba569856535224-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba569856535224-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba569856535224-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba569856535224-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba569856535224-1"><span class="crayon-e">export </span><span class="crayon-v">http_proxy</span><span class="crayon-o">=</span><span class="crayon-s">"http://10.0.0.1:8088/"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba569856535224-2"><span class="crayon-e">export </span><span class="crayon-v">https_proxy</span><span class="crayon-o">=</span><span class="crayon-s">"http://10.0.0.1:8088/"</span></div><div class="crayon-line" id="crayon-634f9a69ba569856535224-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba569856535224-4"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">advertise</span><span class="crayon-o">-</span><span class="crayon-i">address</span><span class="crayon-h"> </span><span class="crayon-cn">10.0.0.100</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">service</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-e">domain&nbsp;&nbsp;</span><span class="crayon-v">k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">network</span><span class="crayon-o">-</span><span class="crayon-v">cidr</span><span class="crayon-o">=</span><span class="crayon-cn">10.244.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-i">version</span><span class="crayon-h"> </span><span class="crayon-cn">1.9.0</span></div><div class="crayon-line" id="crayon-634f9a69ba569856535224-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba569856535224-6"><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-r">chown</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">u</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r">id</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">g</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-e">config</span></div><div class="crayon-line" id="crayon-634f9a69ba569856535224-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba569856535224-8"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">raw</span><span class="crayon-e">.githubusercontent</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">coreos</span><span class="crayon-o">/</span><span class="crayon-v">flannel</span><span class="crayon-o">/</span><span class="crayon-v">v0</span><span class="crayon-sy">.</span><span class="crayon-cn">9.1</span><span class="crayon-o">/</span><span class="crayon-v">Documentation</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">flannel</span><span class="crayon-e">.yml</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0045 seconds] -->

<div class="blog_h2"><span class="graybg">Master高可用</span></div>
<p>K8S要实现Master高可用，需要解决两个问题：</p>
<ol>
<li>Etcd的高可用，Etcd用于所有K8S状态信息的存储。建议在物理机上部署Etcd集群</li>
<li>API Server的高可用/负载均衡。任何四层代理均可，例如Nginx、LVS</li>
</ol>
<p>我们的方案是：Etcd三节点物理机部署、API Server三节点通过LVS负载均衡，架构图如下：</p>
<p><a href="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-master-ha.png"><img class="aligncenter  wp-image-22661" src="https://blog.gmem.cc/wp-content/uploads/2016/06/k8s-master-ha.png" alt="k8s-master-ha" width="924" height="284" /></a> </p>
<div class="blog_h3"><span class="graybg">实施步骤</span></div>
<ol>
<li>在物理节点上安装、配置好Etcd集群</li>
<li>在一台Master节点上执行
			<span id="crayon-634f9a69ba56d735573191" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span></span></span></li>
<li>将/etc/kubernetes目录拷贝到其它Master节点</li>
<li>在其它Master节点上执行
			<span id="crayon-634f9a69ba571323923416" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubeadm </span><span class="crayon-v">init</span></span></span></li>
<li>配置LVS和Keepalived，作为API Server的负载均衡器</li>
<li>安装CNI，然后加入节点</li>
</ol>
<p>Kubeadm配置文件样例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba575415924519" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba575415924519-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba575415924519-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba575415924519-1"><span class="crayon-s ">apiVersion</span><span class="">: kubeadm.k8s.io/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-2"><span class="crayon-s ">kind</span><span class="">: MasterConfiguration</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-3"><span class="crayon-s ">api</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 这里填写虚IP</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">advertiseAddress</span><span class="">: 10.0.10.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-6"><span class="crayon-s ">etcd</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c"># 填写Etcd集群端点</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">endpoints</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- http</span><span class="">://10.0.1.1</span><span class="">:2379</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- http</span><span class="">://10.0.2.1</span><span class="">:2379</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- http</span><span class="">://10.0.3.1</span><span class="">:2379</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-12"><span class="crayon-s ">networking</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">podSubnet</span><span class="">: 172.27.0.0/16</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-14"><span class="crayon-s ">kubernetesVersion</span><span class="">: 1.10.2</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-15"><span class="crayon-s ">imageRepository</span><span class="">: docker.gmem.cc/k8s</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-16"><span class="crayon-s ">apiServerCertSANs</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba575415924519-17">-<span class="crayon-h"> </span>10<span class="crayon-o">.</span>0<span class="crayon-o">.</span>10<span class="crayon-o">.</span>1</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-18">-<span class="crayon-h"> </span>10<span class="crayon-o">.</span>0<span class="crayon-o">.</span>1<span class="crayon-o">.</span>1</div><div class="crayon-line" id="crayon-634f9a69ba575415924519-19">-<span class="crayon-h"> </span>10<span class="crayon-o">.</span>0<span class="crayon-o">.</span>2<span class="crayon-o">.</span>1</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-20">-<span class="crayon-h"> </span>10<span class="crayon-o">.</span>0<span class="crayon-o">.</span>3<span class="crayon-o">.</span>1</div><div class="crayon-line" id="crayon-634f9a69ba575415924519-21"><span class="crayon-s ">apiServerExtraArgs</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba575415924519-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiserver-count</span><span class="">: "3"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<div class="blog_h1"><span class="graybg">集群搭建（手工） </span></div>
<p>本章记录在Fedora 24上从零开始搭建K8S集群的详细步骤。</p>
<div class="blog_h2"><span class="graybg">准备阶段</span></div>
<div class="blog_h3"><span class="graybg">云服务</span></div>
<p>使用云服务时，你可能需要获取Cloud Provider，以管理TCP负载均衡、节点、网络路由。如果在本地VM、裸机上部署则不需要。</p>
<div class="blog_h3"><span class="graybg">节点</span></div>
<p>所有集群节点均应该是amd64的Linux。APIServer+etcd需要在1核/1G内存（10节点集群）或者更好的机器上运行。</p>
<div class="blog_h3"><span class="graybg">网络</span></div>
<p>K8S使用了特殊的网络模型。它会为每个Pod分配IP，你需要指定一个IP地址范围供Pod使用。Pod之间的连接性有两种达成途径：</p>
<ol>
<li>基于Overlay网络：基于流量封装，对Pod网络隐藏底层网络结构</li>
<li>不使用Overlay网络：配置底层设备（例如交换机）让其知晓Pod地址，不需要Overlay的那种封装，性能会更好</li>
</ol>
<p>具体实现方式，包括：</p>
<ol>
<li>使用CNI网络插件，例如Calico、Flannel、Weave</li>
<li>将Cloud Provider模块的Routes接口实现，直接编译到K8S中</li>
<li>在外部配置网络路由</li>
</ol>
<div class="blog_h3"><span class="graybg">网络策略</span></div>
<p>用于细粒度单Pod间网络流量控制，并非所有的网络实现支持。</p>
<div class="blog_h3"><span class="graybg">集群命名</span></div>
<p>你需要为每个集群起一个唯一性的名字，其用途为：</p>
<ol>
<li>kubectl用它来区分需要连接到哪个集群</li>
<li>区分属于不同集群的CloudProvider资源</li>
</ol>
<div class="blog_h3"><span class="graybg">需要的软件</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 15%; text-align: center;">软件</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>etcd</td>
<td>存放集群数据的分布式存储</td>
</tr>
<tr>
<td>CRI</td>
<td>容器运行时，Docker或rkt</td>
</tr>
<tr>
<td>K8S</td>
<td>kubelet、kube-proxy、kube-apiserver、kube-controller-manager、kube-scheduler</td>
</tr>
</tbody>
</table>
<p>这些软件都可以通过<a href="https://github.com/kubernetes/kubernetes/releases/tag/v1.9.0">K8S二进制发行版</a>获得。</p>
<p>Docker、Kubelet、Kube-Proxy在容器外部运行。</p>
<div class="blog_h3"><span class="graybg">需要的镜像</span></div>
<p>etcd、kube-apiserver、kube-controller-manager、 kube-scheduler则推荐以容器的方式运行。</p>
<p>获取K8S组件相关镜像的途径包括：</p>
<ol>
<li>使用GCR（Google Container Registry）提供的镜像：
<ol>
<li>例如gcr.io/google-containers/hyperkube:$TAG，其中TAG要和Kubelet/Kube-Proxy版本一致</li>
<li>此外<a href="https://releases.k8s.io/master/cmd/hyperkube">hyperkube</a>提供了All in On的二进制文件，使用hyperkube apiserver可以运行APIServer</li>
</ol>
</li>
<li>构建自己的镜像，如果打算搭建私服，可以使用该方式。二进制发行版中的./kubernetes/server/bin/kube-apiserver.tar可以被转换为Docker镜像：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba57b631274072" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba57b631274072-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba57b631274072-1"><span class="crayon-e">docker </span><span class="crayon-v">load</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">apiserver</span><span class="crayon-e">.tar</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

</li>
</ol>
<p>获取etcd镜像的途径包括：</p>
<ol>
<li>使用GCR提供的镜像，例如gcr.io/google-containers/etcd:2.2.1</li>
<li>使用DockerHub或者Quay提供镜像，例如quay.io/coreos/etcd:v2.2.1</li>
<li>构建自己的镜像：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba57f246130154" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba57f246130154-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba57f246130154-1"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">cluster</span><span class="crayon-o">/</span><span class="crayon-v">images</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-r">make</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
</p>
<p> 推荐使用K8S二进制发行版中附带的etcd</p>
</li>
</ol>
<div class="blog_h3"><span class="graybg">选择安全模型</span></div>
<p>两种访问APIServer的方式：</p>
<ol>
<li>使用HTTP，需要利用防火墙保证安全</li>
<li>使用HTTPS ，推荐的方式，需要制作数字证书：
<ol>
<li>Master需要数字证书，因为它的APIServer暴露HTTPS服务</li>
<li>Kubelet需要（可选）数字证书，用于：
<ol>
<li>APIServer的双向认证</li>
<li>自己也暴露HTTPS服务</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>除非你想花钱购买证书，否则都需要首先生成根CA密钥对并自签名，然后用根证书对Master、kubelet进行签名。</p>
<p>管理员（或其它用户）需要一个表明自己身份的令牌（密码），令牌仅仅是一个数字+字母的字符串。</p>
<div class="blog_h2"><span class="graybg">详细步骤记录</span></div>
<div class="blog_h3"><span class="graybg">准备软件</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba583912460978" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba583912460978-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba583912460978-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba583912460978-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba583912460978-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba583912460978-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba583912460978-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba583912460978-1"><span class="crayon-e">wget </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">github</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">releases</span><span class="crayon-o">/</span><span class="crayon-v">download</span><span class="crayon-o">/</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-e">.tar</span><span class="crayon-e">.gz</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba583912460978-2"><span class="crayon-e">tar </span><span class="crayon-e">xzf </span><span class="crayon-v">kubernetes</span><span class="crayon-e">.tar</span><span class="crayon-e">.gz</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-r">rm</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span><span class="crayon-e">.tar</span><span class="crayon-e">.gz</span></div><div class="crayon-line" id="crayon-634f9a69ba583912460978-3"><span class="crayon-c"># 下载客户端、服务器二进制文件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba583912460978-4"><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">cluster</span><span class="crayon-o">/</span><span class="crayon-r">get</span><span class="crayon-o">-</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">binaries</span><span class="crayon-e">.sh</span></div><div class="crayon-line" id="crayon-634f9a69ba583912460978-5"><span class="crayon-c"># 下载的服务器文件位于 .kubernetes/server/kubernetes-server-linux-amd64.tar.gz</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba583912460978-6"><span class="crayon-c"># 下载的客户端文件位于 .kubernetes/client/kubernetes-client-linux-amd64.tar.gz</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>安装Docker：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba587524244385" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba587524244385-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba587524244385-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba587524244385-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba587524244385-1"><span class="crayon-e">yum </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-v">docker</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba587524244385-2"><span class="crayon-c"># 启动Docker</span></div><div class="crayon-line" id="crayon-634f9a69ba587524244385-3"><span class="crayon-e">systemctl </span><span class="crayon-e">enable </span><span class="crayon-v">docker</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-e">systemctl </span><span class="crayon-e">start </span><span class="crayon-v">docker</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>安装镜像：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba58b253986511" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba58b253986511-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba58b253986511-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba58b253986511-1"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-2"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-o">/</span><span class="crayon-v">node</span><span class="crayon-o">:</span><span class="crayon-v">v2</span><span class="crayon-sy">.</span><span class="crayon-cn">6.5</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-3"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">controllers</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">0.2</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-4"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-o">/</span><span class="crayon-v">cni</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">11.2</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-5"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-6"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-7"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">controller</span><span class="crayon-o">-</span><span class="crayon-v">manager</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-8"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">scheduler</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">9.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-9"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">weaveworks</span><span class="crayon-o">/</span><span class="crayon-v">weave</span><span class="crayon-o">-</span><span class="crayon-v">npc</span><span class="crayon-o">:</span><span class="crayon-cn">2.1.3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-10"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">weaveworks</span><span class="crayon-o">/</span><span class="crayon-v">weave</span><span class="crayon-o">-</span><span class="crayon-v">kube</span><span class="crayon-o">:</span><span class="crayon-cn">2.1.3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-11"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">coreos</span><span class="crayon-o">/</span><span class="crayon-v">flannel</span><span class="crayon-o">:</span><span class="crayon-v">v0</span><span class="crayon-sy">.</span><span class="crayon-cn">9.1</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-12"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">coreos</span><span class="crayon-o">/</span><span class="crayon-v">flannel</span><span class="crayon-o">:</span><span class="crayon-v">v0</span><span class="crayon-sy">.</span><span class="crayon-cn">9.1</span><span class="crayon-o">-</span><span class="crayon-e">amd64</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-13"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-v">sidecar</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-cn">1.14.7</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-14"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-cn">1.14.7</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-15"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">-</span><span class="crayon-v">dns</span><span class="crayon-o">-</span><span class="crayon-v">dnsmasq</span><span class="crayon-o">-</span><span class="crayon-v">nanny</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-cn">1.14.7</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-16"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-o">/</span><span class="crayon-v">node</span><span class="crayon-o">:</span><span class="crayon-v">v2</span><span class="crayon-sy">.</span><span class="crayon-cn">6.2</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-17"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">calico</span><span class="crayon-o">/</span><span class="crayon-v">cni</span><span class="crayon-o">:</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">11.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-18"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-cn">3.1.10</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-634f9a69ba58b253986511-19"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">quay</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">coreos</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-o">:</span><span class="crayon-v">v3</span><span class="crayon-sy">.</span><span class="crayon-cn">1.10</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba58b253986511-20"><span class="crayon-e">docker </span><span class="crayon-e">pull </span><span class="crayon-v">gcr</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span><span class="crayon-o">/</span><span class="crayon-v">pause</span><span class="crayon-o">-</span><span class="crayon-v">amd64</span><span class="crayon-o">:</span><span class="crayon-cn">3.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0108 seconds] -->

<p>考虑到网络速度问题，将上述镜像Tag为私服镜像。实际编写K8S对象规格时，都使用私服镜像：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="text-align: center;">源镜像</td>
<td style="text-align: center;">本地私服镜像</td>
</tr>
</thead>
<tbody>
<tr>
<td>quay.io/calico/node:v2.6.5</td>
<td>docker.gmem.cc/calico/node</td>
</tr>
<tr>
<td>quay.io/calico/kube-controllers:v1.0.2</td>
<td>docker.gmem.cc/calico/kube-controllers</td>
</tr>
<tr>
<td>quay.io/calico/cni:v1.11.2</td>
<td>docker.gmem.cc/calico/cni</td>
</tr>
<tr>
<td>gcr.io/google_containers/kube-proxy-amd64:v1.9.0</td>
<td>docker.gmem.cc/kube-proxy-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/kube-apiserver-amd64:v1.9.0</td>
<td>docker.gmem.cc/kube-apiserver-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/kube-controller-manager-amd64:v1.9.0</td>
<td>docker.gmem.cc/kube-controller-manager-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/kube-scheduler-amd64:v1.9.0</td>
<td>docker.gmem.cc/kube-scheduler-amd64</td>
</tr>
<tr>
<td>weaveworks/weave-npc:2.1.3</td>
<td>docker.gmem.cc/weave-npc</td>
</tr>
<tr>
<td>weaveworks/weave-kube:2.1.3</td>
<td>docker.gmem.cc/weave-kube</td>
</tr>
<tr>
<td>quay.io/coreos/flannel:v0.9.1-amd64</td>
<td>docker.gmem.cc/flannel</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.7</td>
<td>docker.gmem.cc/k8s-dns-sidecar-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.7</td>
<td>docker.gmem.cc/k8s-dns-kube-dns-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7</td>
<td>docker.gmem.cc/k8s-dns-dnsmasq-nanny-amd64</td>
</tr>
<tr>
<td>gcr.io/google_containers/etcd-amd64:3.1.10</td>
<td>docker.gmem.cc/etcd-amd64</td>
</tr>
</tbody>
</table>
<div class="blog_h1"><span class="graybg">GUI工具</span></div>
<div class="blog_h2"><span class="graybg">Dashboard</span></div>
<p>Kubernetes Dashboard是一个一般性用途的基于Web的UI工具。使用该工具你可以管理K8S集群中的应用程序，以及集群本身。</p>
<p>执行下面的命令部署Dashboard：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba590354061402" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba590354061402-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba590354061402-1"><span class="crayon-e">kubectl </span><span class="crayon-v">apply</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">dashboard</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-v">dashboard</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>然后，你可以：</p>
<ol>
<li>客户端运行
			<span id="crayon-634f9a69ba595422368055" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-v">proxy</span></span></span>，并通过浏览器访问http://localhost:8001/ui，使用仪表盘</li>
<li>或者，直接访问https://kubernetes-dashboard.kube-system.svc.k8s.gmem.cc</li>
</ol>
<div class="blog_h3"><span class="graybg">使用SSL证书</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba599542016969" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba599542016969-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba599542016969-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba599542016969-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba599542016969-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba599542016969-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba599542016969-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba599542016969-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba599542016969-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba599542016969-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba599542016969-1"><span class="crayon-e">openssl </span><span class="crayon-v">genrsa</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba599542016969-2"><span class="crayon-e">openssl </span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">sha256</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">key </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.csr</span></div><div class="crayon-line" id="crayon-634f9a69ba599542016969-3"><span class="crayon-e">openssl </span><span class="crayon-v">x509</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">req</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">days</span><span class="crayon-h"> </span><span class="crayon-cn">3650</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-st">in</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.csr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">CA</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">CAkey</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.key</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-v">CAcreateserial</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">out </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.crt</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba599542016969-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba599542016969-5"><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">cert</span><span class="crayon-o">/</span><span class="crayon-v">dashboard</span><span class="crayon-e">.key</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba599542016969-6"><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span><span class="crayon-e">.svc</span><span class="crayon-e">.k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">cert</span><span class="crayon-o">/</span><span class="crayon-v">dashboard</span><span class="crayon-e">.crt</span></div><div class="crayon-line" id="crayon-634f9a69ba599542016969-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba599542016969-8"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">secret </span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-v">dashboard</span><span class="crayon-o">-</span><span class="crayon-v">certs</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system</span></div><div class="crayon-line" id="crayon-634f9a69ba599542016969-9"><span class="crayon-e">kubectl </span><span class="crayon-e">create </span><span class="crayon-e">secret </span><span class="crayon-e">generic </span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-v">dashboard</span><span class="crayon-o">-</span><span class="crayon-v">certs</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">-</span><span class="crayon-r">file</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">cert</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">system</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0064 seconds] -->

<div class="blog_h3"><span class="graybg">登陆仪表盘</span></div>
<p>建议使用Token。首先创建一个SA：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba59d489913988" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba59d489913988-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba59d489913988-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba59d489913988-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-2"><span class="crayon-s ">kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: admin</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-6"><span class="crayon-s ">imagePullSecrets</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-7"><span class="crayon-s ">- name</span><span class="">: gmemregsecret</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-8">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-9"><span class="crayon-o">---</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-10">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-11"><span class="crayon-s ">kind</span><span class="">: ClusterRoleBinding</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-12"><span class="crayon-s ">apiVersion</span><span class="">: rbac.authorization.k8s.io/v1</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-13"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: admin-role-binding</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-15"><span class="crayon-s ">subjects</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-16"><span class="crayon-s ">- kind</span><span class="">: ServiceAccount</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: admin</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">namespace</span><span class="">: default</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-19"><span class="crayon-s ">roleRef</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">kind</span><span class="">: ClusterRole</span></div><div class="crayon-line" id="crayon-634f9a69ba59d489913988-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">name</span><span class="">: cluster-admin</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba59d489913988-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">apiGroup</span><span class="">: rbac.authorization.k8s.io</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>然后查找此admin用户的secret：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5a1352460426" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5a1352460426-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5a1352460426-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba5a1352460426-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5a1352460426-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba5a1352460426-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5a1352460426-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5a1352460426-1"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-e">sa </span><span class="crayon-v">admin</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5a1352460426-2"><span class="crayon-c"># Mountable secrets:&nbsp;&nbsp; admin-token-msnfp</span></div><div class="crayon-line" id="crayon-634f9a69ba5a1352460426-3"><span class="crayon-c"># Tokens:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;admin-token-msnfp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5a1352460426-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba5a1352460426-5"><span class="crayon-e">kubectl </span><span class="crayon-e">describe </span><span class="crayon-e">secret </span><span class="crayon-v">admin</span><span class="crayon-o">-</span><span class="crayon-v">token</span><span class="crayon-o">-</span><span class="crayon-v">msnfp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5a1352460426-6"><span class="crayon-c"># token: ...</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>将上面的token字段拷贝出来，即可登陆。 </p>
<div class="blog_h3"><span class="graybg">配置参数</span></div>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Dashboard-arguments">仪表盘的配置参数</a>，可以通过修改Deployment对象设置：</p>
<p style="padding-left: 30px;">- --token-ttl=0  会话过期时间，默认15分钟，设置为0永不过期</p>
<div class="blog_h2"><span class="graybg">Kubernetic</span></div>
<p>Kubernetic是一个支持OS X/Linux/Windows的桌面应用，可以查看各类K8S资源的状态。</p>
<div class="blog_h1"><span class="graybg">监控</span></div>
<div class="blog_h2"><span class="graybg">Grafana</span></div>
<p>这是一个优秀的、美观的开源时间序列数据分析、展示平台。</p>
<p>请参考：<a href="https://blog.gmem.cc/time-series-data-renderering-with-grafana">使用Grafana展示时间序列数据</a></p>
<div class="blog_h1"><span class="graybg">操控Etcd</span></div>
<div class="blog_h2"><span class="graybg">连接到Etcd</span></div>
<p>如果是通过kubeadm安装的单节点Master，可以在Master节点上执行：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5a6961740790" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5a6961740790-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5a6961740790-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba5a6961740790-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5a6961740790-1"><span class="crayon-v">ETCDCTL_API</span><span class="crayon-o">=</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-v">etcdctl</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">endpoints</span><span class="crayon-o">=</span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-cn">127.0.0.1</span><span class="crayon-o">:</span><span class="crayon-cn">2379</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5a6961740790-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cacert</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-o">/</span><span class="crayon-v">ca</span><span class="crayon-e">.crt</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">key</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-o">/</span><span class="crayon-v">peer</span><span class="crayon-e">.key</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba5a6961740790-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">cert</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">etcd</span><span class="crayon-o">/</span><span class="crayon-v">peer</span><span class="crayon-e">.crt</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0026 seconds] -->

<div class="blog_h2"><span class="graybg">基础操作</span></div>
<div class="blog_h3"><span class="graybg">搜索键</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5aa115294748" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5aa115294748-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5aa115294748-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5aa115294748-1"><span class="crayon-c"># 全文搜索 functions.kubeless</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5aa115294748-2"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">registry</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">prefix</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-v">json</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">jq</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-s">'.kvs[] | [.key,.value] | .[] '</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">base64</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-s">"functions.kubeless"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<div class="blog_h3"><span class="graybg">删除键</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5ae593246555" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5ae593246555-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5ae593246555-1"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-v">del</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">registry</span><span class="crayon-o">/</span><span class="crayon-v">apiextensions</span><span class="crayon-e">.k8s</span><span class="crayon-e">.io</span><span class="crayon-o">/</span><span class="crayon-v">customresourcedefinitions</span><span class="crayon-o">/</span><span class="crayon-v">functions</span><span class="crayon-e">.kubeless</span><span class="crayon-e">.io</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<div class="blog_h1"><span class="graybg">命令行参数</span></div>
<div class="blog_h2"><span class="graybg">kube-apiserver</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 35%; text-align: center;">参数</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td>--advertise-address</td>
<td>
<p>在什么地址上声明当前API Server是集群的成员之一。指定的IP地址必须可以被集群的所有节点访问到</p>
<p>如果为空，默认使用--bind-address</p>
</td>
</tr>
<tr>
<td>--cors-allowed-origins strings</td>
<td>允许CORS的源列表</td>
</tr>
<tr>
<td>--external-hostname</td>
<td>生成外部URL时（例如Swagger API文档）时，当前master的主机名</td>
</tr>
<tr>
<td>--feature-gates mapStringBool</td>
<td>用于开启或关闭特性</td>
</tr>
<tr>
<td>--max-mutating-requests-inflight int</td>
<td>等待处理的写请求最大数量，默认200，超过后API Server拒绝请求</td>
</tr>
<tr>
<td>--max-requests-inflight int</td>
<td>等待处理的读请求最大数量，默认400，超过后API Server拒绝请求</td>
</tr>
<tr>
<td>--min-request-timeout int</td>
<td>最小请求超时，API Server认定一个请求超时之前必须经过的时间，默认1800，此参数仅仅被watch请求使用，覆盖--request-timeout </td>
</tr>
<tr>
<td>--request-timeout duration</td>
<td>请求超时，默认1m0s</td>
</tr>
<tr>
<td>--target-ram-mb</td>
<td>API Server的内存用量限制</td>
</tr>
<tr>
<td colspan="2"><strong><em>Etcd相关</em></strong></td>
</tr>
<tr>
<td>--default-watch-cache-size int</td>
<td>默认Watch缓存的大小，设置为0则没有默认Watch size的资源的Watch缓存被禁用，默认100</td>
</tr>
<tr>
<td>--delete-collection-workers int</td>
<td>用于DeleteCollection操作的工作线程数量，用于加速命名空间清理，默认1</td>
</tr>
<tr>
<td>--deserialization-cache-size int</td>
<td>反串行化到内存的JSON对象数量，这些对象做缓存用途</td>
</tr>
<tr>
<td>--etcd-cafile string</td>
<td>SSL证书文件</td>
</tr>
<tr>
<td>--etcd-prefix string</td>
<td>所有资源存放的路径前缀，默认/registry</td>
</tr>
<tr>
<td>--etcd-compaction-interval duration</td>
<td>压缩请求的间隔，如果为0则禁用API Server发出压缩请求，默认5m0s</td>
</tr>
<tr>
<td>--etcd-servers strings</td>
<td>需要连接到的Etcd服务器地址列表，形式scheme://ip:port,scheme://ip:port...</td>
</tr>
<tr>
<td>--etcd-servers-overrides strings</td>
<td>
<p>可以为不同资源指定不同的Etcd服务器，形式group/resource#servers，servers为Etcd服务器地址，形式如上一行</p>
</td>
</tr>
<tr>
<td>--storage-backend</td>
<td>存储后端，可选etcd3、etcd2</td>
</tr>
<tr>
<td>--storage-media-type string</td>
<td>存储MIME类型，默认application/vnd.kubernetes.protobuf</td>
</tr>
<tr>
<td>--watch-cache</td>
<td>在API Server中启用Watch缓存，默认true</td>
</tr>
<tr>
<td>--watch-cache-sizes strings</td>
<td>不同资源的Watch缓存大小，形式 resource[.group]#size</td>
</tr>
<tr>
<td colspan="2"><strong><em>安全选项</em></strong></td>
</tr>
<tr>
<td>--bind-address ip</td>
<td>在什么IP地址上监听--secure-port端口，默认0.0.0.0</td>
</tr>
<tr>
<td>--secure-port int</td>
<td>HTTPS端口</td>
</tr>
<tr>
<td>--cert-dir string</td>
<td>TLS证书存放目录，如果指定参数--tls-cert-file、--tls-private-key-file则此选项忽略</td>
</tr>
<tr>
<td>--tls-cert-file string</td>
<td>TLS证书位置</td>
</tr>
<tr>
<td>--tls-private-key-file string</td>
<td>TLS私钥位置</td>
</tr>
<tr>
<td>--insecure-bind-address ip</td>
<td>HTTP监听地址</td>
</tr>
<tr>
<td>--insecure-port</td>
<td>HTTP监听端口</td>
</tr>
<tr>
<td colspan="2"><strong><em>审计选项</em></strong></td>
</tr>
<tr>
<td>--audit-log-*</td>
<td>审计日志相关</td>
</tr>
<tr>
<td>--audit-webhook-*</td>
<td>审计Webhook相关</td>
</tr>
<tr>
<td colspan="2"><strong><em>特性选项</em></strong></td>
</tr>
<tr>
<td>--contention-profiling</td>
<td>在Profiling启用的前提下，启用锁争用Profiling</td>
</tr>
<tr>
<td>--enable-swagger-ui</td>
<td>在/swagger-ui下暴露Swagger UI</td>
</tr>
<tr>
<td colspan="2"><strong><em>身份验证</em></strong></td>
</tr>
<tr>
<td>--anonymous-auth=true</td>
<td>
<p>允许对HTTPS端口的匿名请求，没有被另外一种身份验证机制拒绝的请求被看作匿名请求</p>
<p>匿名请求的用户名为system:anonymous，组为system:unauthenticated</p>
</td>
</tr>
<tr>
<td>--authentication-token-webhook-cache-ttl</td>
<td>缓存webhook token authenticator响应的时长，默认2m0s</td>
</tr>
<tr>
<td>--authentication-token-webhook-config-file</td>
<td>
<p>用于Token验证的Webhook配置文件路径，此文件必须为kubeconfig格式</p>
<p>API Server会查询远程服务，来决定对bearer token的身份验证</p>
</td>
</tr>
<tr>
<td>--basic-auth-file string</td>
<td>如果设置，该文件用于准许通过HTTP基本认证来访问API Server的请求</td>
</tr>
<tr>
<td>--client-ca-file string</td>
<td>教研客户端证书的CA证书，<span style="background-color: #c0c0c0;">客户端身份存放在CommonName字段</span>中</td>
</tr>
<tr>
<td>--oidc-*</td>
<td>和OpenID服务有关</td>
</tr>
<tr>
<td>-requestheader-allowed-names</td>
<td>哪些客户端（通过CommonName识别）可以在 --requestheader-username-headers中提供用户名信息，如果为空，任何通过CA认证的客户端均可</td>
</tr>
<tr>
<td>--requestheader-client-ca-file</td>
<td>在信任客户端请求头中声明的username之前，需要对客户端证书进行认证，该参数指定认证时使用的CA证书</td>
</tr>
<tr>
<td>--requestheader-extra-headers-prefix</td>
<td>请求头前缀，建议X-Remote-Extra-</td>
</tr>
<tr>
<td>--requestheader-group-headers</td>
<td>用户所属组存放在什么请求头，建议X-Remote-Group</td>
</tr>
<tr>
<td>--requestheader-username-headers</td>
<td>用户名存放在什么请求头，，建议X-Remote-User</td>
</tr>
<tr>
<td>--authorization-mode</td>
<td>在安全端口上运行的授权插件列表， AlwaysAllow,AlwaysDeny,ABAC,Webhook,RBAC,Node，默认AlwaysAllow</td>
</tr>
<tr>
<td>--authorization-policy-file</td>
<td>CSV格式的授权策略文件，和--authorization-mode=ABAC连用</td>
</tr>
<tr>
<td>--authorization-webhook-cache-authorized-ttl</td>
<td>缓存来自Webhook authorizer的授权成功（authorized）响应的时长，默认5m0s</td>
</tr>
<tr>
<td>--authorization-webhook-cache-unauthorized-ttl</td>
<td>缓存来自Webhook authorizer的授权失败（unauthorized）响应的时长，默认30s</td>
</tr>
<tr>
<td>--authorization-webhook-config-file</td>
<td>kubeconfig格式的Webhook配置文件路径</td>
</tr>
<tr>
<td colspan="2"><strong><em>API开关</em></strong></td>
</tr>
<tr>
<td>--runtime-config mapStringString</td>
<td>可以用户开启/关闭特定的API版本</td>
</tr>
<tr>
<td colspan="2"><strong><em>Admission参数</em></strong></td>
</tr>
<tr>
<td>--admission-control</td>
<td>启用的准许控制器列表，此选项废弃</td>
</tr>
<tr>
<td>--admission-control-config-file</td>
<td>包含准许控制配置的文件</td>
</tr>
<tr>
<td>--disable-admission-plugins</td>
<td>禁用的准许控制器列表，即使它们默认启用</td>
</tr>
<tr>
<td>--enable-admission-plugins</td>
<td>启用的准许控制器列表</td>
</tr>
<tr>
<td colspan="2"><strong><em>杂项</em></strong></td>
</tr>
<tr>
<td>--allow-privileged=false</td>
<td>允许运行特权模式容器</td>
</tr>
<tr>
<td>--apiserver-count=1</td>
<td>集群中API Server的数量</td>
</tr>
<tr>
<td>--enable-aggregator-routing</td>
<td>允许路由请求到Endpoint IP而非Cluster IP</td>
</tr>
<tr>
<td>--enable-logs-handler=true</td>
<td>如果为true，则开启/logs端点，用于处理API Server日志</td>
</tr>
<tr>
<td>
<p>--endpoint-reconciler-type=lease</p>
</td>
<td> </td>
</tr>
<tr>
<td>--event-ttl=1h0m0s</td>
<td>事件历史的保留时间</td>
</tr>
<tr>
<td>--kubelet-certificate-authority</td>
<td>访问Kubelet的CA证书的路径</td>
</tr>
<tr>
<td>--kubelet-client-certificate</td>
<td>访问Kubelet的客户端证书路径</td>
</tr>
<tr>
<td>--kubelet-client-key</td>
<td>访问Kubelet的客户端私钥路径</td>
</tr>
<tr>
<td>--kubelet-https=true</td>
<td>通过HTTPS来访问Kubelet</td>
</tr>
<tr>
<td>
<p>--kubelet-timeout=5s</p>
</td>
<td>访问Kubelet的超时</td>
</tr>
<tr>
<td>--max-connection-bytes-per-sec</td>
<td>限流，每个用户连接每秒可以发送的字节数，当前仅仅允许长期运行的请求</td>
</tr>
<tr>
<td>--service-account-signing-key-file</td>
<td>Service Account Token Issuer的私钥路径，Issuer使用此私钥来签名issued ID token</td>
</tr>
<tr>
<td>--service-cluster-ip-range</td>
<td>Cluster IP的地址范围，默认 10.0.0.0/24</td>
</tr>
<tr>
<td>--service-node-port-range</td>
<td>NodePort范围，默认30000-32767</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">kube-proxy</span></div>
<table class=" full-width fixed-word-wrap">
<tbody>
<tr>
<td style="width: 35%; text-align: center;"><strong>参数</strong></td>
<td style="text-align: center;"><b>说明</b></td>
</tr>
<tr>
<td>--alsologtostderr</td>
<td>设置true则日志输出到stderr，也输出到日志文件</td>
</tr>
<tr>
<td>--bind-address 0.0.0.0</td>
<td>监听主机IP地址，0.0.0.0监听主机所有主机接口 ，默认0.0.0.0</td>
</tr>
<tr>
<td>--cleanup</td>
<td>如果设置为true，则清除iptables和ipvs规则并退出</td>
</tr>
<tr>
<td>--cleanup-ipvs</td>
<td>如果设置为true，在运行前kube-proxy将清除ipvs规则，默认true</td>
</tr>
<tr>
<td>--cluster-cidr string</td>
<td>集群中 Pod 的CIDR范围。集群外的发送到服务集群IP的流量将被伪装，从pod发送到外部 LoadBalancer IP的流量将被定向到相应的集群IP</td>
</tr>
<tr>
<td>--config string</td>
<td>配置文件路径</td>
</tr>
<tr>
<td>--config-sync-period duration</td>
<td>从apiserver同步配置的时间间隔，默认15m0s</td>
</tr>
<tr>
<td>--conntrack-max-per-core int32</td>
<td>
<p>每个CPU核跟踪的最大NAT连接数</p>
<p>0按原来保留限制并忽略conntrack-min，默认32768</p>
</td>
</tr>
<tr>
<td>--conntrack-min int32</td>
<td>
<p>分配的最小conntrack条目，无视conntrack-max-per-core选项</p>
<p>设置conntrack-max-per-core=0保持原始限制，默认default 131072</p>
</td>
</tr>
<tr>
<td>--conntrack-tcp-timeout-close-wait duration</td>
<td>对于TCP连接处于CLOSE_WAIT阶段的NAT超时时间，默认1h0m0s</td>
</tr>
<tr>
<td>--conntrack-tcp-timeout-established duration</td>
<td>TCP连接的空闲超时，默认24h0m0s</td>
</tr>
<tr>
<td>--feature-gates mapStringBool</td>
<td>打开特性</td>
</tr>
<tr>
<td>--healthz-bind-address 0.0.0.0</td>
<td>
<p>健康检查服务器提供服务的IP地址及端口，默认0.0.0.0:10256</p>
</td>
</tr>
<tr>
<td>--healthz-port int32</td>
<td>配置健康检查服务的端口，0表示禁止，默认10256</td>
</tr>
<tr>
<td>--hostname-override string</td>
<td>使用该名字作为标识而不是实际的主机名</td>
</tr>
<tr>
<td>--iptables-masquerade-bit int32</td>
<td>对于纯iptables代理，则表示fwmark space的位数，用于标记需要SNAT的数据包。[0,31]之间，default 14</td>
</tr>
<tr>
<td>--iptables-min-sync-period duration</td>
<td>当endpoints和service变化，刷新iptables规则的最小时间间隔 </td>
</tr>
<tr>
<td>--iptables-sync-period duration</td>
<td>iptables刷新的最大时间间隔，默认30s</td>
</tr>
<tr>
<td> --ipvs-exclude-cidrs strings</td>
<td>ipvs proxier清理IPVS规则时不触及的CIDR以逗号分隔的列表</td>
</tr>
<tr>
<td>--ipvs-min-sync-period duration</td>
<td>当endpoints和service变化，刷新ipvs规则的最小时间间隔 </td>
</tr>
<tr>
<td>--ipvs-scheduler string</td>
<td>当proxy模式设置为ipvs，ipvs调度的类型</td>
</tr>
<tr>
<td>--ipvs-sync-period duration</td>
<td>ipvs刷新的最大时间间隔，默认30s</td>
</tr>
<tr>
<td>--kube-api-burst int32</td>
<td>发送到kube-apiserver每秒请求量，默认10</td>
</tr>
<tr>
<td>--kube-api-content-type string</td>
<td>发送到kube-apiserver请求的MIME类型，默认application/vnd.kubernetes.protobuf</td>
</tr>
<tr>
<td>--kube-api-qps float32</td>
<td>与kube-apiserver通信的qps，默认default 5</td>
</tr>
<tr>
<td>--kubeconfig string</td>
<td>kubeconfig文件的路径</td>
</tr>
<tr>
<td>--log-backtrace-at traceLocation file:N</td>
<td>
<p>when logging hits line file:N, emit a stack trace (default :0)</p>
<p>当日志发生在什么代码位置时打印调用栈</p>
</td>
</tr>
<tr>
<td>--log-dir string</td>
<td>日志文件的存储位置</td>
</tr>
<tr>
<td>--log-flush-frequency duration</td>
<td>日志刷出的最大间隔，默认5s</td>
</tr>
<tr>
<td>--logtostderr</td>
<td>日志输出到标准错误而非文件</td>
</tr>
<tr>
<td>--masquerade-all</td>
<td>纯 iptables 代理，对所有通过集群 service IP发送的流量进行 SNAT（通常不配置）</td>
</tr>
<tr>
<td>--master string</td>
<td>Kubernetes API server地址，覆盖kubeconfig的配置</td>
</tr>
<tr>
<td>--metrics-bind-address 0.0.0.0</td>
<td>metrics服务地址和端口，默认127.0.0.1:10249</td>
</tr>
<tr>
<td>--nodeport-addresses strings</td>
<td>
<p>NodePort使用哪些IP地址，示例1.2.3.0/24, 1.2.3.4/32，默认情况下所有本地地址都使用</p>
</td>
</tr>
<tr>
<td>--oom-score-adj int32</td>
<td>kube-proxy进程的oom-score-adj值，合法值范围[-1000, 1000] ，默认-999</td>
</tr>
<tr>
<td>--profiling</td>
<td>设置为true，通过web接口/debug/pprof查看性能分析</td>
</tr>
<tr>
<td>--proxy-mode ProxyMode</td>
<td>代理模式，可选值userspace / iptables / ipvs，默认iptables</td>
</tr>
<tr>
<td>--proxy-port-range port-range</td>
<td>
<p>可以用于代理K8S Service流量的苏主机端口范围</p>
</td>
</tr>
<tr>
<td>--stderrthreshold severity</td>
<td>日志输出的最低级别，默认2</td>
</tr>
<tr>
<td>--udp-timeout duration</td>
<td>
<p>空闲UDP连接保持打开的时长，默认250ms</p>
</td>
</tr>
<tr>
<td>-v, --v Level</td>
<td>日志冗余级别</td>
</tr>
<tr>
<td>--version version[=true]</td>
<td>打印版本信息并退出</td>
</tr>
<tr>
<td>--vmodule moduleSpec</td>
<td>逗号分隔的模式=N的列表文件，用以筛选日志记录</td>
</tr>
<tr>
<td>--write-config-to string</td>
<td>输出默认配置到文件并退出</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">kube-scheduler</span></div>
<table class=" full-width fixed-word-wrap">
<tbody>
<tr>
<td style="width: 35%; text-align: center;"><strong>参数</strong></td>
<td style="text-align: center;"><strong>说明</strong></td>
</tr>
<tr>
<td>--address string</td>
<td>监听主机IP地址，0.0.0.0监听主机所有主机接口</td>
</tr>
<tr>
<td style="width: 263px;">--algorithm-provider string</td>
<td style="width: 585px;">设置调度算法，ClusterAutoscalerProvider或DefaultProvider，默认为DefaultProvider</td>
</tr>
<tr>
<td style="width: 263px;">--alsologtostderr</td>
<td style="width: 585px;">设置true则日志输出到stderr，也输出到日志文件</td>
</tr>
<tr>
<td style="width: 263px;">--config string</td>
<td style="width: 585px;">配置文件的路径</td>
</tr>
<tr>
<td style="width: 263px;">--kube-api-burst int32</td>
<td style="width: 585px;">发送到kube-apiserver每秒请求量 ，默认100</td>
</tr>
<tr>
<td style="width: 263px;">--kube-api-content-type string</td>
<td style="width: 585px;">发送到kube-apiserver请求内容类型，默认application/vnd.kubernetes.protobuf</td>
</tr>
<tr>
<td style="width: 263px;">--kube-api-qps float32</td>
<td style="width: 585px;">与kube-apiserver通信的qps，默认50</td>
</tr>
<tr>
<td style="width: 263px;">--kubeconfig string</td>
<td style="width: 585px;">kubeconfig配置文件路径</td>
</tr>
<tr>
<td style="width: 263px;">--leader-elect</td>
<td style="width: 585px;">多个master情况设置为true保证高可用，进行leader选举</td>
</tr>
<tr>
<td style="width: 263px;">--leader-elect-lease-duration duration</td>
<td style="width: 585px;">当leader-elect设置为true生效，选举过程中非leader候选等待选举的时间间隔，默认15s</td>
</tr>
<tr>
<td style="width: 263px;">--leader-elect-renew-deadline duration</td>
<td style="width: 585px;">leader选举过程中在停止leading，再次renew时间间隔，小于或者等于leader-elect-lease-duration duration，也是leader-elect设置为true生效，默认10s</td>
</tr>
<tr>
<td style="width: 263px;">--leader-elect-retry-period duration</td>
<td style="width: 585px;">当leader-elect设置为true生效，获取leader或者重新选举的等待间隔，默认2s</td>
</tr>
<tr>
<td style="width: 263px;">--lock-object-name string</td>
<td style="width: 585px;">定义lock对象名字，默认kube-scheduler</td>
</tr>
<tr>
<td style="width: 263px;">--lock-object-namespace string</td>
<td style="width: 585px;">定义lock对象的namespace，默认kube-system</td>
</tr>
<tr>
<td style="width: 263px;">--log-backtrace-at traceLocation</td>
<td style="width: 585px;">记录日志到file:行号时打印一次stack trace，默认0</td>
</tr>
<tr>
<td style="width: 263px;">--log-dir string</td>
<td style="width: 585px;">记录log的目录</td>
</tr>
<tr>
<td style="width: 263px;">--log-flush-frequency duration</td>
<td style="width: 585px;">flush log的时间间隔，默认5s</td>
</tr>
<tr>
<td style="width: 263px;">--logtostderr</td>
<td style="width: 585px;">写log到stderr，默认true</td>
</tr>
<tr>
<td style="width: 263px;">--master string</td>
<td style="width: 585px;">master的地址，会覆盖kubeconfig中的</td>
</tr>
<tr>
<td style="width: 263px;">--port int</td>
<td style="width: 585px;">没有认证鉴权的不安全端口，默认10251</td>
</tr>
<tr>
<td style="width: 263px;">--profiling</td>
<td style="width: 585px;">开启性能分析，通过host:port/debug/pprof/查看</td>
</tr>
<tr>
<td style="width: 263px;">--scheduler-name string</td>
<td style="width: 585px;">调度器名，由于哪些pod被调度器进行处理，根据pod的spec.schedulerName，默认default-scheduler</td>
</tr>
</tbody>
</table>
<div class="blog_h2"><span class="graybg">kubelet</span></div>
<table class=" full-width fixed-word-wrap">
<tbody>
<tr>
<td style="width: 35%; text-align: center;"><strong>参数</strong></td>
<td style="text-align: center;"><strong>说明</strong></td>
</tr>
<tr>
<td>--allow-privileged=true</td>
<td>允许容器请求特权模式</td>
</tr>
<tr>
<td style="width: 419px;">--anonymous-auth=false</td>
<td style="width: 428px;">
<p>允许匿名请求到 kubelet 服务。未被另一个身份验证方法拒绝的请求被视为匿名请求。匿名请求包含系统的用户名: anonymous ，以及系统的组名: unauthenticated，默认 true </p>
</td>
</tr>
<tr>
<td style="width: 419px;">--application-metrics-count-limit int</td>
<td style="width: 428px;">每一个容器store最大application metrics，默认100</td>
</tr>
<tr>
<td style="width: 419px;">--authentication-token-webhook-cache-ttl</td>
<td style="width: 428px;">
<p>webhook 令牌身份验证缓存响应时间，默认2m0s</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--authorization-mode string</td>
<td style="width: 428px;">
<p>授权模式（AlwaysAllow/ Webhook），Webhook 模式使用 SubjectAccessReview API 来确定授权</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--authorization-webhook-cache-authorized-ttl</td>
<td style="width: 428px;">
<p>webhook 模式认证响应缓存时间，默认5m0s</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--authorization-webhook-cache-unauthorized-ttl</td>
<td style="width: 428px;">webhook 模式认证未响应缓存时间，默认30s</td>
</tr>
<tr>
<td style="width: 419px;">--authentication-token-webhook</td>
<td style="width: 428px;">使用 TokenReview API 来确定不记名令牌的身份验证</td>
</tr>
<tr>
<td style="width: 419px;">--bootstrap-kubeconfig</td>
<td style="width: 428px;">
<p>kubelet 客户端证书的kubeconfig 文件路径</p>
<p>如果指定的文件不存在，将使用 bootstrap kubeconfig 从 API 服务器请求一个客户端证书，成功后生成证书文件和密钥的 kubeconfig 将被写入指定的文件，客户端证书和密钥将被保存在 --cert-dir 指定的目录</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--cadvisor-port=0</td>
<td style="width: 428px;">cAdvisor 端口，默认 4194</td>
</tr>
<tr>
<td style="width: 419px;"> --cert-dir string</td>
<td style="width: 428px;">客户端证书和密钥保存到的目录</td>
</tr>
<tr>
<td style="width: 419px;">--cgroup-driver=cgroupfs</td>
<td style="width: 428px;">可选值有cgroupfs和systemd，与docker驱动一致。默认cgroupfs</td>
</tr>
<tr>
<td style="width: 419px;">--cgroup-root string</td>
<td style="width: 428px;">
<p>Pod的根cgroup</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--cgroups-per-qos</td>
<td style="width: 428px;">
<p>是否创建 QoS cgroup 层级，true 意味着创建顶级 QoS 和pod cgroups ，默认true</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--client-ca-file</td>
<td style="width: 428px;">集群CA证书，默认/etc/kubernetes/ssl/ca.pem</td>
</tr>
<tr>
<td style="width: 419px;">--cluster-dns</td>
<td style="width: 428px;">DNS 服务器的IP列表，逗号分隔</td>
</tr>
<tr>
<td style="width: 419px;">--cluster-domain</td>
<td style="width: 428px;">集群域名, kubelet 将配置所有容器除了主机搜索域还将搜索当前域</td>
</tr>
<tr>
<td style="width: 419px;">--cni-bin-dir</td>
<td style="width: 428px;">CNI插件二进制文件路径，默认/opt/cni/bin</td>
</tr>
<tr>
<td style="width: 419px;">--cni-conf-dir</td>
<td style="width: 428px;">CNI插件配置文件的完整路径，默认/etc/cni/net.d</td>
</tr>
<tr>
<td style="width: 419px;">--container-runtime</td>
<td style="width: 428px;">
<p>指定容器运行时引擎（CRI）</p>
</td>
</tr>
<tr>
<td style="width: 419px;"> --cpu-cfs-quota</td>
<td style="width: 428px;">
<p>开启cpu cfs配额来对容器指定cpu限制，默认true</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--cpu-cfs-quota-period duration</td>
<td style="width: 428px;">设置cpu cfs配置周期值，cpu.cfs_period_us，默认100ms</td>
</tr>
<tr>
<td style="width: 419px;">
<p>--enable-controller-attach-detach</p>
</td>
<td style="width: 428px;">开启attach/detach控制器来管理调度到该节点上的volume</td>
</tr>
<tr>
<td style="width: 419px;">--enforce-node-allocatable strings </td>
<td style="width: 428px;">
<p>默认pods</p>
<p>如果为kube组件和System进程预留资源，则需要设置为pods,kube-reserved,system-reserve</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--event-burst int32</td>
<td style="width: 428px;">
<p>突发事件记录的最大值</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--eviction-hard</td>
<td style="width: 428px;">
<p>清理阈值的集合，达到该阈值将触发一次容器清理，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5bc272215655" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5bc272215655-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5bc272215655-1"><span class="crayon-v">memory</span><span class="crayon-e">.available</span><span class="crayon-o">&lt;</span><span class="crayon-cn">1000Mi</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.available</span><span class="crayon-o">&lt;</span><span class="crayon-cn">10</span><span class="crayon-o">%</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.inodesFree</span><span class="crayon-o">&lt;</span><span class="crayon-cn">10</span><span class="crayon-o">%</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</td>
</tr>
<tr>
<td style="width: 419px;">--eviction-minimum-reclaim</td>
<td style="width: 428px;">
<p>资源回收最小值的集合，即 kubelet 压力较大时 ，执行 pod 清理回收的资源最小值，示例：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5c1906521718" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5c1906521718-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5c1906521718-1"><span class="crayon-v">memory</span><span class="crayon-e">.available</span><span class="crayon-o">=</span><span class="crayon-cn">0Mi</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.available</span><span class="crayon-o">=</span><span class="crayon-cn">500Mi</span><span class="crayon-sy">,</span><span class="crayon-v">imagefs</span><span class="crayon-e">.available</span><span class="crayon-o">=</span><span class="crayon-cn">2Gi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</td>
</tr>
<tr>
<td style="width: 419px;">--eviction-soft</td>
<td style="width: 428px;">
<p>清理阈值的集合，如果达到一个清理周期将触发一次容器清理，示例：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5c5778739019" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5c5778739019-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5c5778739019-1"><span class="crayon-v">memory</span><span class="crayon-e">.available</span><span class="crayon-o">&lt;</span><span class="crayon-cn">1.5Gi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

</td>
</tr>
<tr>
<td style="width: 419px;">--eviction-soft-grace-period</td>
<td style="width: 428px;">
<p>清理周期的集合，在触发一个容器清理之前一个软清理阈值需要保持多久：
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5c9783072466" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5c9783072466-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5c9783072466-1"><span class="crayon-v">memory</span><span class="crayon-e">.available</span><span class="crayon-o">=</span><span class="crayon-cn">300s</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.available</span><span class="crayon-o">=</span><span class="crayon-cn">300s</span><span class="crayon-sy">,</span><span class="crayon-v">nodefs</span><span class="crayon-e">.inodesFree</span><span class="crayon-o">=</span><span class="crayon-cn">300s</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</td>
</tr>
<tr>
<td style="width: 419px;">--fail-swap-on</td>
<td style="width: 428px;">开启了SWAP的前提下，如果设置为true则启动kubelet失败。默认true</td>
</tr>
<tr>
<td style="width: 419px;">
<p>--hairpin-mode string
</td>
<td style="width: 428px;">
<p>可选值promiscuous-bridge / hairpin-veth，NAT回环模式，默认promiscuous-bridge</p>
</td>
</tr>
<tr>
<td style="width: 419px;">
<p>--healthz-bind-address</p>
</td>
<td style="width: 428px;">
<p>健康检查服务的IP地址，默认127.0.0.1 </p>
</td>
</tr>
<tr>
<td style="width: 419px;">--healthz-port</td>
<td style="width: 428px;">
<p>本地健康检查服务的端口号，默认10248</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--host-ipc-sources</td>
<td style="width: 428px;">
<p>允许 pod 使用宿主机 ipc 命名空间列表，默认[*]</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--host-network-sources</td>
<td style="width: 428px;">允许 pod 使用宿主机 net 命名空间列表，默认[*]</td>
</tr>
<tr>
<td style="width: 419px;">--host-pid-sources</td>
<td style="width: 428px;">允许 pod 使用宿主机 pid 命名空间列表，默认[*]</td>
</tr>
<tr>
<td style="width: 419px;">--hostname-override</td>
<td style="width: 428px;">在K8S集群中的当前node name</td>
</tr>
<tr>
<td style="width: 419px;">
<p>--http-check-frequency</p>
</td>
<td style="width: 428px;">
<p>通过 http 检查新数据的周期，默认20s</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--image-gc-high-threshold</td>
<td style="width: 428px;">
<p>磁盘使用占比最大值，超过此值将执行镜像垃圾回收，默认85</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--image-gc-low-threshold</td>
<td style="width: 428px;">磁盘使用率最大值，低于此值将停止镜像垃圾回收，默认80</td>
</tr>
<tr>
<td style="width: 419px;">--image-pull-progress-deadline</td>
<td style="width: 428px;">镜像拉取进度最大时间，如果在这段时间拉取镜像没有任何进展，将取消拉取，默认1m0s</td>
</tr>
<tr>
<td style="width: 419px;"> --iptables-drop-bit</td>
<td style="width: 428px;">
<p>用于标记丢弃数据包的 fwmark  bit，取值范围[0，31]，默认15</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--iptables-masquerade-bit</td>
<td style="width: 428px;">
<p>标记 SNAT 数据包的 fwmark bit，取值范围[0，31]，此参数与 kube-proxy 中的相应参数匹配，默认14</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--kube-api-burst</td>
<td style="width: 428px;">与 kubernetes apiserver 会话时的并发数，默认 10</td>
</tr>
<tr>
<td style="width: 419px;">--kube-api-qps</td>
<td style="width: 428px;">与 kubernetes apiserver 会话时的 QPS，默认15</td>
</tr>
<tr>
<td style="width: 419px;">--kube-reserved</td>
<td style="width: 428px;">
<p>资源预留量，针对kubernetes 系统组件 ，示例：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5cf023457145" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5cf023457145-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5cf023457145-1"><span class="crayon-v">cpu</span><span class="crayon-o">=</span><span class="crayon-cn">200m</span><span class="crayon-sy">,</span><span class="crayon-v">memory</span><span class="crayon-o">=</span><span class="crayon-cn">500Mi</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">storage</span><span class="crayon-o">=</span><span class="crayon-cn">1Gi</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

</td>
</tr>
<tr>
<td style="width: 419px;">--kubeconfig</td>
<td style="width: 428px;">用来指定如何连接到 API Server，默认/etc/kubernetes/kubelet.kubeconfig</td>
</tr>
<tr>
<td style="width: 419px;">--log-dir</td>
<td style="width: 428px;">日志文件路径，默认/var/log/kubernetes</td>
</tr>
<tr>
<td style="width: 419px;">--logtostderr</td>
<td style="width: 428px;">标准输出</td>
</tr>
<tr>
<td style="width: 419px;">--max-pods</td>
<td style="width: 428px;">可以运行的容器组数目，默认 110</td>
</tr>
<tr>
<td style="width: 419px;">--network-plugin</td>
<td style="width: 428px;">使用CNI插件</td>
</tr>
<tr>
<td style="width: 419px;">--node-ip</td>
<td style="width: 428px;">节点的IP地址，kubelet 将使用这个地址作为节点ip地址，主要针对多网卡环境</td>
</tr>
<tr>
<td style="width: 419px;">--node-labels</td>
<td style="width: 428px;">加入集群时为节点打标签，示例env=test</td>
</tr>
<tr>
<td style="width: 419px;">--pod-infra-container-image</td>
<td style="width: 428px;">每个 pod 中的 network/ipc 命名空间容器将使用的pause镜像，默认k8s.gcr.io/pause:3.1</td>
</tr>
<tr>
<td style="width: 419px;">--pod-manifest-path</td>
<td style="width: 428px;">静态启动的容器组（主要针对控制平面）的路径，默认etc/kubernetes/manifests</td>
</tr>
<tr>
<td style="width: 419px;">--register-with-taints</td>
<td style="width: 428px;">加入集群时自带的taint，示例：env=test:NoSchedule</td>
</tr>
<tr>
<td style="width: 419px;">--root-dir</td>
<td style="width: 428px;">kubelet 的工作目录</td>
</tr>
<tr>
<td style="width: 419px;">--registry-burst=10</td>
<td style="width: 428px;">拉取镜像的最大并发数，允许同时拉取的镜像数，不能超过 registry-qps ，仅当 --registry-qps 大于 0 时使用，默认 10</td>
</tr>
<tr>
<td style="width: 419px;">--serialize-image-pulls</td>
<td style="width: 428px;">是否禁用串行化（一个个）拉取镜像模式</td>
</tr>
<tr>
<td style="width: 419px;">--stderrthreshold</td>
<td style="width: 428px;">日志输出阈值 </td>
</tr>
<tr>
<td style="width: 419px;">--system-reserved</td>
<td style="width: 428px;">给系统预留资源，示例cpu=4,memory=5Gi</td>
</tr>
<tr>
<td style="width: 419px;">--tls-cert-file</td>
<td style="width: 428px;">
<p>用于 https 服务的 x509 证书的文件。如果没有提供 --tls-cert-file 和 --tls-private-key-file ， 将会生产一个自签名的证书及密钥给公开地址使用，并将其保存在 --cert-dir 指定的目录
<p>默认/etc/kubernetes/pki/kubelet.crt</p>
</td>
</tr>
<tr>
<td style="width: 419px;">--tls-private-key-file</td>
<td style="width: 428px;">包含 x509 私钥匹配的文件，默认/etc/kubernetes/pki/kubelet.key</td>
</tr>
<tr>
<td style="width: 419px;">--v</td>
<td style="width: 428px;">日志级别</td>
</tr>
<tr>
<td style="width: 419px;">
<p>--address</p>
</td>
<td style="width: 428px;">
<p>服务监听的IP地址，默认 0.0.0.0</p>
</td>
</tr>
</tbody>
</table>
<p>推荐参数：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5d4526427718" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5d4526427718-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5d4526427718-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba5d4526427718-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5d4526427718-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5d4526427718-1"><span class="crayon-o">--</span><span class="crayon-v">serialize</span><span class="crayon-o">-</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">pulls</span><span class="crayon-o">=</span><span class="crayon-t">false</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5d4526427718-2"><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">pull</span><span class="crayon-o">-</span><span class="crayon-v">progress</span><span class="crayon-o">-</span><span class="crayon-i">deadline</span><span class="crayon-h"> </span><span class="crayon-cn">5m0s</span></div><div class="crayon-line" id="crayon-634f9a69ba5d4526427718-3"><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">gc</span><span class="crayon-o">-</span><span class="crayon-v">high</span><span class="crayon-o">-</span><span class="crayon-v">threshold</span><span class="crayon-o">=</span><span class="crayon-cn">75</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5d4526427718-4"><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">gc</span><span class="crayon-o">-</span><span class="crayon-v">low</span><span class="crayon-o">-</span><span class="crayon-v">threshold</span><span class="crayon-o">=</span><span class="crayon-cn">60</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->

<div class="blog_h2"><span class="graybg">kube-controller-manager</span></div>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 35%; text-align: center;">参数</td>
<td style="text-align: center;">说明</td>
</tr>
</thead>
<tbody>
<tr>
<td colspan="2"><strong><em>调试参数</em></strong></td>
</tr>
<tr>
<td>--contention-profiling</td>
<td>如果启用了 profiling，则启用锁争用性分析</td>
</tr>
<tr>
<td>--profiling</td>
<td>开启profilling，通过web接口host:port/debug/pprof/分析性能</td>
</tr>
<tr>
<td colspan="2"><strong><em>一般参数</em></strong></td>
</tr>
<tr>
<td>--allocate-node-cidrs</td>
<td>是否应在云提供商上分配和设置Pod的CIDR</td>
</tr>
<tr>
<td>--cidr-allocator-type string</td>
<td>CIDR分配器的类型，默认RangeAllocator</td>
</tr>
<tr>
<td>--cloud-config string</td>
<td>云提供商配置文件路径，空代表没有配置文件</td>
</tr>
<tr>
<td>--cloud-provider string</td>
<td>云提供商，空代表没有云提供商</td>
</tr>
<tr>
<td>--configure-cloud-routes</td>
<td>是否在云提供商上配置allocate-node-cidrs分配的CIDR，默认true</td>
</tr>
<tr>
<td>--cluster-cidr string</td>
<td>集群中Pod的CIDR范围，要求--allocate-node-cidrs为true</td>
</tr>
<tr>
<td>--cluster-name string</td>
<td>集群的实例前缀，默认kubernetes</td>
</tr>
<tr>
<td>--controller-start-interval</td>
<td>启动控制器管理器的间隔时间</td>
</tr>
<tr>
<td>--controllers</td>
<td>
<p>需要开启的控制器列表，默认*表示全部开启，foo表示开启foo，-foo表示禁用foo</p>
<p>可用控制器列表：</p>
<p>attachdetach, bootstrapsigner, clusterrole-aggregation,cronjob, csrapproving, csrcleaner, csrsigning, daemonset,deployment, disruption, endpoint, garbagecollector,horizontalpodautoscaling, job, namespace, nodeipam, nodelifecycle,persistentvolume-binder, persistentvolume-expander, podgc, pv-protection,pvc-protection, replicaset, replicationcontroller,resourcequota, route, service, serviceaccount, serviceaccount-token,statefulset, tokencleaner, ttl,ttl-after-finished</p>
</td>
</tr>
<tr>
<td>--feature-gates</td>
<td>开启特性</td>
</tr>
<tr>
<td>--kube-api-burst</td>
<td>发送到kube-apiserver每秒请求爆发量，默认100</td>
</tr>
<tr>
<td>--kube-api-content-type</td>
<td>发送到kube-apiserver的MIME类型，默认application/vnd.kubernetes.protobuf</td>
</tr>
<tr>
<td>--kube-api-qps</td>
<td>
<p>与kube-apiserver通信的qps，默认50</p>
</td>
</tr>
<tr>
<td>--leader-elect</td>
<td>多个master情况设置为true保证高可用，进行leader选举</td>
</tr>
<tr>
<td>--leader-elect-lease-duration</td>
<td>当leader-elect设置为true生效，选举过程中非leader候选等待选举的时间间隔，默认15s</td>
</tr>
<tr>
<td>--leader-elect-renew-deadline</td>
<td>当leader-elect设置为true生效，leader选举过程中在停止leading，再次renew的时间间隔，小于或者等于leader-elect-lease-duration，默认10s</td>
</tr>
<tr>
<td>--leader-elect-retry-period</td>
<td>当leader-elect设置为true生效，leader或者重新选举的等待间隔，默认2s</td>
</tr>
<tr>
<td>--min-resync-period</td>
<td>获取K8S资源的重新同步周期，默认12h0m0s</td>
</tr>
<tr>
<td>--route-reconciliation-period</td>
<td>协调由云提供商为节点创建的路由的时间间隔，默认10s</td>
</tr>
<tr>
<td>--use-service-account-credentials</td>
<td>
<p>是否为每个控制器设置独立的SA。如果设置为true，则Kubernetes为控制器管理器中的每个控制器创建SA：</p>
<p style="padding-left: 30px;">attachdetach-controller<br />calico-kube-controller<br />certificate-controller<br />clusterrole-aggregation-controller<br />cronjob-controller<br />daemon-set-controller<br />deployment-controller<br />disruption-controller<br />endpoint-controller<br />expand-controller<br />job-controller<br />namespace-controller<br />node-controller<br />pv-protection-controller<br />pvc-protection-controller<br />replicaset-controller<br />replication-controller<br />resourcequota-controller<br />service-account-controller<br />service-controller<br />statefulset-controller<br />ttl-controller</p>
</td>
</tr>
<tr>
<td colspan="2"><strong><em>安全参数</em></strong></td>
</tr>
<tr>
<td>--bind-address</td>
<td>监听--secure-port端口的IP地</td>
</tr>
<tr>
<td>-cert-dir</td>
<td>TLS证书所在的目录。如果提供了--tls-cert-file和--tls-private-key-file，则将忽略此标志</td>
</tr>
<tr>
<td>--http2-max-streams-per-connection</td>
<td>API Server提供给 client 的HTTP / 2最大 stream 连接数</td>
</tr>
<tr>
<td>--secure-port</td>
<td>使用身份验证和授权提供服务的HTTPS端口</td>
</tr>
<tr>
<td>--tls-cert-file</td>
<td>文件包含HTTPS的默认x509证书的文件。如果启用了HTTPS服务，但是 --tls-cert-file和--tls-private-key-file 未设置，则会为公共地址生成自签名证书和密钥，并将其保存到--cert-dir的目录中</td>
</tr>
<tr>
<td>--tls-cipher-suites</td>
<td>逗号分隔的cipher suites列表</td>
</tr>
<tr>
<td>--tls-min-version</td>
<td>支持最低TLS版本，取值VersionTLS10，VersionTLS11，VersionTLS12</td>
</tr>
<tr>
<td>--tls-private-key-file</td>
<td>文件包括与 --tls-cert-file 匹配的默认x509私钥</td>
</tr>
<tr>
<td>--tls-sni-cert-key</td>
<td>x509证书和私钥对的文件路径，例如example.crt,example.key</td>
</tr>
<tr>
<td colspan="2"><strong><em>身份验证</em></strong></td>
</tr>
<tr>
<td>--authentication-kubeconfig</td>
<td>有权创建tokenaccessreviews.authentication.k8s.io的kubeconfig，如果不设置所有Token请求视为匿名</td>
</tr>
<tr>
<td>--authentication-skip-lookup</td>
<td>如果设置false，authentication-kubeconfig用来在集群中查找缺失的authentication配置</td>
</tr>
<tr>
<td>--authentication-token-webhook-cache-ttl</td>
<td>来自webhook token authenticator的响应的缓存时间，默认10s</td>
</tr>
<tr>
<td>--client-ca-file</td>
<td>如果设置，此参数指定的CA列表中任何CA签名的客户端证书，均身份验证成功，并且其身份标识从CommanName读取</td>
</tr>
<tr>
<td colspan="2"><strong><em>授权</em></strong></td>
</tr>
<tr>
<td>--authorization-always-allow-paths</td>
<td>无需授权即可访问的URL列表，默认/healthz</td>
</tr>
<tr>
<td>--authorization-kubeconfig</td>
<td>有权创建subjectaccessreviews.authorization.k8s.io的kubeconfig</td>
</tr>
<tr>
<td>--authorization-webhook-cache-authorized-ttl</td>
<td>来自webhook authorizer的针对授权URL的响应的缓存时间，默认10s</td>
</tr>
<tr>
<td>--authorization-webhook-cache-unauthorized-ttl</td>
<td>来自webhook authorizer的针对非授权URL的响应的缓存时间，默认10s </td>
</tr>
<tr>
<td colspan="2"><strong><em>节点控制器</em></strong></td>
</tr>
<tr>
<td>--node-monitor-period </td>
<td>NodeController同步NodeStatus的时间间隔，默认5s</td>
</tr>
<tr>
<td colspan="2"><strong><em>服务控制器</em></strong></td>
</tr>
<tr>
<td>--concurrent-service-syncs</td>
<td>允许同时同步的 service 数量。 数字越大服务管理响应越快，但消耗更多 CPU 和网络资源</td>
</tr>
<tr>
<td colspan="2"><strong><em>Attachdetach控制器</em></strong></td>
</tr>
<tr>
<td>--attach-detach-reconcile-sync-period </td>
<td>卷attach、detach之间，Reconciler同步的等待时间，必须大于1m</td>
</tr>
<tr>
<td> --disable-attach-detach-reconcile-sync</td>
<td>禁用卷attach/detach的Reconciler同步，禁用可能导致卷和Pod不匹配，小心 </td>
</tr>
<tr>
<td colspan="2"><strong><em>证书请求（CSR）签名控制器</em></strong></td>
</tr>
<tr>
<td>--cluster-signing-cert-file</td>
<td>PEM编码的X509 CA证书，用于签发集群范围的证书，默认/etc/kubernetes/ca/ca.pem</td>
</tr>
<tr>
<td>--cluster-signing-key-file</td>
<td>上述CA证书的私钥路径，默认/etc/kubernetes/ca/ca.key</td>
</tr>
<tr>
<td colspan="2"><strong><em>Deployment控制器</em></strong></td>
</tr>
<tr>
<td>--concurrent-deployment-syncs</td>
<td>允许并行Sync的Deployment对象数量，默认5</td>
</tr>
<tr>
<td>--deployment-controller-sync-period</td>
<td>同步K8S资源的间隔，默认30s</td>
</tr>
<tr>
<td colspan="2"><strong><em>Endpoint控制器</em></strong></td>
</tr>
<tr>
<td>--concurrent-endpoint-syncs</td>
<td>允许并行Sync的Endpoint对象数量，默认5</td>
</tr>
<tr>
<td colspan="2"><strong><em>Garbagecollector控制器</em></strong></td>
</tr>
<tr>
<td>--concurrent-gc-syncs</td>
<td>运行并行Sync的垃圾回收器Worker的数量，默认20</td>
</tr>
<tr>
<td>--enable-garbage-collector</td>
<td>是否启用垃圾回收器，必须和APIServer的参数匹配</td>
</tr>
<tr>
<td colspan="2"><strong><em>HPA控制器</em></strong></td>
</tr>
<tr>
<td>--horizontal-pod-autoscaler-cpu-initialization-period</td>
<td>Pod启动后，多长时间内不进行CPU采样，默认5m0s</td>
</tr>
<tr>
<td>--horizontal-pod-autoscaler-downscale-stabilization</td>
<td>扩容后，多长时间内不会所容，默认5m0s</td>
</tr>
<tr>
<td>--horizontal-pod-autoscaler-initial-readiness-delay</td>
<td>Pod启动后，多长时间内readiness的变更被看作最初的readiness（也就是Pod可以提供服务了），默认30s</td>
</tr>
<tr>
<td>--horizontal-pod-autoscaler-sync-period</td>
<td>多长时间来同步Pod的数量信息，默认15s</td>
</tr>
<tr>
<td>--horizontal-pod-autoscaler-tolerance</td>
<td>
<p>引发HPA考虑应当扩容的，监控指标的变化最小量，默认0.1</p>
</td>
</tr>
<tr>
<td colspan="2"><strong><em>Namespace控制器</em></strong></td>
</tr>
<tr>
<td>--concurrent-namespace-syncs</td>
<td>允许并行Sync的命名空间对象的数量，默认10</td>
</tr>
<tr>
<td>--namespace-sync-period</td>
<td>命名空间Sync间隔</td>
</tr>
<tr>
<td colspan="2"><strong><em>Nodeipam控制器</em></strong></td>
</tr>
<tr>
<td>--node-cidr-mask-size</td>
<td>Node的CIDR的掩码大小，默认24</td>
</tr>
<tr>
<td>--service-cluster-ip-range</td>
<td>K8S服务的CIDR范围</td>
</tr>
<tr>
<td colspan="2"><strong><em>Nodelifecycle控制器</em></strong></td>
</tr>
<tr>
<td>--enable-taint-manager</td>
<td>设置为true，则启用NoExecute Taint，并且驱除所有不能容忍Taint的Pod，默认true</td>
</tr>
<tr>
<td>--large-cluster-size-threshold</td>
<td>多少节点的集群被认为是大集群，默认50。此控制器的逻辑会改变</td>
</tr>
<tr>
<td>--node-eviction-rate</td>
<td>当可用区（Zone）是健康的前提下，节点失败后需要驱除其上的Pod，那么每秒由多少节点上的Pod被删除，默认0.1</td>
</tr>
<tr>
<td>--secondary-node-eviction-rate</td>
<td>类似上面，但是集群被认为是小集群时自动置0</td>
</tr>
<tr>
<td>--node-monitor-grace-period</td>
<td>节点不响应心跳后，至少等待多久才能将其标记为不健康。必须是Kubelet的nodeStatusUpdateFrequency参数的N倍，默认40s</td>
</tr>
<tr>
<td>--node-startup-grace-period</td>
<td>对于一个启动中的节点，在此时间之前不得标记为不健康，默认1m0s</td>
</tr>
<tr>
<td>--pod-eviction-timeout</td>
<td>在失败节点上删除Pod的等待期，默认5m0s</td>
</tr>
<tr>
<td>--unhealthy-zone-threshold</td>
<td>什么比例的Node处于NotReady状态，才认为整个Zone是不健康的</td>
</tr>
<tr>
<td colspan="2"><strong><em>Persistentvolume-binder控制器</em></strong></td>
</tr>
<tr>
<td>--enable-dynamic-provisioning</td>
<td>启用卷的动态提供，默认true</td>
</tr>
<tr>
<td>--enable-hostpath-provisioner</td>
<td>启用HostPath PV的动态提供，主要用在非云环境，用于开发、测试目的</td>
</tr>
<tr>
<td>--flex-volume-plugin-dir</td>
<td>
<p>从什么目录来搜索额外的第三方Flex卷插件</p>
<p>默认/usr/libexec/kubernetes/kubelet-plugins/volume/exec/</p>
</td>
</tr>
<tr>
<td>--pv-recycler-increment-timeout-nfs</td>
<td>每Gi容量为NFS Scrubber Pod的ActiveDeadlineSeconds增加多少时间，默认30</td>
</tr>
<tr>
<td>--pv-recycler-minimum-timeout-hostpath </td>
<td>HostPath Recycler Pod的最小ActiveDeadlineSeconds </td>
</tr>
<tr>
<td>--pv-recycler-minimum-timeout-nfs </td>
<td>NFS Recycler Pod的最小ActiveDeadlineSeconds</td>
</tr>
<tr>
<td>--pv-recycler-pod-template-filepath-nfs</td>
<td>NFS Recycler Pod的模板 </td>
</tr>
<tr>
<td> --pvclaimbinder-sync-period</td>
<td>同步PV/PVC的间隔，默认15s </td>
</tr>
</tbody>
</table>
<div class="blog_h1"><span class="graybg">其它</span></div>
<div class="blog_h2"><span class="graybg">JSONPath支持</span></div>
<p>除了<a href="/javascript-faq#jsonpath">标准的JSONPath</a>之外，Kubernetes还额外支持：</p>
<ol>
<li>可选的
			<span id="crayon-634f9a69ba5de066683218" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">$</span></span></span>运算符，默认表达式从根对象开始</li>
<li>支持通过
			<span id="crayon-634f9a69ba5e3889697060" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-s">""</span></span></span>引用JSONPath表达式中的文本</li>
<li>支持通过
			<span id="crayon-634f9a69ba5e7447244271" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">range</span></span></span>迭代列表</li>
</ol>
<div class="blog_h3"><span class="graybg">函数列表</span></div>
<p>对于输入：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba5eb058181700" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">JSON</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba5eb058181700-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba5eb058181700-34">34</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-1"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"kind"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"List"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"items"</span><span class="crayon-o">:</span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"kind"</span><span class="crayon-o">:</span><span class="crayon-s">"None"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"metadata"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-s">"127.0.0.1"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"status"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"capacity"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-s">"cpu"</span><span class="crayon-o">:</span><span class="crayon-s">"4"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"addresses"</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-sy">{</span><span class="crayon-s">"type"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"LegacyHostIP"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"address"</span><span class="crayon-o">:</span><span class="crayon-s">"127.0.0.1"</span><span class="crayon-sy">}</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"kind"</span><span class="crayon-o">:</span><span class="crayon-s">"None"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"metadata"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-s">"127.0.0.2"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"status"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"capacity"</span><span class="crayon-o">:</span><span class="crayon-sy">{</span><span class="crayon-s">"cpu"</span><span class="crayon-o">:</span><span class="crayon-s">"8"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"addresses"</span><span class="crayon-o">:</span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"type"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"LegacyHostIP"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"address"</span><span class="crayon-o">:</span><span class="crayon-s">"127.0.0.2"</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span><span class="crayon-s">"type"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"another"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"address"</span><span class="crayon-o">:</span><span class="crayon-s">"127.0.0.3"</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"users"</span><span class="crayon-o">:</span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"myself"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"user"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"e2e"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"user"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-s">"username"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"admin"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"password"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"secret"</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-634f9a69ba5eb058181700-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba5eb058181700-34"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0061 seconds] -->

<p> 可用的函数，以及示例如下：</p>
<table class="full-width fixed-word-wrap">
<thead>
<tr>
<td style="width: 120px; text-align: center;">函数</td>
<td style="width: 200px; text-align: center;">说明</td>
<td style="text-align: center;">示例</td>
</tr>
</thead>
<tbody>
<tr>
<td>text</td>
<td>原始文本</td>
<td>
			<span id="crayon-634f9a69ba5f0202877288" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kind</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">kind</span><span class="crayon-sy">}</span></span></span>，结果：kind is List</td>
</tr>
<tr>
<td>@</td>
<td>当前对象</td>
<td>
			<span id="crayon-634f9a69ba5f4036476140" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">@</span><span class="crayon-sy">}</span></span></span>输出和输入一致</td>
</tr>
<tr>
<td>. 或 []</td>
<td>取子对象</td>
<td>
			<span id="crayon-634f9a69ba5f8965635110" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">kind</span><span class="crayon-sy">}</span></span></span>, 
			<span id="crayon-634f9a69ba5fc659366252" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">[</span><span class="crayon-s">'kind'</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></span></span>，
			<span id="crayon-634f9a69ba600107558752" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">[</span><span class="crayon-s">'name\.type'</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></span></span></td>
</tr>
<tr>
<td>..</td>
<td>递归子对象</td>
<td>
			<span id="crayon-634f9a69ba603705842578" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span></span></span>，结果：127.0.0.1 127.0.0.2 myself e2e</td>
</tr>
<tr>
<td>*</td>
<td>通配，获取所有对象</td>
<td>
			<span id="crayon-634f9a69ba607357516232" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-o">*</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">metadata</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span></span></span>，结果： [127.0.0.1 127.0.0.2]</td>
</tr>
<tr>
<td>[start:end :step]</td>
<td>切片</td>
<td>
			<span id="crayon-634f9a69ba60b626458271" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">users</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span></span></span>，结果：myself</td>
</tr>
<tr>
<td>[,]</td>
<td>联合</td>
<td>
			<span id="crayon-634f9a69ba60f092582144" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-o">*</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">'metadata.name'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'status.capacity'</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span></span></span>，结果：127.0.0.1 127.0.0.2 map[cpu:4] map[cpu:8]</td>
</tr>
<tr>
<td>?()</td>
<td>过滤</td>
<td>
			<span id="crayon-634f9a69ba613107890360" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">users</span><span class="crayon-sy">[</span><span class="crayon-sy">?</span><span class="crayon-sy">(</span><span class="crayon-sy">@</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-o">==</span><span class="crayon-s">"e2e"</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">password</span><span class="crayon-sy">}</span></span></span>，结果：secret</td>
</tr>
<tr>
<td>range, end</td>
<td>迭代列表</td>
<td>
			<span id="crayon-634f9a69ba617012485379" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-i">range</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-o">*</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">[</span><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">metadata</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">status</span><span class="crayon-sy">.</span><span class="crayon-v">capacity</span><span class="crayon-sy">}</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-st">end</span><span class="crayon-sy">}</span></span></span>，结果：[127.0.0.1, map[cpu:4]] [127.0.0.2, map[cpu:8]]</td>
</tr>
<tr>
<td>''</td>
<td>因为转义字符</td>
<td>
			<span id="crayon-634f9a69ba621952953459" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-sy">{</span><span class="crayon-i">range</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-o">*</span><span class="crayon-sy">]</span><span class="crayon-sy">}</span><span class="crayon-sy">{</span><span class="crayon-sy">.</span><span class="crayon-v">metadata</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span><span class="crayon-sy">{</span><span class="crayon-s">'\t'</span><span class="crayon-sy">}</span><span class="crayon-sy">{</span><span class="crayon-st">end</span><span class="crayon-sy">}</span></span></span>，结果：127.0.0.1 127.0.0.2</td>
</tr>
</tbody>
</table>
<div class="blog_h1"><span class="graybg">大规模集群调优</span></div>
<div class="blog_h2"><span class="graybg">APIServer</span></div>
<div class="blog_h3"><span class="graybg">监控</span></div>
<p>在大规模集群中，对APIServer的监控需要调优，避免过于频繁的数据采集。特别是APIServer副本数很多的情况下，这会对Etcd造成巨大的读压力。</p>
<div class="blog_h3"><span class="graybg">NodeLease</span></div>
<p>在大规模集群下开启NodeLease来降低API Server处理心跳的成本，可以降低50% CPU开销。</p>
<div class="blog_h2"><span class="graybg">Etcd</span></div>
<div class="blog_h3"><span class="graybg">基础设施调优</span></div>
<p>Etcd是Kubernetes集群正常运作的基石，但是多节点、强一致性的需求导致Etcd很容易出现性能瓶颈。</p>
<p>在云环境中，即使是规模仅有<span style="background-color: #c0c0c0;"><strong>500节点</strong></span>的集群中，使用<strong><span style="background-color: #c0c0c0;">基于SSD的存储 + 万兆网络</span></strong>，也可能随机出现Etcd响应延迟过大的情况，<span style="background-color: #c0c0c0;"><strong>延迟可达500ms</strong></span>。此问题的根本原因是Etcd存在大量<strong><span style="background-color: #c0c0c0;">顺序IO</span></strong>，对<strong><span style="background-color: #c0c0c0;">磁盘延迟敏感，而不是IOPS</span></strong>。使用本地SSD而非网络存储，可以将Etcd的<span style="background-color: #c0c0c0;"><strong>写延迟降低10倍以上</strong></span>。</p>
<div class="blog_h3"><span class="graybg">参数调优</span></div>
<ol>
<li>通过参数
			<span id="crayon-634f9a69ba626493731244" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">-</span><span class="crayon-v">quota</span><span class="crayon-o">-</span><span class="crayon-v">backend</span><span class="crayon-o">-</span><span class="crayon-v">bytes</span></span></span>调整Etcd最大存储大小，默认2GB</li>
<li>根据网络延迟来调整心跳间隔、选举超时</li>
<li>提升Etcd的网络、磁盘IO优先级</li>
</ol>
<div class="blog_h3"><span class="graybg">Etcd垂直分片</span></div>
<p>将相对次要，且产生数据量大的资源类型，存储到单独的Etcd集群中，例如Events：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba62a106963031" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba62a106963031-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba62a106963031-1">--etcd-servers-overrides=/events#https://0.example.com:2381;https://1.example.com:2381;https://2.example.com:2381</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<div class="blog_h3"><span class="graybg">Boltdb优化</span></div>
<p>优化Etcd底层存储Bolt的B+树的空闲列表分配/释放算法的时间复杂度为O(1)，解决超大数据量（100GB级别）下Etcd的性能瓶颈，操作延迟可以降低10倍。</p>
<div class="blog_h2"><span class="graybg">Scheduler</span></div>
<div class="blog_h3"><span class="graybg">策略调优</span></div>
<ol>
<li>根据应用场景调整：默认策略倾向于均摊负载到所有节点。对于批处理应用场景，可以修改调度策略，让负载集中，并释放空闲节点以节约资源</li>
<li>扩展调度器，支持基于负载IO需求、节点IO能力的调度</li>
<li>预选阶段优化：
<ol>
<li>根据集群规模调整参与可调度评分的节点比例，对于大规模集群（1000+），调低参数可以提升40%以上的调度性能：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba62e518208235" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba62e518208235-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba62e518208235-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba62e518208235-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba62e518208235-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba62e518208235-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba62e518208235-1"><span class="crayon-s ">apiVersion</span><span class="">: componentconfig/v1alpha1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba62e518208235-2"><span class="crayon-s ">kind</span><span class="">: KubeSchedulerConfiguration</span></div><div class="crayon-line" id="crayon-634f9a69ba62e518208235-3"><span class="crayon-s ">algorithmSource</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba62e518208235-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">provider</span><span class="">: DefaultProvider</span></div><div class="crayon-line" id="crayon-634f9a69ba62e518208235-5"><span class="crayon-s ">percentageOfNodesToScore</span><span class="">: 50</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

</li>
<li>预选短路，优先执行低成本的断言，并且一个断言失败即排除节点</li>
</ol>
</li>
</ol>
<div class="blog_h2"><span class="graybg">DNS优化</span></div>
<div class="blog_h3"><span class="graybg">KubeDNS</span></div>
<p>每个节点上包含多个KubeDNS Pod没有意义，可以设置反亲和：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba633576245954" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba633576245954-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba633576245954-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba633576245954-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba633576245954-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba633576245954-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba633576245954-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba633576245954-1"><span class="crayon-s ">affinity</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba633576245954-2"><span class="crayon-h"> </span><span class="crayon-s ">podAntiAffinity</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba633576245954-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-s ">requiredDuringSchedulingIgnoredDuringExecution</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba633576245954-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-s ">- weight</span><span class="">: 100</span></div><div class="crayon-line" id="crayon-634f9a69ba633576245954-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">labelSelector</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba633576245954-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">matchExpressions</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba633576245954-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">- key</span><span class="">: k8s-app</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba633576245954-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">operator</span><span class="">: In</span></div><div class="crayon-line" id="crayon-634f9a69ba633576245954-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">values</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba633576245954-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>-<span class="crayon-h"> </span>kube-dns</div><div class="crayon-line" id="crayon-634f9a69ba633576245954-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">topologyKey</span><span class="">: kubernetes.io/hostname</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<div class="blog_h3"><span class="graybg">ARP缓存</span></div>
<p>在高性能计算集群中，可能需要增大节点的ARP缓存：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba637800952185" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">/etc/sysctl.conf</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba637800952185-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba637800952185-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba637800952185-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba637800952185-1"><span class="crayon-v">net</span><span class="crayon-e">.ipv4</span><span class="crayon-e">.neigh</span><span class="crayon-e">.default</span><span class="crayon-e">.gc_thresh1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">80000</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba637800952185-2"><span class="crayon-v">net</span><span class="crayon-e">.ipv4</span><span class="crayon-e">.neigh</span><span class="crayon-e">.default</span><span class="crayon-e">.gc_thresh2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">90000</span></div><div class="crayon-line" id="crayon-634f9a69ba637800952185-3"><span class="crayon-v">net</span><span class="crayon-e">.ipv4</span><span class="crayon-e">.neigh</span><span class="crayon-e">.default</span><span class="crayon-e">.gc_thresh3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100000</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>否则，在内核日志中可能看到neighbor table overflow!错误。 </p>
<div class="blog_h3"><span class="graybg">CoreDNS优化</span></div>
<p>引入autopath插件，可以将针对外部DNS名称的查询QPS提升5倍。</p>
<div class="blog_h2"><span class="graybg">镜像拉取</span></div>
<div class="blog_h3"><span class="graybg">并行拉取</span></div>
<p>设置Kubelet参数
			<span id="crayon-634f9a69ba63b373238687" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">serialize</span><span class="crayon-o">-</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">pulls</span><span class="crayon-o">=</span><span class="crayon-t">false</span></span></span>， 注意需要配合设置Docker的存储驱动为Overlay2，提高
			<span id="crayon-634f9a69ba63f301027416" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">max</span><span class="crayon-o">-</span><span class="crayon-v">concurrent</span><span class="crayon-o">-</span><span class="crayon-v">downloads</span></span></span>的值。</p>
<p>最好将Docker数据目录挂载到本地磁盘。</p>
<div class="blog_h3"><span class="graybg">拉取超时</span></div>
<p>设置Kubelet参数
			<span id="crayon-634f9a69ba642239178604" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">image</span><span class="crayon-o">-</span><span class="crayon-v">pull</span><span class="crayon-o">-</span><span class="crayon-v">progress</span><span class="crayon-o">-</span><span class="crayon-v">deadline</span><span class="crayon-o">=</span><span class="crayon-cn">30m</span></span></span>，来支持超大镜像的拉取，避免rpc error: code = 2 desc = net/http: request canceled错误</p>
<div class="blog_h1"><span class="graybg">关键新特性</span></div>
<div class="blog_h2"><span class="graybg">1.13</span></div>
<ol>
<li>kubeadm达到GA</li>
<li>CSI达到GA</li>
<li>CoreDNS作为默认DNS实现</li>
<li>支持第三方设备监控插件，Alpha</li>
<li>设备插件注册，达到稳定状态。此特性实现了一个通用的kubelet插件发现模型，用于各种节点级别的插件，例如设备插件、CSI、CNI和kubelet的交互</li>
<li><span style="background-color: #c0c0c0;">拓扑感知的卷调度</span>，达到稳定状态</li>
<li>APIServer DryRun达到Beta状态</li>
<li>Kubectl Diff达到Beta状态，用于比较本地资源清单和K8S中对象的区别</li>
</ol>
<div class="blog_h2"><span class="graybg">1.14</span></div>
<ol>
<li>Windows支持达到生产可用，现在可以支持Windows工作节点，并向其调度Windows容器</li>
<li>Kubectl插件机制达到稳定状态</li>
<li>继承Kustomize到Kubectl</li>
<li>本地PV达到生产可用</li>
<li><span style="background-color: #c0c0c0;">Pod Ready++生产可用</span>，此特性改进Readiness/Liveness探针的不足—— 在一些情况下，往往只是新的 Pod 完成自身初始化，系统尚未完成 Endpoint、负载均衡器等外部可达的访问信息刷新，老的 Pod 就立即被删除，最终造成服务不可用，允许用户通过ReadinessGates自定义Pod就绪条件</li>
<li><span style="background-color: #c0c0c0;">Pod优先级和抢占式调度达到生产可用</span></li>
<li>PID数量限制特性，达到Beta，使用kubelet参数
			<span id="crayon-634f9a69ba647406191351" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">max</span><span class="crayon-o">-</span><span class="crayon-v">pids</span></span></span>开启</li>
<li>Kubeadm支持在HA集群中自动执行控制平面的证书复制</li>
</ol>
<div class="blog_h2"><span class="graybg">1.15</span></div>
<ol>
<li>CRD进入GA，支持基于Structural Schema校验自定义资源的每个字段</li>
<li>支持在运行时进行CR不同版本之间的转换，通过Webhook</li>
<li>CRD默认值，Alpha</li>
<li>CRD未知字段裁剪，通过CRD的
			<span id="crayon-634f9a69ba64b563224945" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">spec</span><span class="crayon-sy">.</span><span class="crayon-v">preserveUnknownFields</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">false</span></span></span>启用</li>
<li>Admission Webhook重新调用，如果某个Webhook修改了资源，可以重新调用Webhook进行校验</li>
<li>通过<span style="background-color: #c0c0c0;">Device Monitoring Agent进行异构硬件监控</span>，不需要修改Kubelet</li>
<li><span style="background-color: #c0c0c0;">Scheduler Framework</span>，Alpha， 加强调度器扩展定制能力。在原有的Priority/Predicates 接口的基础上增加了QueueSort, Prebind, Postbind, Reserve, Unreserve 和 Permit接口。Scheduler Framework 仍以 Pod 为单位进行调度，对于需要<span style="background-color: #c0c0c0;">成组Pod一起调度的离线类（计算）业务，考虑使用Volcano之类的社区框架</span></li>
<li>Kubeadm HA达到GA</li>
</ol>
<div class="blog_h2"><span class="graybg">1.16</span></div>
<ol>
<li>Admission Webhook达到GA</li>
<li>存储方面的改进，<span style="background-color: #c0c0c0;">CSI的卷Resize</span>的API达到Beta</li>
<li>Kubeadm支持添加Windows工作节点，Alpha</li>
<li>Windows节点的CSI插件支持，Alpha</li>
<li>能够支持更加强大的集群扩容、更灵活的网络地址处理的网络端点切片（Endpoint Slices）特性。EndpointSlice可以作为Endpoint的替代</li>
<li><span style="background-color: #c0c0c0;">Ephemeral containers</span>：在一个运行中的Pod中，临时运行一个容器，用于诊断目的</li>
</ol>
<div class="blog_h2"><span class="graybg">1.17</span></div>
<ol>
<li>Pod共享PID命名空间达到GA，可用于容器之间需要相互发信号的场景</li>
<li><span style="background-color: #c0c0c0;">拓扑感知服务路由</span>，可以避免跨物理位置访问Service的Endpoint，Alpha状态</li>
<li>Endpoints对象存放了服务的所有端点，1.17的EndpointSlice代替之，可扩容性更好。<span style="background-color: #c0c0c0;">拓扑感知路由也依赖于EndpointSlice</span></li>
<li>可以在一个集群中同时支持IPv4和IPv6</li>
<li>CSI：<span style="background-color: #c0c0c0;">卷快照API到达Beta状态，支持拓扑感知</span></li>
</ol>
<div class="blog_h2"><span class="graybg">1.18</span></div>
<ol>
<li>为Service Account Token Issuer提供OpenID Connect (OIDC)发现。SA可以基于Token（JWT）来请求K8S API Server，进行身份验证。目前K8S API Server是唯一能验证Token的服务，但是它不能从外部网络访问，这意味着某些工作负载需要使用单独的身份验证系统。OIDC发现可以让K8S的Token验证在集群外可用，实现方式是<span style="background-color: #c0c0c0;">API Server提供OIDC发现文档（其中包含Token公钥），OIDC Authenticator可以基于此OIDC发现文档校验Token</span></li>
<li>支持定制单个HPA的扩容速度，以前的版本仅仅支持全局设置。为HPA添加以下设置：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba650400078771" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba650400078771-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba650400078771-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba650400078771-1"><span class="crayon-s ">behavior</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-2"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-s ">scaleUp</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba650400078771-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">policies</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">- type</span><span class="">: Percent</span></div><div class="crayon-line" id="crayon-634f9a69ba650400078771-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">value</span><span class="">: 100</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">periodSeconds</span><span class="">: 15</span></div><div class="crayon-line" id="crayon-634f9a69ba650400078771-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-s ">scaleDown</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">policies</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba650400078771-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">- type</span><span class="">: Pods</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">value</span><span class="">: 4</span></div><div class="crayon-line" id="crayon-634f9a69ba650400078771-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-s ">periodSeconds</span><span class="">: 60</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba650400078771-12"><span class="crayon-c"># 15秒内扩容到4个，60秒内缩容到2个</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

</li>
<li>CertificateSigningRequest接口，支持由K8S对证书请求进行签名</li>
<li>kubectl debug，用于在运行中的Pod上进行调试，它可以创建一个Debug容器，或者使用新配置重新部署Pod</li>
<li>Windows增强：
<ol>
<li>实现RuntimeClass</li>
<li>支持CRI-ContainerD</li>
</ol>
</li>
<li>调度相关
<ol>
<li>支持多个调度Profile。不同工作负载的调度需求不同，对于Web服务，倾向于分散到不同节点上，对于某些延迟敏感的服务，则倾向于调度在同一节点上。在以前，可以配置多个调度器来满足差异化调度，但是这会引入竞态条件，因为每个调度器在同一时刻看到不同的集群视图。调度Profile允许同一调度器以多种配置运行，每个配置有自己的schedulerName，Pod仍然使用schedulerName来指定使用哪个Profile</li>
<li>Beta：跨越多个故障域平均分布Pod，使用topologySpreadConstraints，可以定义如何在跨越区域（Zone）的大规模集群上平均调度Pod</li>
<li>Alpha：跨越多个故障域平均分布Pod，支持配置默认规则</li>
</ol>
</li>
<li>节点相关
<ol>
<li>Hugepage支持，硬件优化会让大块内存访问更加快速，对于在内存中处理大量数据集的应用（例如数据库）、以及内存延迟敏感应用很有价值。现在Pod可以请求不同尺寸的Hugepage：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba655869928754" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba655869928754-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba655869928754-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba655869928754-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba655869928754-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba655869928754-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba655869928754-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba655869928754-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba655869928754-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba655869928754-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba655869928754-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba655869928754-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba655869928754-2"><span class="crayon-s ">kind</span><span class="">: Pod</span></div><div class="crayon-line" id="crayon-634f9a69ba655869928754-3">…</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba655869928754-4"><span class="crayon-s ">spec</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba655869928754-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">containers</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba655869928754-6">…</div><div class="crayon-line" id="crayon-634f9a69ba655869928754-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">resources</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba655869928754-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">requests</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba655869928754-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hugepages-2Mi</span><span class="">: 1Gi</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba655869928754-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hugepages-1Gi</span><span class="">: 2Gi </span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</li>
<li>统计Pod沙盒消耗的（而不是关联到特定容器）资源。启用PodOverhead特性门，则调度时考虑Pod沙盒的资源消耗，资源消耗在Admission期间计算并固化，其值和RuntimeClass有关</li>
<li>节点拓扑管理器（Node Topology Manager）是Kubelet的组件，负责专门协调硬件资源的分配。机器学习、科学计算、财务服务等都是计算密集型、低延迟要求的应用，这类应用锁定到特定的核心上会得到更好的性能，NTM能够执行这种锁定</li>
<li>延迟liveness探针执行：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba659330362823" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba659330362823-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba659330362823-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba659330362823-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba659330362823-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba659330362823-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba659330362823-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba659330362823-1"><span class="crayon-s ">startupProbe</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba659330362823-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">httpGet</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba659330362823-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /healthz</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba659330362823-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">port</span><span class="">: liveness-port</span></div><div class="crayon-line" id="crayon-634f9a69ba659330362823-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">failureThreshold</span><span class="">: 30</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba659330362823-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">periodSeconds</span><span class="">: 10</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
</p>
<p>仅当此探针成功，才认为Pod启动完毕，然后才会执行其它探针，例如liveness</p>
</li>
</ol>
</li>
<li>网络
<ol>
<li> NodeLocal DNSCache到达GA，此特性增强集群DNS性能，避免DNAT和conntrack导致的和UDP相关的竞态条件</li>
</ol>
</li>
<li>存储
<ol>
<li>跳过卷所有权变更，在bind挂载卷到容器之前，它的文件权限会被改为fsGroup设置的值。如果卷很大，这个处理过程会很慢，而且这种修改会导致某些权限敏感的应用出问题，例如数据库。新增的FSGroupChangePolicy字段可以控制此行为，如果设置为Always行为依旧，如果设置为OnRootMismatch，则仅当卷的根目录的权限不匹配fsGroup时才设置权限</li>
<li>不可变ConfigMap和Secret：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba65d526268888" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba65d526268888-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba65d526268888-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba65d526268888-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba65d526268888-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba65d526268888-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba65d526268888-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba65d526268888-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba65d526268888-1"><span class="crayon-s ">apiVersion</span><span class="">: v1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba65d526268888-2"><span class="crayon-s ">kind</span><span class="">: Secret</span></div><div class="crayon-line" id="crayon-634f9a69ba65d526268888-3"><span class="crayon-s ">metadata</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba65d526268888-4"><span class="crayon-h">&nbsp;&nbsp;</span>…</div><div class="crayon-line" id="crayon-634f9a69ba65d526268888-5"><span class="crayon-s ">data</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba65d526268888-6"><span class="crayon-h">&nbsp;&nbsp;</span>…</div><div class="crayon-line" id="crayon-634f9a69ba65d526268888-7"><span class="crayon-s ">immutable</span><span class="">: true</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

</li>
<li>
<p>跳过non-attachable卷的Attach行为。这是个内部优化，简化了 不需要Attach/Detach操作的CSI驱动（例如NFS）的VolumeAttachment对象的创建</p>
</li>
<li>支持<span style="background-color: #c0c0c0;">访问原始（Raw）块存储</span>，BlockVolume到达GA。要访问原始卷（跳过文件系统，提升IO性能降低延迟），将volumeMode设置为block</li>
</ol>
</li>
</ol>
<div class="blog_h1"><span class="graybg">Kubernetes开发</span></div>
<div class="blog_h2"><span class="graybg">构建</span></div>
<div class="blog_h3"><span class="graybg">本地构建</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba662488343413" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-22">22</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-24">24</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-26">26</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-28">28</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-30">30</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-32">32</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-34">34</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-36">36</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-38">38</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-40">40</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-42">42</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-44">44</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-46">46</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-48">48</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-50">50</div><div class="crayon-num" data-line="crayon-634f9a69ba662488343413-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba662488343413-52">52</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba662488343413-1"><span class="crayon-c"># 交叉编译，需要先安装交叉编译器</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-2"><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">install </span><span class="crayon-v">gcc</span><span class="crayon-o">-</span><span class="crayon-cn">5</span><span class="crayon-o">-</span><span class="crayon-v">aarch64</span><span class="crayon-o">-</span><span class="crayon-v">linux</span><span class="crayon-o">-</span><span class="crayon-e">gnu</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-3"><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-e">install </span><span class="crayon-v">gcc</span><span class="crayon-o">-</span><span class="crayon-v">aarch64</span><span class="crayon-o">-</span><span class="crayon-v">linux</span><span class="crayon-o">-</span><span class="crayon-v">gnu</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-6"><span class="crayon-c"># 签出代码</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-7"><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-v">$GOPATH</span><span class="crayon-o">/</span><span class="crayon-v">src</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-e">.io</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-8"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-v">$GOPATH</span><span class="crayon-o">/</span><span class="crayon-v">src</span><span class="crayon-o">/</span><span class="crayon-v">k8s</span><span class="crayon-e">.io</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-9"><span class="crayon-e">git </span><span class="crayon-r">clone</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">github</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-e">kubernetes</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-10"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-v">kubernetes</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-12">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-13"><span class="crayon-c"># 构建二进制文件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-14"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;构建kubelet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设置版本号为v1.18.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 去除版本号的dirty</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-15"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">WHAT</span><span class="crayon-o">=</span><span class="crayon-v">cmd</span><span class="crayon-o">/</span><span class="crayon-e">kubelet </span><span class="crayon-v">KUBE_GIT_VERSION</span><span class="crayon-o">=</span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">18.3</span><span class="crayon-h"> </span><span class="crayon-v">KUBE_GIT_TREE_STATE</span><span class="crayon-o">=</span><span class="crayon-v">clean</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c"># 为ARM平台构建&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 设置GOFLAGS</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">KUBE_BUILD_PLATFORMS</span><span class="crayon-o">=</span><span class="crayon-v">linux</span><span class="crayon-o">/</span><span class="crayon-e">arm64 </span><span class="crayon-v">GOFLAGS</span><span class="crayon-o">=</span><span class="crayon-s">"-tags=nokmem"</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-20"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 打印帮助</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-21"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">release</span><span class="crayon-o">-</span><span class="crayon-e">images </span><span class="crayon-v">PRINT_HELP</span><span class="crayon-o">=</span><span class="crayon-v">y</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-22">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-24"><span class="crayon-c"># 跨平台编译</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-25"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">cross</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-26">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-27"><span class="crayon-c"># 校验，确保代码格式化完毕、Bazel依赖更新完毕</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-28"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">verify</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-29">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-30"><span class="crayon-c"># 执行所有更新脚本</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-31"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">update</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-32">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-33"><span class="crayon-c"># 执行单元测试</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-34"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-35"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span><span class="crayon-h"> </span><span class="crayon-r">WHAT</span><span class="crayon-o">=</span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">pkg</span><span class="crayon-o">/</span><span class="crayon-v">api</span><span class="crayon-o">/</span><span class="crayon-e">helper </span><span class="crayon-v">GOFLAGS</span><span class="crayon-o">=</span><span class="crayon-o">-</span><span class="crayon-v">v</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-36">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-37"><span class="crayon-c"># 执行集成测试</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-38"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span><span class="crayon-o">-</span><span class="crayon-v">integration</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-39">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-40">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-41">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-42"><span class="crayon-c"># release-skip-tests quick-release 只是默认参数不同</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-43">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-44"><span class="crayon-c"># 生成镜像&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不跳过测试&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 镜像前缀&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-45"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">release</span><span class="crayon-o">-</span><span class="crayon-v">skip</span><span class="crayon-o">-</span><span class="crayon-e">tests&nbsp;&nbsp;</span><span class="crayon-v">KUBE_RELEASE_RUN_TESTS</span><span class="crayon-o">=</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-v">KUBE_DOCKER_REGISTRY</span><span class="crayon-o">=</span><span class="crayon-v">docker</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-o">/</span><span class="crayon-v">tcnp</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Base镜像前缀</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">KUBE_BASE_IMAGE_REGISTRY</span><span class="crayon-o">=</span><span class="crayon-v">registry</span><span class="crayon-e">.aliyuncs</span><span class="crayon-e">.com</span><span class="crayon-o">/</span><span class="crayon-v">google_containers</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 不要总是尝试拉取镜像，某些镜像在国内拉取不到&nbsp;&nbsp; 打印更多的日志信息</span></div><div class="crayon-line" id="crayon-634f9a69ba662488343413-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">KUBE_BUILD_PULL_LATEST_IMAGES</span><span class="crayon-o">=</span><span class="crayon-i">n</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">KUBE_VERBOSE</span><span class="crayon-o">=</span><span class="crayon-cn">5</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-50">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba662488343413-51"><span class="crayon-c"># 生成镜像&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 交叉编译其它平台</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba662488343413-52"><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">quick</span><span class="crayon-o">-</span><span class="crayon-e">release&nbsp;&nbsp;</span><span class="crayon-v">KUBE_FASTBUILD</span><span class="crayon-o">=</span><span class="crayon-t">false</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0075 seconds] -->

<div class="blog_h3"><span class="graybg">在容器中构建</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba666644496512" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba666644496512-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba666644496512-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba666644496512-1"><span class="crayon-c"># 仅编译linux二进制程序</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-2"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-3"><span class="crayon-c"># 编译跨平台二进制程序</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-4"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-v">cross</span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-5"><span class="crayon-c"># 指定组件与平台编译</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-6"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-e">kubectl </span><span class="crayon-v">KUBE_BUILD_PLATFORMS</span><span class="crayon-o">=</span><span class="crayon-v">darwin</span><span class="crayon-o">/</span><span class="crayon-v">amd64</span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-7"><span class="crayon-c"># 运行所有单元测试用例</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-8"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-9"><span class="crayon-c"># 运行集成测试用例</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-10"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span><span class="crayon-o">-</span><span class="crayon-v">integration</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-11"><span class="crayon-c"># 运行命令行测试</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-12"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">run</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span><span class="crayon-r">make</span><span class="crayon-h"> </span><span class="crayon-r">test</span><span class="crayon-o">-</span><span class="crayon-v">cmd</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-13"><span class="crayon-c"># 把docker中的 _output/dockerized/bin 拷贝到本地的 _output/dockerized/bin</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-14"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">copy</span><span class="crayon-o">-</span><span class="crayon-v">output</span><span class="crayon-e">.sh</span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-15"><span class="crayon-c"># 清理_output目录</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-16"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-r">make</span><span class="crayon-o">-</span><span class="crayon-v">clean</span><span class="crayon-e">.sh</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-634f9a69ba666644496512-17"><span class="crayon-c"># 进入bash shell中进行编译</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba666644496512-18"><span class="crayon-v">build</span><span class="crayon-o">/</span><span class="crayon-v">shell</span><span class="crayon-e">.sh</span> </div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

<div class="blog_h1"><span class="graybg">常见问题</span></div>
<div class="blog_h2"><span class="graybg">零散问题</span></div>
<div class="blog_h3"><span class="graybg">多网卡机器上报告错误节点IP</span></div>
<p>现象：
			<span id="crayon-634f9a69ba66a333429530" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">node</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">yaml</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">InternalIP</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">B</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></span></span> 返回不期望的IP地址。</p>
<p>原因：具有多个可以相互连接的网络接口。</p>
<p>解决办法：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba66e234736013" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title">/etc/default/kubelet</span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba66e234736013-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba66e234736013-1"><span class="crayon-v">KUBELET_EXTRA_ARGS</span><span class="crayon-o">=</span><span class="crayon-s">"--node-ip=10.0.4.1"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>然后重启kubelet即可。 </p>
<div class="blog_h3"><span class="graybg">NodePort不能使用80</span></div>
<p>报错信息：is invalid: spec.ports[0].nodePort: Invalid value: 80: provided port is not in the valid range. The range of valid ports is 30000-32767 </p>
<p>解决方案：修改Master节点的/etc/kubernetes/manifests/kube-apiserver.yaml，添加参数：</p>
<p style="padding-left: 60px;">--service-node-port-range=80-32767</p>
<div class="blog_h3"><span class="graybg">僵尸Pod问题</span></div>
<p>如果Node宕机或者网络分区，Pod可能进入Unknown状态，因为1.5+版本仅仅当Master确认Pod不在集群中运行时才会重新调度之。</p>
<p>这种情况下，如果作为管理员的你知道Node是宕机了，可以：</p>
<ol>
<li>强制删除
			<span id="crayon-634f9a69ba673718878221" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">kubectl </span><span class="crayon-e">delete </span><span class="crayon-e">pod </span><span class="crayon-v">pod</span><span class="crayon-o">-</span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">grace</span><span class="crayon-o">-</span><span class="crayon-v">period</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">force</span></span></span>后重新创建之</li>
</ol>
<div class="blog_h3"><span class="graybg">设置Pod时区</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba677296146414" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">YAML</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba677296146414-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba677296146414-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba677296146414-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba677296146414-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba677296146414-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba677296146414-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba677296146414-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba677296146414-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba677296146414-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba677296146414-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba677296146414-1"><span class="crayon-s ">volumeMounts</span><span class="">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba677296146414-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: tz-config</span></div><div class="crayon-line" id="crayon-634f9a69ba677296146414-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># 常见的Linux发行版都从下面的文件中读取时区</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba677296146414-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">mountPath</span><span class="">: /etc/localtime</span></div><div class="crayon-line" id="crayon-634f9a69ba677296146414-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba677296146414-6"><span class="crayon-s ">volumes</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba677296146414-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s ">- name</span><span class="">: tz-config</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba677296146414-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">hostPath</span><span class="">:</span></div><div class="crayon-line" id="crayon-634f9a69ba677296146414-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c"># Ubuntu、CentOS等宿主机上都有下面的文件</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba677296146414-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s ">path</span><span class="">: /usr/share/zoneinfo/Asia/Shanghai</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h3"><span class="graybg">设置资源预留后无法启动kubelet</span></div>
<p>报错信息：Failed to enforce System Reserved Cgroup Limits on "/system.slice": failed to set supported cgroup subsystems for cgroup /system.slice: Failed to set config for supported subsystems : failed to write 536870912 to memory.limit_in_bytes: write /sys/fs/cgroup/memory/system.slice/memory.limit_in_bytes: device or resource busy</p>
<p>报错原因：设置的限额，比当前system.slice组已经使用的不可压缩资源量（内存）更小，无法执行</p>
<div class="blog_h3"><span class="graybg">使用SubPath的Configmap导致容器重启失败</span></div>
<p>报错信息：</p>
<p>Error: failed to start container "dubbo":<span style="background-color: #c0c0c0;"> Error response from daemon: OCI runtime create failed</span>: container_linux.go:348:<br /> starting container process caused "process_linux.go:402: container init caused \"rootfs_linux.go:58: <span style="background-color: #c0c0c0;">mounting</span> \\\"/var/lib/kubelet/pods/1df7c1e1-d8ef-11e8-8029-3863bb2bccdc/volume-subp<br />aths/tomcatconf/dubbo/3\\\" <span style="background-color: #c0c0c0;">to rootfs</span> \\\"/var/lib/docker/overlay2/2fb619c8c8911576b936b460711d229f85489c82f222918ce79c90013b95e640/merged\\\" at \\\"/var/lib/docker/overlay2/2fb619c8c8<br />911576b936b460711d229f85489c82f222918ce79c90013b95e640/merged/tomcat/conf/server.xml\\\" <span style="background-color: #c0c0c0;">caused</span> \\\"<span style="background-color: #c0c0c0;">no such file or directory</span>\\\"\"": <span style="background-color: #c0c0c0;">unknown </span></p>
<p>原因：<a href="https://github.com/kubernetes/kubernetes/issues/68211">已知的缺陷</a>，当挂载ConfigMap/Secret，使用subPath时，如果ConfigMap被修改（我们的问题场景下貌似没有修改），则容器（而不是Pod）重启（可能由于健康检查失败导致）会失败。</p>
<div class="blog_h3"><span class="graybg">ConfigMap格式混乱</span></div>
<p>现象：换行符被替换为\n，无法阅读</p>
<p>原因：1.12版本中，只有任意一行以空格结尾，就会出现这种情况。</p>
<div class="blog_h3"><span class="graybg">如何重启Pod</span></div>
<p>K8S没有提供重启Pod的功能，Pod只能删除。但是Pod删除后，容器的本地文件系统状态就丢失了。</p>
<p>可以通过杀死进程的方式，让Pod（的容器）重启：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba67c313467562" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba67c313467562-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba67c313467562-1"><span class="crayon-e">kubectl </span><span class="crayon-v">exec</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">it </span><span class="crayon-e">ubuntu </span><span class="crayon-r">kill</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>注意不要kill -9，原因是PID 1是init进程，即使在PID命名空间中也是这样。<span style="background-color: #c0c0c0;">PID 1不定义KILL的信号处理器，因此无法被SIGKILL杀死</span>。 </p>
<div class="blog_h3"><span class="graybg">因Docker版本无法加入集群</span></div>
<p>报错：unsupported docker version: 18.09.0</p>
<p>解决办法：为kubeadm添加参数
			<span id="crayon-634f9a69ba680502256227" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-o">--</span><span class="crayon-v">ignore</span><span class="crayon-o">-</span><span class="crayon-v">preflight</span><span class="crayon-o">-</span><span class="crayon-v">errors</span><span class="crayon-o">=</span><span class="crayon-v">SystemVerification</span></span></span></p>
<div class="blog_h2"><span class="graybg">Kubeadm相关</span></div>
<div class="blog_h3"><span class="graybg">为证书添加SAN</span></div>
<p>删除旧证书：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba684294852811" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba684294852811-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba684294852811-1"><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">apiserver</span><span class="crayon-sy">.</span><span class="crayon-o">*</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>修改/etc/kubernetes/kubeadm-config.yaml，添加额外的SAN。</p>
<p>执行下面的命令生成新的API Server证书：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba688884503656" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba688884503656-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba688884503656-1"><span class="crayon-e">kubeadm </span><span class="crayon-e">init </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-v">apiserver</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span><span class="crayon-v">kubeadm</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-e">.yaml</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<div class="blog_h3"><span class="graybg">证书过期处理</span></div>
<p>通过Kubeadm安装的K8S集群，其控制平面证书有效期默认为1年，到期后你会遇到x509: certificate has expired or is not yet valid错误。</p>
<p>解决办法，通过kubeadm命令重新生成证书：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba68c366304737" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-8">8</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-10">10</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-12">12</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-14">14</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-16">16</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-18">18</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-20">20</div><div class="crayon-num" data-line="crayon-634f9a69ba68c366304737-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba68c366304737-22">22</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba68c366304737-1"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">kubernetes</span><span class="crayon-o">/</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-3"><span class="crayon-r">rm</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">rf </span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">apiserver</span><span class="crayon-sy">.</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">kubelet</span><span class="crayon-o">-</span><span class="crayon-sy">.</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">pki</span><span class="crayon-o">/</span><span class="crayon-v">front</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span><span class="crayon-o">-</span><span class="crayon-o">*</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-5"><span class="crayon-c"># apiserver API Server服务器证书 </span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-6"><span class="crayon-c"># apiserver-etcd-client API Server访问Kubelet使用的证书</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-7"><span class="crayon-c"># apiserver-kubelet-client 用于API Server连接到kubelet的证书</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-8"><span class="crayon-c"># ca 根证书</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-9"><span class="crayon-c"># sa 用于签名Service Account Token的证书</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-10"><span class="crayon-c"># front-proxy-ca 前置代理的自签名CA证书</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-11"><span class="crayon-c"># front-proxy-client 前置代理客户端证书</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-12"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-i">apiserver</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">cert</span><span class="crayon-o">-</span><span class="crayon-v">extra</span><span class="crayon-o">-</span><span class="crayon-v">sans</span><span class="crayon-o">=</span><span class="crayon-v">k8s</span><span class="crayon-e">.gmem</span><span class="crayon-e">.cc</span><span class="crayon-sy">,</span><span class="crayon-v">localhost</span><span class="crayon-sy">,</span><span class="crayon-cn">10.0.2.1</span><span class="crayon-sy">,</span><span class="crayon-cn">10.0.3.1</span><span class="crayon-sy">,</span><span class="crayon-cn">127.0.0.1</span><span class="crayon-sy">,</span><span class="crayon-v">radon</span><span class="crayon-sy">,</span><span class="crayon-e">neon</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-14"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">kubelet</span><span class="crayon-o">-</span><span class="crayon-e">clientkubec</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-15"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-e">sa</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-16"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-v">front</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span><span class="crayon-o">-</span><span class="crayon-e">ca</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-17"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">certs </span><span class="crayon-v">front</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span><span class="crayon-o">-</span><span class="crayon-v">client</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-18">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-19"><span class="crayon-c"># 配置文件也需要重新生成</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-20"><span class="crayon-r">rm</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">rf</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">.conf</span></div><div class="crayon-line" id="crayon-634f9a69ba68c366304737-21"><span class="crayon-e">kubeadm </span><span class="crayon-e">alpha </span><span class="crayon-e">phase </span><span class="crayon-e">kubeconfig </span><span class="crayon-v">all</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">apiserver</span><span class="crayon-o">-</span><span class="crayon-v">advertise</span><span class="crayon-o">-</span><span class="crayon-v">address</span><span class="crayon-o">=</span><span class="crayon-cn">10.0.2.1</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba68c366304737-22"><span class="crayon-r">cp</span><span class="crayon-h"> </span><span class="crayon-v">admin</span><span class="crayon-e">.conf</span><span class="crayon-h"> </span><span class="crayon-v">$HOME</span><span class="crayon-o">/</span><span class="crayon-e">.kube</span><span class="crayon-o">/</span><span class="crayon-v">config</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0052 seconds] -->

<p>生成的文件中，除了front-proxy-client.crt之外的所有crt文件，都是基于/etc/kubernetes/pki/ca.*进行签名。</p>
<p>用于Service Account Token的签名和校验的sa.pub则仅仅是公钥，这也意味着，<span style="background-color: #c0c0c0;">所有API Server必须共享一致的sa.key/sa.pub</span>。</p>
<p>证书更新后，kube-proxy可能无法访问API Server，报错 Unauthorized，原因是重新生成了sa.*，签名用的密钥变了。其实<span style="background-color: #c0c0c0;">sa.*不需要重新生成，它不牵涉证书过期的问题</span>。清空所有Token，导致其重新自动生成即可解决此问题：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba691573215813" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba691573215813-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba691573215813-1"><span class="crayon-e">kubectl </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">secrets</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">all</span><span class="crayon-o">-</span><span class="crayon-v">namespaces</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">no</span><span class="crayon-o">-</span><span class="crayon-v">headers</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">service</span><span class="crayon-o">-</span><span class="crayon-v">account</span><span class="crayon-o">-</span><span class="crayon-v">token</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">awk</span><span class="crayon-h"> </span><span class="crayon-s">'{system("kubectl -n "$1" delete secrets "$2)}'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>所有依赖于Service Account Token的Pod（基本上所有控制平面Pod都需要访问API Server）都需要重启：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba695498164011" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba695498164011-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba695498164011-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba695498164011-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba695498164011-1"><span class="crayon-c"># 否则，这些Pod访问API Server后，API Server会报错</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba695498164011-2"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp; invalid bearer token, [invalid bearer token, square/go-jose: error in cryptographic primitive</span></div><div class="crayon-line" id="crayon-634f9a69ba695498164011-3"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-e">delete </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">all</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<div class="blog_h2"><span class="graybg">Kubelet相关</span></div>
<div class="blog_h3"><span class="graybg">the server could not find the requested resource ( pods/log ...</span></div>
<p>命令：
			<span id="crayon-634f9a69ba699798482097" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-e">logs </span><span class="crayon-v">tiller</span><span class="crayon-o">-</span><span class="crayon-v">deploy</span><span class="crayon-o">-</span><span class="crayon-cn">79988f9658</span><span class="crayon-o">-</span><span class="crayon-cn">874gs</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">v</span><span class="crayon-h"> </span><span class="crayon-cn">9</span></span></span>可以获得更加详细的错误。</p>
<p>logs和exec子资源最终调用kubelet，因此获取其它K8S资源时没有问题，可以考虑是否节点存在问题。</p>
<p>查看节点Kubelet日志，发现：Failed to set some node status fields: failed to validate nodeIP: node IP: "172.17.0.4" not found in the host's network interfaces。原来是Kind集群重启后，IP地址发生变化导致。</p>
<p>Kind的节点IP静态的写在 /var/lib/kubelet/kubeadm-flags.env文件中，可以修改之。</p>
<div class="blog_h3"><span class="graybg">Orphaned pod "***" found, but volume paths are still present on disk</span></div>
<p>到目标节点上，进入/var/lib/kubelet/pods/***目录，查看etc-hosts文件内容，即可得知Pod的名字。</p>
<p>如果Pod已经不存在，可以删除***目录。防止继续出现此报错。</p>
<div class="blog_h3"><span class="graybg">Failed to start cAdvisor inotify_add_watch /sys/fs/cgroup/cpu,cpuacct/system.slice/run-u11867.scope: no space left on device</span></div>
<p>可能原因是内核参数取值太小：
			<span id="crayon-634f9a69ba69d943715322" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-e">sudo </span><span class="crayon-e">sysctl </span><span class="crayon-v">fs</span><span class="crayon-sy">.</span><span class="crayon-v">inotify</span><span class="crayon-sy">.</span><span class="crayon-v">max_user_watches</span><span class="crayon-o">=</span><span class="crayon-cn">1048576</span></span></span></p>
<div class="blog_h2"><span class="graybg">集群管理</span></div>
<div class="blog_h3"><span class="graybg">无法Ping通ClusterIP</span></div>
<p>是的，默认情况下你会无法Ping通集群IP，但是访问服务开放的端口是没问题的。 </p>
<div class="blog_h3"><span class="graybg">DNS无法解析非FQDN</span></div>
<p>使用kubeadm时，自定义集群域名时，出现此现象。</p>
<p>解决办法，使用kubelet参数：--cluster-domain=k8s.gmem.cc</p>
<div class="blog_h2"><span class="graybg">宕机快检</span></div>
<p>默认配置下，对节点宕机的响应速度较慢。可以进行以下调整。</p>
<div class="blog_h3"><span class="graybg">Kubelet</span></div>
<p>默认每10秒上报当前节点的健康状态，可以调低：--node-status-update-frequency=3s</p>
<div class="blog_h3"><span class="graybg">控制器管理器</span></div>
<p>默认每5秒在Master上检测其它节点状态，可以调低：--node-monitor-period=3s</p>
<p>如果发现其它节点不响应了，默认需要过40秒（10 *4）才能认为节点处于Unhealthy状态。可以调低 --node-monitor-grace-period=12s ，取值必须是--node-status-update-frequency的整数倍。</p>
<p>如果节点处于Unhealthy状态，则经过5分钟后控制器管理器才开始清除其上的Pod，可以调低 --pod-eviction-timeout=36s</p>
<p>控制器管理器的配置文件位于/etc/kubernetes/manifests/kube-controller-manager.yaml。</p>
<div class="blog_h2"><span class="graybg">查看日志</span></div>
<div class="blog_h3"><span class="graybg">控制器管理器</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6a6955151775" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6a6955151775-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6a6955151775-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba6a6955151775-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6a6955151775-1"><span class="crayon-c"># 如果以静态Pod方式运行</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6a6955151775-2"><span class="crayon-v">PODNAME</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">component</span><span class="crayon-o">=</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">controller</span><span class="crayon-o">-</span><span class="crayon-v">manager</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{.items[0].metadata.name}'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69ba6a6955151775-3"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-i">logs</span><span class="crayon-h"> </span><span class="crayon-v">$PODNAME</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-r">tail</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<div class="blog_h3"><span class="graybg">调度器</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6aa205732331" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6aa205732331-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6aa205732331-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba6aa205732331-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6aa205732331-1"><span class="crayon-c"># 如果以静态Pod方式执行</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6aa205732331-2"><span class="crayon-v">PODNAME</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">l</span><span class="crayon-h"> </span><span class="crayon-v">component</span><span class="crayon-o">=</span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">scheduler</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">jsonpath</span><span class="crayon-o">=</span><span class="crayon-s">'{.items[0].metadata.name}'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-634f9a69ba6aa205732331-3"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-i">logs</span><span class="crayon-h"> </span><span class="crayon-v">$PODNAME</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-r">tail</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0021 seconds] -->

<div class="blog_h3"><span class="graybg">Kubelet</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6ae424142508" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6ae424142508-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6ae424142508-1"><span class="crayon-v">journalctl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">u</span><span class="crayon-h"> </span><span class="crayon-v">kubelet</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-cn">0..7</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<div class="blog_h3"><span class="graybg">Kubeproxy </span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6b2265538159" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6b2265538159-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6b2265538159-1"><span class="crayon-v">kubectl</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-e">system </span><span class="crayon-r">get</span><span class="crayon-h"> </span><span class="crayon-v">pod</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r">grep</span><span class="crayon-h"> </span><span class="crayon-v">kube</span><span class="crayon-o">-</span><span class="crayon-v">proxy</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<div class="blog_h3"><span class="graybg">容器日志</span></div>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6b7559353571" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6b7559353571-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6b7559353571-1"><span class="crayon-i">kubectl</span><span class="crayon-h"> </span> <span class="crayon-o">-</span><span class="crayon-i">n</span><span class="crayon-h"> </span><span class="crayon-e">ns </span><span class="crayon-e">podname </span><span class="crayon-v">containername</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>如果只有一个容器，不需要指定containername，否则不指定containername会报错：</p>
<p>Error from server (BadRequest): a container name must be specified for pod maven-cddc1, choose one of: [** **]</p>
<div class="blog_h2"><span class="graybg">Ingress相关</span></div>
<div class="blog_h3"><span class="graybg">直接提供HTTPS的服务</span></div>
<p>Ingress必须添加注解：
			<span id="crayon-634f9a69ba6be307332192" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">nginx</span><span class="crayon-sy">.</span><span class="crayon-v">ingress</span><span class="crayon-sy">.</span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-v">io</span><span class="crayon-o">/</span><span class="crayon-v">secure</span><span class="crayon-o">-</span><span class="crayon-v">backends</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"true"</span></span></span></p>
<p>否则：</p>
<ol>
<li>Ingress Controller报错：upstream sent no valid HTTP/1.0 header while reading response header from upstream</li>
<li>Chrome浏览器报错：ERR_SPDY_PROTOCOL_ERROR</li>
</ol>
<div class="blog_h3"><span class="graybg">如何暴露gRPC服务</span></div>
<p>Ingress必须添加注解：
			<span id="crayon-634f9a69ba6c7395050286" class="crayon-syntax crayon-syntax-inline  crayon-theme-gmem-github crayon-theme-gmem-github-inline crayon-font-consolas" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important;"><span class="crayon-pre crayon-code" style="font-size: 15px !important; line-height: 20px !important;font-size: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><span class="crayon-v">nginx</span><span class="crayon-sy">.</span><span class="crayon-v">ingress</span><span class="crayon-sy">.</span><span class="crayon-v">kubernetes</span><span class="crayon-sy">.</span><span class="crayon-v">io</span><span class="crayon-o">/</span><span class="crayon-v">backend</span><span class="crayon-o">-</span><span class="crayon-v">protocol</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"GRPC"</span></span></span></p>
<div class="blog_h2"><span class="graybg">构建相关</span></div>
<div class="blog_h3"><span class="graybg">cmd/go: -tags space-separated list contains comma</span></div>
<p>这个问题和Goland有关，去除环境变量：</p>
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6cd880543129" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6cd880543129-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6cd880543129-1"><span class="crayon-e">unset </span><span class="crayon-v">GOFLAGS</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>即可解决。</p>
<div class="blog_h2"><span class="graybg">CentOS相关</span></div>
<div class="blog_h3"><span class="graybg">Bitnami镜像无法运行</span></div>
<p>报错：Error executing 'postInstallation': EEXIST: file already exists, symlink '/opt/bitnami/redis/conf' -&gt; '/opt/bitnami/redis/etc'，但是实际上文件根本不存在。</p>
<p>原因：CentOS使用的内核存在缺陷，升级到最新版本内核即可。</p>
<div class="blog_h2"><span class="graybg">Minikube相关</span></div>
<div class="blog_h3"><span class="graybg">Mac下基于VMware Fusion时报SSH错</span></div>
<p>报错信息：handshake failed: ssh: unable to authenticate, no supported methods remain</p>
<p>报错原因： 和VMware Fusion存在兼容性问题，Minikube的docker用户所需要的密钥没有正确拷贝</p>
<p>解决办法：</p>
<ol>
<li>启动Minikube：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6d5406552160" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6d5406552160-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6d5406552160-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba6d5406552160-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6d5406552160-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba6d5406552160-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6d5406552160-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba6d5406552160-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6d5406552160-1"><span class="crayon-e">minikube </span><span class="crayon-v">start</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">vm</span><span class="crayon-o">-</span><span class="crayon-v">driver</span><span class="crayon-o">=</span><span class="crayon-v">vmwarefusion</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-e">version </span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">15.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6d5406552160-2">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba6d5406552160-3"><span class="crayon-c"># 使用代理</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6d5406552160-4"><span class="crayon-e">export </span><span class="crayon-v">PROXY</span><span class="crayon-o">=</span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-cn">192.168.72.77</span><span class="crayon-o">:</span><span class="crayon-cn">8087</span></div><div class="crayon-line" id="crayon-634f9a69ba6d5406552160-5"><span class="crayon-v">https_proxy</span><span class="crayon-o">=</span><span class="crayon-v">$PROXY</span><span class="crayon-h"> </span><span class="crayon-e">minikube </span><span class="crayon-v">start</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-h"> </span><span class="crayon-v">HTTP_PROXY</span><span class="crayon-o">=</span><span class="crayon-v">$PROXY</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6d5406552160-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-h"> </span><span class="crayon-v">HTTPS_PROXY</span><span class="crayon-o">=</span><span class="crayon-v">$PROXY</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">docker</span><span class="crayon-o">-</span><span class="crayon-r">env</span><span class="crayon-h"> </span><span class="crayon-v">NO_PROXY</span><span class="crayon-o">=</span><span class="crayon-cn">192.168.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">16</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba6d5406552160-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">vm</span><span class="crayon-o">-</span><span class="crayon-v">driver</span><span class="crayon-o">=</span><span class="crayon-v">vmwarefusion</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">v</span><span class="crayon-o">=</span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">kubernetes</span><span class="crayon-o">-</span><span class="crayon-e">version </span><span class="crayon-v">v1</span><span class="crayon-sy">.</span><span class="crayon-cn">15.0</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

</li>
<li>在另外一个命令行窗口执行：<br />
<!-- Crayon Syntax Highlighter v2.7.0 -->

		<div id="crayon-634f9a69ba6db063972520" class="crayon-syntax crayon-theme-gmem-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" no-popup minimize scroll-mouseover" style=" margin-top: 0px; margin-bottom: 0px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-634f9a69ba6db063972520-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6db063972520-2">2</div><div class="crayon-num" data-line="crayon-634f9a69ba6db063972520-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6db063972520-4">4</div><div class="crayon-num" data-line="crayon-634f9a69ba6db063972520-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-634f9a69ba6db063972520-6">6</div><div class="crayon-num" data-line="crayon-634f9a69ba6db063972520-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-634f9a69ba6db063972520-1"><span class="crayon-s">'/Applications/VMware Fusion.app/Contents/Library/vmrun'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">gu </span><span class="crayon-v">docker</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">gp </span><span class="crayon-i">tcuser</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6db063972520-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">createDirectoryInGuest</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.minikube</span><span class="crayon-o">/</span><span class="crayon-v">machines</span><span class="crayon-o">/</span><span class="crayon-v">minikube</span><span class="crayon-o">/</span><span class="crayon-v">minikube</span><span class="crayon-e">.vmx</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba6db063972520-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">docker</span><span class="crayon-o">/</span><span class="crayon-e">.ssh</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6db063972520-4">&nbsp;</div><div class="crayon-line" id="crayon-634f9a69ba6db063972520-5"><span class="crayon-s">'/Applications/VMware Fusion.app/Contents/Library/vmrun'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">gu </span><span class="crayon-v">docker</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">gp </span><span class="crayon-i">tcuser</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-634f9a69ba6db063972520-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">CopyFileFromHostToGuest</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.minikube</span><span class="crayon-o">/</span><span class="crayon-v">machines</span><span class="crayon-o">/</span><span class="crayon-v">minikube</span><span class="crayon-o">/</span><span class="crayon-v">minikube</span><span class="crayon-e">.vmx</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-634f9a69ba6db063972520-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-e">.minikube</span><span class="crayon-o">/</span><span class="crayon-v">machines</span><span class="crayon-o">/</span><span class="crayon-v">minikube</span><span class="crayon-o">/</span><span class="crayon-v">id_rsa</span><span class="crayon-e">.pub</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">docker</span><span class="crayon-o">/</span><span class="crayon-e">.ssh</span><span class="crayon-o">/</span><span class="crayon-v">authorized_keys</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->

</li>
</ol>
<div class="open_social_box share_box"><div class="open-social-hint">分享这篇文章到：</div><div class="share_button share_icon_weibo" onclick="share_button_click('http://v.t.sina.com.cn/share/share.php?url=%URL%&title=%TITLE%&pic=%PIC%&appkey=&ralateUid=gmemcc&language=zh_cn&searchPic=false',event)" title="Share with Weibo"></div><div class="share_button share_icon_qqzone" onclick="share_button_click('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=%URL%&title=%TITLE%&desc=&summary=&site=&pics=%PIC%',event)" title="Share with QQZone"></div><div class="share_button share_icon_youdao" onclick="share_button_click('http://note.youdao.com/memory/?url=%URL%&title=%TITLE%&sumary=&pic=%PIC%&product=',event)" title="Share with YoudaoNote"></div><div class="share_button share_icon_wechat" onclick="share_button_click('QRCODE',event)" title="Share with WeChat"></div><div class="share_button share_icon_twitter" onclick="share_button_click('http://twitter.com/home/?status=%TITLE%:%URL%',event)" title="Share with Twitter"></div><div class="share_button share_icon_facebook" onclick="share_button_click('http://www.facebook.com/sharer.php?u=%URL%&amp;t=%TITLE%',event)" title="Share with Facebook"></div><div class="share_button share_icon_google" onclick="share_button_click('http://translate.google.com.hk/translate?hl=en_US&sl=zh-CN&tl=en&u=%URL%',event)" title="Google Translation"></div><div class="open_social_qrcode" onclick="jQuery(this).hide();"></div></div></div><script type="text/javascript" src="https://blog.gmem.cc/wp-content/themes/infinitygrid/js/page-single-after-content.js"></script>
</div>
  
<div class="singlewrap">

        

<div class="related-wrap">
        

        
        
        







        
        
        







        
        
        






</div>
</div>




<div class="singlewrap dbumpsm linetopbtm bump topbtmbump">
<div class="row">				
				
    <div class="col-xs-6 text-left">
     &larr; <a href="https://blog.gmem.cc/essay-20160603" rel="prev">Previous Post</a> 
    </div>
    
    <div class="col-xs-6 text-right">
    <a href="https://blog.gmem.cc/shinken-study-note" rel="next">Shinken学习笔记</a> &rarr; 
    </div>
</div>
</div>


<div class="row">
</div><!--end row-->



<!-- You can start editing here. -->
<!-- If comments are open, but there are no comments. -->


								<div id="respond" class="comment-respond">
				<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/kubernetes-study-note#respond" style="display:none;">Cancel reply</a></small></h3>
									<form action="https://blog.gmem.cc/wp-comments-post.php" method="post" id="commentform" class="comment-form">
						<div class="open-social-hint">您可以使用以下网站的账户登录：</div><div class="open_social_box login_box"><div class="login_button login_icon_google" onclick="login_button_click('google','https://blog.gmem.cc/')" title="使用Google登录"></div><div class="login_button login_icon_douban" onclick="login_button_click('douban','https://blog.gmem.cc/')" title="使用Douban登录"></div><div class="login_button login_icon_csdn" onclick="login_button_click('csdn','https://blog.gmem.cc/')" title="使用CSDN登录"></div><div class="login_button login_icon_oschina" onclick="login_button_click('oschina','https://blog.gmem.cc/')" title="使用OSChina登录"></div><div class="login_button login_icon_twitter" onclick="login_button_click('twitter','https://blog.gmem.cc/')" title="使用Twitter登录"></div><div class="login_button login_icon_github" onclick="login_button_click('github','https://blog.gmem.cc/')" title="使用Github登录"></div></div>													<p class="comment-notes">Your email address will not be published. Required fields are marked <span class="required">*</span></p>							<p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" placeholder="姓名（必填）" name="author" type="text" value="" size="30" aria-required='true' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" placeholder="Email（必填）" name="email" type="text" value="" size="30" aria-required='true' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" placeholder="网站" name="url" type="text" value="" size="30" /></p>
												<p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" placeholder="说点什么吧" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>						<p class="form-allowed-tags">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes:  <code>&lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code class=&quot;&quot; title=&quot;&quot; data-url=&quot;&quot;&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;strike&gt; &lt;strong&gt; &lt;pre class=&quot;&quot; title=&quot;&quot; data-url=&quot;&quot;&gt; &lt;span class=&quot;&quot; title=&quot;&quot; data-url=&quot;&quot;&gt; </code></p>						<p class="form-submit">
							<input name="submit" type="submit" id="submit" value="发布" />
							<input name="submit" type="button" id="cancelReply" value="取消"/>
							<input type='hidden' name='comment_post_ID' value='16626' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
						</p>
						<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="d0b1874220" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="178"/></p>					</form>
							</div><!-- #respond -->
			


</article>
</div><!--end col8-->



<div class="col-md-3"><aside class="sidebar"><div id="wri_widget-3" class="widget-container widget_wri_widget"><h4 class="widget-title-sidebar"><span class="whiteme">Related Posts</span></h4><div class='yarpp-related'>
<div class="wri-title"></div><ul class="wri-related">
<li><a href='https://blog.gmem.cc/problem-detection-and-auto-repairing-in-k8s'>Kubernetes故障检测和自愈</a>
</li><li><a href='https://blog.gmem.cc/kata-containers-study-note'>Kata Containers学习笔记</a>
</li><li><a href='https://blog.gmem.cc/external-lb-for-on-premise-k8s-cluster'>为裸金属K8S集群提供外部负载均衡器</a>
</li><li><a href='https://blog.gmem.cc/cni-study-note'>CNI学习笔记</a>
</li><li><a href='https://blog.gmem.cc/rook-based-k8s-storage-solution'>基于Rook的Kubernetes存储方案</a>
</li></ul>
</div>
</div>		<div id="recent-posts-2" class="widget-container widget_recent_entries">		<h4 class="widget-title-sidebar"><span class="whiteme">Recent Posts</span></h4>		<ul>
					<li>
				<a href="https://blog.gmem.cc/terraform">Terraform快速参考</a>
						</li>
					<li>
				<a href="https://blog.gmem.cc/aquarium-2021">草缸2021</a>
						</li>
					<li>
				<a href="https://blog.gmem.cc/kubernetes-style-apiserver">编写Kubernetes风格的APIServer</a>
						</li>
					<li>
				<a href="https://blog.gmem.cc/debugging-slow-keydb">记录一次KeyDB缓慢的定位过程</a>
						</li>
					<li>
				<a href="https://blog.gmem.cc/ebpf">eBPF学习笔记</a>
						</li>
				</ul>
		</div></aside></div><!--end 3 col sidebar-->
        
</div><!--end row-->
</div><!-- ending container-->
</section><!--end section-->

<style>
<!--
    .widget-container{
        margin-bottom: 40px;
    }
-->
</style>
<footer class="section-wrap-footerbase linetop footercolor stickystopper">
    <div class="container">
    	<div class="row">


                                                                                      <div class="col-md-3">  
                                                <div class="widget-area-footer">
                                                <div class="footer-widget-pads">
                                                    <div id="text-2" class="widget-container widget_text "><div class="footer-bg-headers"><h5 class="widget-title-footer">ABOUT ME</h5></div>			<div class="textwidget"><div  class="textWidgetContent">
<p>汪震 | Alex Wong </p>
<p>江苏淮安人，现居北京。目前供职于腾讯云，专注容器方向。</p>
<p><span style="display:inline-block;width:60px">GitHub：</span><a href="https://github.com/gmemcc">gmemcc</a>
</p>
<p><span style="display:inline-block;width:60px">Git：</span><a href="https://git.gmem.cc/alex">git.gmem.cc</a>
</p>
<p><span style="display:inline-block;width:60px">Email：</span>gmem<span class="invisible">junk@gmem.cc</span><span>@</span>me.com</p>

</div></div>
		</div><div id="text-4" class="widget-container widget_text "><div class="footer-bg-headers"><h5 class="widget-title-footer">ABOUT GMEM</h5></div>			<div class="textwidget"><div class="textWidgetContent">
<p>绿色记忆是我的个人网站，域名gmem.cc中G是Green的简写，MEM是Memory的简写，CC则是我的小天使彩彩名字的简写。</p>
<p>我在这里记录自己的工作与生活，同时和大家分享一些编程方面的知识。</p>
</div></div>
		</div><div id="text-3" class="widget-container widget_text "><div class="footer-bg-headers"><h5 class="widget-title-footer">GMEM HISTORY</h5></div>			<div class="textwidget"><div style="clear:both;min-width:250px">
<script type="text/javascript">
function popupWin(url, title, w, h) {
  var left = (screen.width/2)-(w/2);
  var top = (screen.height/2)-(h/2);
  window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width='+w+', height='+h+', top='+top+', left='+left);
} 
</script>
<div><a href="https://blog.gmem.cc" >v2.00：微风</a></div>
<div><a href="javascript:popupWin('https://history.gmem.cc/v103/','单车旅行',700,450);">v1.03：单车旅行</a></div>
<div><a href="https://history.gmem.cc/v102/" target="_blank">v1.02：夏日版</a></div>
<div><a href="https://history.gmem.cc/v101/" target="_blank">v1.01：未完成</a></div>
<div><a href="https://history.gmem.cc/v010/" target="_blank">v0.10：彩虹天堂</a></div>
<div><a href="https://history.gmem.cc/v001/" target="_blank">v0.01：阳光海岸</a></div>
</div></div>
		</div><div id="text-5" class="widget-container widget_text "><div class="footer-bg-headers"><h5 class="widget-title-footer">MIRROR INFO</h5></div>			<div class="textwidget"><div style="clear:both;min-width:250px">
<script type="text/javascript" src="/wp-content/serverinfo.js.php"></script>
<script type="text/javascript">
    document.write('<div  class="textWidgetContent"><p>镜像名称：&nbsp;&nbsp;' + serverinfo.name+  '</p><p>镜像地址：&nbsp;&nbsp;' + serverinfo.serverip+  '</p><p>接入地址：&nbsp;&nbsp;' + serverinfo.clientip+  '</p></div>');
</script>
</div></div>
		</div><div id="meta-2" class="widget-container widget_meta "><div class="footer-bg-headers"><h5 class="widget-title-footer">Meta</h5></div>			<ul>
						<li><a rel="nofollow" href="https://blog.gmem.cc/wp-login.php">Log in</a></li>
			<li><a href="https://blog.gmem.cc/feed" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://blog.gmem.cc/comments/feed" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
</div>                                                </div>
                                                </div><!--end widget-area-footer -->
                                            </div><!--end onefourth-->
                                        
                                                                                                                            <div class="col-md-3">  
                                                <div class="widget-area-footer">
                                                <div class="footer-widget-pads">
                                                                  <div id="infinitygrid_recent_posts-2" class="widget-container widget_infinitygrid_recent_posts ">                  <div class="footer-bg-headers"><h5 class="widget-title-footer">Recent Posts</h5></div>							<ul class="widget-recent-posts clearfix">
							                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/terraform">
                                        Terraform快速参考                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        简介
Terraform用于实现基础设施即代码（infrastructure as code）—— 通过代码（ ... 
<a href="https://blog.gmem.cc/terraform" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/aquarium-2021">
                                        草缸2021                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                         经过四个多月的努力，我的小小荷兰景到达极致了状态。      </p>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/kubernetes-style-apiserver">
                                        编写Kubernetes风格的APIServer                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        背景
前段时间接到一个需求做一个工具，工具将在K8S中运行。需求很适合用控制器模式实现，很自然的就基于kube ... 
<a href="https://blog.gmem.cc/kubernetes-style-apiserver" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/debugging-slow-keydb">
                                        记录一次KeyDB缓慢的定位过程                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        环境说明
运行环境
这个问题出现在一套搭建在虚拟机上的Kubernetes 1.18集群上。集群有三个节点： ... 
<a href="https://blog.gmem.cc/debugging-slow-keydb" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/ebpf">
                                        eBPF学习笔记                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        简介
BPF，即Berkeley Packet Filter，是一个古老的网络封包过滤机制。它允许从用户空间注 ... 
<a href="https://blog.gmem.cc/ebpf" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/nodeport-leak-under-ipvs-mode">
                                        IPVS模式下ClusterIP泄露宿主机端口的问题                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        问题
在一个启用了IPVS模式kube-proxy的K8S集群中，运行着一个Docker Registry服务 ... 
<a href="https://blog.gmem.cc/nodeport-leak-under-ipvs-mode" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/in-memory-of-grandpa">
                                        念爷爷                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        　　今天是爷爷的头七，十二月七日、阴历十月廿三中午，老人家与世长辞。
　　九月初，回家看望刚动完手术的爸爸，发</p>                                    </div>
                                    
								</li>

                                        
                                   								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/yangmeikeng" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/12/6-150x150.jpg" class="attachment-thumbnail wp-post-image" alt="6" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/yangmeikeng">
                                            杨梅坑                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/34759" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/12/liuhuashan-150x150.jpg" class="attachment-thumbnail wp-post-image" alt="liuhuashan" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/34759">
                                                                                    </a>
                                                                        
                                        <div class="sidebar-h">			    
                                            深圳人才公园的网红景点 —— 流花山     </p>                                        </div>
                                        
									</li>
                                    
                                    								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/20201005-nianhuawan" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/12/16-150x150.jpg" class="attachment-thumbnail wp-post-image" alt="1" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/20201005-nianhuawan">
                                            2020年10月拈花湾                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/nodeport-63s-delay-due-to-kernel-issue">
                                        内核缺陷触发的NodePort服务63秒延迟问题                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        现象
我们有一个新创建的TKE 1.3.0集群，使用基于Galaxy + Flannel（VXLAN模式）的容 ... 
<a href="https://blog.gmem.cc/nodeport-63s-delay-due-to-kernel-issue" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/galaxy-study-note">
                                        Galaxy学习笔记                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        简介
Galaxy是TKEStack的一个网络组件，支持为TKE集群提供Overlay/Underlay容器网 ... 
<a href="https://blog.gmem.cc/galaxy-study-note" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/cilium">
                                        Cilium学习笔记                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        简介
Cilium
Cilium是在Docker/K8S之类的容器管理平台下，透明的为应用程序服务提供安全网 ... 
<a href="https://blog.gmem.cc/cilium" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/20200614-huangyaguan" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/06/71-150x150.jpg" class="attachment-thumbnail wp-post-image" alt="彩彩" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/20200614-huangyaguan">
                                            2020年6月黄崖关                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/20200517-shenzhen" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/05/IMG_3216-150x150.jpeg" class="attachment-thumbnail wp-post-image" alt="总部远眺" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/20200517-shenzhen">
                                            2020年5月深圳                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/a-bite-of-shunde" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/05/IMG_3199-150x150.jpeg" class="attachment-thumbnail wp-post-image" alt="绚丽之花" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/a-bite-of-shunde">
                                            寻味顺德                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                									
							    <li class="recent-poststhumb-widget">
							    
                                        <span class="rwt-img">
                                            <a href="https://blog.gmem.cc/picnic-by-the-lakeside" class="opac">
                                                <img src="https://blog.gmem.cc/wp-content/uploads/2020/05/tuanbolake-150x150.jpg" class="attachment-thumbnail wp-post-image" alt="tuanbolake" style="width: 64px; border-radius:3px" />                                            </a>
                                        </span>
                                        
                                        <a  href="https://blog.gmem.cc/picnic-by-the-lakeside">
                                            团泊湖野餐                                        </a>
                                                                        
                                        <div class="sidebar-h">			    
                                                   </p>                                        </div>
                                        
									</li>
                                    
                                    								                                

							    <li class="recent-poststhumb-widget">
						                                            
                                    <a  href="https://blog.gmem.cc/typescript">
                                        TypeScript学习笔记                                    </a>
                                                                    
                                    <div class="sidebar-h">			    
                                        安装和配置
安装
执行下面的命令安装TypeScript：
npm install -g typescri ... 
<a href="https://blog.gmem.cc/typescript" title=""></a>                                    </div>
                                    
								</li>

                                        
                                   								                                
															</ul>
              </div>                                                        </div>
                                                </div><!--end widget-area-footer -->
                                            </div><!--end onefourth-->
                                                                                
                                                                                    <div class="col-md-3">  
                                                <div class="widget-area-footer">
                                                    <div class="footer-widget-pads">
                                                    
<div id="infinitygrid_toplikes_widget-3" class="widget-container widget_infinitygrid_toplikes_widget ">
<div class="footer-bg-headers"><h5 class="widget-title-footer">TOPLINKS</h5></div>         


<ul class="heartul">

        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/zitahlis-blue">Zitahli's blue</a>
            <span class="likeswidget"><span class="heartcount">91</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/dream-wedding">梦中的婚礼</a>
            <span class="likeswidget"><span class="heartcount">64</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/wangjinghao">汪静好</a>
            <span class="likeswidget"><span class="heartcount">61</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/wheni-was-one-year-old">那年我一岁</a>
            <span class="likeswidget"><span class="heartcount">36</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/for-love">为了爱</a>
            <span class="likeswidget"><span class="heartcount">28</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/mitori-no-ayana">小绿彩</a>
            <span class="likeswidget"><span class="heartcount">26</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/lady-caihongs-smile">彩虹姐姐的笑脸</a>
            <span class="likeswidget"><span class="heartcount">24</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/yangmeikeng">杨梅坑</a>
            <span class="likeswidget"><span class="heartcount">6</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/yalong-bay">亚龙湾之旅</a>
            <span class="likeswidget"><span class="heartcount">1</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/wangchangbo">汪昌博</a>
            <span class="likeswidget"><span class="heartcount"></span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/201311-fragrant-hill">2013年11月香山</a>
            <span class="likeswidget"><span class="heartcount">10</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/201307-qinhuangdao">2013年7月秦皇岛</a>
            <span class="likeswidget"><span class="heartcount">6</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/201306-panshan">2013年6月蓟县盘山</a>
            <span class="likeswidget"><span class="heartcount">5</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/201302-plumblossom-hill">2013年2月梅花山</a>
            <span class="likeswidget"><span class="heartcount">2</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2013-huaiyin-lantern-show">2013年淮阴自贡迎春灯会</a>
            <span class="likeswidget"><span class="heartcount">3</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2012-jinshan">2012年镇江金山游</a>
            <span class="likeswidget"><span class="heartcount">1</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2012-hui-hang-road">2012年徽杭古道</a>
            <span class="likeswidget"><span class="heartcount">9</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2011-yangzhou">2011年清明节后扬州行</a>
            <span class="likeswidget"><span class="heartcount">1</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2008-yunlong-park">2008年十一云龙公园</a>
            <span class="likeswidget"><span class="heartcount">5</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/2008-autumn-memory">2008年之秋忆</a>
            <span class="likeswidget"><span class="heartcount">7</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/old-photos-of-my-family">老照片</a>
            <span class="likeswidget"><span class="heartcount">13</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/june-on-fire">火一样的六月</a>
            <span class="likeswidget"><span class="heartcount">16</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/alexs-old-photos">发黄的相片</a>
            <span class="likeswidget"><span class="heartcount">3</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/cesium-study-note">Cesium学习笔记</a>
            <span class="likeswidget"><span class="heartcount">88</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/intellij-idea-faq">IntelliJ IDEA知识集锦</a>
            <span class="likeswidget"><span class="heartcount">59</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/webrtc-server-basedon-kurento">基于Kurento搭建WebRTC服务器</a>
            <span class="likeswidget"><span class="heartcount">38</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/phonegap-study-note">PhoneGap学习笔记</a>
            <span class="likeswidget"><span class="heartcount">32</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/chrome-native-client-study-note">NaCl学习笔记</a>
            <span class="likeswidget"><span class="heartcount">32</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/jvm-monitoring-with-oracle-jmc">使用Oracle Java Mission Control监控JVM运行状态</a>
            <span class="likeswidget"><span class="heartcount">29</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/calico">基于Calico的CNI</a>
            <span class="likeswidget"><span class="heartcount">27</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/ceph-study-note">Ceph学习笔记</a>
            <span class="likeswidget"><span class="heartcount">26</span> people like this</span>
        </li>
    
        
        <li class="cat-item-plus">
            <a href="https://blog.gmem.cc/three-js-study-note">Three.js学习笔记</a>
            <span class="likeswidget"><span class="heartcount">24</span> people like this</span>
        </li>
    
    
</ul><!--end heart ul-->

</div>              
                                                            </div>
                                                </div><!--end widget-area-footer -->
                                            </div><!--end onefourth-->  
                                        
                                                                                    <div class="col-md-3">  
                                                <div class="widget-area-footer">
                                                    <div class="footer-widget-pads">
                                                    <div id="tag_cloud-2" class="widget-container widget_tag_cloud "><div class="footer-bg-headers"><h5 class="widget-title-footer">Tag Cloud</h5></div><div class="tagcloud"><a href='https://blog.gmem.cc/tag/activemq' class='tag-link-26' title='8 topics' style='font-size: 13.483333333333pt;'>ActiveMQ</a>
<a href='https://blog.gmem.cc/tag/aspectj' class='tag-link-75' title='4 topics' style='font-size: 10.566666666667pt;'>AspectJ</a>
<a href='https://blog.gmem.cc/tag/cdt' class='tag-link-135' title='4 topics' style='font-size: 10.566666666667pt;'>CDT</a>
<a href='https://blog.gmem.cc/tag/ceph' class='tag-link-295' title='2 topics' style='font-size: 8pt;'>Ceph</a>
<a href='https://blog.gmem.cc/tag/chrome' class='tag-link-159' title='2 topics' style='font-size: 8pt;'>Chrome</a>
<a href='https://blog.gmem.cc/tag/cni' class='tag-link-317' title='5 topics' style='font-size: 11.5pt;'>CNI</a>
<a href='https://blog.gmem.cc/tag/command' class='tag-link-106' title='6 topics' style='font-size: 12.316666666667pt;'>Command</a>
<a href='https://blog.gmem.cc/tag/cordova' class='tag-link-213' title='3 topics' style='font-size: 9.4pt;'>Cordova</a>
<a href='https://blog.gmem.cc/tag/coroutine' class='tag-link-192' title='2 topics' style='font-size: 8pt;'>Coroutine</a>
<a href='https://blog.gmem.cc/tag/cxf' class='tag-link-86' title='2 topics' style='font-size: 8pt;'>CXF</a>
<a href='https://blog.gmem.cc/tag/cygwin' class='tag-link-28' title='2 topics' style='font-size: 8pt;'>Cygwin</a>
<a href='https://blog.gmem.cc/tag/dns' class='tag-link-309' title='5 topics' style='font-size: 11.5pt;'>DNS</a>
<a href='https://blog.gmem.cc/tag/docker' class='tag-link-243' title='3 topics' style='font-size: 9.4pt;'>Docker</a>
<a href='https://blog.gmem.cc/tag/ebpf' class='tag-link-319' title='3 topics' style='font-size: 9.4pt;'>eBPF</a>
<a href='https://blog.gmem.cc/tag/eclipse' class='tag-link-55' title='8 topics' style='font-size: 13.483333333333pt;'>Eclipse</a>
<a href='https://blog.gmem.cc/tag/extjs' class='tag-link-32' title='16 topics' style='font-size: 16.75pt;'>ExtJS</a>
<a href='https://blog.gmem.cc/tag/f7' class='tag-link-214' title='4 topics' style='font-size: 10.566666666667pt;'>F7</a>
<a href='https://blog.gmem.cc/tag/faq' class='tag-link-62' title='24 topics' style='font-size: 18.733333333333pt;'>FAQ</a>
<a href='https://blog.gmem.cc/tag/groovy' class='tag-link-209' title='4 topics' style='font-size: 10.566666666667pt;'>Groovy</a>
<a href='https://blog.gmem.cc/tag/hibernate' class='tag-link-25' title='5 topics' style='font-size: 11.5pt;'>Hibernate</a>
<a href='https://blog.gmem.cc/tag/http' class='tag-link-185' title='3 topics' style='font-size: 9.4pt;'>HTTP</a>
<a href='https://blog.gmem.cc/tag/intellij' class='tag-link-225' title='8 topics' style='font-size: 13.483333333333pt;'>IntelliJ</a>
<a href='https://blog.gmem.cc/tag/io%e7%bc%96%e7%a8%8b' class='tag-link-269' title='2 topics' style='font-size: 8pt;'>IO编程</a>
<a href='https://blog.gmem.cc/tag/ipvs' class='tag-link-297' title='2 topics' style='font-size: 8pt;'>IPVS</a>
<a href='https://blog.gmem.cc/tag/jacksonjson' class='tag-link-74' title='2 topics' style='font-size: 8pt;'>JacksonJSON</a>
<a href='https://blog.gmem.cc/tag/jms' class='tag-link-248' title='4 topics' style='font-size: 10.566666666667pt;'>JMS</a>
<a href='https://blog.gmem.cc/tag/json' class='tag-link-253' title='2 topics' style='font-size: 8pt;'>JSON</a>
<a href='https://blog.gmem.cc/tag/jvm' class='tag-link-142' title='5 topics' style='font-size: 11.5pt;'>JVM</a>
<a href='https://blog.gmem.cc/tag/k8s' class='tag-link-271' title='35 topics' style='font-size: 20.6pt;'>K8S</a>
<a href='https://blog.gmem.cc/tag/kernel' class='tag-link-305' title='6 topics' style='font-size: 12.316666666667pt;'>kernel</a>
<a href='https://blog.gmem.cc/tag/lb' class='tag-link-277' title='3 topics' style='font-size: 9.4pt;'>LB</a>
<a href='https://blog.gmem.cc/tag/libvirt' class='tag-link-241' title='3 topics' style='font-size: 9.4pt;'>libvirt</a>
<a href='https://blog.gmem.cc/tag/linux%e7%9f%a5%e8%af%86' class='tag-link-307' title='9 topics' style='font-size: 14.066666666667pt;'>Linux知识</a>
<a href='https://blog.gmem.cc/tag/linux%e7%bc%96%e7%a8%8b' class='tag-link-283' title='7 topics' style='font-size: 12.9pt;'>Linux编程</a>
<a href='https://blog.gmem.cc/tag/log' class='tag-link-260' title='7 topics' style='font-size: 12.9pt;'>LOG</a>
<a href='https://blog.gmem.cc/tag/maven' class='tag-link-68' title='4 topics' style='font-size: 10.566666666667pt;'>Maven</a>
<a href='https://blog.gmem.cc/tag/mingw' class='tag-link-29' title='3 topics' style='font-size: 9.4pt;'>MinGW</a>
<a href='https://blog.gmem.cc/tag/mock' class='tag-link-202' title='2 topics' style='font-size: 8pt;'>Mock</a>
<a href='https://blog.gmem.cc/tag/monitoring' class='tag-link-232' title='3 topics' style='font-size: 9.4pt;'>Monitoring</a>
<a href='https://blog.gmem.cc/tag/multimedia' class='tag-link-259' title='6 topics' style='font-size: 12.316666666667pt;'>Multimedia</a>
<a href='https://blog.gmem.cc/tag/mvc' class='tag-link-199' title='4 topics' style='font-size: 10.566666666667pt;'>MVC</a>
<a href='https://blog.gmem.cc/tag/mysql' class='tag-link-90' title='2 topics' style='font-size: 8pt;'>MySQL</a>
<a href='https://blog.gmem.cc/tag/netfs' class='tag-link-107' title='2 topics' style='font-size: 8pt;'>netfs</a>
<a href='https://blog.gmem.cc/tag/netty' class='tag-link-190' title='2 topics' style='font-size: 8pt;'>Netty</a>
<a href='https://blog.gmem.cc/tag/nginx' class='tag-link-275' title='2 topics' style='font-size: 8pt;'>Nginx</a>
<a href='https://blog.gmem.cc/tag/nio' class='tag-link-184' title='4 topics' style='font-size: 10.566666666667pt;'>NIO</a>
<a href='https://blog.gmem.cc/tag/node-js' class='tag-link-208' title='4 topics' style='font-size: 10.566666666667pt;'>Node.js</a>
<a href='https://blog.gmem.cc/tag/nosql' class='tag-link-258' title='4 topics' style='font-size: 10.566666666667pt;'>NoSQL</a>
<a href='https://blog.gmem.cc/tag/oracle' class='tag-link-129' title='2 topics' style='font-size: 8pt;'>Oracle</a>
<a href='https://blog.gmem.cc/tag/pdt' class='tag-link-56' title='3 topics' style='font-size: 9.4pt;'>PDT</a>
<a href='https://blog.gmem.cc/tag/php' class='tag-link-9' title='4 topics' style='font-size: 10.566666666667pt;'>PHP</a>
<a href='https://blog.gmem.cc/tag/redis' class='tag-link-301' title='3 topics' style='font-size: 9.4pt;'>Redis</a>
<a href='https://blog.gmem.cc/tag/rpc' class='tag-link-266' title='3 topics' style='font-size: 9.4pt;'>RPC</a>
<a href='https://blog.gmem.cc/tag/scheduler' class='tag-link-77' title='2 topics' style='font-size: 8pt;'>Scheduler</a>
<a href='https://blog.gmem.cc/tag/servicemesh' class='tag-link-281' title='9 topics' style='font-size: 14.066666666667pt;'>ServiceMesh</a>
<a href='https://blog.gmem.cc/tag/snmp' class='tag-link-204' title='3 topics' style='font-size: 9.4pt;'>SNMP</a>
<a href='https://blog.gmem.cc/tag/spring' class='tag-link-24' title='8 topics' style='font-size: 13.483333333333pt;'>Spring</a>
<a href='https://blog.gmem.cc/tag/ssl' class='tag-link-110' title='3 topics' style='font-size: 9.4pt;'>SSL</a>
<a href='https://blog.gmem.cc/tag/svn' class='tag-link-88' title='2 topics' style='font-size: 8pt;'>svn</a>
<a href='https://blog.gmem.cc/tag/tomcat' class='tag-link-49' title='4 topics' style='font-size: 10.566666666667pt;'>Tomcat</a>
<a href='https://blog.gmem.cc/tag/tsdb' class='tag-link-234' title='5 topics' style='font-size: 11.5pt;'>TSDB</a>
<a href='https://blog.gmem.cc/tag/ubuntu' class='tag-link-35' title='8 topics' style='font-size: 13.483333333333pt;'>Ubuntu</a>
<a href='https://blog.gmem.cc/tag/webgl' class='tag-link-179' title='2 topics' style='font-size: 8pt;'>WebGL</a>
<a href='https://blog.gmem.cc/tag/webrtc' class='tag-link-254' title='2 topics' style='font-size: 8pt;'>WebRTC</a>
<a href='https://blog.gmem.cc/tag/webservice' class='tag-link-87' title='3 topics' style='font-size: 9.4pt;'>WebService</a>
<a href='https://blog.gmem.cc/tag/websocket' class='tag-link-245' title='5 topics' style='font-size: 11.5pt;'>WebSocket</a>
<a href='https://blog.gmem.cc/tag/wxwidgets' class='tag-link-31' title='2 topics' style='font-size: 8pt;'>wxWidgets</a>
<a href='https://blog.gmem.cc/tag/xdebug' class='tag-link-57' title='3 topics' style='font-size: 9.4pt;'>XDebug</a>
<a href='https://blog.gmem.cc/tag/xml' class='tag-link-66' title='2 topics' style='font-size: 8pt;'>XML</a>
<a href='https://blog.gmem.cc/tag/xpath' class='tag-link-116' title='2 topics' style='font-size: 8pt;'>XPath</a>
<a href='https://blog.gmem.cc/tag/xrm' class='tag-link-97' title='2 topics' style='font-size: 8pt;'>XRM</a>
<a href='https://blog.gmem.cc/tag/zookeeper' class='tag-link-251' title='2 topics' style='font-size: 8pt;'>ZooKeeper</a>
<a href='https://blog.gmem.cc/tag/%e4%ba%9a%e9%be%99%e6%b9%be' class='tag-link-279' title='4 topics' style='font-size: 10.566666666667pt;'>亚龙湾</a>
<a href='https://blog.gmem.cc/tag/%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95' class='tag-link-203' title='5 topics' style='font-size: 11.5pt;'>单元测试</a>
<a href='https://blog.gmem.cc/tag/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0' class='tag-link-148' title='47 topics' style='font-size: 22pt;'>学习笔记</a>
<a href='https://blog.gmem.cc/tag/%e5%ae%9e%e6%97%b6%e5%a4%84%e7%90%86' class='tag-link-264' title='2 topics' style='font-size: 8pt;'>实时处理</a>
<a href='https://blog.gmem.cc/tag/%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b' class='tag-link-201' title='6 topics' style='font-size: 12.316666666667pt;'>并发编程</a>
<a href='https://blog.gmem.cc/tag/%e5%bd%a9%e5%a7%90' class='tag-link-149' title='4 topics' style='font-size: 10.566666666667pt;'>彩姐</a>
<a href='https://blog.gmem.cc/tag/%e6%80%a7%e8%83%bd%e5%89%96%e6%9e%90' class='tag-link-303' title='7 topics' style='font-size: 12.9pt;'>性能剖析</a>
<a href='https://blog.gmem.cc/tag/%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98' class='tag-link-125' title='3 topics' style='font-size: 9.4pt;'>性能调优</a>
<a href='https://blog.gmem.cc/tag/%e6%96%87%e6%9c%ac%e5%a4%84%e7%90%86' class='tag-link-145' title='4 topics' style='font-size: 10.566666666667pt;'>文本处理</a>
<a href='https://blog.gmem.cc/tag/%e6%96%b0%e7%89%b9%e6%80%a7' class='tag-link-200' title='3 topics' style='font-size: 9.4pt;'>新特性</a>
<a href='https://blog.gmem.cc/tag/%e6%9e%b6%e6%9e%84%e6%a8%a1%e5%bc%8f' class='tag-link-198' title='2 topics' style='font-size: 8pt;'>架构模式</a>
<a href='https://blog.gmem.cc/tag/%e7%b3%bb%e7%bb%9f%e7%bc%96%e7%a8%8b' class='tag-link-285' title='5 topics' style='font-size: 11.5pt;'>系统编程</a>
<a href='https://blog.gmem.cc/tag/%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b' class='tag-link-215' title='4 topics' style='font-size: 10.566666666667pt;'>网络编程</a>
<a href='https://blog.gmem.cc/tag/%e8%a7%86%e9%a2%91%e7%9b%91%e6%8e%a7' class='tag-link-252' title='3 topics' style='font-size: 9.4pt;'>视频监控</a>
<a href='https://blog.gmem.cc/tag/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f' class='tag-link-195' title='26 topics' style='font-size: 19.083333333333pt;'>设计模式</a>
<a href='https://blog.gmem.cc/tag/%e8%bf%9c%e7%a8%8b%e8%b0%83%e8%af%95' class='tag-link-122' title='2 topics' style='font-size: 8pt;'>远程调试</a>
<a href='https://blog.gmem.cc/tag/%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6' class='tag-link-73' title='3 topics' style='font-size: 9.4pt;'>配置文件</a>
<a href='https://blog.gmem.cc/tag/zitahli' class='tag-link-23' title='5 topics' style='font-size: 11.5pt;'>齐塔莉</a></div>
</div><div id="recent-comments-3" class="widget-container widget_recent_comments "><div class="footer-bg-headers"><h5 class="widget-title-footer">Recent Comments</h5></div><ul id="recentcomments"><li class="recentcomments"><a href='https://code84.com/501597.html' rel='external nofollow' class='url'>C/C++编程：WebSocketpp（Linux + Clion + boostAsio） &#8211; 源码巴士</a> on <a href="https://blog.gmem.cc/websocket-library-for-c-or-cpp#comment-57399">基于C/C++的WebSocket库</a></li><li class="recentcomments">jerbin on <a href="https://blog.gmem.cc/ebpf#comment-57179">eBPF学习笔记</a></li><li class="recentcomments">point on <a href="https://blog.gmem.cc/istio-tproxy#comment-55951">Istio中的透明代理问题</a></li><li class="recentcomments">G on <a href="https://blog.gmem.cc/istio-tproxy#comment-46377">Istio中的透明代理问题</a></li><li class="recentcomments"><a href='https://blog.gmem.cc/go-unitest-and-mock' rel='external nofollow' class='url'>绿色记忆:Go语言单元测试和仿冒</a> on <a href="https://blog.gmem.cc/ginkgo-study-note#comment-45783">Ginkgo学习笔记</a></li><li class="recentcomments">point on <a href="https://blog.gmem.cc/istio-tproxy#comment-45439">Istio中的透明代理问题</a></li><li class="recentcomments"><a href='http://it.newban.cn/archives/151418' rel='external nofollow' class='url'>【Maven】maven插件开发实战 &#8211; IT汇</a> on <a href="https://blog.gmem.cc/maven-plugin-development#comment-44165">Maven插件开发</a></li><li class="recentcomments">chenlx on <a href="https://blog.gmem.cc/ebpf#comment-42855">eBPF学习笔记</a></li><li class="recentcomments"><a href='http://gmem.cc' rel='external nofollow' class='url'>Alex</a> on <a href="https://blog.gmem.cc/ebpf#comment-41161">eBPF学习笔记</a></li><li class="recentcomments"><a href='https://www.cnxct.com' rel='external nofollow' class='url'>CFC4N</a> on <a href="https://blog.gmem.cc/ebpf#comment-41109">eBPF学习笔记</a></li><li class="recentcomments">李运田 on <a href="https://blog.gmem.cc/in-memory-of-grandpa#comment-27757">念爷爷</a></li><li class="recentcomments"><a href='https://xiking.win' rel='external nofollow' class='url'>yongman</a> on <a href="https://blog.gmem.cc/debugging-slow-keydb#comment-27471">记录一次KeyDB缓慢的定位过程</a></li><li class="recentcomments"><a href='http://gmem.cc' rel='external nofollow' class='url'>Alex</a> on <a href="https://blog.gmem.cc/istio-tproxy#comment-26189">Istio中的透明代理问题</a></li><li class="recentcomments">will on <a href="https://blog.gmem.cc/istio-tproxy#comment-26129">Istio中的透明代理问题</a></li><li class="recentcomments">will on <a href="https://blog.gmem.cc/istio-tproxy#comment-26127">Istio中的透明代理问题</a></li><li class="recentcomments">haolipeng on <a href="https://blog.gmem.cc/go-plugin-over-grpc#comment-26043">基于本地gRPC的Go插件系统</a></li><li class="recentcomments">吴杰 on <a href="https://blog.gmem.cc/websocket-library-for-c-or-cpp#comment-25983">基于C/C++的WebSocket库</a></li><li class="recentcomments"><a href='https://blog.gmem.cc/nginx-faq' rel='external nofollow' class='url'>绿色记忆:Nginx知识集锦</a> on <a href="https://blog.gmem.cc/apache-http-server-faq#comment-25385">Apache HTTP Server知识集锦</a></li><li class="recentcomments">NotMeBug on <a href="https://blog.gmem.cc/aspectj-study-note#comment-25345">AspectJ编程学习笔记</a></li><li class="recentcomments">fx_carrot on <a href="https://blog.gmem.cc/bazel-study-note#comment-24133">Bazel学习笔记</a></li><li class="recentcomments"><a href='http://www.fixbbs.com/p/01415873.html' rel='external nofollow' class='url'>bytebuddy简单入门 &#8211; FIXBBS</a> on <a href="https://blog.gmem.cc/byte-buddy-study-note#comment-23725">Byte Buddy学习笔记</a></li><li class="recentcomments"><a href='https://www.admin31.com/2020/1222/238' rel='external nofollow' class='url'>4.深入Istio源码：Pilot的Discovery Server如何执行xDS异步分发-站长之家</a> on <a href="https://blog.gmem.cc/interaction-between-istio-pilot-and-envoy#comment-22707">Istio Pilot与Envoy的交互机制解读</a></li><li class="recentcomments"><a href='https://www.luozhiyun.com/archives/408' rel='external nofollow' class='url'>4.深入Istio源码：Pilot的Discovery Server如何执行xDS异步分发？ - luozhiyun`s Blog</a> on <a href="https://blog.gmem.cc/interaction-between-istio-pilot-and-envoy#comment-22215">Istio Pilot与Envoy的交互机制解读</a></li></ul></div>                                                    </div>
                                                </div><!--end widget-area-footer -->
                                            </div><!--end onefourth-->  
                                            	</div><!--end this row-->
    </div><!--end container-->
    
<section class="section-wrap-footer-small damp">
    <div class="container">
    	<div class="row">
    	
            <div class="col-md-6 minh" style="color:#7A7A7A;">     
                &copy;2005-2022 Gmem.cc | Powered by WordPress
            </div>

            <div class="col-md-6">
                    <div class="social-icons">
<ul>

































</ul>
</div>            </div>
                        
    	</div><!--end row inside footer-->
    </div><!--ending footer-->
</section>
    
</footer><!--colored section footer-->
         
</div><!--shadow-->
</div><!--margin-->
</div><!--end entiresite wrap-->

<script type='text/javascript' src='https://blog.gmem.cc/wp-content/plugins/akismet/_inc/form.js?ver=3.0.2'></script>
<link rel='stylesheet' id='wri-thumbnails-yarpp-thumbnail-css'  href='https://blog.gmem.cc/wp-content/themes/infinitygrid/wri_template/styles-wri-thumbnails.php?width=120&#038;height=120&#038;ver=3.9.14' type='text/css' media='all' />
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/plugins/open-social/images/os.js?ver=3.9.14'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/retina.js?ver=3.9.14'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var ajax_var = {"url":"https:\/\/blog.gmem.cc\/wp-admin\/admin-ajax.php","nonce":"5111e7d604"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/post-like.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/isotope.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/isotopeme.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.infinitescroll.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/manual-trigger.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/post-like.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.easing-1.3.pack.js?ver=1.3'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/custom.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.fitvids.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.sidr.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/superfishmenu.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/hoverintent.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/jquery.nivo.slider.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/nivome.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/navie.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-content/themes/infinitygrid/js/bootstrap.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://blog.gmem.cc/wp-includes/js/comment-reply.min.js?ver=3.9.14'></script>
</body>
</html>
<!-- Dynamic page generated in 10.563 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2022-10-19 14:34:26 -->

<!-- Compression = gzip -->